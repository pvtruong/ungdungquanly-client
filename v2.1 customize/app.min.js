function writtenNumber(t,n){if(n=n||{},n=util.defaults(n,writtenNumber.defaults),0>t)return"";t=Math.round(+t);var e,a="string"==typeof n.lang?i18n[n.lang]:n.lang,i=a.useLongScale?longScale:shortScale,o=a.units;if(!(o instanceof Array)){var r=o;o=[],i=Object.keys(r);for(var c in i)o.push(r[i[c]]),i[c]=Math.pow(10,parseInt(i[c]))}a||(languages.indexOf(writtenNumber.defaults.lang)<0&&(writtenNumber.defaults.lang="en"),a=i18n[writtenNumber.defaults.lang]);var d=a.base;if(a.unitExceptions[t])return a.unitExceptions[t];if(d[t])return d[t];if(100>t)return handleSmallerThan100(t,a,e,d,n);var l=t%100,_=[];l&&_.push(!n.noAnd||a.andException&&a.andException[10]?a.unitSeparator+writtenNumber(l,n):writtenNumber(l,n));for(var u,c=0,s=o.length;s>c;c++){var p,h=Math.floor(t/i[c]);if(p=c===s-1?1e6:i[c+1]/i[c],h%=p,e=o[c],h)if(u=i[c],e.useBaseInstead){var f=e.useBaseException.indexOf(h)>-1&&(e.useBaseExceptionWhenNoTrailingNumbers?0===c&&_.length:!0);_.push(f?h>1&&e.plural?e.plural:e.singular:d[h*i[c]])}else{var g;if(g="string"==typeof e?e:!(h>1&&e.plural)||e.avoidInNumberPlural&&l?e.singular:e.plural,e.avoidPrefixException&&e.avoidPrefixException.indexOf(h)>-1)_.push(g);else{var m=a.unitExceptions[h],v=m||writtenNumber(h,util.defaults({noAnd:!(a.andException&&a.andException[h]||e.andException)},n));t-=h*i[c],_.push(v+" "+g)}}}var k=u*Math.floor(t/u),$=t-k;a.andWhenTrailing&&u&&$>0&&0!==_[0].indexOf(a.unitSeparator)&&(_=[_[0],a.unitSeparator.replace(/\s+$/,"")].concat(_.slice(1)));var b=_.reverse().join(" ");return b.substring(0,1).toUpperCase()+b.substring(1)}function handleSmallerThan100(t,n,e,a,i){var o=10*Math.floor(t/10);return e=t-o,e?a[o]+n.baseSeparator+writtenNumber(e,i):a[o]}!function(){angular.module("adf",["adf.provider","adf.locale","ui.bootstrap"]).value("adfTemplatePath","../src/templates/").value("rowTemplate",'<adf-dashboard-row row="row" adf-model="adfModel" options="options" edit-mode="editMode" ng-repeat="row in column.rows" />').value("columnTemplate",'<adf-dashboard-column column="column" adf-model="adfModel" options="options" edit-mode="editMode" ng-repeat="column in row.columns" />').value("adfVersion","0.13.0-SNAPSHOT"),angular.module("adf").run(["$templateCache",function(t){t.put("../src/templates/dashboard-column.html",'<div adf-id={{column.cid}} class=column ng-class=column.styleClass ng-model=column.widgets> <adf-widget ng-repeat="definition in column.widgets" adf-model=adfModel definition=definition column=column edit-mode=editMode options=options widget-state=widgetState>  </adf-widget></div> '),t.put("../src/templates/dashboard-edit.html",'<div class=modal-header> <button type=button class=close ng-click=closeDialog() aria-hidden=true>&times;</button> <h4 class=modal-title ng-bind="translate(\'ADF_COMMON_EDIT_DASHBOARD\')">Edit Dashboard</h4> </div> <div class=modal-body> <form role=form> <div class=form-group> <label for=dashboardTitle ng-bind="translate(\'ADF_COMMON_TITLE\')">Title</label> <input type=text class=form-control id=dashboardTitle ng-model=copy.title required> </div> <div class=form-group> <label ng-bind="translate(\'ADF_EDIT_DASHBOARD_STRUCTURE_LABEL\')">Structure</label> <div class=row ng-init="splitted = split(structures, 3)"> <div class=col-lg-4 ng-repeat="structureColumn in splitted"> <div class=radio ng-repeat="(key, structure) in structureColumn"> <div class=row> <div class=col-sm-2> <label> <input type=radio value={{key}} ng-model=model.structure ng-change="changeStructure(key, structure)"> </label> </div> <div class=col-sm-9 ng-click="changeStructure(key, structure)"> <adf-structure-preview name=key structure=structure selected="model.structure == key"> </adf-structure-preview> </div> </div> </div> </div> </div> </div> </form> </div> <div class=modal-footer> <button type=button class="btn btn-primary" ng-click=closeDialog() ng-bind="translate(\'ADF_COMMON_CLOSE\')">Close</button> </div> '),t.put("../src/templates/dashboard-row.html","<div class=row ng-class=row.styleClass ng-style=row.style>  </div> "),t.put("../src/templates/dashboard-title.html","<div style='min-height:10px;padding-left:10px;padding-bottom:10px'> <!--{{model.title}}-->Ngày {{now|date:'dd/MM/yyyy'}} <span style=\"font-size: 16px\" class=pull-right> <a href ng-if=editMode title=\"{{ translate('ADF_DASHBOARD_TITLE_TOOLTIP_ADD') }}\" ng-click=addWidgetDialog()> <i class=\"glyphicon glyphicon-plus-sign\"></i> </a> <a href ng-if=editMode title=\"{{ translate('ADF_COMMON_EDIT_DASHBOARD') }}\" ng-click=editDashboardDialog()> <i class=\"glyphicon glyphicon-cog\"></i> </a> <a href ng-if=options.editable title=\"{{editMode ? translate('ADF_DASHBOARD_TITLE_TOOLTIP_SAVE') : translate('ADF_DASHBOARD_TITLE_TOOLTIP_EDIT_MODE') }}\" ng-click=toggleEditMode()> <i class=glyphicon x-ng-class=\"{'glyphicon-edit' : !editMode, 'glyphicon-save' : editMode}\"></i></a> <a href ng-if=editMode title=\"{{ translate('ADF_DASHBOARD_TITLE_TOOLTIP_UNDO') }}\" ng-click=cancelEditMode()> <i class=\"glyphicon glyphicon-repeat adf-flip\"></i> </a> </span> </div> "),t.put("../src/templates/dashboard.html",'<div class=dashboard-container> <div ng-include src=model.titleTemplateUrl></div> <div class=dashboard x-ng-class="{\'edit\' : editMode}"> <adf-dashboard-row row=row adf-model=model options=options ng-repeat="row in model.rows" edit-mode=editMode continuous-edit-mode=continuousEditMode> </adf-dashboard-row></div> </div> '),t.put("../src/templates/structure-preview.html",'<div class=structure-preview ng-class="{selected: selected}"> <h4>{{name}}</h4> <adf-dashboard-row ng-repeat="row in preview.rows" row=row> </adf-dashboard-row></div> '),t.put("../src/templates/widget-add.html",'<div class=modal-header> <button type=button class=close ng-click=closeDialog() aria-hidden=true>&times;</button> <h4 class=modal-title ng-bind="translate(\'ADF_WIDGET_ADD_HEADER\')">Add new widget</h4> </div>\n <div class=modal-body>\n   <div ng-if=createCategories>\n    <uib-accordion ng-init="categorized = createCategories(widgets)">\n     <uib-accordion-group heading={{category.name}} ng-repeat="category in categorized | adfOrderByObjectKey: \'name\'">\n       <div class=dl-horizontal>\n        <div ng-repeat="widget in category.widgets | adfOrderByObjectKey: \'key\'">\n         <h3><a href ng-click=addWidget(widget.key)> {{widget.title}} </a></h3>\n         <p ng-if=widget.description> {{widget.description}} </p>\n        </div>\n\n       </div>\n      </uib-accordion-group>\n    </uib-accordion>\n  </div>\n  <div style="display: inline-block;" ng-if=!createCategories>\n   <div class=dl-horizontal>\n    <div ng-repeat="widget in widgets | adfOrderByObjectKey: \'key\'">\n     <h3><a href ng-click=addWidget(widget.key)> {{widget.title}} </a></h3>\n     <p ng-if=widget.description> {{widget.description}} </p>\n    </div>\n   </div>\n  </div>\n</div>\n<div class=modal-footer> <button type=button class="btn btn-primary" ng-click=closeDialog() ng-bind="translate(\'ADF_COMMON_CLOSE\')">Close</button> </div> '),t.put("../src/templates/widget-delete.html",'<div class=modal-header> <h4 class=modal-title><span ng-bind="translate(\'ADF_COMMON_DELETE\')">Delete</span> {{widget.title}}</h4> </div> <div class=modal-body> <form role=form> <div class=form-group> <label for=widgetTitle ng-bind="translate(\'ADF_WIDGET_DELETE_CONFIRM_MESSAGE\')">Are you sure you want to delete this widget ?</label> </div> </form> </div> <div class=modal-footer> <button type=button class="btn btn-default" ng-click=closeDialog() ng-bind="translate(\'ADF_COMMON_CLOSE\')">Close</button> <button type=button class="btn btn-primary" ng-click=deleteDialog() ng-bind="translate(\'ADF_COMMON_DELETE\')">Delete</button> </div> '),t.put("../src/templates/widget-edit.html",'<form name=widgetEditForm novalidate role=form ng-submit=saveDialog()> <div class=modal-header> <button type=button class=close ng-click=closeDialog() aria-hidden=true>&times;</button> <h4 class=modal-title>{{widget.title}}</h4> </div> <div class=modal-body> <div class="alert alert-danger" role=alert ng-show=validationError> <strong>Apply error:</strong> {{validationError}} </div> <div class=form-group> <label for=widgetTitle ng-bind="translate(\'ADF_COMMON_TITLE\')">Title</label> <input type=text class=form-control id=widgetTitle ng-model=definition.title placeholder="Enter title" required> </div> <div ng-if=widget.edit> <adf-widget-content adf-model=adfModel model=definition content=widget.edit> </adf-widget-content></div> </div> <div class=modal-footer> <button type=button class="btn btn-default" ng-click=closeDialog() ng-bind="translate(\'ADF_COMMON_CANCEL\')">Cancel</button> <input type=submit class="btn btn-primary" ng-disabled=widgetEditForm.$invalid ng-value="translate(\'ADF_COMMON_APPLY\')"> </div> </form> '),t.put("../src/templates/widget-fullscreen.html",'<div class=modal-header> <div class="pull-right widget-icons"> <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_REFRESH\') }}" ng-if=widget.reload ng-click=reload()> <i class="glyphicon glyphicon-refresh"></i> </a> <a href title=close ng-click=closeDialog()> <i class="glyphicon glyphicon-remove"></i> </a> </div> <h4 class=modal-title>{{definition.title}}</h4> </div> <div class=modal-body> <adf-widget-content adf-model=adfModel model=definition content=widget> </adf-widget-content></div> <div class=modal-footer> <button type=button class="btn btn-primary" ng-click=closeDialog() ng-bind="translate(\'ADF_COMMON_CLOSE\')">Close</button> </div> '),t.put("../src/templates/widget-title.html",'<h3 class=panel-title> {{definition.title}} <span class=pull-right> <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_REFRESH\') }}" ng-if=widget.reload ng-click=reload()> <i class="glyphicon glyphicon-refresh"></i> </a>  <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_MOVE\') }}" class=adf-move ng-if=editMode> <i class="glyphicon glyphicon-move"></i> </a>  <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_COLLAPSE\') }}" ng-show="options.collapsible && !widgetState.isCollapsed" ng-click="widgetState.isCollapsed = !widgetState.isCollapsed"> <i class="glyphicon glyphicon-minus"></i> </a>  <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_EXPAND\') }}" ng-show="options.collapsible && widgetState.isCollapsed" ng-click="widgetState.isCollapsed = !widgetState.isCollapsed"> <i class="glyphicon glyphicon-plus"></i> </a>  <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_EDIT\') }}" ng-click=edit()> <i class="glyphicon glyphicon-cog"></i> </a> <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_FULLSCREEN\') }}" ng-click=openFullScreen() ng-show=options.maximizable> <i class="glyphicon glyphicon-fullscreen"></i> </a>  <a href title="{{ translate(\'ADF_WIDGET_TOOLTIP_REMOVE\') }}" ng-click=remove() ng-if=editMode> <i class="glyphicon glyphicon-remove"></i> </a> </span> </h3> '),t.put("../src/templates/widget.html",'<div adf-id={{definition.wid}} adf-widget-type={{definition.type}} ng-class="widgetClasses(widget, definition)" class=widget> <div class="panel-heading clearfix" ng-if="!widget.frameless || editMode"> <div ng-include src=definition.titleTemplateUrl></div> </div> <div ng-class="{\'panel-body\':!widget.frameless || editMode}" uib-collapse=widgetState.isCollapsed> <adf-widget-content adf-model=adfModel model=definition content=widget> </adf-widget-content></div> </div> ')}]),angular.module("adf").factory("widgetService",["$http","$q","$sce","$templateCache","dashboard",function(t,n,e,a,i){function o(t){var n=t;return t.indexOf("{widgetsPath}")>=0&&(n=t.replace("{widgetsPath}",i.widgetsPath).replace("//","/"),0===n.indexOf("/")&&(n=n.substring(1))),n}var r={};return r.getTemplate=function(i){var r=n.defer();if(i.template)r.resolve(i.template);else if(i.templateUrl){var c=a.get(i.templateUrl);if(c)r.resolve(c);else{var d=e.getTrustedResourceUrl(o(i.templateUrl));t.get(d).then(function(t){return t.data}).then(function(t){a.put(i.templateUrl,t),r.resolve(t)}).catch(function(){r.reject("could not load template")})}}return r.promise},r}]),angular.module("adf").factory("adfUtilsService",function(){function t(t){switch(angular.isString(t)?t.toLowerCase():null){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(t)}}function n(t,n){var e=[],a=0;return angular.forEach(t,function(t,i){var o=a++%n;e[o]||(e[o]={}),e[o][i]=t}),e}var e={stringToBoolean:t,split:n};return e}),angular.module("adf").factory("adfStructurePreviewService",function(){function t(n){if(n.rows&&n.rows.length>0){var e=100/n.rows.length;angular.forEach(n.rows,function(n){n.style={height:e+"%"},n.columns&&angular.forEach(n.columns,function(n){t(n)})})}}var n={adjustRowHeight:t};return n}),angular.module("adf").factory("adfDashboardService",["$log","dashboard","$rootScope",function(t,n,e){function a(t,n){if(t.widgets&&t.widgets.length>0)for(var e=t.widgets.shift();e;)n.widgets.push(e),e=t.widgets.shift()}function i(t,n,e){return e=e||0,angular.isDefined(t.rows)&&angular.forEach(t.rows,function(t){angular.forEach(t.columns,function(t){t.widgets||(t.widgets=[]),angular.isDefined(n[e])&&angular.isUndefined(t.rows)&&(a(n[e],t),e++),e=i(t,n,e)})}),e}function o(t,n){return n=n||[],angular.isDefined(t.rows)&&angular.forEach(t.rows,function(t){angular.forEach(t.columns,function(t){t.hasOwnProperty("rows")||n.push(t),o(t,n)})}),n}function r(t,n){var e=o(t),a=0;for(t.rows=angular.copy(n.rows);a<e.length;)a=i(t,e,a)}function c(t){var e={},a=n.widgets[t].config;return a&&(e=angular.copy(a)),e}function d(n){var e=null;if(!angular.isArray(n.rows))return t.error("model does not have any rows"),null;for(var a=0;a<n.rows.length;a++){var i=n.rows[a];if(angular.isArray(i.columns))for(var o=0;o<i.columns.length;o++){var r=i.columns[o];if(!r.rows){e=r;break}}if(e)break}return e}function l(n,a,i){if(n){var o=d(n);o?(o.widgets||(o.widgets=[]),o.widgets.unshift(a),e.$broadcast("adfWidgetAdded",i,n,a)):t.error("could not find first widget column")}else t.error("model is undefined")}function _(t){var e=n.widgets[t];return e&&e.edit&&e.edit.immediate}function u(t){var n={};return angular.forEach(t,function(t,e){var a=t.category;a||(a="Miscellaneous"),angular.isUndefined(n[a])&&(n[a]={widgets:{}}),n[a].widgets[e]=t}),n}var s={changeStructure:r,createConfiguration:c,addNewWidgetToModel:l,isEditModeImmediate:_,createCategories:u,_tests:{_readColumns:o}};return s}]),angular.module("adf").directive("adfWidget",["$injector","$q","$log","$uibModal","$rootScope","dashboard","adfTemplatePath",function(t,n,e,a,i,o,r){function c(t){var n=t.definition;if(t.translate=o.translate,n){var a=o.widgets[n.type];if(a){n.title||(n.title=a.title),n.titleTemplateUrl||(n.titleTemplateUrl=r+"widget-title.html",a.titleTemplateUrl&&(n.titleTemplateUrl=a.titleTemplateUrl)),n.editTemplateUrl||(n.editTemplateUrl=r+"widget-edit.html",a.editTemplateUrl&&(n.editTemplateUrl=a.editTemplateUrl)),n.titleTemplateUrl||(n.frameless=a.frameless),n.styleClass||(n.styleClass=a.styleClass),n.wid||(n.wid=o.id()),t.widget=angular.copy(a);var i=n.config;i?angular.isString(i)&&(i=angular.fromJson(i)):i={},t.config=i,t.widgetState||(t.widgetState={},t.widgetState.isCollapsed=a.collapsed===!0?a.collapsed:!1)}else e.warn("could not find widget "+n.type)}else e.debug("definition not specified, widget was probably removed")}function d(c,d){var l=c.definition;if(l){var _=function(){var t=c.col;if(t){var n=t.widgets.indexOf(l);n>=0&&t.widgets.splice(n,1)}d.remove(),i.$broadcast("adfWidgetRemovedFromColumn",l)};c.remove=function(){if(c.options.enableConfirmDelete){var t=c.$new();t.translate=o.translate;var n=r+"widget-delete.html";l.deleteTemplateUrl&&(n=l.deleteTemplateUrl);var e={scope:t,templateUrl:n,windowClass:"adf-remove-widget-modal",backdrop:"static"},i=a.open(e);t.closeDialog=function(){i.close(),t.$destroy()},t.deleteDialog=function(){_(),t.closeDialog()}}else _()},c.reload=function(){c.$broadcast("widgetReload")},c.edit=function(){function e(t){var e;if("boolean"==typeof t){var a=n.defer();t?a.resolve():a.reject(),e=a.promise}else e=n.when(t);return e}var d=c.$new();d.translate=o.translate,d.definition=angular.copy(l);var _=r+"widget-edit.html";l.editTemplateUrl&&(_=l.editTemplateUrl);var u={scope:d,templateUrl:_,windowClass:"adf-edit-widget-modal",backdrop:"static",size:"sm"},s=a.open(u);d.closeDialog=function(){s.close(),d.$destroy()},d.saveDialog=function(){d.validationError=null;var n,a=c.widget;n=a.edit?a.edit.apply:function(){return!0};var o={widget:a,definition:d.definition,config:d.definition.config},r=t.invoke(n,n,o);e(r).then(function(){l.title=d.definition.title,angular.extend(l.config,d.definition.config),a.edit&&a.edit.reload&&(c.$broadcast("widgetConfigChanged"),i.$broadcast("adfDashboardChanged",null,c.adfModel)),d.closeDialog()},function(t){d.validationError=t?t:"Validation durring apply failed"})}}}else e.debug("widget not found")}function l(t){t.$on("adfDashboardCollapseExpand",function(n,e){t.widgetState.isCollapsed=e.collapseExpandStatus}),t.$on("adfWidgetEnterEditMode",function(n,e){o.idEquals(t.definition.wid,e.wid)&&t.edit()}),t.widgetClasses=function(n,e){var a=e.styleClass||"";return n&&n.frameless&&!t.editMode||(a+=" panel panel-default"),a},t.openFullScreen=function(){var n=t.definition,e=t.$new(),i={scope:e,templateUrl:r+"widget-fullscreen.html",size:n.modalSize||"md",backdrop:"static",windowClass:n.fullScreen?"dashboard-modal widget-fullscreen":"dashboard-modal"},o=a.open(i);e.closeDialog=function(){o.close(),e.$destroy()}}}return l.$inject=["$scope"],{replace:!0,restrict:"EA",transclude:!1,templateUrl:o.customWidgetTemplatePath?o.customWidgetTemplatePath:r+"widget.html",scope:{adfModel:"=",definition:"=",col:"=column",editMode:"=",options:"=",widgetState:"="},controller:l,compile:function(){return{pre:c,post:d}}}}]),angular.module("adf").directive("adfWidgetContent",["$log","$q","widgetService","$compile","$controller","$injector","dashboard",function(t,n,e,a,i,o,r){function c(n,e){t.warn(e),n.html(r.messageTemplate.replace(/{}/g,e))}function d(t,n,e){var a=t.model,i=t.content,o=e;if(a)if(i)o=l(t,n,e,a,i);else{var r="Không tìm thấy widget";c(n,r)}else c(n,"model is undefined");return o}function l(t,d,l,_,u){d.html(r.loadingTemplate);var s=t.$new();_.config||(_.config={}),s.config=_.config;var p={$scope:s,widget:_,config:_.config},h={};return h.$tpl=e.getTemplate(u),u.resolve&&angular.forEach(u.resolve,function(t,n){h[n]=angular.isString(t)?o.get(t):o.invoke(t,t,p)}),n.all(h).then(function(t){angular.extend(t,p),u.resolveAs&&(s[u.resolveAs]=t);var n=t.$tpl;if(d.html(n),u.controller){var e=i(u.controller,t);u.controllerAs&&(s[u.controllerAs]=e),d.children().data("$ngControllerController",e)}a(d.contents())(s)},function(t){var n="Could not resolve all promises";t&&(n+=": "+t),c(d,n)}),l&&l.$destroy(),s}function _(t,n){var e=d(t,n,null);t.$on("widgetConfigChanged",function(){e=d(t,n,e)}),t.$on("widgetReload",function(){e=d(t,n,e)})}return{replace:!0,restrict:"EA",transclude:!1,scope:{adfModel:"=",model:"=",content:"="},link:_}}]),angular.module("adf").directive("adfStructurePreview",["adfTemplatePath","adfStructurePreviewService",function(t,n){function e(t){var e=angular.copy(t.structure);n.adjustRowHeight(e),t.preview=e}return{restrict:"E",replace:!0,scope:{name:"=",structure:"=",selected:"="},templateUrl:t+"structure-preview.html",link:e}}]),angular.module("adf").directive("adfDashboard",["$rootScope","$log","$timeout","$uibModal","dashboard","adfTemplatePath","adfDashboardService","adfUtilsService",function(t,n,e,a,i,o,r,c){function d(t,n){e(function(){t.$broadcast("adfWidgetEnterEditMode",n)},200)}function l(e){function l(){var t=e.$new();return t.translate=i.translate,t}e.now=new Date;var _={},u={},s=null,p={},h=e.name;e.$watch("adfModel",function(t,a){(null!==a||null===t&&null===a)&&(_=e.adfModel,s=e.adfWidgetFilter,_&&_.rows||(p=e.structure,u=i.structures[p],u?(_?_.rows=angular.copy(u).rows:_=angular.copy(u),_.structure=p):n.error("could not find structure "+p)),_?(_.title||(_.title="Dashboard"),_.titleTemplateUrl||(_.titleTemplateUrl=o+"dashboard-title.html"),e.model=_):n.error("could not find or create model"))},!0),e.editMode=!1,e.editClass="",e.translate=i.translate,e.toggleEditMode=function(){e.editMode=!e.editMode,e.editMode&&(e.continuousEditMode||(e.modelCopy=angular.copy(e.adfModel,{}),t.$broadcast("adfIsEditMode"))),e.editMode||t.$broadcast("adfDashboardChanged",h,_)},e.$on("adfToggleEditMode",function(){e.toggleEditMode()}),e.collapseAll=function(n){t.$broadcast("adfDashboardCollapseExpand",{collapseExpandStatus:n})},e.cancelEditMode=function(){e.editMode=!1,e.continuousEditMode||(e.modelCopy=angular.copy(e.modelCopy,e.adfModel)),t.$broadcast("adfDashboardEditsCancelled")},e.editDashboardDialog=function(){var t=l();t.copy={title:_.title},t.structures=i.structures,t.split=c.split;var e=o+"dashboard-edit.html";_.editTemplateUrl&&(e=_.editTemplateUrl);var d=a.open({scope:t,templateUrl:e,backdrop:"static",windowClass:"adf-edit-dashboard-modal",size:"md"});t.changeStructure=function(t,e){n.info("change structure to "+t),r.changeStructure(_,e),_.structure!==t&&(_.structure=t)},t.closeDialog=function(){_.title=t.copy.title,d.close(),t.$destroy()}},e.addWidgetDialog=function(){var t,n=l(),c=e.model;angular.isFunction(s)?(t={},angular.forEach(i.widgets,function(n,e){s(n,e,c)&&(t[e]=n)})):t=i.widgets,n.widgets=t,n.translate=e.translate,e.options.categories&&(e.createCategories=r.createCategories);var _=o+"widget-add.html";c.addTemplateUrl&&(_=c.addTemplateUrl);var u={scope:n,templateUrl:_,windowClass:"adf-add-widget-modal",backdrop:"static",size:"sm"},p=a.open(u);n.addWidget=function(t){var a={type:t,config:r.createConfiguration(t)};r.addNewWidgetToModel(c,a,h),p.close(),n.$destroy(),r.isEditModeImmediate(t)&&d(e,a)},n.closeDialog=function(){p.close(),n.$destroy()}},e.addNewWidgetToModel=r.addNewWidgetToModel}function _(t,n,e){var a={name:e.name,editable:!0,enableConfirmDelete:c.stringToBoolean(e.enableConfirmDelete),maximizable:c.stringToBoolean(e.maximizable),collapsible:c.stringToBoolean(e.collapsible),categories:c.stringToBoolean(e.categories)};angular.isDefined(e.editable)&&(a.editable=c.stringToBoolean(e.editable)),t.options=a}return l.$inject=["$scope"],{replace:!0,restrict:"EA",transclude:!1,scope:{structure:"@",name:"@",collapsible:"@",editable:"@",editMode:"@",continuousEditMode:"=",maximizable:"@",adfModel:"=",adfWidgetFilter:"=",categories:"@"},controller:l,link:_,templateUrl:o+"dashboard.html"}}]),angular.module("adf").directive("adfDashboardRow",["$compile","adfTemplatePath","columnTemplate",function(t,n,e){function a(n,a){angular.isDefined(n.row.columns)&&angular.isArray(n.row.columns)&&t(e)(n,function(t){a.append(t)})}return{restrict:"E",replace:!0,scope:{row:"=",adfModel:"=",editMode:"=",continuousEditMode:"=",options:"="},templateUrl:n+"dashboard-row.html",link:a}}]),angular.module("adf").directive("adfDashboardColumn",["$log","$compile","$rootScope","adfTemplatePath","rowTemplate","dashboard",function(t,n,e,a,i,o){function r(t,n,a){var i=n.widgets;t.$apply(function(){i.splice(a.newIndex,0,i.splice(a.oldIndex,1)[0]),e.$broadcast("adfWidgetMovedInColumn")})}function c(t,n){for(var e=null,a=0;a<t.widgets.length;a++){var i=t.widgets[a];if(o.idEquals(i.wid,n)){e=i;break}}return e}function d(t,n){for(var e=null,a=0;a<t.rows.length;a++){for(var i=t.rows[a],r=0;r<i.columns.length;r++){var c=i.columns[r];if(o.idEquals(c.cid,n)){e=c;break}c.rows&&(e=d(c,n))}if(e)break}return e}function l(t){var n=t.getAttribute("adf-id");return n?n:"-1"}function _(n,a,i,o){var r=l(o.from),_=d(a,r);if(_){var u=l(o.item),s=c(_,u);s?n.$apply(function(){i.widgets||(i.widgets=[]),i.widgets.splice(o.newIndex,0,s),e.$broadcast("adfWidgetAddedToColumn")}):t.warn("could not find widget with id "+u)}else t.warn("could not find column with id "+r)}function u(t,n,a){t.$apply(function(){n.widgets.splice(a.oldIndex,1),e.$broadcast("adfWidgetRemovedFromColumn")})}function s(t,n,e,a){var i=n[0],o=Sortable.create(i,{group:"widgets",handle:".adf-move",ghostClass:"placeholder",animation:150,onAdd:function(n){_(t,e,a,n)},onRemove:function(n){u(t,a,n)},onUpdate:function(n){r(t,a,n)}});n.on("$destroy",function(){o.el&&o.destroy()})}function p(t,e){var a=t.column;a.cid||(a.cid=o.id()),angular.isDefined(a.rows)&&angular.isArray(a.rows)?n(i)(t,function(t){e.append(t)}):s(t,e,t.adfModel,a)}return{restrict:"E",replace:!0,scope:{column:"=",editMode:"=",continuousEditMode:"=",adfModel:"=",options:"="},templateUrl:a+"dashboard-column.html",link:p}}]),angular.module("adf").filter("adfOrderByObjectKey",["$filter",function(t){return function(n,e){var a=[];return angular.forEach(n,function(t,n){t[e]=n,a.push(t)}),t("orderBy")(a,e)}}]),angular.module("adf.provider",["adf.locale"]).provider("dashboard",["adfLocale",function(t){function n(){return s}function e(){return u}function a(t){var n=s[u][t];return n?n:t}var i={},o="",r={},c='<div class="alert alert-danger">{}</div>',d='      <div class="progress progress-striped active">\n        <div class="progress-bar" role="progressbar" style="width: 100%">\n          <span class="sr-only">loading ...</span>\n        </div>\n      </div>',l=null,_=function(){return!0},u=t.defaultLocale,s=t.frameworkLocales;this.widget=function(t,n){var e=angular.extend({reload:!1,frameless:!1},n);if(e.edit){var a={reload:!0,immediate:!1,apply:_};angular.extend(a,e.edit),e.edit=a}return i[t]=e,this},this.widgetsPath=function(t){return o=t,this},this.structure=function(t,n){return r[t]=n,this},this.messageTemplate=function(t){return c=t,this},this.loadingTemplate=function(t){return d=t,this},this.customWidgetTemplatePath=function(t){return l=t,this},this.setLocale=function(t){if(!s[t])throw new Error("Cannot set locale: "+t+". Locale is not defined.");return u=t,this},this.addLocale=function(t,n){if(!angular.isString(t))throw new Error("locale must be an string");if(!angular.isObject(n))throw new Error("translations must be an object");return s[t]=n,this},this.$get=function(){var t=0;return{widgets:i,widgetsPath:o,structures:r,messageTemplate:c,loadingTemplate:d,setLocale:this.setLocale,locales:n,activeLocale:e,translate:a,customWidgetTemplatePath:l,id:function(){return(new Date).getTime()+"-"+ ++t},idEquals:function(t,n){return t&&n&&t.toString()===n.toString()}}}}]),angular.module("adf.locale",[]),angular.module("adf.locale").constant("adfLocale",{defaultLocale:"vi-VI",frameworkLocales:{"en-GB":{ADF_COMMON_CLOSE:"Close",ADF_COMMON_DELETE:"Delete",ADF_COMMON_TITLE:"Title",ADF_COMMON_CANCEL:"Cancel",ADF_COMMON_APPLY:"Apply",ADF_COMMON_EDIT_DASHBOARD:"Edit dashboard",ADF_EDIT_DASHBOARD_STRUCTURE_LABEL:"Structure",ADF_DASHBOARD_TITLE_TOOLTIP_ADD:"Add new widget",ADF_DASHBOARD_TITLE_TOOLTIP_SAVE:"Save changes",ADF_DASHBOARD_TITLE_TOOLTIP_EDIT_MODE:"Enable edit mode",ADF_DASHBOARD_TITLE_TOOLTIP_UNDO:"Undo changes",ADF_WIDGET_ADD_HEADER:"Add new widget",ADF_WIDGET_DELETE_CONFIRM_MESSAGE:"Are you sure you want to delete this widget ?",ADF_WIDGET_TOOLTIP_REFRESH:"Reload widget Content",ADF_WIDGET_TOOLTIP_MOVE:"Change widget location",ADF_WIDGET_TOOLTIP_COLLAPSE:"Collapse widget",ADF_WIDGET_TOOLTIP_EXPAND:"Expand widget",ADF_WIDGET_TOOLTIP_EDIT:"Edit widget configuration",ADF_WIDGET_TOOLTIP_FULLSCREEN:"Fullscreen widget",ADF_WIDGET_TOOLTIP_REMOVE:"Remove widget"},"vi-VI":{ADF_COMMON_CLOSE:"Đóng",ADF_COMMON_DELETE:"Xóa",ADF_COMMON_TITLE:"Tiêu đề",ADF_COMMON_CANCEL:"Hủy",ADF_COMMON_APPLY:"Áp dụng",ADF_COMMON_EDIT_DASHBOARD:"Sửa bảng điều khiển",ADF_EDIT_DASHBOARD_STRUCTURE_LABEL:"Cấu trúc",ADF_DASHBOARD_TITLE_TOOLTIP_ADD:"Thêm widget mới",ADF_DASHBOARD_TITLE_TOOLTIP_SAVE:"Lưu thay đổi",ADF_DASHBOARD_TITLE_TOOLTIP_EDIT_MODE:"Chế độ chỉnh sửa",ADF_DASHBOARD_TITLE_TOOLTIP_UNDO:"Hủy bỏ thay đổi",ADF_WIDGET_ADD_HEADER:"Thêm widget mới",ADF_WIDGET_DELETE_CONFIRM_MESSAGE:"Bạn có chắc chắn muốn xóa widget này ?",ADF_WIDGET_TOOLTIP_REFRESH:"Làm mới nội dung",ADF_WIDGET_TOOLTIP_MOVE:"Change widget location",ADF_WIDGET_TOOLTIP_COLLAPSE:"Collapse widget",ADF_WIDGET_TOOLTIP_EXPAND:"Expand widget",ADF_WIDGET_TOOLTIP_EDIT:"Chỉnh sửa nội dung",ADF_WIDGET_TOOLTIP_FULLSCREEN:"Fullscreen widget",ADF_WIDGET_TOOLTIP_REMOVE:"Xóa widget"}}})}(window),angular.module("adf.structures.base",["adf"]).config(["dashboardProvider",function(t){t.structure("12",{rows:[{columns:[{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"},{styleClass:"col-md-1"}]},{columns:[{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"}]},{columns:[{styleClass:"col-md-3"},{styleClass:"col-md-3"},{styleClass:"col-md-3"},{styleClass:"col-md-3"}]},{columns:[{styleClass:"col-md-4"},{styleClass:"col-md-4"},{styleClass:"col-md-4"}]},{columns:[{styleClass:"col-md-6"},{styleClass:"col-md-6"}]},{columns:[{styleClass:"col-md-12"}]},{columns:[{styleClass:"col-md-6"},{styleClass:"col-md-6"}]},{columns:[{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"},{styleClass:"col-md-2"}]},{columns:[{styleClass:"col-md-3"},{styleClass:"col-md-3"},{styleClass:"col-md-3"},{styleClass:"col-md-3"}]},{columns:[{styleClass:"col-md-4"},{styleClass:"col-md-4"},{styleClass:"col-md-4"}]}]}).structure("4/(4-8)",{rows:[{columns:[{styleClass:"col-md-3"},{styleClass:"col-md-3"},{styleClass:"col-md-3"},{styleClass:"col-md-3"}]},{columns:[{styleClass:"col-md-6"},{styleClass:"col-md-6"}]},{columns:[{styleClass:"col-md-4"},{styleClass:"col-md-8"}]}]}).structure("4-8",{rows:[{columns:[{styleClass:"col-md-4",widgets:[]},{styleClass:"col-md-8",widgets:[]}]}]}).structure("2-3-7",{rows:[{columns:[{styleClass:"col-md-2",widgets:[]},{styleClass:"col-md-3",widgets:[]},{styleClass:"col-md-7",widgets:[]}]}]}).structure("2-4-6",{rows:[{columns:[{styleClass:"col-md-2",widgets:[]},{styleClass:"col-md-4",widgets:[]},{styleClass:"col-md-6",widgets:[]}]}]}).structure("2-2-8",{rows:[{columns:[{styleClass:"col-md-2",widgets:[]},{styleClass:"col-md-2",widgets:[]},{styleClass:"col-md-8",widgets:[]}]}]}).structure("8-2-2",{rows:[{columns:[{styleClass:"col-md-8",widgets:[]},{styleClass:"col-md-2",widgets:[]},{styleClass:"col-md-2",widgets:[]}]}]}).structure("12/4-4-4",{rows:[{columns:[{styleClass:"col-md-12"}]},{columns:[{styleClass:"col-md-4"},{styleClass:"col-md-4"},{styleClass:"col-md-4"}]}]}).structure("12/6-6",{rows:[{columns:[{styleClass:"col-md-12"}]},{columns:[{styleClass:"col-md-6"},{styleClass:"col-md-6"}]}]}).structure("12/6-6/12",{rows:[{columns:[{styleClass:"col-md-12"}]},{columns:[{styleClass:"col-md-6"},{styleClass:"col-md-6"}]},{columns:[{styleClass:"col-md-12"}]}]}).structure("3-9 (12/6-6)",{rows:[{columns:[{styleClass:"col-md-3"},{styleClass:"col-md-9",rows:[{columns:[{styleClass:"col-md-12"}]},{columns:[{styleClass:"col-md-6"},{styleClass:"col-md-6"}]}]}]}]})}]);var d3locale=d3.locale({decimal:",",thousands:".",grouping:[3],currency:[""," đ."],dateTime:"%A, %e %B %Y г. %X",date:"%d.%m.%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["CN","T2","T3","T4","T5","T6","T7"],shortDays:["CN","T2","T3","T4","T5","T6","T7"],months:["1","2","3","4","5","6","7","8","9","10","11","12"],shortMonths:["1","2","3","4","5","6","7","8","9","10","11","12"]});angular.module("adf.widget.counter",["adf.provider"]).config(["dashboardProvider",function(t){t.widget("counter",{title:"Đếm số lượng",description:"Đếm số đối tượng",templateUrl:"templates/widgets/counter/view.html",reload:!0,edit:{templateUrl:"templates/widgets/counter/edit.html",controller:"counterEditCtrl"},controller:["$scope","$http",function(t,n){if(t.count=0,t.collection=t.config.collection,t.collection&&"customer"==t.collection.trim()&&(t.collection="dmkh"),t.collection){var e=server_url_report+"/api/"+id_app+"/"+t.config.collection+"?fields=_id&count=1";n.get(e).then(function(n){t.count=n.data.rows_number},function(t){console.log("can not get info",e,t.data)
})}}]})}]).controller("counterEditCtrl",[function(){}]),angular.module("adf.widget.balance",["adf.provider"]).config(["dashboardProvider",function(t){t.widget("balance",{title:"Số dư",description:"Hiện số dư của một đối tượng",templateUrl:"templates/widgets/balance/view.html",reload:!0,edit:{templateUrl:"templates/widgets/balance/edit.html",controller:"balanceEditCtrl"},controller:["$scope","$http",function(t,n){if(t.du00=0,t.config.tk){var e=server_url_report+"/api/"+id_app+"/cktk?tk="+t.config.tk;t.config.ma_kh&&(e=e+"&ma_kh="+t.config.ma_kh),t.config.ma_kho&&(e=e+"&ma_kho="+t.config.ma_kho),t.config.ma_bp&&(e=e+"&ma_bp="+t.config.ma_bp),t.config.ma_nv&&(e=e+"&ma_nv="+t.config.ma_nv),t.config.ma_hd&&(e=e+"&ma_hd="+t.config.ma_hd),t.config.ma_phi&&(e=e+"&ma_phi="+t.config.ma_phi),n.get(e).then(function(n){t.du00=STP.sum(n.data,"du_no00")-STP.sum(n.data,"du_co00"),t.config.du_co_yn&&(t.du00=0-t.du00)},function(t){console.log("can not get info",e,t.data)})}}]})}]).controller("balanceEditCtrl",[function(){}]),angular.module("adf.widget.linklist",["adf.provider"]).config(["dashboardProvider",function(t){t.widget("linklist",{title:"Liên kết",description:"Tạo danh sách truy cập nhanh",templateUrl:"templates/widgets/linklist/view.html",edit:{templateUrl:"templates/widgets/linklist/edit.html",controller:"linklistEditCtrl"}})}]).controller("linklistEditCtrl",["$scope",function(t){function n(){return t.config.links||(t.config.links=[]),t.config.links}t.addLink=function(){n().push({})},t.removeLink=function(t){n().splice(t,1)}}]),angular.module("adf.widget.pttct",["adf.provider"]).config(["dashboardProvider",function(t){t.widget("pttct",{title:"BC phân tích",description:"Hiện báo cáo phân tích theo chỉ tiêu",templateUrl:"templates/widgets/pttct/view.html",reload:!0,edit:{templateUrl:"templates/widgets/pttct/edit.html",controller:"pttctEditCtrl"},controller:["$scope","$localStorage","user","$rootScope","$location","$timeout","$shttp","api","$window","$interval","appInfo","$uibModal","$filter",function(t,n,e,a,i,o,r,c,d,l){t.id_widget=(new Date).getTime().toString(),t.config.tu_ngay?t.config.tu_ngay=new Date(t.config.tu_ngay):(t.config.tu_ngay=new Date,t.config.tu_ngay.setMonth(0),t.config.tu_ngay.setDate(1)),t.config.den_ngay=t.config.den_ngay?new Date(t.config.den_ngay):new Date;var u;t.opt_chart_close=!0;var s,p=function(n){s=c3.generate({bindto:"#chart"+t.id_widget,data:{x:"x",columns:n,type:"bar",order:null,types:u,onclick:function(t){console.log("dashboard chart click",t)}},axis:{y:{label:{text:"1000 đ",position:"outer-middle"},tick:{format:d3locale.numberFormat(",")}},x:{type:"category"}},grid:{y:{lines:[{value:0}]}}})},h=function(e){var a=server_url_report+"/api/"+id_app+"/pttct?t=1";if(t.config.id_rptform){n.set(id_app+"_dash_chart",t.config.id_rptform),a=a+"&id_rptform="+t.config.id_rptform,t.thangs=[];var i,o,c,d;for(i=12*t.config.tu_ngay.getFullYear()+t.config.tu_ngay.getMonth()+1;i<=12*t.config.den_ngay.getFullYear()+t.config.den_ngay.getMonth()+1;i++)d=i-12*t.config.tu_ngay.getFullYear(),o=t.config.tu_ngay.getFullYear(),d>12&&(d-=12,o+=1),c=d.toString()+"/"+o.toString(),t.thangs.push({name:c,thang:d,nam:o});var l=[],s={};async.mapSeries(t.thangs,function(n,e){var i=new Date(Date.UTC(n.nam,n.thang-1,1,0,0,0,0));n.nam==t.config.tu_ngay.getFullYear()&&n.thang==t.config.tu_ngay.getMonth()+1&&(i=t.config.tu_ngay);var o=new Date(Date.UTC(n.nam,n.thang,0,0,0,0,0));n.nam==t.config.den_ngay.getFullYear()&&n.thang==t.config.den_ngay.getMonth()+1&&(o=t.config.den_ngay);var c=a+"&tu_ngay="+moment(i).format("YYYY-MM-DD");c=c+"&den_ngay="+moment(o).format("YYYY-MM-DD"),r.get(c).then(function(t){t.data.forEach(function(t){t.thang_nam=n.name,s[t.ma_so]||(s[t.ma_so]={name:t.chi_tieu,chart:t.chart,data:[]}),s[t.ma_so].data.push(t)}),e(null,t.data)},function(t){e(t.data||"Không kết nối được với máy chủ")})},function(n){if(n)return e(n);u={};var a,i,o,r;for(r_name in s)r=s[r_name],u[r.name]=r.chart?r.chart:"bar",o=[r.name],l.push(o),t.thangs.forEach(function(t){i=_.filter(r.data,function(n){return n.thang_nam==t.name}),a=0,i.forEach(function(t){a+=Math.round(t.so_kn/1e3,0)}),o.push(a)});var c=_.pluck(t.thangs,"name");c=["x"].concat(c),l=[c].concat(l),e(null,l)})}},f=l(function(){t.error="",h(function(n,e){return n?t.error=n:void(s?s.load({columns:e}):p(e))})},9e5);t.$on("$destroy",function(){console.log("interval cancel"),l.cancel(f)}),t.fetchData=function(){t.error="",h(function(n,e){n?t.error=n:p(e)})},t.config.id_rptform?t.fetchData():o(function(){t.fetchData()},1e3)}]})}]).controller("pttctEditCtrl",["$scope",function(){}]),angular.module("adf.widget.sosanhkhvatt",["adf.provider"]).config(["dashboardProvider",function(t){t.widget("sosanhkhvatt",{title:"So sánh kế hoạch và thực tế",description:"Hiện báo cáo so sánh kế hoạch và thực tế",templateUrl:"templates/widgets/sosanhkhvatt/view.html",reload:!0,edit:{templateUrl:"templates/widgets/sosanhkhvatt/edit.html",controller:"sosanhkhvattEditCtrl"},controller:["$scope","$localStorage","user","$rootScope","$location","$timeout","$shttp","api","$window","$interval","appInfo","$uibModal","$filter",function(t,n,e,a,i,o,r,c,d,l){t.id_widget=(new Date).getTime().toString(),t.config.nam||(t.config.nam=(new Date).getFullYear()),t.config.tu_thang||(t.config.tu_thang=(new Date).getMonth()+1),t.config.den_thang||(t.config.den_thang=(new Date).getMonth()+1),t.config.type||(t.config.type="bar"),t.config.groupby||(t.config.groupby="ten_kho");var _;t.opt_chart_close=!0;var u,s=function(n){u=c3.generate({bindto:"#chart"+t.id_widget,data:{x:"x",columns:n,type:t.config.type,order:null,types:_,onclick:function(t){console.log("dashboard chart click",t)}},axis:{y:{label:{text:"1000 đ",position:"outer-middle"},tick:{format:d3locale.numberFormat(",")}},x:{type:"category"}},grid:{y:{lines:[{value:0}]}}})},p=function(n){var e=t.config.groupby||"ten_kho",a=server_url_report+"/api/"+id_app+"/sosanhkhvatt?nam="+t.config.nam+"&tu_thang="+t.config.tu_thang+"&den_thang="+t.config.den_thang+"&groupby="+e;t.config.group_id&&(a=a+"&group_id="+t.config.group_id),r.get(a).then(function(t){var a=[],i=["Kế hoạch"],o=["Thực tế"];t.data.forEach(function(t){t.bold||(i.push(Math.round(t.chi_tieu/1e3,0)),o.push(Math.round(t.ps/1e3,0)))}),a=[i,o];var r=[],c=0;t.data.forEach(function(t){r.push(t[e]||c),c+=1}),r=["x"].concat(r),a=[r].concat(a),n(null,a)},function(t){console.log("error fetch data",a),n(t.data||"Không thể kết nối với máy chủ")})},h=l(function(){t.error="",p(function(n,e){return n?t.error=n:void(u?u.load({columns:e}):s(e))})},9e5);t.$on("$destroy",function(){console.log("interval cancel"),l.cancel(h)}),t.fetchData=function(){t.error="",p(function(n,e){n?t.error=n:s(e)})},o(function(){t.fetchData()},1e3)}]})}]).controller("sosanhkhvattEditCtrl",["$scope",function(){}]),angular.module("adf.widget.task",["adf.provider"]).config(["dashboardProvider",function(t){t.widget("task",{title:"Công việc",description:"Công việc",templateUrl:"templates/widgets/task/view.html",reload:!0,edit:{templateUrl:"templates/widgets/task/edit.html",controller:"taskEditCtrl"},controller:["$scope","$http",function(){}]})}]).controller("taskEditCtrl",["$scope","$http",function(t){t.config.progresses||(t.config.progresses=[{code:0,name:"Chưa thực hiện",sel:!0},{code:1,name:"Đang thực hiện",sel:!0},{code:2,name:"Hoàn thành",sel:!1},{code:3,name:"Tạm dừng",sel:!0},{code:4,name:"Đang chờ",sel:!0}])}]),angular.module("adf.widget.taskgroup",["adf.provider"]).config(["dashboardProvider",function(t){t.widget("taskgroup",{title:"Nhóm công việc",description:"Nhóm công việc",templateUrl:"templates/widgets/taskgroup/view.html",reload:!0,edit:{templateUrl:"templates/widgets/taskgroup/edit.html",controller:"taskgroupEditCtrl"},controller:["$scope","$http",function(){}]})}]).controller("taskgroupEditCtrl",["$scope","$http",function(){}]),angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale","$uibModal",function(t,n,e){var a=t.eventSources,i=t.calendarWatchEvent?t.calendarWatchEvent:angular.noop,o=function(n){return function(){if(t.$root.$$phase)return n.apply(this,arguments);var e=arguments,a=this;return t.$root.$apply(function(){return n.apply(a,e)})}},r=1;this.eventFingerprint=function(t){t._id||(t._id=r++);var n=i({event:t})||"",e=moment.isMoment(t.start)?t.start.unix():t.start?moment(t.start).unix():"",a=moment.isMoment(t.end)?t.end.unix():t.end?moment(t.end).unix():"";return[t._id,t.id||"",t.title||"",t.url||"",e,a,t.allDay||"",t.className||"",n].join("")};var c=1,d=1;this.sourceFingerprint=function(t){var n=""+(t.__id||(t.__id=c++)),e=angular.isObject(t)&&t.events;return e&&(n=n+"-"+(e.__id||(e.__id=d++))),n},this.allEvents=function(){return Array.prototype.concat.apply([],(a||[]).reduce(function(t,n){if(angular.isArray(n))t.push(n);else if(angular.isObject(n)&&angular.isArray(n.events)){var e=Object.keys(n).filter(function(t){return"_id"!==t&&"events"!==t});n.events.forEach(function(t){angular.extend(t,e)}),t.push(n.events)}return t},[]))},this.changeWatcher=function(t,n){var e,a=function(){return((angular.isFunction(t)?t():t)||[]).reduce(function(t,e){var a=n(e);return o[a]=e,t.push(a),t},[])},i=function(t,n){var e=(n||[]).reduce(function(t,n){return t[n]=!0,t},Object.create(null));return(t||[]).filter(function(t){return!e[t]})},o={},r=function(t,a){var r,c,d={},l=i(a,t);for(r=0;r<l.length;r++){var _=l[r],u=o[_];delete o[_];var s=n(u);s===_?e.onRemoved(u):(d[s]=_,e.onChanged(u))}var p=i(t,a);for(r=0;r<p.length;r++)c=p[r],d[c]||e.onAdded(o[c])};return e={subscribe:function(t,n){t.$watch(a,function(t,e){var a=!(n&&n(t,e)===!1);a&&r(t,e)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(t,n){var e={};return angular.extend(e,n),angular.extend(e,t),angular.forEach(e,function(t,n){"function"==typeof t&&(e[n]=o(e[n]))}),e},this.getLocaleConfig=function(t){if(!t.lang&&!t.locale||t.useNgLocale){var e=function(t){return(Object.keys(t)||[]).reduce(function(n,e){return n.push(t[e]),n},[])},a=n.DATETIME_FORMATS;return{monthNames:e(a.MONTH),monthNamesShort:e(a.SHORTMONTH),dayNames:e(a.DAY),dayNamesShort:e(a.SHORTDAY)}}return{}},t.chooseMonthYear=function(t){e.open({templateUrl:"templates/sys/choosemotnhandyear.html",controller:["$scope","$controller","$http","$uibModalInstance","$rootScope",function(n,e,a,i){var o=t.fullCalendar("getDate");n.month=o.month()+1,n.year=o.year(),n.months=[1,2,3,4,5,6,7,8,9,10,11,12],n.ok=function(){t.fullCalendar("gotoDate",new Date(n.year,n.month-1,1)),i.close()},n.cancel=function(){i.close()}}],size:"lg",backdrop:"static",resolve:{}})}}]).directive("uiCalendar",["uiCalendarConfig",function(t){return{restrict:"A",scope:{eventSources:"=ngModel",zevents:"=",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(n,e,a,i){function o(){var e=a.uiCalendar?n.$parent.$eval(a.uiCalendar):{},o=i.getFullCalendarConfig(e,t),r=i.getLocaleConfig(o);angular.extend(r,o),u={eventSources:n.eventSources},angular.extend(u,r),u.calendars=null;var c={};for(var d in u)"eventSources"!==d&&(c[d]=u[d]);return JSON.stringify(c)}var r,c=n.eventSources,d=!1,l=i.changeWatcher(c,i.sourceFingerprint),_=i.changeWatcher(i.allEvents,i.eventFingerprint),u=null;n.destroyCalendar=function(){r&&r.fullCalendar&&r.fullCalendar("destroy"),r=a.calendar?t.calendars[a.calendar]=angular.element(e).html(""):angular.element(e).html("")},n.initCalendar=function(){r||(r=$(e).html("")),r.fullCalendar(u),a.calendar&&(t.calendars[a.calendar]=r);var i=document.querySelector(".fc-center"),o=angular.element(i);o.bind("click",function(){n.chooseMonthYear(r)})},n.$on("$destroy",function(){n.destroyCalendar()}),l.onAdded=function(n){r&&r.fullCalendar&&(r.fullCalendar(u),a.calendar&&(t.calendars[a.calendar]=r),r.fullCalendar("addEventSource",n),d=!0)},l.onRemoved=function(t){r&&r.fullCalendar&&(r.fullCalendar("removeEventSource",t),d=!0)},l.onChanged=function(){r&&r.fullCalendar&&(r.fullCalendar("refetchEvents"),d=!0)},_.onAdded=function(t){r&&r.fullCalendar&&r.fullCalendar("renderEvent",t,!!t.stick)},_.onRemoved=function(t){r&&r.fullCalendar&&r.fullCalendar("removeEvents",t._id)},_.onChanged=function(t){if(r&&r.fullCalendar)for(var n=r.fullCalendar("clientEvents",t._id),e=0;e<n.length;e++){var a=n[e];a=angular.extend(a,t),r.fullCalendar("updateEvent",a)}},l.subscribe(n),_.subscribe(n,function(){return d===!0?(d=!1,!1):void 0}),n.$watch(o,function(t,e){t!==e?(n.destroyCalendar(),n.initCalendar()):t&&angular.isUndefined(r)&&n.initCalendar()}),n.$watch("zevents",function(t,e){t!==e&&(n.destroyCalendar(),n.initCalendar())},!0)}}}]);var appInfoService=angular.module("appInfoService",[]);appInfoService.factory("appInfo",["$shttp","$localStorage","user","$rootScope","$location","app","$timeout","$uibModal",function(t,n,e,a,i,o,r,c){var d;return{confDashboard:function(t,e){t.dashboard||(t.dashboard={tasks:!0,notifications:!1,orders:!1,reports:!0,emails:!1,pbl:!1,like:!1}),e||(e=function(){});c.open({templateUrl:"templates/sys/confdashboard.html",controller:["$scope","$uibModalInstance","parentScope",function(a,i){a.ok=function(){e(),i.close()},a.cancel=function(){e(),i.close()},a.appInfo=t,a.$watch("appInfo",function(){n.set("dashboard"+t._id,JSON.stringify(t.dashboard))},!0)}],size:"lg",resolve:{parentScope:function(){return{}}}})},asDesktop:function(){return"function"==typeof require?!0:!1},commands:function(e,i){var o=a.getCacheFactory(e,"SYSTEM");t.get(server_url+"/api/"+e+"/menu?access_token="+n.get("token"),{cache:o}).then(function(n){var e=n.data;a.commands=e.menu,a.cmdmodules=cmdmodules=e.modules,a.commands.forEach(function(n){n.title=getLabel(a.labels,"TEN_CT"+n.name.toUpperCase(),n.title,a.lang,t).text,n.input.forEach(function(e){e.path?e.header=getLabel(a.labels,"TEN_CT"+e.path.toUpperCase(),e.header,a.lang,t).text:e.items&&(e.header=getLabel(a.labels,"TEN_CT"+(n.name+e.name).toUpperCase(),e.header,a.lang,t).text,e.items.forEach(function(i){i.path?i.header=getLabel(a.labels,"TEN_CT"+i.path.toUpperCase(),i.header,a.lang,t).text:i.group&&(i.group=getLabel(a.labels,"TEN_CT"+(n.name+e.name+i.name).toUpperCase(),i.group,a.lang,t).text,i.items.forEach(function(n){n.header=getLabel(a.labels,"TEN_CT"+n.path.toUpperCase(),n.header,a.lang,t).text}))}))})}),i&&i(null,a.commands)},function(t){if(!t.data){var o=n.getObject(e+"_menu_"+a.user.email);if(o)return a.commands=o.menu,a.cmdmodules=cmdmodules=o.modules,void(i&&i(null,a.commands))}i&&i(t.data)})},get:function(t,n){d?n(null,d):o.get(t,t).then(function(t){var e=t.data;d=e,console.log("appinfo",d),n(null,d)},function(e){console.log("get appinfo",e,t),n(error.data)})},label:function(e,i){var o=a.getCacheFactory(null,"SYSTEM",null,!1),r={},c="labelinfoSYS",d=a[c];d||(d=n.getObject(c,"{}"),a[c]=d),_.extend(r,d);var l;async.parallel({check:function(n){0==_.values(d).length||"SYS"===e.toUpperCase()?(l=server_url+"/labels/SYS",t.get(l,{cache:o}).then(function(t){d=t.data,"SYS"===e.toUpperCase()&&(a[c]=d),_.extend(r,d),n()},function(t){t.data&&console.log("Can't get label info",e,t.data,l),n()})):(a[c]=d,n())}},function(){if("SYS"!==e.toUpperCase()){var c="labelinfo"+e.toUpperCase(),d=a[c];d||(d=n.getObject(c,"{}")),_.extend(r,d),l=server_url+"/labels/"+e,t.get(l,{cache:o}).then(function(t){var n=t.data;_.extend(r,n),a[c]=n},function(t){t.data&&console.log("Can't get label info",e,t.data)}),i(r)}else i(r)})},info:function(r,c){return id_app||(id_app=n.get("id_app"),id_app&&(a.id_app=id_app)),id_app||_.contains(paths_not_require_id_app,r)?(e.getInfo(function(e,i){if(e)return c&&c(e),!1;if(endpoint&&n.get("endpoint64")!==endpoint+i.email){var r=server_url+"/api/register-endpoint?ep="+encodeURI(endpoint);t.get(r).then(function(){n.set("endpoint64",endpoint+i.email),console.log("register endpoint successfyll")},function(t){console.log("can not register endpoint",r,t.data)})}if(!a.app_info&&id_app)o.get(id_app,id_app).then(function(t){var e=t.data;if(i.email===e.user_created)i.appAdmin=!0;else{var o=_.find(e.participants,function(t){return t.email==i.email});i.appAdmin=o&&o.admin?!0:!1}a.app_info=e,n.setObject("currentuser",i),n.setObject("appinfo"+id_app,e),c&&c(null,i,e)},function(t){if(!t.data){var e=n.getObject("appinfo"+id_app);if(e)return a.app_info=e,c&&c(null,i,e),!0}c&&c(t.data)});else{if(a.app_info)if(i.email===a.app_info.user_created)i.appAdmin=!0;else{var d=_.find(a.app_info.participants,function(t){return t.email==i.email});i.appAdmin=d&&d.admin?!0:!1}c&&c(null,i,a.app_info)}}),!0):(c&&c("bạn phải chọn một công ty"),i.url("/app"),!1)}}}]),appInfoService.factory("$localStorage",["$window","$cookies","$rootScope","$shttp",function(t,n){return{remove:function(e){t.localStorage?t.localStorage[e]="":n[e]=""},set:function(e,a){t.localStorage?t.localStorage[e]=a:n[e]=a},get:function(e){return t.localStorage?t.localStorage[e]:n[e]},setObject:function(n,e){t.localStorage&&(t.localStorage[n]=JSON.stringify(e))},getObject:function(n,e){e||(e=[]);var a;if(t.localStorage&&(a=t.localStorage[n]),a||(a=e),_.isObject(a)||_.isArray(a))return a;try{return JSON.parse(a)}catch(i){return e}}}}]),appInfoService.factory("$shttp",["$rootScope","$http","$q",function(t,n,e){return{post:function(t,e,a){return n.post(t,e,a)},put:function(t,e,a){return n.put(t,e,a)},"delete":function(t,e){return n.delete(t,e)},get:function(a,i){var o,r=e.defer();return i&&i.cache&&(o=i.cache!==!0?i.cache:t.getCacheFactory(null,i.cacheName?i.cacheName:"SYSTEM")),_online?(i&&i.cache&&(delete i.cache,delete i.cacheName),n.get(a,i).then(function(t){r.resolve(t),o&&o.put(a,t.data,function(t){t&&console.error("cached",a,t)})},function(t){t.data?r.reject(t):o?o.get(a,function(t,n){n?r.resolve({data:n}):r.reject({data:"Không thể kết nối với máy chủ"})}):r.reject({data:"KHông thể kết nối với máy chủ"})})):o?o.get(a,function(t,n){n?r.resolve({data:n}):(console.log("Not found cache for ",a),r.reject({data:"Không thể kết nối với máy chủ"}))}):r.reject({data:"KHông thể kết nối với máy chủ"}),r.promise}}}]),appInfoService.factory("nodeWebkit",["$rootScope","$timeout","$location",function(t,n,e){var a=function(n,a,i){if(!endpoint){_.isObject(i)||(_.isFunction(i)?i={onClick:i}:_.isString(i)?i={url:i}:i||(i={}));var o={body:n,icon:server_url+"/images/icon/256x256.png",vibrate:[200,100,200,100,200,100,200],data:i};a||(a=t.program_name);var r=function(){i.onClick?i.onClick():i.url&&t.$apply(function(){e.url(i.url)}),window.focus(),c.close()};if("SYSTEM"===i.sender)t.toast(i.content||n,6e4,i.title,i.onClick,"success");else try{var c=new Notification(a,o);c.onclick=r}catch(d){t.toast(n)}}};return{notification:function(t,n,e){Notification&&"granted"!==Notification.permission?Notification.requestPermission(function(i){"granted"===i&&a(t,n,e)}):a(t,n,e)}}}]),appInfoService.factory("socket",["$rootScope",function(t){var n=server_url,e=io.connect(n);return{on:function(n,a){e.on(n,function(){var n=arguments;t.$apply(function(){a.apply(e,n)})})},once:function(n,a){e.once(n,function(){var n=arguments;t.$apply(function(){a.apply(e,n)})})},emit:function(n,a,i){e.emit(n,a,function(){var n=arguments;t.$apply(function(){i&&i.apply(e,n)})})}}}]),appInfoService.factory("excel",[function(){return{tableToExcel:function(t){var n=$($(t).html()),e=n.find("table");0===e.length&&(n=n.wrap("<table>").parent(),e=n.find("table")),e.attr("border",1),e.attr("cellspacing",0),e.attr("bordercolor","#222");var a=(e.find("img").attr("height",64).attr("width",64),n.html());a="<http><head><meta charset='utf-8'/></head><body>"+(a||"")+"</body></html>";var i=new Blob([a],{type:"text/plain;charset=utf-8;"});saveAs(i,"Report.xls")}}}]),appInfoService.factory("printFactory",["$http","$localStorage","$rootScope","$compile","options","$timeout","numberToWord","$uibModal","$q","templaterpt",function(t,n,e,a,i,o,r,c,d,l){var u=function(t,n,e){var a=$(t);e&&e.width&&("printView"!==a.attr("id")?a=$("<div id='printView' style='width: "+e.width+"mm; margin: 0px auto;'>"+t+"</div>"):a.css("width",e.width+"mm"));var i,o,r,c;if(i=a.find("*:contains('{{getValue(')").each(function(){$(this).children().length>0||(o=this.innerHTML,r="",o.split(")}}").forEach(function(t){if(c=t,c&&c.indexOf("{{getValue(")>=0){var n=c.split("{{getValue(")[1].split(",");3==n.length&&(r="<span get-value module="+n[0]+" field="+n[1]+" condition="+n[2]+"></span>",o=o.replace("{{getValue("+n.join(",")+")}}",r))}}),$(this).html(o))}),i=a.find("[ng-repeat]"),0===i.length&&(i=a.find("#details"),i.length>0?i.attr("ng-repeat","r in datasource.details"):(i=a.find("tr:contains('{{r.')"),0===i.length&&(i=a.find("tr:contains('{{::r.')")),1===i.length?i.attr("ng-repeat","r in datasource.details"):i.length>1&&("TBODY"===i.parent()[0].nodeName?i.parent().attr("ng-repeat","r in datasource.details"):i.wrapAll("<tbody ng-repeat='r in datasource.details'>")))),n){var d;for(d in n)_.isArray(n[d])&&(i=a.find("tr:contains('{{"+d+".')"),0===i.length&&(i=a.find("tr:contains('{{::"+d+".')")),1===i.length?i.attr("ng-repeat",d+" in datasource."+d):i.length>1&&("TBODY"===i.parent()[0].nodeName?i.parent().attr("ng-repeat",d+" in datasource."+d):i.wrapAll("<tbody ng-repeat='"+d+" in datasource."+d+"'>")))}return a},s=function(n,i,c,l,_){l.values={},l.doc_so=r;var s=c||l.data||{};l.company=l.appInfo=e.app_info,_||(_={}),l.title=i||_.ten_mau_in||e.function_title,_.liens&&0!==_.liens.length||(_.liens=[{line:0,ma_lien:1,ten_lien:"Liên 1"}]);var p=d.defer();if(s&&s._id){var h=server_url_report+"/api/"+id_app+"/vsocai/"+s._id;t.get(h).then(function(t){s.dinh_khoan=t.data,p.resolve(t.data)},function(t){console.log(t.data),p.resolve([])})}else p.resolve([]);p.promise.then(function(){var t=_.liens;async.mapSeries(t,function(t,r){l.datasource=JSON.parse(JSON.stringify(s)),l.datasource.lien=t;var c=u(n,l.datasource,_),d=a(c[0].outerHTML)(l);o(function(){e.printS(d[0].outerHTML,i),o(function(){r()},200)},500)},function(){})},function(t){e.alert(t)})},p=function(t,n,a,i){t?(t=t.split("<em>").join("").split("</em>").join(""),n.printRpt=function(n,i){s(t,n,i,e,a)}):i&&(n.printRpt=function(t,e){h(i,t,e,n)})},h=function(t,n,a,i){if(e.user){c.open({templateUrl:"templates/sys/chooseTemplate.html",controller:["$scope","$uibModalInstance","parentScope",function(n,i){n.template,n.code=t.toUpperCase(),n.ok=function(){if(i.close(),n.template){var t=n.template.html_code;t&&(t=t.split("<em>").join("").split("</em>").join(""),s(t,n.titlePrint,a,e,n.template.exfields))}},n.cancel=function(){i.close()}}],size:"sm",resolve:{parentScope:function(){return i}}})}},f=function(t,a){if(e.user){{var o=id_app+"_"+e.user.email+"_"+t+"_option";n.getObject(o,{system:{}})}i.load(id_app,{filter:{id_func:t}}).then(function(n){var e=n.data;if(1==e.length){var i=e[0];i.option&&i.option.system&&i.option.defaultRpt?l.get(id_app,i.option.defaultRpt).then(function(n){n.data?p(n.data.html_code,a,n.data.exfields):p("",a,null,t)},function(n){console.log("error load template rpt",n.data),p("",a,null,t)}):p("",a,null,t)}else p("",a,null,t)},function(){p("",a,null,t)})}};return{loadTemplate:f,initTemplate:u,chooseTemplate:h}}]),appInfoService.factory("vPrint",["printFactory",function(t){return t.loadTemplate}]),appInfoService.factory("Base64",function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(n){var e,a,i,o,r,c="",d="",l="",_=0;do e=n.charCodeAt(_++),a=n.charCodeAt(_++),d=n.charCodeAt(_++),i=e>>2,o=(3&e)<<4|a>>4,r=(15&a)<<2|d>>6,l=63&d,isNaN(a)?r=l=64:isNaN(d)&&(l=64),c=c+t.charAt(i)+t.charAt(o)+t.charAt(r)+t.charAt(l),e=a=d="",i=o=r=l="";while(_<n.length);return c},decode:function(n){var e,a,i,o,r,c="",d="",l="",_=0,u=/[^A-Za-z0-9\+\/\=]/g;u.exec(n)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),n=n.replace(/[^A-Za-z0-9\+\/\=]/g,"");do i=t.indexOf(n.charAt(_++)),o=t.indexOf(n.charAt(_++)),r=t.indexOf(n.charAt(_++)),l=t.indexOf(n.charAt(_++)),e=i<<2|o>>4,a=(15&o)<<4|r>>2,d=(3&r)<<6|l,c+=String.fromCharCode(e),64!=r&&(c+=String.fromCharCode(a)),64!=l&&(c+=String.fromCharCode(d)),e=a=d="",i=o=r=l="";while(_<n.length);return c}}});for(var initLabel=function(t,n,e,a,i){n.STP=t.STP,t.ui_dropdowns={},n.turnOffDropdown=function(n){for(var e in t.ui_dropdowns)e===n&&t.Ui.turnOff(e)},n.toggleDropdown=function(n){if(t.Ui.active(n))t.Ui.turnOff(n);else{for(var e in t.ui_dropdowns)t.Ui.turnOff(e);t.Ui.turnOn(n),t.ui_dropdowns={},t.ui_dropdowns[n]=!0}},n.code=a,e.label(a,function(e){n.labels=e,n.getLabel=function(e,o){var r=getLabel(n.labels,e,o,t.lang,i,a.toUpperCase());return r}})},getLabel=function(t,n,e,a,i,o){o||(o="SYS"),t&&_.isObject(t)||(t={});var r=t[n.toUpperCase()];if(r&&r.texte||(r={labelid:o,textid:n,texte:e,textv:e},t[n.toUpperCase()]=r),i&&!r._id&&r.textv&&r.texte&&_online){var c={};_.extend(c,r),r._id="TMP";var d=server_url+"/api/labelinfo";i.post(d,c).then(function(t){r._id=t.data._id},function(t){t.data})}return r.text="EN"==a?r.texte:r.textv,r},dateTime2Date=function(t){return t},languages=["en","vn"],i18n={en:{useLongScale:!1,baseSeparator:"-",unitSeparator:"and ",base:{0:"zero",1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",8:"eight",9:"nine",10:"ten",11:"eleven",12:"twelve",13:"thirteen",14:"fourteen",15:"fifteen",16:"sixteen",17:"seventeen",18:"eighteen",19:"nineteen",20:"twenty",30:"thirty",40:"forty",50:"fifty",60:"sixty",70:"seventy",80:"eighty",90:"ninety"},units:["hundred","thousand","million","billion","trillion","quadrillion","quintillion","sextillion","septillion","octillion","nonillion","decillion","undecillion","duodecillion","tredecillion","quattuordecillion","quindecillion"],unitExceptions:[]},vn:{useLongScale:!1,baseSeparator:" ",unitSeparator:" ",base:{0:"không",1:"một",2:"hai",3:"ba",4:"bốn",5:"năm",6:"sáu",7:"bảy",8:"tám",9:"chín",10:"mười",15:"mười lăm",20:"hai mươi",21:"hai mươi mốt",25:"hai mươi lăm",30:"ba mươi",31:"ba mươi mốt",40:"bốn mươi",41:"bốn mươi mốt",45:"bốn mươi lăm",50:"năm mươi",51:"năm mươi mốt",55:"năm mươi lăm",60:"sáu mươi",61:"sáu mươi mốt",65:"sáu mươi lăm",70:"bảy mươi",71:"bảy mươi mốt",75:"bảy mươi lăm",80:"tám mươi",81:"tám mươi mốt",85:"tám mươi lăm",90:"chín mươi",91:"chín mươi mốt",95:"chín mươi lăm"},units:["trăm","ngàn","triệu","tỷ","nghìn tỷ"],unitExceptions:[]}},util={defaults:function(t,n){null==t&&(t={});for(var e={},a=Object.keys(n),i=0,o=a.length;o>i;i++){var r=a[i];e[r]=t[r]||n[r]}return e}},shortScale=[100],i=1;16>=i;i++)shortScale.push(Math.pow(10,3*i));var longScale=[100,1e3];for(i=1;15>=i;i++)longScale.push(Math.pow(10,6*i));writtenNumber.defaults={noAnd:!1,lang:"vn"},appInfoService.factory("numberToWord",[function(){return writtenNumber}]);var getTemplate=function(t,n,e){e||(e=60);var a='<div style="height:{{innerHeight}}px">';return a+='<div class="modal-header section-info">',a+='<button type="button" class="close" ng-click ="close()" aria-hidden="true"> &times;</button>',a+='<h4 class="modal-title" id="findModalLabel">',a+='   {{title||"::"}}',a+="</h4>",a+="</div>",a=a+'<div class="modal-body"  style="height:{{innerHeight-'+e.toString()+'}}px">',a+=n||"  <"+t+"-form></"+t+"-form>",a+="</div>",a+="</div>"},viewProfile=function(t,n){t.open({templateUrl:"templates/sys/profile.html",controller:["$scope","$uibModalInstance","user","$location","$rootScope",function(t,e,a,i,o){a.getProfile(n,function(n,e){t.profile=e}),t.cancel=function(){e.close()},t.gotoChat=function(t){e.close(),i.path("/message/chat/"+t)},t.current_User=t.currentUser=o.user}],size:"md"})},baseInput=function(t,a,i,o,r){t&&(STPModules[t.toLowerCase()]={obj:this,type:"INPUT"}),this.code=t,this.server_path=a,this.fields_find=i,this.title=o,r||(r={}),r.limit||(r.limit=30),this.options=r,this.group=r.group,this.group||(this.group="lists"),this.defaultConditions=r.defaultConditions,this.defaultValues=r.defaultValues,this.loading=r.onLoading,this.loaded=r.onLoaded,this.initHomeController=r.onInitHomeController,this.initAddController=r.onInitAddController,this.initEditController=r.onInitEditController,this.init=r.onInit,this.setDataSource2Print=r.onSetDataSource2Print,this.loadItem=r.onLoadItem,this.initImport=r.onImport,this.defaultCondition4Search=r.defaultCondition4Search,this.prepareCondition4Search=r.onPrepareCondition4Search;var c=t+"Module";_.contains(modulesD,c)||modulesD.push(c),this.module=angular.module(c,["ngRoute"]);var d=this;this.module.factory(t+"Config",function(){return{title:o,path:t}}),this.url_service=function(t){var n;return n=_.contains(paths_not_require_id_app,a)?(t&&servers[t]?servers[t]:server_url)+"/api/"+a:(t&&servers[t]?servers[t]:server_url)+"/api/"+id_app+"/"+a},this.getService=function(t,n,e){return baseService2(e,t,n,a,d.url_service,i,r.services)},this.module.factory(t,["$http","$q","$rootScope",function(t,n,e){return d.getService(t,n,e)}]),this.download=function(t,n,e,a,i){i||(i=function(){});var o=d.getService(t,n,e),r=e.sync_date;r||(r=moment(new Date(2001,1,1)).startOf("date").toDate());var c={sync_from_date:r};o.load(id_app,{limit:a,condition:c}).then(function(){i()},function(t){i(t.data?t.data:"Không thể kết nối với máy chủ")})},this.module.controller(t+"JsonController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$window","$interval","$uibModal","$filter","appInfo","$localStorage",function(n,e,a,i,o,c,l,u,s,p,h,f){e.list=[],e.condition="",d.defaultConditions&&(e.condition={},_.extend(e.condition,d.defaultConditions)),angular.extend(e,c),e.limit=3e4;var g=o.search();f.info(t,function(t){t||(e.list=[],i.load(id_app,{condition:e.condition,filter:e.filter,page:1,limit:e.limit,queryParams:g,onCondition:r.onCondition}).then(function(t){var n=t.data;e.list=n},function(t){var n=t.data;n&&l.alert(n)}))})}]),this.module.controller(t+"HomeController",["$q","$controller","$scope","$shttp",t,"$location",t+"Config","$rootScope","$window","$interval","$uibModal","$filter","appInfo","$localStorage","$cordovaBarcodeScanner","follow","rpt","printFactory",function(i,c,l,u,s,p,h,f,g,m,v,k,b,y,w,S,M,D){initLabel(f,l,b,t,u);var x,T={};l.isListView||(f.function_title=o,f.function_code=t,T=p.search()),l.list=[],angular.extend(l,h),l.condition="",l.filter||(l.filter={}),l.limit||(l.limit=r.limit),d.defaultConditions&&_.extend(l.filter,d.defaultConditions),l.parameters&&_.extend(l.filter,l.parameters),l.total_page=1,l.current_page=1,l.pages=[1],l.$uibModal=v,l.$http=u,l.config=h,d.init&&d.init(l,c,{$http:u}),l.limitOpts={limit:l.limit,begin:0},l.loadPage=function(){l.limitOpts.limit=l.limitOpts.limit+5},b.info(t,function(b,y){if(!b){{(id_app||"")+y.email+t+"data"}d.loading&&f.nextTick(function(){d.loading(l,{$q:i,$controller:c,$http:u,service:s,$filter:k,$location:p,config:h,$rootScope:f,$window:g,$interval:m,$uibModal:v})}),l.current_user=f.user,l.pageBar={},l.goToPage=function(t,n,a){return l.selectedRow=null,l.limitOpts.limit=l.limit,l.list=[],l.current_page=t,l.pageBar.current_page=t,l.notLoadData?(l.renderCompleted=!0,console.log("Don't allow load data")):void f.nextTick(function(){if(l.$emit("$dataChangeStart"),l.list=[],n||void 0!=n||(n=x||l.condition),l.findBy&&!_.isObject(n)){var i=n;n={},n[l.findBy]={$regex:i,$options:"i"}}return C()?console.log("reload when begin fetch data from server"):(x=n,void s.load(id_app,{condition:n,filter:l.filter,page:t,limit:l.limit,queryParams:T,onCondition:r.onCondition,fields_find:l.fields_find}).then(function(t){if(C())return console.log("reload when fetch data from server completed");s.load(id_app,{condition:n,filter:l.filter,count:1,queryParams:T,onCondition:r.onCondition,fields_find:l.fields_find}).then(function(t){l.rows_number=t.data.rows_number,l.total_page=STP.round(t.data.rows_number/Number(l.limit),0),l.total_page<t.data.rows_number/Number(l.limit)&&(l.total_page+=1),0==l.total_page&&(l.total_page=1),l.pages=[];for(var n=1;n<=l.total_page;n++)l.pages.push(n)});var i=t.data;async.map(i,function(t,n){id_app&&_online?S.load(id_app,{filter:{id_object:t._id,user_created:l.current_user.email}}).then(function(e){var a=e.data;
a&&a.length>0?(t.followObject=a[0],t.follow_yn=1):t.follow_yn=0,n()},function(){t.follow_yn=0,n(e.data)}):n()},function(t){return t&&console.log(t),C()?console.log("reload when near finish"):(l.list=k("orderBy")(i,r.predicate||"ngay_tao",!1),l.list.length>0&&l.setSelectedRow(l.list[0],!0),l.renderCompleted=!0,a&&a(null,l.list),d.loaded&&f.nextTick(function(){d.loaded(l,{$controller:c,$http:u,service:s,$filter:k,$location:p,config:h,$rootScope:f,$window:g,$interval:m,$uibModal:v})}),void l.$emit("$dataChangeSuccess"))})},function(t){if(C())return console.log("reload when error");var n=t.data;console.log(n),l.$emit("$dataChangeError"),a&&a(n),d.loaded&&f.nextTick(function(){d.loaded(l,{$controller:c,$http:u,service:s,$filter:k,$location:p,config:h,$rootScope:f,$window:g,$interval:m,$uibModal:v})})}))})},l.goToPage(1,null,function(t){t&&f.alert(t)}),l.update=function(t,n,e){l.$emit("$dataSaveStart"),s.update(id_app,t._id,t).then(function(a){var i=a.data;t.updated=!0,l.$emit("$dataSaveSuccess"),e&&angular.extend(e,i),n?n(null,i):f.toast("Đã cập nhật thành công")},function(t){var e=t.data;if(l.$emit("$dataSaveError"),!e)return f.alert("Không thể kết nối với máy chủ");var a=JSON.stringify(e);if(a.indexOf("Lỗi")<0){if(a.indexOf("duplicate")>=0)return a="Lỗi: Đã tồn tại",f.alert(a);if(a.indexOf("Not allowed")>=0)return a="Lỗi: Bạn không có quyền thực hiện thao tác này",f.alert(a)}a=JSON.parse(a),n?n(a):f.alert(angular.isArray(a)?a.join("\n"):a)})},l.add=function(t){if(t||(t={}),d.defaultvalues){var n=JSON.parse(JSON.stringify(d.defaultvalues));_.extend(t,n)}l.parameters&&_.extend(t,l.parameters),d.quickadd(v,function(t){_.find(l.list,function(n){return n._id===t._id})||(l.list=[t].concat(l.list)),l.setSelectedRow(t,!0)},t)},l.copy=function(t,n,e){e||(e=function(){});var a={};_.extend(a,t),delete a._id,delete a.so_ct,delete a.ngay_ct,delete a.__v,delete a.date_created,delete a.date_updated,delete a.user_created,delete a.user_updated,delete a.stt_rec,delete a.id_pc0,delete a.id_pc3,delete a.id_pc2,delete a.id_contract,delete a.id_bao_gia;for(var i in a)0==i.indexOf("id_")&&delete a[i];l.parameters&&_.extend(a,l.parameters),n&&_.extend(a,n),d.quickadd(v,function(t){_.find(l.list,function(n){return n._id===t._id})||(l.list=[t].concat(l.list)),l.setSelectedRow(t,!0),e(t)},a)},l.xemhoachtoan=function(t){v.open({templateUrl:"templates/sys/xemhoachtoan.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","appInfo",function(n,e,a,i,o,r){initLabel(e,n,r,"SYS",i),n.data=t,s.getSocai(t.id_app,t._id).then(function(t){n.socai=t.data},function(t){o.close(),t.data&&e.alert(t.data)}),n.close=function(){o.close()}}],size:r.modal_size||"sm",resolve:{parentScope:function(){return l}}})},l.xemsokho=function(t){v.open({templateUrl:"templates/sys/xemsokho.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","appInfo",function(n,e,a,i,o,r){initLabel(e,n,r,"SYS",i),n.data=t,s.getSokho(t.id_app,t._id).then(function(t){n.sokho=t.data},function(t){o.close(),t.data&&e.alert(t.data)}),n.close=function(){o.close()}}],size:r.modal_size||"sm",resolve:{parentScope:function(){return l}}})},l.xemlogs=function(n){v.open({templateUrl:"templates/sys/logs.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(e,a,i,o,r,c,d){initLabel(a,e,d,"SYS",o),e.data=n,e.module=t,e.close=function(){r.close()}}],size:r.modal_size||"sm",resolve:{parentScope:function(){return l}}})},l.xemDeleted=function(){v.open({templateUrl:"templates/sys/deleted.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",t,function(t,n,e,a,i,o,r,c){initLabel(n,t,r,"SYS",a),t.data=[],t.fields_find=d.fields_find,c.logs(id_app,"DELETE").then(function(n){t.data=n.data},function(t){return t.data?n.alert(t.data):void 0}),t.close=function(){i.close()},t.restore=function(e){var i=e._id.toString();delete e.data.data.stt_rec,d.quickadd(v,function(){url=server_url+"/api/"+id_app+"/log/"+i,a.delete(url).then(function(){t.data=_.filter(t.data,function(t){return t._id.toString()!==i})},function(t){t.data&&n.alert(t.data)})},e.data.data)}}],size:r.modal_size||"sm",resolve:{parentScope:function(){return l}}})},l.edit=function(t){var n=_.find(l.list,function(n){return n._id===t});return!n||l.selectedRow&&l.selectedRow._id===n._id||l.setSelectedRow(n),l.isListView&&l.onListItemClick?void l.onListItemClick({$item:n}):void d.quickedit(v,t,function(t,e){l.selectedRow&&l.selectedRow._id===t._id&&_.extend(l.selectedRow,t),n&&"delete"!==e&&(_.extend(n,t),f.toast("Đã cập nhật thành công"))},function(t){l.list=_.reject(l.list,function(n){return n._id===t._id}),h.list=l.list})},l.view=function(t){return l.isListView?l.edit(t):void(r.has_view?p.path("/"+l.path+"/view/"+(_.isObject(t)?t._id:t)):l.edit(t))},l.isEqual=function(t,n){return angular.equals(t,n)},l.setSelectedRow=function(t,n){return l.selectedRow&&l.selectedRow._id===t._id?void(n&&l.edit(t._id)):void(l.selectedRow=n?JSON.parse(JSON.stringify(t)):t)},l.openProfile=function(t){viewProfile(v,t)},l.searchKeyup=function(t,n){13==t.keyCode&&l.search(n)},l.search=function(n,e){l.renderCompleted&&(n&&console.log(t,"search by condition",n),l.renderCompleted=!1,l.goToPage(1,n,function(){0==l.list.length&&f.toast("Không tìm thấy dữ liệu"),e&&e(l.list)}))},l.searchBarcode=function(){document.addEventListener("deviceready",function(){w.scan().then(function(t){l.condition=t.text,l.search(t.text,function(t){1===t.length&&l.onRowClick&&l.onRowClick({$item:t[0]})})},function(){})},!1)},l.searchByField=function(t,n,e){var a={};f.prompt("Nhập giá trị cần tìm:","Number"==e?0:"").then(function(i){var o=i.buttonIndex;if(1==o){n||(n="regex"),e||(e="String");var r=i.input1;if(r||0==r){if("Number"==e){try{r=Number(r)}catch(c){}r||(r=0)}switch(n){case"=":a[t]=r;break;case">":a[t]={$gte:r};break;case"<":a[t]={$lte:r};break;default:a[t]={$regex:r,$option:"i"}}l.search(a)}}})},l.find=function(){v.open({templateUrl:"templates/"+d.group+"/"+t+"/templates/find.html",controller:["$scope","$uibModalInstance","parentScope",function(t,n,e){t.vcondition={},d.defaultCondition4Search&&(t.vcondition=d.defaultCondition4Search),t.list=e.list,t.search=e.search,t.okFind=function(){var e={};if(d.prepareCondition4Search)e=d.prepareCondition4Search(t,t.vcondition);else for(var a in t.vcondition)t.vcondition[a]&&(e[a]=_.isString(t.vcondition[a])?{$regex:t.vcondition[a],$options:"i"}:t.vcondition[a]);e.ngay_ct&&(e.ngay_ct.$gte&&(e.ngay_ct.$gte=moment(e.ngay_ct.$gte).startOf("date").toDate()),e.ngay_ct.$lte&&(e.ngay_ct.$lte=moment(e.ngay_ct.$lte).endOf("date").toDate())),t.vcondition.trang_thai&&!e.trang_thai&&(e.trang_thai=t.vcondition.trang_thai),t.search(e),n.close()},t.cancelFind=function(){n.close()}}],size:"sm",resolve:{parentScope:function(){return l}}})},l.changeLimit=function(t){l.limit=t,l.search()},l.changeFilter=function(t){l.findBy=null,l.filter=t.filter,l.filter_title=window.innerWidth<=450?t.title.length<13?t.title:"..."+t.title.slice(-10):t.title,l.search()};var C=function(){return l.reload?(l.reload=!1,l.renderCompleted=!0,console.log("run reload when parameters changed",t,n),l.search(),!0):!1};l.$watch("parameters",function(n,e){n&&!_.isEqual(n,e)&&(l.filter={},_.extend(l.filter,n),(l.renderCompleted=!1)?(console.log("require reload when parameters changed",t,n),l.reload=!0):(console.log("search when parameters changed",t,n),l.renderCompleted=!0,l.search()))},!0),l.$watch("requireReload",function(t,n){t&&!_.isEqual(t,n)&&(l.onBeforeReload&&l.onBeforeReload({$item:l}),(l.renderCompleted=!1)?l.reload=!0:(l.renderCompleted=!0,l.search()))},!0),l.changeFindBy=function(t){l.filter=null,l.findBy=t.findBy,l.filter_title=window.innerWidth<=450?t.title.length<13?t.title:"..."+t.title.slice(-10):t.title,l.search()},l.location=p.url(),l.reverse=!0,l.order=function(t,n){l.list=k("orderBy")(l.list,t,n)},l.selectionAll=!1,l.$watch("selectionAll",function(t){l.list&&l.list.forEach(function(n){n.sel=t})},!0),l.selectionAllChange=function(t){l.selectionAll=t},l.multiSelect=f.isMobile?!1:!0,l.toggleMultiSel=function(t,n){t?t.forEach(function(t){t.sel=n}):(l.multiSelect=!l.multiSelect,l.selectionAll=!1)},l.isUnSelected=function(){if(!l.list)return!0;for(var t=0;t<l.list.length;t++){var n=l.list[t];if(n.sel&&1==n.sel)return!1}return!0},l.deleteAll=function(t){f.confirm("Có chắc chắn xoá tất cả dữ liệu của chức năng này không?").then(function(n){var e=n;1==e?s.deleteAll(id_app).then(function(){l.list=[],l.selectedRow=null,f.toast("Đã xoá thành công")},function(n){var e,a=n.data;e=_.isObject(a)?JSON.stringify(a):a,t?t(e):f.alert(e.indexOf("Lỗi:")>=0?e:"Không thể xóa")}):t&&t("NOTACCEPTED")})},l.delete=function(t,n){return t||_.find(l.list,function(t){return t.sel})?void(t?f.confirm("Có chắc chắn xoá không?").then(function(e){var a=e;1==a?s.delete(id_app,t).then(function(n){n.data;l.list=_.reject(l.list,function(n){return n._id==t}),l.selectedRow=null,f.toast("Đã xoá thành công")},function(t){var e,a=t.data;e=_.isObject(a)?JSON.stringify(a):a,n?n(e):f.alert(e)}):n&&n("NOTACCEPTED")}):f.confirm("Có chắc chắn xoá những dòng đã chọn không").then(function(t){var n=t;1==n&&async.map(l.list,function(t,n){if(t.sel&&1==t.sel){var e=t._id;s.delete(id_app,e).then(function(t){t.data;l.list=_.reject(l.list,function(t){return t._id==e}),n(null,e)},function(t){var e=t.data;n(e)})}else n()},function(t){if(t){var n;n=_.isObject(t)?JSON.stringify(t):t,f.alert(n.indexOf("Lỗi:")>=0?n:"Không thể xóa")}else l.selectedRow=null,f.toast("Đã xoá thành công"),h.list=l.list})})):(l.multiSelect=!0,void f.toast("Hãy chọn ít nhất một dòng để xoá"))},d.initHomeController&&d.initHomeController(c,l,u,s,p,h),id_app&&f.nextTick(function(){M.load(id_app,{filter:{ma_cn:t.toUpperCase()}}).then(function(t){var n=t.data;l.rpts=n},function(t){console.log(t.data)})}),l.isListView&&l.onLoadView&&l.onLoadView(l,f),l.export2excel=function(){var t=server_url_report+"/api/"+id_app+"/"+a+"?type_data=xlsx&access_token="+f.token;f.toast("Chương trình đang thực hiện. Anh(chị) hãy chờ đợi trong giây lát."),f.downloadFile(t,o+".xlsx",function(t){t&&console.log("error export list to excel",t)})},l.rptManagementUrl="#!/rpt?ma_cn="+t.toUpperCase(),l.rptManagement=function(){var n="rpt?ma_cn="+t.toUpperCase();f.openUrl(n)},l.printXlsx=function(n){if(!_online)return f.alert("Chức năng này yêu cầu kết nối internet");var e=[];if(l.list.forEach(function(t){t.sel&&e.push(t._id)}),e.length>0){var a=server_url_report+"/api/"+id_app+"/"+t+"/excel/"+n+"?_id="+e.join(",")+"&access_token="+f.token;f.toast("Chương trình đang thực hiện. Anh(chị) hãy chờ đợi trong giây lát."),f.downloadFile(a,o+".xlsx",function(t){t&&console.log("error export to excel",t)})}else l.multiSelect=!0,f.toast("Hãy chọn ít nhất một phiếu")},l.importhtml5=function(){if(!_online)return f.alert("Chức năng này yêu cầu kết nối internet");{var t=l.search;v.open({templateUrl:"templates/sys/importhtml5.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(n,e,a,i,o,r,c){initLabel(e,n,c,"IMP",i),n.template=server_url_import+"/templates/imports/"+d.code+".xlsx",n.update=!0,n.action=server_url_import+"/api/"+id_app+"/"+d.server_path+"/import/excel",n.cancel=function(){o.close()},n.$on("$fileUploadSuccess",function(e,a){n.result=a,t()}),n.$on("$fileUploadError",function(e,a){t(),n.result=a})}],size:r.modal_size||"sm",resolve:{parentScope:function(){return l}}})}},l.import=function(){var n="#"+t+"/import?t=1";if(d.initImport)d.initImport(l,n,function(t,n){if(t)return f.alert(t);var e=0,a=g.open(n,"Import","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=200");stop=m(function(){return"OK"==a.document.title?(l.search(),m.cancel(stop),stop=void 0,void a.close()):"ERROR"==a.document.title?(m.cancel(stop),void(stop=void 0)):(e+=500,void(e>3e5&&stop&&(m.cancel(stop),stop=void 0)))},500)});else{var e=0,a=g.open(n,"Import","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=200");stop=m(function(){return"OK"==a.document.title?(l.search(),m.cancel(stop),stop=void 0,void a.close()):"ERROR"==a.document.title?(m.cancel(stop),void(stop=void 0)):(e+=500,void(e>3e5&&stop&&(m.cancel(stop),stop=void 0)))},500)}},l.follow=function(n){1==n.follow_yn?S.delete(id_app,n.followObject._id).then(function(t){t.data;n.follow_yn=0},function(t){t.data&&f.alert(t.data)}):(followObject={id_object:n._id,collection_name:t,id_app:id_app},S.create(id_app,followObject).then(function(t){var e=t.data;n.followObject=e,n.follow_yn=1},function(t){t.data&&f.alert(t.data)}))},l.isLike=!1,id_app&&(u.get(server_url+"/api/"+id_app+"/like_module?q={module:'"+t+"',user_created:'"+y.email+"'}").then(function(t){var n=t.data;n&&1==n.length&&(l.isLike=n[0].like)},function(t){console.log(t.data)}),l.like=function(){var n=server_url+"/api/"+id_app+"/like_module";u.post(n,{id_app:id_app,module:t,like:!0}).then(function(t){var n=t.data;n&&(l.isLike=!0)},function(t){console.log(t.data)})},l.unlike=function(){var n=server_url+"/api/"+id_app+"/like_module";u.post(n,{id_app:id_app,module:t,like:!1}).then(function(t){var n=t.data;n&&(l.isLike=!1)},function(t){console.log(t.data)})}),l.$on("keydown",function(t,n){return 116==n.which?void l.search():n.ctrlKey&&77==n.which?void l.add():n.ctrlKey&&68==n.which?void l.delete():(n.ctrlKey&&65==n.which&&(l.multiSelect=!0,l.list&&l.list.forEach(function(t){t.sel=!0})),void(n.ctrlKey&&85==n.which&&(l.multiSelect=!1,l.list&&l.list.forEach(function(t){t.sel=!1}))))}),l.chooseTemplate=function(n,e){D.chooseTemplate(t,n,e,l)},l.options=function(){{var n=(f.token,"templates/"+d.group+"/"+t+"/templates/options.html"),e="templates/sys/options-"+d.group+".html";v.open({templateUrl:e,controller:["$scope","$controller","$http","$uibModalInstance","$window","$localStorage","options","parentScope","printFactory","$rootScope",function(e,a,i,o,r,c,l,_,u,s){e.code=t,e.group=d.group,e.path=n;var p={},h=id_app+"_"+y.email+"_"+t+"_option";e.locals=c.getObject(h,{}),e.locals||(e.locals={system:{}}),e.locals.system||(e.locals.system={}),e.options={check_so_ct:"0"},l.load(id_app,{filter:{id_func:t}}).then(function(n){var a=n.data;1==a.length?(p=a[0],e.options=p.option,e.options.check_so_ct||(e.options.check_so_ct="0"),e.options.system||(e.options.system={}),e.options.system.width||(e.options.system.width=203)):(p.id_app=id_app,p.id_func=t)},function(n){console.log("error when load options",t,n.data)}),e.changeWidthPage=function(t){if(e.options&&e.options.system&&e.options.system.templateRpt){var n=$(e.options.system.templateRpt);"printView"===n.attr("id")?(n.removeAttr("style"),t&&(n.css("width",t+"mm"),n.css("margin","0px auto"))):n=$(t?"<div id='printView' style='width: "+t+"mm; margin: 0px auto;'>"+e.options.system.templateRpt+"</div>":"<div id='printView'>"+e.options.system.templateRpt+"</div>"),e.options.system.templateRpt=n[0].outerHTML}},e.save=function(){if(e.isSave)return s.alert("Chương trình đang thực hiện");e.isSave=!0,e.locals||(e.locals={}),e.options&&e.options.system&&e.options.system.templateRpt&&(e.options.system.templateRpt=u.initTemplate(e.options.system.templateRpt,{details:[],tdttnos:[],tdttcos:[],vatvaos:[],vatras:[],ctcpmhs:[],ctcpbhs:[]},e.options.system)[0].outerHTML,e.locals.system.templateRpt=e.options.system.templateRpt);for(var n in e.locals)!e.options[n]&&e.locals[n]&&(e.options[n]=e.locals[n]);try{c.setObject(h,e.locals)}catch(a){}p.option=e.options,p._id?l.update(id_app,p._id,p).then(function(){u.loadTemplate(t,_),o.close(),e.isSave=!1},function(t){s.toast(t.data+"<br/>Chỉ những tùy chọn theo người dùng được lưu.",null,null,null,"error"),o.close(),e.isSave=!1}):l.create(id_app,p).then(function(){u.loadTemplate(t,_),o.close(),e.isSave=!1},function(t){s.toast(t.data+"<br/>Chỉ những tùy chọn theo người dùng được lưu.",null,null,null,"error"),o.close(),e.isSave=!1})},e.cancel=function(){o.close(),e.isSave=!1}}],size:"sm",resolve:{parentScope:function(){return l}}})}},T.add&&(delete T.add,l.add(T))}})}]);var l=t;l&&(l=l.split("_").join(""),this.module.directive(l+"ListView",[function(){return{restrict:"E",scope:{onListItemClick:"&?",parameters:"=?",defaultValues:"=?",limit:"@",notLoadData:"=?",requireReload:"=?",onBeforeReload:"&?",onLoadView:"=?",selectedRow:"=?"},templateUrl:function(n,e){return"templates/"+d.group+"/"+t+"/templates/"+(e.templateUrl?e.templateUrl:"list")+".html"},controller:["$controller","$scope","$rootScope",function(n,e,a){e.isListView=!0,e.server_url=server_url,e.openUrl=a.openUrl,n(t+"HomeController",{$scope:e})}],link:function(){}}}]),this.module.directive(l+"Form",[function(){return{restrict:"E",templateUrl:"templates/"+d.group+"/"+t+"/templates/form.html"}}])),this.quickview=function(n,e,a,i){if(_online){var r=_.filter(_.values(cmdmodules),function(n){return n.path.toLowerCase()===t});if(r.length>0&&!_.find(r,function(t){return t.command.visible}))return void n.open({templateUrl:"templates/sys/alert.html",controller:["$scope","$uibModalInstance",function(t,n){t.msg="Bạn không có quyền sử dụng tính năng này.",t.dismiss=function(){n.close()}}],size:"sm"});i||(i={});{n.open({template:function(){var n="<div  class='modal-header section-info'><button type='button' class='close' ng-click ='close()' aria-hidden='true'> &times;</button><h4 class='modal-title'>{{list_title}}</h4></div><div class='modal-body'><div style='height:{{innerHeight-70}}px'><"+t.split("_").join("")+"-list-view "+(i.templateUrl?"template-url='"+i.templateUrl+"'":"")+" parameters ='parameters' "+(i.onListItemClick?"on-list-item-click='onListItemClick($item)' ":"")+(i.onLoadView?"on-load-view='onLoadView' ":"")+"></"+t.split("_").join("")+"-list-view></div></div>";return n},controller:["$rootScope","$scope","$controller","$uibModalInstance","appInfo","$http",function(n,r,c,d,l,_){initLabel(n,r,l,t,_),r.list_title=r.getLabel("ten_ct"+t,o).text,r.list_code=t,r.parameters=e,r.openUrl=n.openUrl,r.Ui=n.Ui,r.STP=STP,i.onLoadView&&(r.onLoadView=function(t,n){i.onLoadView(t,n,d)}),i.onListItemClick&&(r.onListItemClick=function(t){i.onListItemClick(t,d)}),r.close=function(){a&&a(),d.close()},r.$on("backbutton",function(){r.close()})}],size:"md",backdrop:"static",resolve:{}})}}},this.module.controller(t+"ImportController",["$scope","$rootScope","$location","$routeParams",t+"Config","appInfo","$http",function(n,e,a,i,o,r,c){initLabel(e,n,r,t,c),r.info(t,function(t){if(!t){var i=e.token;e.hide_nav=!0,n.action=server_url+"/api/"+id_app+"/"+d.server_path+"/import/excel?access_token="+i,n.template="templates/templates/"+d.code+".xlsx";var o=a.search();o.values&&(n.action=n.action+"&values="+o.values),o.update&&(n.action=n.action+"&update="+o.update)}})}]),this.module.controller(t+"AddController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$uibModal","$window","appInfo","$localStorage","options","$timeout","vPrint","$q",function(n,e,a,i,c,l,u,s,p,h,f,g,m,v,k){u.function_title=o,u.function_code=t,initLabel(u,e,h,t,a),e.masterData={status:!0},e.data={status:!0,visible_to:0,exfields:{}},e.$uibModal=s,e.$http=a,e.$window=p,d.init&&d.init(e,n,{$http:a}),e.action="Mới",h.info(t,function(o){if(!o){e.current_user=u.user,e.vPrint=v,angular.extend(e,l),async.parallel({opts:function(n){g.load(id_app,{filter:{id_func:t}}).then(function(a){var i=a.data;if(1==i.length){var o=i[0];e.ext_options={};for(var r in o.option)"system"!==r&&o.option[r]&&(e.ext_options[r]=o.option[r]);var c=id_app+"_"+u.user.email+"_"+t+"_option",d=f.getObject(c);for(var r in d)"system"!==r&&d[r]&&(e.ext_options[r]=d[r])}n()},function(t){console.log("load options",t.data),n()})}},function(){if(u.app_info&&u.app_info.options&&(e.f_sl=u.app_info.options.f_sl||2,e.f_ty_gia=u.app_info.options.f_ty_gia||0,e.f_gia=u.app_info.options.f_gia||0,e.f_tien=u.app_info.options.f_tien||0,1==e.data.ty_gia?(e.f_gia_nt=u.app_info.options.f_gia||0,e.f_tien_nt=u.app_info.options.f_tien||0):(e.f_gia_nt=u.app_info.options.f_gia_nt||2,e.f_tien_nt=u.app_info.options.f_tien_nt||2),e.round=e.f_tien_nt,e.$watch("data.ty_gia",function(){1==e.data.ty_gia?(e.f_gia_nt=u.app_info.options.f_gia||0,e.f_tien_nt=u.app_info.options.f_tien||0):(e.f_gia_nt=u.app_info.options.f_gia_nt||2,e.f_tien_nt=u.app_info.options.f_tien_nt||2),e.round=e.f_tien_nt})),e.data.options=e.ext_options,e.masterData.options=e.ext_options,_.extend(e.data,e.ext_options),_.extend(e.masterData,e.ext_options),d.defaultValues){var t=JSON.parse(JSON.stringify(d.defaultValues));_.extend(e.data,t),_.extend(e.masterData,t)}var o=c.search();o&&(_.extend(e.data,o),_.extend(e.masterData,o)),r.onAdd&&u.nextTick(function(){r.onAdd(e,{$controller:n,$rootScope:u,$http:a,service:i,$location:c,config:l,$window:p,$uibModal:s})}),r.onInput&&r.onInput(e,{$controller:n,$rootScope:u,$http:a,service:i,$location:c,config:l,$window:p,$uibModal:s,$q:k,app_info:u.app_info||{options:{}}}),m(function(){e.isDataLoaded=!0},100)}),e.reset=function(){e.data=angular.copy(e.masterData)},e.cancel=function(){var t=c.search().redirect;t?"back"==t?p.history.back():c.url(t):p.history.back()},e.isUnchanged=function(){return angular.equals(e.data,e.masterData)};var h=function(t,n){return e.isSave?u.alert("Chương trình đang thực hiện"):(e.isSave=!0,e.$emit("$dataSaveStart"),void i.create(id_app,e.data).then(function(a){var i=a.data;e.masterData=i,_.extend(e.data,i),l.list||(l.list=[]),l.list.push(e.masterData);var o=c.search().redirect;o?"back"==o?p.history.back():c.url(o):r.has_view?c.url("/"+e.path+"/view/"+i._id):c.path("/"+e.path),e.$emit("$dataSaveSuccess"),r.onSaved&&r.onSaved(e,i,{$rootScope:u}),e.printRpt&&t&&(r.onPrint?r.onPrint(e,function(){e.printRpt("",i)}):e.printRpt("",i)),e.isSave=!1,n&&n(i)},function(t){e.isSave=!1;var n=t.data;e.$emit("$dataSaveError");var a=n;a.indexOf("Lỗi")<0&&(a.indexOf("duplicate")>=0?a="Lỗi: Đã tồn tại":a.indexOf("Not allowed")>=0&&(a="Lỗi: Bạn không có quyền thực hiện thao tác này")),angular.isArray(a)?u.alert(a.join("\n")):(a||(a="Không thể kết nối với máy chủ. Hãy thử lại."),u.alert(a))}))};e.create=function(t,o){r.onSave?r.onSave(e,e.data,{action:"CREATE",$controller:n,$rootScope:u,$http:a,service:i,$location:c,config:l,$window:p,$uibModal:s},function(n,e){return n?u.alert(n):void(e&&h(t,o))}):h(t,o)},e.$on("keydown",function(t,n){n.ctrlKey&&83==n.which&&e.create()}),d.initAddController&&d.initAddController(n,e,a,i,c,l)}})}]),this.quickadd=function(n,e,a,i){var o=_.filter(_.values(cmdmodules),function(n){return n.path.toLowerCase()===t});if(o.length>0&&!_.find(o,function(t){return t.command.visible}))return void n.open({templateUrl:"templates/sys/alert.html",controller:["$scope","$uibModalInstance",function(t,n){t.msg="Bạn không có quyền sử dụng tính năng này.",t.dismiss=function(){n.close()}}],size:"sm"});n.open({templateUrl:"templates/"+d.group+"/"+t+"/templates/dialog-quickadd.html",controller:["$scope","$controller","$http",t,"$location",t+"Config","$uibModalInstance","$window","$rootScope","appInfo","$localStorage","options","$timeout","vPrint","$q",function(o,c,l,u,s,p,h,f,g,m,v,k,$,b,y){initLabel(g,o,m,t,l),o.$uibModal=n,o.$http=l,o.$window=f,o.action="Mới",o.Ui=g.Ui,o.STP=STP,o.vPrint=b;var w=function(){var e,i;o.data&&(e=o.data.ma_dvcs,i=o.data.ma_kho),o.masterData={status:!0},o.data={status:!0,visible_to:0,exfields:{}},async.parallel({opts:function(n){o.ext_options?n():k.load(id_app,{filter:{id_func:t}}).then(function(e){var a=e.data;if(1==a.length){var i=a[0];o.ext_options={};for(var r in i.option)"system"!==r&&i.option[r]&&(o.ext_options[r]=i.option[r]);var c=id_app+"_"+g.user.email+"_"+t+"_option",d=v.getObject(c);for(var r in d)"system"!==r&&d[r]&&(o.ext_options[r]=d[r])}n()},function(t){console.log(t.data),n()})}},function(){if(o.data.options=o.ext_options,o.masterData.options=o.ext_options,_.extend(o.masterData,o.ext_options),_.extend(o.data,o.ext_options),e&&!o.data.ma_dvcs&&(o.data.ma_dvcs=e),i&&!o.data.ma_kho&&(o.data.ma_kho=i),d.defaultValues){var t=JSON.parse(JSON.stringify(d.defaultValues));_.extend(o.data,t)}if(a)for(var h in a)o.data[h]=a[h];for(var m in o.ext_options)o.data.details&&o.data.details.forEach(function(t){t[m]||(t[m]=o.ext_options[m])});var v=s.search();v&&(_.extend(o.data,v),_.extend(o.masterData,v)),angular.extend(o,p),g.app_info&&g.app_info.options&&(o.f_sl=g.app_info.options.f_sl||2,o.f_ty_gia=g.app_info.options.f_ty_gia||0,o.f_gia=g.app_info.options.f_gia||0,o.f_tien=g.app_info.options.f_tien||0,1==o.data.ty_gia?(o.f_gia_nt=g.app_info.options.f_gia||0,o.f_tien_nt=g.app_info.options.f_tien||0):(o.f_gia_nt=g.app_info.options.f_gia_nt||2,o.f_tien_nt=g.app_info.options.f_tien_nt||2),o.round=o.f_tien_nt,o.$watch("data.ty_gia",function(){1==o.data.ty_gia?(o.f_gia_nt=g.app_info.options.f_gia||0,o.f_tien_nt=g.app_info.options.f_tien||0):(o.f_gia_nt=g.app_info.options.f_gia_nt||2,o.f_tien_nt=g.app_info.options.f_tien_nt||2),o.round=o.f_tien_nt})),d.init&&d.init(o,c,{$http:l}),d.initAddController&&d.initAddController(c,o,l,u,s,p),r.onAdd&&g.nextTick(function(){r.onAdd(o,{$controller:c,$rootScope:g,$http:l,service:u,$location:s,config:p,$window:f,$uibModal:n})}),r.onInput&&r.onInput(o,{$controller:c,$rootScope:g,$http:l,service:u,$location:s,config:p,$window:f,$uibModal:n,$q:y,app_info:g.app_info||{options:{}}}),$(function(){o.isDataLoaded=!0},100)})};o.isUnchanged=function(){return angular.equals(o.data,o.masterData)};var S=function(t,n,a){return o.isSave?g.alert("Chương trình đang thực hiện"):(o.isSave=!0,o.$emit("$dataSaveStart"),void u.create(id_app,o.data).then(function(i){var c=i.data;o.masterData=c,_.extend(o.data,c),p.list||(p.list=[]),p.list.push(o.masterData),e&&e(o.masterData),n&&n(c),o.isSave=!1,o.$emit("$dataSaveSuccess"),r.onSaved&&r.onSaved(o,c,{$rootScope:g}),o.printRpt&&t?r.onPrint?r.onPrint(o,function(){o.printRpt("",c),a&&a.newAfterSave?w():h.close()}):(o.printRpt("",c),a&&a.newAfterSave?w():h.close()):a&&a.newAfterSave?w():h.close()},function(t){o.isSave=!1;var n=t.data;o.$emit("$dataSaveError");var e=n;e.indexOf("Lỗi")<0&&(e.indexOf("duplicate")>=0?e="Lỗi: Đã tồn tại":e.indexOf("Not allowed")>=0&&(e="Lỗi: Bạn không có quyền thực hiện thao tác này")),angular.isArray(e)?g.alert(e.join("\n")):(e||(e="Không thể kết nối với máy chủ. Hãy thử lại."),g.alert(e))}))};o.create=function(t,e,a){r.onSave?r.onSave(o,o.data,{action:"CREATE",$controller:c,$rootScope:g,$http:l,service:u,$location:s,config:p,$window:f,$uibModal:n},function(n,i){return n?g.alert(n):void(i&&S(t,e,a))},a):S(t,e,a)},o.createAndAdd=function(t,n){o.create(t,n,{newAfterSave:!0})},o.cancel=function(){h.close(),i&&i()},w(),o.$on("backbutton",function(){o.cancel()})}],size:r.modal_size||"sm",backdrop:"static",resolve:{}})},this.quickupdate=function(t,n,e){t.update(id_app,n._id,n).then(function(t){e(null,t.data)},function(t){var n=t.data;e(n)})},this.quickedit=function(n,e,a,i){var o=_.filter(_.values(cmdmodules),function(n){return n.path.toLowerCase()===t});if(o.length>0&&!_.find(o,function(t){return t.command.visible}))return void n.open({templateUrl:"templates/sys/alert.html",controller:["$scope","$uibModalInstance",function(t,n){t.msg="Bạn không có quyền sử dụng tính năng này.",t.dismiss=function(){n.close()}}],size:"sm"});var c;_.isObject(e)||(e={_id:e}),c=e._id;n.open({templateUrl:"templates/"+d.group+"/"+t+"/templates/dialog-quickadd.html",controller:["$scope","$controller","$http",t,"$location",t+"Config","$uibModalInstance","$window","$routeParams","$timeout","$rootScope","appInfo","options","vPrint","$q",function(o,l,u,s,p,h,f,g,m,v,k,$,b,y,w){initLabel(k,o,$,t,u),o.data=e,o._data=e,o.Ui=k.Ui,o.STP=STP,o.vPrint=y,d.init&&d.init(o,l,{$http:u}),k.nextTick(function(){s.get(id_app,c).then(function(e){var $=e.data;if(!$)return k.alert("Đối tượng này không tồn tại\nid:"+c),void f.close();o.masterData=$,_.extend(o.data,$),o.$uibModal=n,o.$http=u,o.$window=g,o.action="Sửa",b.load(id_app,{filter:{id_func:t}}).then(function(t){var n=t.data;if(1==n.length){var e=n[0];o.ext_options={};for(var a in e.option)e.option[a]&&(o.ext_options[a]=e.option[a]);o.data.options=o.ext_options,o.masterData.options=o.ext_options}}),d.loadItem&&d.loadItem(o,o.data),v(function(){o.isDataLoaded=!0},100),angular.extend(o,h),k.app_info&&k.app_info.options&&(o.f_sl=k.app_info.options.f_sl||2,o.f_ty_gia=k.app_info.options.f_ty_gia||0,o.f_gia=k.app_info.options.f_gia||0,o.f_tien=k.app_info.options.f_tien||0,1==o.data.ty_gia?(o.f_gia_nt=k.app_info.options.f_gia||0,o.f_tien_nt=k.app_info.options.f_tien||0):(o.f_gia_nt=k.app_info.options.f_gia_nt||2,o.f_tien_nt=k.app_info.options.f_tien_nt||2),o.round=o.f_tien_nt,o.$watch("data.ty_gia",function(){1==o.data.ty_gia?(o.f_gia_nt=k.app_info.options.f_gia||0,o.f_tien_nt=k.app_info.options.f_tien||0):(o.f_gia_nt=k.app_info.options.f_gia_nt||2,o.f_tien_nt=k.app_info.options.f_tien_nt||2),o.round=o.f_tien_nt})),o.isUnchanged=function(){return angular.equals(o.data,o.masterData)},r.onEdit&&k.nextTick(function(){r.onEdit(o,{$controller:l,$rootScope:k,$http:u,service:s,$location:p,config:h,$window:g,$uibModal:n})}),r.onInput&&r.onInput(o,{$controller:l,$rootScope:k,$http:u,service:s,$location:p,config:h,$window:g,$uibModal:n,$q:w,app_info:k.app_info||{options:{}}});var y=function(t,n){return o.isSave?k.alert("Chương trình đang thực hiện"):(o.isSave=!0,o.$emit("$dataSaveStart"),void s.update(id_app,c,o.data).then(function(e){var i=e.data;for(var c in i)o.masterData[c]=i[c];_.extend(o.data,i),a&&a(o.masterData),f.close(),o.$emit("$dataSaveSuccess"),r.onSaved&&r.onSaved(o,i,{$rootScope:k}),o.printRpt&&t&&(r.onPrint?r.onPrint(o,function(){o.printRpt("",i)}):o.printRpt("",i)),o.isSave=!1,n&&n(i)},function(t){o.isSave=!1;var n=t.data;o.$emit("$dataSaveError");var e=JSON.stringify(n);if(e.indexOf("Lỗi")<0){if(e.indexOf("duplicate")>=0)return e="Lỗi: Đã tồn tại",k.alert(e);if(e.indexOf("Not allowed")>=0)return e="Lỗi: Bạn không có quyền thực hiện thao tác này",k.alert(e)}e=JSON.parse(e),angular.isArray(e)?k.alert(e.join("\n")):(e||(e="Lỗi: Không thể kết nối với máy chủ. Hãy thử lại."),k.alert(e))}))};o.create=function(t,e){r.onSave?r.onSave(o,o.data,{action:"UPDATE",$controller:l,$rootScope:k,$http:u,service:s,$location:p,config:h,$window:g,$uibModal:n},function(n,a){return n?k.alert(n):void(a&&y(t,e))}):y(t,e)},o.delete=function(t){k.confirm("Có chắc chắn xoá không?").then(function(n){var e=n;1==e&&s.delete(id_app,t._id).then(function(t){var n=t.data;h.list=_.reject(h.list,function(t){return t._id==n._id}),i&&i(n),a&&a(n,"delete"),f.close(),o.$emit("$dataSaveSuccess")},function(t){o.$emit("$dataSaveError");var n,e=t.data;n=_.isObject(e)?JSON.stringify(e):e,k.alert(n.indexOf("Lỗi:")>=0?n:"Không thể xóa")})})},o.cancel=function(){f.close()},o.$on("backbutton",function(){o.cancel()}),d.initEditController&&d.initEditController(l,o,u,s,p,m,h,v)},function(t){var n=t.data;k.alert(n.indexOf("Lỗi")>=0?n:n||"Không thể tìm thấy đối tượng này"),f.close()})})}],size:r.modal_size||"sm",backdrop:"static",resolve:{}})},this.module.controller(t+"EditController",["$controller","$scope","$http",t,"$location","$routeParams",t+"Config","$timeout","$rootScope","$uibModal","$window","appInfo","options","vPrint","$q",function(n,e,a,i,c,l,u,s,p,h,f,g,m,v,k){p.function_title=o,p.function_code=t,initLabel(p,e,g,t,a),e.masterData=null,e.data={},e.$uibModal=h,e.$http=a,e.$window=f,e.action="Sửa",angular.extend(e,u),d.init&&d.init(e,n,{$http:a}),g.info(t,function(o){if(!o){e.current_user=p.user,e.vPrint=v,u.list&&(e.masterData=_.find(u.list,function(t){return t._id==l.id})),e.openProfile=function(t){viewProfile(h,t)},e.masterData?(e.data=angular.copy(e.masterData),d.loadItem&&d.loadItem(e,e.data),r.onEdit&&p.nextTick(function(){r.onEdit(e,{$controller:n,$http:a,service:i,$location:c,config:u,$window:f,$uibModal:h})}),s(function(){e.isDataLoaded=!0},100)):(e.masterData={},p.nextTick(function(){e.$emit("$dataChangeStart"),i.get(id_app,l.id).then(function(o){var l=o.data;e.masterData=l,e.data=angular.copy(e.masterData),u.list||(u.list=[]),u.list.push(e.masterData),m.load(id_app,{filter:{id_func:t}}).then(function(t){var n=t.data;
if(1==n.length){var a=n[0];e.ext_options={};for(var i in a.option)a.option[i]&&(e.ext_options[i]=a.option[i]);e.data.options=e.ext_options,e.masterData.options=e.ext_options}},function(t){console.log(t.data)}),d.loadItem&&d.loadItem(e,e.data),p.app_info&&p.app_info.options&&(e.f_sl=p.app_info.options.f_sl||2,e.f_ty_gia=p.app_info.options.f_ty_gia||0,e.f_gia=p.app_info.options.f_gia||0,e.f_tien=p.app_info.options.f_tien||0,1==e.data.ty_gia?(e.f_gia_nt=p.app_info.options.f_gia||0,e.f_tien_nt=p.app_info.options.f_tien||0):(e.f_gia_nt=p.app_info.options.f_gia_nt||2,e.f_tien_nt=p.app_info.options.f_tien_nt||2),e.round=e.f_tien_nt,e.$watch("data.ty_gia",function(){1==e.data.ty_gia?(e.f_gia_nt=p.app_info.options.f_gia||0,e.f_tien_nt=p.app_info.options.f_tien||0):(e.f_gia_nt=p.app_info.options.f_gia_nt||2,e.f_tien_nt=p.app_info.options.f_tien_nt||2),e.round=e.f_tien_nt})),r.onEdit&&p.nextTick(function(){r.onEdit(e,{$controller:n,$rootScope:p,$http:a,service:i,$location:c,config:u,$window:f,$uibModal:h})}),r.onInput&&r.onInput(e,{$controller:n,$rootScope:p,$http:a,service:i,$location:c,config:u,$window:f,$uibModal:h,$q:k,app_info:p.app_info||{options:{}}}),s(function(){e.isDataLoaded=!0,e.$emit("$dataChangeSuccess")},100)},function(t){var n=t.data;e.$emit("$dataChangeError"),p.alert(n.indexOf("Lỗi")>=0?n:n||"Không thể tìm thấy đối tượng này")})})),e.isUnchanged=function(){return angular.equals(e.data,e.masterData)},e.reset=function(){e.data=angular.copy(e.masterData)},e.cancel=function(){var t=c.search().redirect;t?"back"==t?f.history.back():c.url(t):r.has_view?c.url("/"+e.path+"/view/"+e.data._id):f.history.back()},e.$on("keydown",function(t,n){n.ctrlKey&&83==n.which&&e.create()});var g=function(t,n){return e.isSave?p.alert("Chương trình đang thực hiện"):(e.isSave=!0,e.$emit("$dataSaveStart"),void i.update(id_app,l.id,e.data).then(function(a){var i=a.data;for(var o in i)e.masterData[o]=i[o];_.extend(e.data,i);var d=c.search().redirect;d?"back"==d?f.history.back():c.url(d):r.has_view?c.url("/"+e.path+"/view/"+i._id):c.path("/"+e.path),e.$emit("$dataSaveSuccess"),r.onSaved&&r.onSaved(e,i,{$rootScope:p}),e.printRpt&&t&&(r.onPrint?r.onPrint(e,function(){e.printRpt("",i)}):e.printRpt("",i)),e.isSave=!1,n&&n(i)},function(t){e.isSave=!1;var n=t.data;e.$emit("$dataSaveError");var a=JSON.stringify(n);if(a.indexOf("Lỗi")<0){if(a.indexOf("duplicate")>=0)return a="Lỗi: Đã tồn tại",p.alert(a);if(a.indexOf("Not allowed")>=0)return a="Lỗi: Bạn không có quyền thực hiện thao tác này",p.alert(a)}a=JSON.parse(a),angular.isArray(a)?p.alert(a.join("\n")):(a||(a="Không thể kết nối với máy chủ. Hãy thử lại."),p.alert(a))}))};e.create=function(t,o){r.onSave?r.onSave(e,e.data,{action:"UPDATE",$controller:n,$rootScope:p,$http:a,service:i,$location:c,config:u,$window:f,$uibModal:h},function(n,e){return n?p.alert(n):void(e&&g(t,o))}):g(t,o)},d.initEditController&&d.initEditController(n,e,a,i,c,l,u,s)}})}]),this.module.controller(t+"ViewController",["$controller","$scope","$routeParams",t+"Config",t,"$rootScope","$location","$window","$http","$uibModal","appInfo","$localStorage","$interval","follow","link","$timeout",function(n,e,a,i,c,l,u,s,p,h,f,g,m,v,k,$){l.function_title=o,l.function_code=t,e.Ui=l.Ui,e.STP=STP,initLabel(l,e,f,t,p),f.info(t,function(o){if(!o){e.code=t,e.location=u.url(),e.current_user=l.user,e.action="Xem",e.current_record=0,e.total_records=0,angular.extend(e,i);var f=function(){l.nextTick(function(){e.$emit("$dataChangeStart"),c.get(id_app,e._id||a.id).then(function(t){var a=t.data;e.data=a,e.data.links=[],id_app&&v.load(id_app,{filter:{id_object:a._id,user_created:e.current_user.email}}).then(function(t){var n=t.data;n&&n.length>0?(a.followObject=n[0],a.follow_yn=1):a.follow_yn=0},function(){a.follow_yn=0}),r.onView&&r.onView(e,{$controller:n,$http:p,service:c,$location:u,config:i,$window:s,$uibModal:h,$rootScope:l,$localStorage:g,$interval:m,$timeout:$}),e.$emit("$dataChangeSuccess")},function(t){console.log("error",t),t.data&&l.alert(t.data),e.$emit("$dataChangeError"),u.url("/"+e.path)})})};if(e.list)for(var b=0;b<e.list.length;b++)if(e.list[b]._id==(e._id||a.id)){e.current_record=b,e.total_records=e.list.length-1,e.data=e.list[e.current_record],e.data.links=[],r.onView&&r.onView(e,{$controller:n,$http:p,service:c,$location:u,config:i,$window:s,$uibModal:h,$rootScope:l,$localStorage:g,$interval:m,$timeout:$});break}e.data||f(),e.back=function(){var t=u.search().redirect;t?"back"==t?s.history.back():u.url(t):u.url("/"+e.path)},e.update=function(t,n){var a={};_.extend(a,e.data),t&&_.extend(a,t),c.update(id_app,e.data._id,a).then(function(t){var a=t.data;e.onUpdated&&e.onUpdated(a),_.extend(e.data,a),n&&(_.isFunction(n)?n(null,a):l.alert(n))},function(t){n&&_.isFunction(n)?n(t.data):t.data&&l.alert(t.data)})},e.edit=function(){d.quickedit(h,e._id||a.id,function(t){_.extend(e.data,t)},function(){e.back()})},e.add=function(){d.quickadd(h,function(n){u.url("/"+t+"/view/"+n._id)},d.defaultvalues)},e.backRecord=function(){if(e.current_record>0){e.current_record=e.current_record-1;var n=e.list[e.current_record]._id;u.path(t+"/view/"+n)}},e.nextRecord=function(){if(e.list&&e.current_record<e.total_records){e.current_record=e.current_record+1;var n=e.list[e.current_record]._id;u.path(t+"/view/"+n)}},e.delete=function(t){l.confirm("Có chắc chắn xoá không?").then(function(n){var a=n;1==a&&c.delete(id_app,t).then(function(n){var a=n.data;if(i.list=_.reject(i.list,function(n){return n._id==t}),e.onDeleted)e.onDeleted(a);else{var o=u.search().redirect;o?"back"==o?s.history.back():u.url(o):u.url("/"+e.path)}},function(t){var n,e=t.data;n=_.isObject(e)?JSON.stringify(e):e,l.alert(n.indexOf("Lỗi:")>=0?n:"Không thể xóa")})})},e.openProfile=function(t){viewProfile(h,t)},e.follow=function(){1==e.data.follow_yn?v.delete(id_app,e.data.followObject._id).then(function(){e.data.follow_yn=0},function(t){t.data&&l.alert(t.data)}):(followObject={id_object:e.data._id,collection_name:t,id_app:id_app},v.create(id_app,followObject).then(function(t){var n=t.data;e.data.followObject=n,e.data.follow_yn=1},function(t){t.data&&l.alert(t.data)}))},e.$on("keydown",function(t,n){if(116==n.which)return void f();if(n.ctrlKey){if(69==n.which)return void e.edit();if(77==n.which)return void e.add()}}),e.$on("backbutton",function(){e.back()}),e.addLink=function(n,a){var i={};i.id_a=e.data._id,i.collection_a=t,i.collection_b=n.collection_name,i.id_b=n._id,k.create(id_app,i).then(function(t){var o=t.data;_.extend(i,o),i.obj=n,i.collection_obj=n.collection_name,i.title=n[a],e.data.links.push(i)},function(t){var o=t.data;console.log(o);var r={id_a:i.id_a,id_b:i.id_b};k.load(id_app,{filter:r}).then(function(t){var o=t.data;o.length>0&&(_.extend(i,o[0]),i.obj=n,i.collection_obj=n.collection_name,i.title=n[a],e.data.links.push(i))})})}}})}]),this.module.directive(d.code+"DetailView",function(){return{restrict:"E",scope:{onDeleted:"=?",onExpand:"&?",onCloseSlide:"&?",onUpdated:"=?"},templateUrl:function(t,n){var e="templates/"+d.group+"/"+d.code+"/templates/"+(n.templateUrl?n.templateUrl:"view")+".html";return e},controller:d.code+"ViewController",link:function(t,n,e){t._id=e.code,t.innerHeight=window.innerHeight-80}}}),this.quickdetailview=function(n,e,a,i){var r;_.isObject(e)||(e={_id:e}),r=e._id;n.open({template:function(){var n=getTemplate(t,"<"+t+'-detail-view on-deleted ="itemDeleted" on-updated ="itemUpdated" code="'+r+'"></'+t+"-detail-view>");return n},controller:["$scope","$uibModalInstance",function(t,n){t.itemDeleted=function(t){i&&i(t),n.close("deleted")},t.itemUpdated=function(t){a&&a(t)},t.close=function(){n.close()},t.title=o,t.innerHeight=window.innerHeight-10}],size:"md",backdrop:"static"})},this.module.config(["$routeProvider","$locationProvider",function(t){t.when("/"+d.code,{templateUrl:"templates/"+d.group+"/"+d.code+"/templates/list.html",controller:d.code+"HomeController"}).when("/"+d.code+"/add",{templateUrl:"templates/"+d.group+"/"+d.code+"/templates/edit.html",controller:d.code+"AddController"}).when("/"+d.code+"/json",{templateUrl:"templates/sys/json.html",controller:d.code+"JsonController"}).when("/"+d.code+"/import",{templateUrl:"templates/sys/import.html",controller:d.code+"ImportController"}).when("/"+d.code+"/edit/:id",{templateUrl:"templates/"+d.group+"/"+d.code+"/templates/edit.html",controller:d.code+"EditController"}).when("/"+d.code+"/view/:id",{templateUrl:"templates/"+d.group+"/"+d.code+"/templates/view.html",controller:d.code+"ViewController"})}]),this.initModule&&this.initModule(this.module)},baseRpt=function(t,n,e,a){t=t.toLowerCase(),STPModules[t]={obj:this,type:"RPT"},this.rptId=t;var i=t+"Module";_.contains(modulesD,i)||modulesD.push(i),this.rptModuleName=i,this.module=angular.module(this.rptModuleName,["ngRoute"]),a||(a={}),a.onInit&&(this.init=a.onInit),a.onAfterLoadData&&(this.afterLoadData=a.onAfterLoadData),a.onFetchData&&(this.fetchData=a.onFetchData),a.onDefaultCondition&&(this.defaultCondition=a.onDefaultCondition),a.onPrepareCondition&&(this.prepareCondition=a.onPrepareCondition),this.getUrl=function(){var t;return t=0==a.require_id_app?server_url_report+"/public/"+n:server_url_report+"/api/"+id_app+"/"+n},this.module.factory(t+"Config",function(){return{}}),this.getData=function(n,e,a,i,o,r,c){var d;r&&(d=r.getCacheFactory(id_app,"report"));var l=STPModules[t].obj.getUrl()+"?t=1";if(o&&(o.error="",o.$emit("$dataChangeStart"),o.running=!0),a&&angular.forEach(a,function(t,n){angular.isDate(t)?(t=moment(t).endOf("date").toDate(),t=JSON.stringify(t).replace(/\"/g,"")):angular.isObject(t)&&(t=JSON.stringify(t)),t&&(l=l+"&"+n+"="+encodeURIComponent(t))}),_online)c&&window.fetch?fetch(l+"&access_token="+access_token+"&jsonstream=1").then(function(t){const n=t.body.getReader(),e=new TextDecoder;var a="";n.read().then(function r(t){return t.done?void 0:(o.$apply(function(){const n=e.decode(t.value,{stream:!0});if(n.indexOf("error")>=0){o.$emit("$dataChangeError"),o.running=!1;try{return i(JSON.parse(n).error)}catch(r){return i(n)}}if("running"===n)console.log("program is streaming....");else if(a+=n,a.endsWith("$$end%")){const c=a.split("$$end%");async.map(c,function(t,n){if(t)try{i(null,JSON.parse(t)),n()}catch(e){n(t)}else n()},function(t){t&&console.log("error parse data",c,t)}),a=""}}),n.read().then(r))}).then(function(){o.$apply(function(){o.$emit("$dataChangeSuccess"),o.running=!1})})}).catch(function(t){console.log("error fetch data",t),o.$apply(function(){if(o.$emit("$dataChangeError"),o.running=!1,t){var n="Lỗi: ";n+=t.message?t.message:t,i(n)}else i("Không thể kết nối với máy chủ")})}):n.get(l,{timeout:18e5}).then(function(n){var e=n.data;if(d)try{d.put(l,e),console.log("CACHED REPORT",l)}catch(a){console.log("can't cache report",a,l)}o&&(o.$emit("$dataChangeSuccess"),o.running=!1),STPModules[t].obj.fetchData&&STPModules[t].obj.fetchData(l,e),i(null,e)},function(t){console.log("error fetch data",t.data);var n=t.data;if(o&&(o.$emit("$dataChangeError"),o.running=!1),n){var e="Lỗi: ";e+=n.message?n.message:JSON.stringify(n),i(e)}else i("Không thể kết nối với máy chủ")});else{if(!d)return o&&(o.$emit("$dataChangeError"),o.running=!1),i("Bạn đang ngoại tuyến. Báo cáo này cần kết nối internet để lấy dữ liệu");console.log("GET DATA FROM CACHED REPORT",l),d.get(l,function(n,e){e?(o&&(o.$emit("$dataChangeSuccess"),o.running=!1),STPModules[t].obj.fetchData&&STPModules[t].obj.fetchData(l,e),i(null,e)):(o&&(o.$emit("$dataChangeError"),o.running=!1),i("Bạn đang ngoại tuyến. Báo cáo này cần kết nối internet để lấy dữ liệu"))})}},this.module.controller(t+"Controller",["$localStorage","$scope","$http","$filter","$location",t+"Config","$controller","$rootScope","$window","appInfo","$uibModal","excel","vPrint",function(n,i,o,r,c,d,l,u,s,p,h,f,g){initLabel(u,i,p,t,o),i.rptId=t,i.isView||(u.function_title=e,u.function_code=t),i.forms={};var m=c.search(),v=t;if(id_app&&(v+=id_app),i.condition||i.isView)i.condition.isDrillDown=!0;else{if(i.condition=n.getObject(v,{}),(!i.condition||_.isEqual(i.condition,{}))&&(i.condition={},STPModules[t].obj.defaultCondition&&STPModules[t].obj.defaultCondition(i.condition)),_.isEqual(m,{})&&d.condition)for(var k in d.condition)c.search(k,d.condition[k]),m[k]=d.condition[k];_.extend(i.condition,m)}STPModules[t].obj.init&&STPModules[t].obj.init(i,o,r,c,d,l),p.info(t,function(s,p,m){if(!s){i.appInfo=m,i.title=e,!i.isView&&d.id_app==id_app&&_.isEqual(i.condition,d.condition)&&(i.data=d.data),i.data?(i.condition_show=!1,STPModules[t].obj.afterLoadData&&STPModules[t].obj.afterLoadData(i,i.data)):i.condition_show=!0,i.viewVoucher=function(t,n){t&&n&&u.openUrl(t.toLowerCase(),{_id:n,_action:"edit"},function(){i.getData()})},i.order=function(t,n){i.data=r("orderBy")(i.data,t,n)};var k=a.stream?1e7:50;i.limit=k,i.begin=0,i.loadPage=function(){i.limit=i.limit+10},i.getData=function(){i.limit=k,a.onStartGetData?a.onStartGetData(i,function(t){t?u.alert(t):i.getDataFromServer()}):i.getDataFromServer()},i.getDataFromServer=function(){if(c.$$search={},!i.isView){n.setObject(v,i.condition);for(var e in i.condition){var l=i.condition[e];angular.isDate(l)&&(l=r("date")(l,"yyyy-MM-dd")),l&&""!=l&&c.search(e,l)}}STPModules[t].obj.prepareCondition?STPModules[t].obj.prepareCondition(i.condition,r,function(n,e){n?i.error=n:(i.data=[],STPModules[t].obj.getData(o,r,e,function(n,e){e?(_.isArray(e)?i.data=i.data.concat(e):i.data.push(e),STPModules[t].obj.afterLoadData&&STPModules[t].obj.afterLoadData(i,i.data)):(i.error=n,n||(i.condition_show=!1,i.isView||(d.condition=c.search(),d.data=e,d.id_app=id_app)))},i,u,a.stream))}):(i.data=[],STPModules[t].obj.getData(o,r,i.condition,function(n,e){e?(_.isArray(e)||(e=[e]),i.data=e.concat(i.data),STPModules[t].obj.afterLoadData&&STPModules[t].obj.afterLoadData(i,i.data)):(i.error=n,n||(i.condition_show=!1,i.isView||(d.condition=c.search(),d.data=e,d.id_app=id_app)))},i,u,a.stream))},i.exportExcel=function(){if(!_online)return void f.tableToExcel("#exportable","Report");var n=STPModules[t].obj.getUrl()+"/excel?access_token="+access_token;STPModules[t].obj.prepareCondition?STPModules[t].obj.prepareCondition(i.condition,r,function(t,a){t?i.error=t:(angular.forEach(a,function(t,e){angular.isDate(t)&&(t=r("date")(t,"yyyy-MM-dd")),angular.isObject(t)&&(t=JSON.stringify(t)),t&&(n=n+"&"+e+"="+encodeURI(t))}),u.toast("Chương trình đang thực hiện. Anh(chị) hãy chờ đợi trong giây lát."),u.downloadFile(n,e+".xlsx",function(t){t&&(console.log(t),f.tableToExcel("#exportable","Report"))}))}):(angular.forEach(i.condition,function(t,e){angular.isDate(t)&&(t=r("date")(t,"yyyy-MM-dd")),angular.isObject(t)&&(t=JSON.stringify(t)),t&&(n=n+"&"+e+"="+encodeURI(t))}),u.toast("Chương trình đang thực hiện. Anh(chị) hãy chờ trong giây lát."),u.downloadFile(n,e+".xlsx",function(t){t&&(console.log(t),f.tableToExcel("#exportable","Report"))}))},a.onLoading&&a.onLoading(i,{$http:o,$filter:r,$location:c,$config:d,$controller:l,$rootScope:u}),i.condition.isDrillDown&&(i.condition_show=!1,i.getData()),i.isLike=!1,id_app&&(o.get(server_url_report+"/api/"+id_app+"/like_module?q={module:'"+t+"'}").then(function(t){var n=t.data;n&&1==n.length&&(i.isLike=n[0].like)},function(t){console.log(t.data)}),i.like=function(){var n=server_url+"/api/"+id_app+"/like_module";o.post(n,{id_app:id_app,module:t,like:!0}).then(function(t){var n=t.data;n&&(i.isLike=!0)},function(t){console.log(t.data)})},i.unlike=function(){var n=server_url+"/api/"+id_app+"/like_module";o.post(n,{id_app:id_app,module:t,like:!1}).then(function(t){var n=t.data;n&&(i.isLike=!1)},function(t){console.log(t.data)})}),i.$on("keydown",function(t,n){if(116==n.which)return void i.getData();if(n.ctrlKey){if(69==n.which)return void i.exportExcel();if(80==n.which)return void i.print()}}),g(t,i),i.options=function(){{var n=t,e=(u.token,"templates/reports/"+n+"/templates/options.html"),a="templates/sys/options-reports.html";h.open({templateUrl:a,controller:["$scope","$controller","$http","$uibModalInstance","$window","$localStorage","options","parentScope","vPrint",function(a,i,o,r,c,d,l,_,s){a.code=n,a.path=e;var h={},f=id_app+"_"+p.email+"_"+n+"_option";a.locals=d.getObject(f,{}),a.locals||(a.locals={system:{}}),a.locals.system||(a.locals.system={}),a.options={},l.load(id_app,{filter:{id_func:n}}).then(function(t){var e=t.data;1==e.length?(h=e[0],a.options=h.option,a.options.check_so_ct||(a.options.check_so_ct="0")):(h.id_app=id_app,h.id_func=n)},function(t){console.log("error when load options",n,t.data)}),a.changeWidthPage=function(t){if(a.options&&a.options.system&&a.options.system.templateRpt){var n=$(a.options.system.templateRpt);"printView"===n.attr("id")?(n.removeAttr("style"),t&&(n.css("width",t+"mm"),n.css("margin","0px auto"))):n=$(t?"<div id='printView' style='width: "+t+"mm; margin: 0px auto;'>"+a.options.system.templateRpt+"</div>":"<div id='printView'>"+a.options.system.templateRpt+"</div>"),a.options.system.templateRpt=n[0].outerHTML}},a.save=function(){if(!a.isSave){a.isSave=!0,a.locals||(a.locals={}),a.options&&a.options.system&&a.options.system.templateRpt&&(a.locals.system.templateRpt=a.options.system.templateRpt);try{d.setObject(f,a.locals)}catch(n){}h.option=a.options,h._id?l.update(id_app,h._id,h).then(function(){s(t,_),r.close(),a.isSave=!1},function(t){u.toast(t.data+"<br/>Chỉ những tùy chọn theo người dùng được lưu.",null,null,null,"error"),r.close(),a.isSave=!1}):l.create(id_app,h).then(function(){s(t,_),r.close(),a.isSave=!1},function(t){u.toast(t.data+"<br/>Chỉ những tùy chọn theo người dùng được lưu.",null,null,null,"error"),r.close(),a.isSave=!1})}},a.cancel=function(){r.close()}}],size:"sm",resolve:{parentScope:function(){return i}}})}}}})}]),this.module.directive(t.split("_").join("")+"ReportView",[function(){return{restrict:"E",scope:{condition:"=?"},templateUrl:function(n,e){return"templates/reports/"+t+"/templates/"+(e.templateUrl?e.templateUrl:"browser")+".html"},controller:["$controller","$scope","$rootScope",function(n,e){e.isView=!0,n(t+"Controller",{$scope:e})}]}}]),this.quickview=function(n,a,i){n.open({template:function(){var n=t.split("_").join("");return"<div  class='modal-header section-info'><button type='button' class='close' ng-click ='close()' aria-hidden='true'> &times;</button><h4 class='modal-title'>{{rpt_title}}</h4></div><div class='modal-body'><div style='height:{{innerHeight-60}}px'><"+n+"-report-view condition ='condition'></"+n+"-report-view></div></div>"},controller:["$rootScope","$scope","$controller","$uibModalInstance","appInfo","$http",function(n,o,r,c,d,l){initLabel(n,o,d,t,l),o.rpt_title=o.getLabel("ten_ct"+t,e).text,o.rpt_code=t,o.condition=a,o.close=function(){i&&i(),c.close()}}],size:"md",backdrop:"static",resolve:{}})},this.module.controller(t+"PrintController",["$controller","appInfo","$scope",t+"Config","$timeout","$location","$rootScope","$http",function(n,a,i,o,r,c,d,l){d.function_title=e,d.function_code=t,initLabel(d,i,a,t,l),a.info(t,function(a,l,_){a||(i.parameters={},i.condition=o.condition,i.title=e,i.data=o.data,i.appInfo=_,STPModules[t].obj.setParameters&&STPModules[t].obj.setParameters(i,n),i.print=function(){i.printing=!0,d.printing=!0,r(function(){window.print(),i.printing=!1,d.printing=!1},100)},i.back=function(){c.url("/"+t)},i.$on("keydown",function(t,n){return n.ctrlKey&&80==n.which?void i.print():void 0}))})}]),this.module.config(["$routeProvider","$locationProvider",function(n){n.when("/"+t,{templateUrl:"templates/reports/"+t+"/templates/browser.html",controller:t+"Controller",reloadOnSearch:!1}).when("/"+t+"/print",{templateUrl:"templates/reports/"+t+"/templates/print.html",controller:t+"PrintController",reloadOnSearch:!1})}])},baseRptLink=function(rptId,path_service,title,options){this.rptId=rptId;var moduleName=rptId+"Module";_.contains(modulesD,moduleName)||modulesD.push(moduleName),this.rptModuleName=moduleName,this.module=angular.module(this.rptModuleName,["ngRoute"]);var rpt=this;options||(options={}),options.onInit&&(rpt.init=options.onInit),options.onAfterLoadData&&(rpt.afterLoadData=options.onAfterLoadData),options.onFetchData&&(rpt.fetchData=options.onFetchData),options.onDefaultCondition&&(rpt.defaultCondition=options.onDefaultCondition),options.onPrepareCondition&&(rpt.prepareCondition=options.onPrepareCondition),this.module.factory(rptId+"Config",function(){return{}}),this.getData=function($http,$filter,condition,callback,$scope){var url=server_url_report+"/api/"+id_app+"/ent-report/"+path_service+"?t=1";$scope&&$scope.$emit("$dataChangeStart");var headers={};condition&&angular.forEach(condition,function(t,n){t&&(angular.isDate(t)?t=t.getFullYear().toString()+"-"+(t.getMonth()+1).toString()+"-"+t.getDate().toString():angular.isObject(t)&&(t=JSON.stringify(t)),url=url+"&"+n+"="+encodeURI(t))}),$http.get(url,{headers:headers,timeout:18e5}).then(function(res){var data=res.data;if(data.indexOf("ERROR")>=0){var error=data;$scope&&$scope.$emit("$dataChangeError"),callback(error)}else{if(_.isString(data))try{data=eval("("+data+")")}catch(e){return callback(e)}callback(null,data),$scope&&$scope.$emit("$dataChangeSuccess"),rpt.fetchData&&rpt.fetchData(url,data)}},function(t){var n=t.data;if($scope&&$scope.$emit("$dataChangeError"),n){var e="Lỗi: ";n.message?e+=n.message:"ECONNREFUSED"==n.code?e=e+"Không thể kết nối với chương trình STP ENTERPISE tại "+$scope.appInfo.stp_api_address:e+=JSON.stringify(n),callback(e)}else callback("Không thể kết nối với chương trình STP ENTERPISE tại "+$scope.appInfo.stp_api_address)})},this.module.controller(rptId+"Controller",["$scope","excel","$http","$filter","$location",rptId+"Config","$controller","$rootScope","$window","appInfo",function(t,n,e,a,i,o,r,c,d,l){c.function_title=title,c.function_code=rptId,initLabel(c,t,l,rptId,e);var u=i.search();if(!t.condition){if(t.condition={},rpt.defaultCondition&&rpt.defaultCondition(t.condition),_.isEqual(u,{})&&o.condition)for(var s in o.condition)i.search(s,o.condition[s]),u[s]=o.condition[s];_.extend(t.condition,u)}rpt.init&&rpt.init(t,e,a,i,o,r),l.info(rptId,function(d,l,s){d||(t.appInfo=s,t.title=title,o.id_app==id_app&&_.isEqual(u,o.condition)&&(t.data=o.data),t.data?(t.condition_show=!1,rpt.afterLoadData&&rpt.afterLoadData(t,t.data)):t.condition_show=!0,t.hideCondition=function(){t.condition_show=!t.condition_show},t.viewVoucher=function(t,n){if(t&&n){var e=t.toLowerCase()+"/edit/"+n+"?redirect=back";i.url(e)}},t.order=function(n,e){t.data=a("orderBy")(t.data,n,e)},t.limit=100,t.begin=0,t.loadPage=function(){t.limit=t.limit+5},t.getData=function(){t.limit=100,options.onStartGetData?options.onStartGetData(t,function(n){n?c.alert(n):t.getDataFromServer()}):t.getDataFromServer()},t.getDataFromServer=function(){i.$$search={};for(var n in t.condition){var r=t.condition[n];angular.isDate(r)&&(r=a("date")(r,"yyyy-MM-dd")),r&&""!=r&&i.search(n,r)}rpt.prepareCondition?rpt.prepareCondition(t.condition,a,function(n,r){n?t.error=n:rpt.getData(e,a,r,function(n,e){t.data=e,t.error=n,n||(t.condition_show=!1,o.condition=i.search(),o.data=e,o.id_app=id_app,rpt.afterLoadData&&rpt.afterLoadData(t,e))},t)}):rpt.getData(e,a,t.condition,function(n,e){t.data=e,t.error=n,n||(t.condition_show=!1,o.condition=i.search(),o.data=e,o.id_app=id_app,rpt.afterLoadData&&rpt.afterLoadData(t,e))},t)},t.exportExcel=function(){n.tableToExcel("#exportable","Report")},options.onLoading&&options.onLoading(t,{$http:e,$filter:a,$location:i,$config:o,$controller:r}),t.condition.isDrillDown&&(t.condition_show=!1,t.getData()),t.isLike=!1,id_app&&(e.get(server_url+"/api/"+id_app+"/like_module?q={module:'"+rptId+"'}").then(function(n){var e=n.data;e&&1==e.length&&(t.isLike=e[0].like)},function(t){console.log(t.data)}),t.like=function(){var n=server_url+"/api/"+id_app+"/like_module";e.post(n,{id_app:id_app,module:rptId,like:!0}).then(function(n){var e=n.data;e&&(t.isLike=!0)},function(t){console.log(t.data)})},t.unlike=function(){var n=server_url+"/api/"+id_app+"/like_module";e.post(n,{id_app:id_app,module:rptId,like:!1}).then(function(n){var e=n.data;e&&(t.isLike=!1)},function(t){console.log(t.data)})}),t.$on("keydown",function(n,e){if(116==e.which)return void t.getData();if(e.ctrlKey){if(69==e.which)return void t.exportExcel();if(80==e.which)return void t.print()}}))})}]),this.module.directive(rptId+"Print",function(){return{restrict:"E",templateUrl:"templates/ent-reports/"+rptId+"/templates/print.html",controller:["$controller","appInfo","$scope",rptId+"Config","$timeout","$location","$rootScope","appInfo","$http",function(t,n,e,a,i,o,r){e.parameters={},e.title=title,rpt.setParameters&&rpt.setParameters(e,t),e.printRpt=function(t){t||(t=title);var n=document.getElementById("printView");if(!n)return r.alert("Mẫu in thiếu id 'printView'");var e=n.innerHTML;r.printS(e,t)}}]}}),this.module.controller(rptId+"PrintController",["$controller","appInfo","$scope",rptId+"Config","$timeout","$location","$rootScope","$http",function(t,n,e,a,i,o,r,c){r.function_title=title,r.function_code=rptId,initLabel(r,e,n,rptId,c),n.info(rptId,function(n,c,d){n||(e.parameters={},e.condition=a.condition,e.title=title,e.data=a.data,e.appInfo=d,rpt.setParameters&&rpt.setParameters(e,t),e.print=function(){e.printing=!0,r.printing=!0,i(function(){window.print(),e.printing=!1,r.printing=!1},100)},e.back=function(){o.url("/"+rptId)},e.$on("keydown",function(t,n){return n.ctrlKey&&80==n.which?void e.print():void 0}))})}]),this.module.filter("sdate",["$filter",function(t){return function(n){var e="";return n&&(e=new Date(n),e&&(e=t("date")(e,"dd/MM/yyyy"))),e}}]),this.module.config(["$routeProvider","$locationProvider",function(t){t.when("/"+rptId,{templateUrl:"templates/ent-reports/"+rptId+"/templates/browser.html",controller:rptId+"Controller",reloadOnSearch:!1}).when("/"+rptId+"/print",{templateUrl:"templates"+rptId+"/templates/print.html",controller:rptId+"PrintController",reloadOnSearch:!1})}])},baseVoucher=function(t,n,e,a,i){var o=this;i||(i={}),e&&0!=e.length||(e=["so_ct","dien_giai","ma_kh","ten_kh"]),i.group="vouchers",i.modal_size||(i.modal_size="lg"),o.watchMaster=i.onWatchMaster,o.defaultValues4Detail=i.onDefaultValues4Detail,o.watchDetail=i.onWatchDetail,o.tinhCkvt=function(t,n,e,a){if(e.ma_vt){var i=server_url_report+"/api/"+id_app+"/ckvt?ma_vt="+e.ma_vt;e.ma_tt1&&(i=i+"&ma_tt1="+e.ma_tt1),e.ma_tt2&&(i=i+"&ma_tt2="+e.ma_tt2),e.ma_tt3&&(i=i+"&ma_tt3="+e.ma_tt3),(a||n.ma_kho||e.ma_kho)&&(i=i+"&ma_kho="+(a||n.ma_kho||e.ma_kho)),n._id&&(i=i+"&id_ct="+n._id),t.get(i).then(function(t){t.data.length>0&&(e.ton_kho=t.data[0].ton)},function(){e.ton_kho=0})}};var r=i.onLoading;i.onLoading=function(t,e){r&&r(t,e),t.updateSoCt=function(){e.$uibModal.open({templateUrl:"templates/sys/update-voucher-number.html",controller:["$scope","$rootScope","appInfo","$uibModalInstance","parentScope","$http",function(t,a,o,r,c,d){initLabel(a,t,o,"DBS",d),t.vcondition={tu_so:1,den_so:999999,tu_ngay:new Date,den_ngay:new Date,post_again:!1},t.list=c.list,t.search=c.search,t.giaodichs=i.giaodichs,t.running=!1,t.okFind=function(){var i=server_url+"/api/"+id_app+"/"+n;t.vcondition.post_again?(i+="/action/postagain",i=i+"?tu_so="+t.vcondition.tu_so,i=i+"&den_so="+t.vcondition.den_so,t.vcondition.ma_gd&&(i=i+"&ma_gd="+t.vcondition.ma_gd),i=i+"&tu_ngay="+e.$filter("date")(t.vcondition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e.$filter("date")(t.vcondition.den_ngay,"yyyy-MM-dd"),t.vcondition.tien_to&&(i=i+"&tien_to="+t.vcondition.tien_to),t.vcondition.hau_to&&(i=i+"&hau_to="+t.vcondition.hau_to),t.running=!0,d.get(i).then(function(){r.close(),t.running=!1,a.alert("Chương trình đã thực hiện xong")},function(n){t.running=!1,a.alert(n.data||"Đã có lỗi xảy . Hãy liên hệ với người quản trị hệ thống để được hỗ trợ")})):(i+="/update/so_ct",i=i+"?tu_so="+t.vcondition.tu_so,i=i+"&den_so="+t.vcondition.den_so,t.vcondition.ma_gd&&(i=i+"&ma_gd="+t.vcondition.ma_gd),i=i+"&tu_ngay="+e.$filter("date")(t.vcondition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e.$filter("date")(t.vcondition.den_ngay,"yyyy-MM-dd"),t.vcondition.tien_to&&(i=i+"&tien_to="+t.vcondition.tien_to),t.vcondition.hau_to&&(i=i+"&hau_to="+t.vcondition.hau_to),t.running=!0,d.get(i).then(function(n){n.data;t.running=!1,r.close(),t.search(),a.alert("Chương trình đã thực hiện xong")},function(n){t.running=!1,a.alert(n.data||"Đã có lỗi xảy . Hãy liên hệ với người quản trị hệ thống để được hỗ trợ")}))},t.cancelFind=function(){r.close()}}],size:"lg",resolve:{parentScope:function(){return t}}})}};var c=i.onEdit;i.onEdit=function(n,e){c&&c(n,e),n.data.details||(n.data.details=[]),n.data.ma_ct=t.toUpperCase(),o.watchMaster&&o.watchMaster(n,e),n.hideListProducts=!0,n.vPrint(t,n)};var d=i.onAdd;i.onAdd=function(n,e){d&&d(n,e),n.data.ngay_ct||(n.data.ngay_ct=new Date,n.data.ma_nt||(n.data.ty_gia=1,n.data.ma_nt="VND")),n.data.details||(n.data.details=[]),n.data.so_ct||e.service.next(id_app,"so_ct").then(function(t){var e=t.data;n.data.so_ct=e.so_ct},function(t){console.log(t.data)}),n.data.ma_ct=t.toUpperCase(),o.watchMaster&&o.watchMaster(n,e),n.vPrint(t,n)},baseInput.call(this,t,n,e,a,i),o.module.directive(t.split("_").join("")+"DetailTable",function(){return{restrict:"E",scope:{ngMasterData:"=",onChange:"&?"},templateUrl:"templates/vouchers/"+t+"/templates/detail-table.html",controller:["$scope","$uibModal","$timeout","$http","$window","$rootScope","appInfo",function(n,e,a,i,r,c,d){initLabel(c,n,d,t,i),n.status={isOpened:!1},n.$uibModal=e,n.$http=i,n.$window=r,n.STP=STP,n.openUrl=c.openUrl,n.app_info=c.app_info,n.f_sl=c.app_info.options.f_sl||2,n.f_ty_gia=c.app_info.options.f_ty_gia||0,n.f_gia=c.app_info.options.f_gia||0,n.f_tien=c.app_info.options.f_tien||0,1==n.ngMasterData.ty_gia?(n.f_gia_nt=c.app_info.options.f_gia||0,n.f_tien_nt=c.app_info.options.f_tien||0):(n.f_gia_nt=c.app_info.options.f_gia_nt||2,n.f_tien_nt=c.app_info.options.f_tien_nt||2),n.round=n.f_tien_nt,n.tinhCkvt=function(t,e){var a=n.ngMasterData||n.data;o.tinhCkvt(i,a,t,e)},n.$watch("ngMasterData.ty_gia",function(){1==n.ngMasterData.ty_gia?(n.f_gia_nt=c.app_info.options.f_gia||0,n.f_tien_nt=c.app_info.options.f_tien||0):(n.f_gia_nt=c.app_info.options.f_gia_nt||2,n.f_tien_nt=c.app_info.options.f_tien_nt||2),n.round=n.f_tien_nt}),o.watchDetail&&o.watchDetail(n,{$rootScope:c,$http:i}),n.isNotRowSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},n.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},n.delete1Row=function(t){var e=_.reject(n.ngMasterData.details,function(n){return n.line===t.line});n.ngMasterData.details.length=0;var a=0;e.forEach(function(t){t.line=a,n.ngMasterData.details.push(t),n.onChange&&n.onChange({$item:t}),a++})},n.addDetail=function(){var t=n.ngMasterData.details.length;n.dt_master=null,n.dt_current={line:t},o.defaultValues4Detail&&_.extend(n.dt_current,o.defaultValues4Detail),n.ngMasterData.options&&_.extend(n.dt_current,n.ngMasterData.options),n.ngMasterData.details||(n.ngMasterData.details=[]),n.openDetail("md")},n.editDetail=function(t){n.dt_master=_.find(n.ngMasterData.details,function(n){return n.line==t}),n.dt_current={},_.extend(n.dt_current,n.dt_master),n.openDetail("md")},n.openDetail=function(i){var r=e.open({templateUrl:"templates/vouchers/"+t+"/templates/detail-edit.html",controller:["$scope","$uibModalInstance","parentScope","$rootScope","$http",function(t,n,e,a,i){o.watchDetail&&o.watchDetail(t,{$rootScope:a,$http:i}),t.tinhCkvt=e.tinhCkvt,t.data=t.ngMasterData=e.ngMasterData,t.status=e.status,t.STP=STP,t.round=e.round,t.f_sl=e.f_sl,t.f_gia=e.f_gia,t.f_tien=e.f_tien,t.f_ty_gia=e.f_ty_gia,t.f_gia_nt=e.f_gia_nt,t.f_tien_nt=e.f_tien_nt,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.app_info=e.app_info,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.data.details.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.close()}}],size:i,resolve:{parentScope:function(){return n}}});r.opened.then(function(){a(function(){n.status.isOpened=!0},300)}),r.result.then(function(){n.status.isOpened=!1
},function(){n.status.isOpened=!1})}}],link:function(){}}})};baseVoucher.prototype=new baseInput;var baseService=function(t,n,e,a,i){var o,r={list:function(i,r,c,d,l,u,s,p,h,f){f&&(a=f);var g=e("list")+"?t=1";if(1==d&&(g+="&count=1"),l&&(g=g+"&page="+l.toString()),u&&(g=g+"&limit="+u.toString()),angular.isObject(r)){var m={};_.extend(m,r),s&&_.extend(m,s),h&&_.extend(m,h),p&&p(m,r);var v=JSON.stringify(m);g=g+"&q="+encodeURIComponent(v)}else if("$text"==a&&r)g=g+"&$text="+encodeURIComponent(JSON.stringify(r));else{var m={};h&&_.extend(m,h),r&&a&&0!=a.length?(m.$or=[],a.forEach(function(t){var n={};n[t]={$regex:r,$options:"i"},m.$or.push(n)})):s&&_.extend(m,s),p&&p(m,r),g=g+"&q="+encodeURIComponent(JSON.stringify(m))}return c&&(g=g+"&fields="+c),o=n.defer(),t.get(g,{timeout:o.promise})},next:function(n,a){return t.get(e()+"/next/"+a)},get:function(n,a){return t.get(e()+"/"+a)},create:function(n,a){return t.post(e(),a)},update:function(n,a,i){return t.put(e()+"/"+a,i)},"delete":function(n,a){return t.delete(e()+"/"+a)},getSocai:function(n,a){return t.get(e("report")+"/socai/"+a)},getVsocai:function(n,a){return t.get(e("report")+"/vsocai/"+a)}};return r.load=function(t,n){var e;return e=n?r.list(t,n.condition,n.fields,n.count,n.page,n.limit,n.queryParams,n.onCondition,n.filter,n.fields_find):r.list(t)},r.load2=function(t,n){var e={cancel:function(t){o.resolve(t)},promise:r.load(t,n)};return e},i&&_.extend(r,i(t)),r},baseService2=function(t,n,e,a,i,o,r){var c,d={list:function(t,a,r,d,l,u,s,p,h,f){f&&(o=f);var g=i("list")+"?t=1";if(_.isObject(a)&&a.sync_from_date&&(g=i("report")+"?t=1"),1==d&&(g+="&count=1"),l&&(g=g+"&page="+l.toString()),u&&(g=g+"&limit="+u.toString()),angular.isObject(a)){var m={};_.extend(m,a),s&&_.extend(m,s),h&&_.extend(m,h),p&&p(m,a);var v=JSON.stringify(m);g=g+"&q="+encodeURIComponent(v)}else if("$text"==o&&a)g=g+"&$text="+encodeURIComponent(JSON.stringify(a));else{var m={};h&&_.extend(m,h),a&&o&&0!=o.length?(m.$or=[],o.forEach(function(t){var n={};n[t]={$regex:a,$options:"i"},m.$or.push(n)})):s&&_.extend(m,s),p&&p(m,a),g=g+"&q="+encodeURIComponent(JSON.stringify(m))}return r&&(g=g+"&fields="+r),c=e.defer(),n.get(g,{timeout:c.promise})},next:function(t,e){return n.get(i()+"/next/"+e)},get:function(r,c){var d=e.defer(),l=t.getCacheFactory(r,a,o);return _online?n.get(i()+"/"+c).then(function(n){t.getCacheFactory(r,a,o).put(c,n.data),d.resolve(n)},function(t){t.data?d.reject(t):l.get(c,function(t,n){n?d.resolve({data:n}):d.reject(t?{data:t}:{data:"KHông thể kết nối với máy chủ. Hãy kiểm tra lại internet của bạn"})})}):l.get(c,function(t,n){n?d.resolve({data:n}):d.reject(t?{data:t}:{data:"KHông thể kết nối với máy chủ. Hãy kiểm tra lại internet của bạn"})}),d.promise},create:function(r,c){var d=e.defer();return _online?(delete c.name_service_need_sync,delete c._id,n.post(i(),c).then(function(n){t.getCacheFactory(r,a,o).put(n.data._id,n.data),d.resolve(n)},function(n){n.data?d.reject(n):(c.tmp_id?c._id=c.tmp_id:(c._id=a+"$$"+(new Date).getTime().toString(),c.tmp_id=c._id),c.name_service_need_sync=a,t.getCacheFactory(r,"tempData").put(c._id,c,function(n){n?(t.getCacheFactory(r,"tempData").remove(c._id),t.getCacheFactory(r,a,o).remove(c._id),d.reject({data:n})):(t.getCacheFactory(r,a,o).put(c._id,c),d.resolve({data:c}))}))})):(c._id=a+"$$"+(new Date).getTime().toString(),c.tmp_id=c._id,c.name_service_need_sync=a,t.getCacheFactory(r,"tempData").put(c._id,c,function(n){n?(t.getCacheFactory(r,"tempData").remove(c._id),t.getCacheFactory(r,a,o).remove(c._id),d.reject({data:n})):(t.getCacheFactory(r,a,o).put(c._id,c),d.resolve({data:c}))})),d.promise},update:function(r,c,d){var l=e.defer();if(_online){delete d.name_service_need_sync;var _;d.tmp_id==c?(delete d._id,_=n.post(i()+"/"+c,d)):_=n.put(i()+"/"+c,d),_.then(function(n){t.getCacheFactory(r,"tempData").remove(d._id),d.tmp_id&&(t.getCacheFactory(r,"tempData").remove(d.tmp_id),t.getCacheFactory(r,a,o).remove(d.tmp_id)),t.getCacheFactory(r,a,o).put(n.data._id,n.data),l.resolve(n)},function(n){n.data?l.reject(n):(d._id||(d._id=c),d.name_service_need_sync=a,t.getCacheFactory(r,"tempData").put(c,d,function(n){n?(t.getCacheFactory(r,"tempData").remove(c),t.getCacheFactory(r,a,o).remove(c),l.reject({data:n})):(t.getCacheFactory(r,a,o).put(c,d),l.resolve({data:d}))}))})}else d.name_service_need_sync=a,t.getCacheFactory(r,"tempData").put(c,d,function(n){n?(t.getCacheFactory(r,"tempData").remove(c),t.getCacheFactory(r,a,o).remove(c),l.reject({data:n})):(t.getCacheFactory(r,a,o).put(c,d),l.resolve({data:d}))});return l.promise},"delete":function(r,c){var d=e.defer();return _online?n.delete(i()+"/"+c).then(function(n){t.getCacheFactory(r,a,o).remove(c),d.resolve(n)},function(n){n.data?d.reject(n):t.getCacheFactory(r,"tempData_deleted").put(c,{_id:c,name_service:a},function(n){n?d.reject({data:n}):(t.getCacheFactory(r,a,o).remove(c),d.resolve({data:1}))})}):t.getCacheFactory(r,"tempData_deleted").put(c,{_id:c,name_service:a},function(n){n?d.reject({data:n}):(t.getCacheFactory(r,a,o).remove(c),d.resolve({data:1}))}),d.promise},deleteAll:function(r){var c=e.defer();return _online?n.delete(i()+"/a/delete/all").then(function(n){t.getCacheFactory(r,a,o).destroy(),c.resolve(n)},function(t){c.reject(t.data?t:{data:"Chắc năng này cần có internet để thực hiện"})}):c.reject({data:"Chắc năng này cần có internet để thực hiện"}),c.promise},getSocai:function(t,e){return n.get(i("report")+"/socai/"+e)},getSokho:function(t,e){return n.get(i("report")+"/sokho/"+e)}};return d.filterOffline=function(n,i){i||(i={condition:""});var r=e.defer();if(i.count)return r.resolve({data:{rows_number:0}}),r.promise;var c=a;i&&i.cacheName&&(c=i.cacheName);var d,l=t.getCacheFactory(n,c,o);return i.condition&&(_.isObject(i.condition)?(d=i.condition.value_for_find,delete i.condition.value_for_find):d=i.condition),l.find(o,d,function(t,n){if(t)return r.reject({data:t});if(0===n.length)r.resolve({data:n});else{var e={};i.filter&&_.extend(e,i.filter),i.queryParams&&_.extend(e,i.queryParams),_.isObject(i.condition)&&_.extend(e,i.condition);var a=_.where(n,e);r.resolve({data:a})}}),r.promise},d.load=function(n,i){var r=t.getCacheFactory(n,a,o),c=e.defer();if(_online){var l;l=i?d.list(n,i.condition,i.fields,i.count,i.page,i.limit,i.queryParams,i.onCondition,i.filter,i.fields_find):d.list(n),l.then(function(n){c.resolve(n),i&&(i.count||i.fields)||async.mapSeries(n.data,function(t,n){t._id?r.put(t._id.toString(),t,function(e){if(e)return n(e);var a=[t.picture,t.picture_thumb];t.exfields&&(a.push(t.exfields.picture),a.push(t.exfields.picture_thumb)),async.mapSeries(a,function(t){if(t&&"APP"!==_platform)try{ImgCache.cacheFile(server_url+t,function(){console.log("Cached image",t),n()})}catch(e){console.error("error cache image",t),n()}else n()},function(t){n(t)})}):n()},function(n){n&&t.toast("Can't cache data for offline, error:"+n)})},function(t){t.data?c.reject(t.data):d.filterOffline(n,i).then(function(t){c.resolve(t)})})}else d.filterOffline(n,i).then(function(t){c.resolve(t)});return c.promise},d.load2=function(t,n){var e={cancel:function(t){c.resolve(t)},promise:d.load(t,n)};return e},d.logs=function(t,e,a){var o=i("report")+"/g/log/"+e+"?t=1";return a&&(a.user&&(o=o+"&user="+a.user),a.tu_ngay&&(a.tu_ngay=new Date(a.tu_ngay),o=o+"&tu_ngay="+moment(a.tu_ngay).format("YYYY-MM-DD")),a.den_ngay&&(a.den_ngay=new Date(a.den_ngay),o=o+"&den_ngay="+moment(a.den_ngay).format("YYYY-MM-DD"))),n.get(o)},r&&_.extend(d,r(n)),d},loginModule=angular.module("loginModule",["ngRoute"]);loginModule.controller("loginController",["$scope","$rootScope","api","$http","$location","user","Base64","$window","$interval","$localStorage","appInfo",function(t,n,e,a,i,o,r,c,d,l,_){n.function_title=MAIN_APPLICATION_NAME,n.function_code="",t.interfaces=interfaces,t.interface=l.get("interface"),initLabel(n,t,_,"login",a),l.set("token",""),l.set("id_app",""),n.app_info=void 0,n.isLogined=!1,n.messages_count=0,n.notifies_count=0,n.task_count=0,id_app=void 0,n.id_app=void 0,n.user=void 0,e.init(),t.data={},t.auth_google=function(t){t||(t="dashboard"),l.set("interface",t);var a=c.open(server_url+"/auth/google","Google authentication"),r=d(function(){try{if(a.location.href&&a.location.href.indexOf("/auth/google/callback")&&a.document.body.innerHTML&&a.document.body.innerHTML.indexOf("access_token")>=0){var c=JSON.parse(a.document.title),_=c.access_token;d.cancel(r),a.close(),l.set("token",_),e.init(_),o.getInfo(function(e){n.interface=t,n.user=e,i.url("/app")})}}catch(u){}},500)},t.auth_facebook=function(t){t||(t="dashboard"),l.set("interface",t);var a=c.open(server_url+"/auth/facebook","Facebook authentication"),r=d(function(){try{if(a.location.href&&a.location.href.indexOf("/auth/facebook/callback")&&a.document.body.innerHTML&&a.document.body.innerHTML.indexOf("access_token")>=0){var c=a.document.title;d.cancel(r),a.close(),l.set("token",c),e.init(c),o.getInfo(function(e){n.interface=t,n.user=e,i.url("/app")})}}catch(_){}},500)},t.auth_local=function(c){c||(c="dashboard"),l.set("interface",c),t.data.username=$("#username").val(),t.data.password=$("#password").val();var d=server_url+"/auth/local",_="Basic "+r.encode(t.data.username+":"+t.data.password);t.isLogin=!0,t.$emit("$dataSaveStart"),t.messageError="";var u=n.getCacheFactory(null,"SYSTEM"),s=d+_;n.error=void 0,_online?a.get(d,{headers:{Authorization:_}}).then(function(r){t.messageError="";var _=r.data;t.isLogin=!1,t.$emit("$dataSaveSuccess"),l.set("token",_),e.init(_),o.getInfo(function(t,e){return t?console.log("error login",t):(n.interface=c,n.user=e,u.put(s,{token:_,user:e},function(t){t?(console.log("error cache token",t),n.toast("Error cache data login"+t)):console.log("cached token")}),d=server_url+"/api/app?access_token="+_,void a.get(d).then(function(t){1===t.data.length&&l.set("id_app",t.data[0]._id),n.openDefaultInterface()},function(){i.url("/app")}))})},function(n){t.messageError=n.data?"Tên đăng nhập hoặc mật khẩu không chính xác":"Chương trình không thể kết nối với máy chủ",t.isLogin=!1,t.$emit("$dataSaveError")}):(t.isLogin=!1,console.log("login offline"),n.user={email:t.data.username},u.get(s,function(a,o){t.$apply(function(){if(!o||a)delete n.user,console.log("error login offline",a,s),t.messageError="Chương trình không thể kết nối với máy chủ",t.$emit("$dataSaveError");else{t.messageError="";var r=o.token;t.isLogin=!1,t.$emit("$dataSaveSuccess"),l.set("token",r),e.init(r),n.user=o.user,n.interface=c,i.url("/app")}})}))},t.signup=function(){i.url("/signup")}}]),loginModule.controller("signupController",["$scope","$rootScope","api","$http","$location","$localStorage","appInfo","$routeParams",function(t,n,e,a,i,o,r,c){n.function_title=MAIN_APPLICATION_NAME,n.function_code="",initLabel(n,t,r,"login",a),o.remove("token"),o.remove("id_app"),n.app_info=void 0,id_app=void 0,n.id_app=void 0,n.isLogined=!1,o.remove("endpoint64"),delete n.commands,delete n.cmdmodules,n.user=void 0,e.init(),n.token=null;var d=o.partner;d||(d=c.invb),t.data={partner:d},t.signup=function(){t.messageError="";var n=server_url+"/signup";a.post(n,t.data).then(function(n){var e=n.data;t.alertType="alert alert-success",t.messageError=e,t.data={}},function(n){t.alertType="alert alert-danger",t.messageError=n.data})}}]);var notificationShowed={};loginModule.factory("user",["$http","$shttp","$localStorage","$rootScope","$location","socket","nodeWebkit","$uibModal","Base64",function(t,n,e,a,i,o,r,c){return{getInfo:function(t){a.user?t(null,a.user):n.get(server_url+"/api/user",{cache:!0}).then(function(n){var i=n.data,d=i.name.split(" ");i.last_name=d[d.length-1],a.error=void 0,a.user=i,e.setObject("currentuser",i),o.on("connect",function(){o.emit("login",{token:i.token,email:i.email})}),o.emit("login",{token:i.token,email:i.email}),o.on("notify:count",function(t){a.notifies_count=t,notificationShowed.so_thong_bao_chua_doc||(notificationShowed.so_thong_bao_chua_doc=1,t&&r.notification("Bạn có "+t.toString()+" thông báo chưa đọc","","/notification"))}),o.on("notify:new",function(t){notificationShowed[t._id+":new"]||(notificationShowed[t._id+":new"]=t,r.notification(t.body,"Thông báo từ "+t.sender,{sender:t.sender,content:t.content,title:t.title,id:t._id,onClick:function(){notificationModule.quickedit(c,t._id)}}))}),o.on("message:count",function(t){a.messages_count=t,notificationShowed.so_tin_nhan_chua_doc||(notificationShowed.so_tin_nhan_chua_doc=1,t&&r.notification("Bạn có "+t.toString()+" tin nhắn chưa đọc","","/message"))}),o.on("message:new",function(t){notificationShowed[t._id+":new"]||(notificationShowed[t._id+":new"]=t,r.notification(t.content,"Tin nhắn từ "+t.sender,"/message/chat/"+t.sender))}),o.on("call:in",function(t){notificationShowed[t._id+":in"]||(notificationShowed[t._id+":in"]=t,dmkhModule.callIn(c,t),t.ten_kh?r.notification(t.ten_kh+" đang gọi...","/dmkh/view/"+t.id_kh):r.notification(t.phone+" đang gọi...","/dmkh/add?dien_thoai="+t.phone))}),o.on("pbl:new",function(t){notificationShowed[t._id+":new"]||(notificationShowed[t._id+":new"]=t,t.id_app===id_app&&0==t.trang_thai&&r.notification("Phiếu đặt chỗ mới","",{url:"/pbl/edit/"+t._id,onClick:function(){pblModule.quickedit(c,t._id)}}))}),o.on("pbl:update",function(t){notificationShowed[t._id+":update"]||(notificationShowed[t._id+":update"]=t,t.id_app===id_app&&0==t.trang_thai&&r.notification("Phiếu đặt chỗ đã được cập nhật","",{url:"/pbl/edit/"+t._id,onClick:function(){pblModule.quickedit(c,t._id)}}))}),o.on("disconnect",function(){}),t(null,i)},function(n){var o,r=n.data;r||(o=e.getObject("currentuser")),o?(a.error=void 0,a.user=o,t(null,o)):(a.error=r,a.user=void 0,t(r),i.url("login"))})},getProfile:function(t,e){if(t.indexOf("guest@")>=0){var i=t.split("@")[1];i=window.atob(i),e(null,{email:t,name:i,picture:"/images/avatar.jpg"})}else{var o=a.getCacheFactory(null,"SYSTEM"),r=server_url+"/api/profile?email="+t;n.get(r,{cache:o}).then(function(t){var n=t.data;e(null,n)},function(t){e(t.data)})}},getProfileByToken:function(t){var e=a.getCacheFactory(null,"SYSTEM"),i=server_url+"/api/profile";n.get(i,{cache:e}).then(function(n){t(null,n.data)},function(n){t(n.data)})},updateProfile:function(n,e){var a=server_url+"/api/updateprofile";t.post(a,n).then(function(t){e(null,t.data)},function(t){e(t.data)})},updatePassword:function(n,e){var a=server_url+"/api/changepassword";t.post(a,n).then(function(t){e(null,t.data)},function(t){e(t.data)})},resetPassword:function(n,e){var a=server_url+"/resetpassword?email="+n;t.get(a).then(function(t){e(null,t.data)},function(t){e(t.data)})},getNotifies:function(t){var e=server_url+"/api/notifies";n.get(e,{cache:!0}).then(function(n){t(null,n.data)},function(n){t(n.data)})},getMessagesColleagues:function(t){var e=server_url+"/api/message/colleague/latest";n.get(e,{cache:!0}).then(function(n){t(null,n.data)},function(n){t(n.data)})},logout:function(n){if(!e.get("token"))return n;var a=server_url+"/api/user/logout";endpoint&&(a=a+"?ep="+endpoint),t.get(a).then(function(t){n(t.data)},function(){n()})}}}]),loginModule.controller("uploadController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams",function(t,n,e,a,i,o,r,c){var d=c.folder;t.action=server_url+"/api/uploadfile?access_token="+e.get("token")+"&folder="+d}]),loginModule.controller("uploadExcelController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams",function(t,n,e){t.action=server_url+"/api/uploadexcel?access_token="+e.get("token")}]),loginModule.controller("profileController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$interval","appInfo","$http",function(t,n,e,a,i,o,r,c,d,l){a.function_title="Thông tin người dùng",a.function_code="profile",initLabel(a,t,d,"login",l),d.info("profile",function(i){if(!i){t.access_token=e.get("token");var o=server_url+"/api/token";n.getProfileByToken(function(n,e){return n?(t.alertType="danger",t.messageError=n):(t.alertType="success",t.data=e,void l.get(o).then(function(n){t.tokens=n.data},function(t){console.log("error when get tokens of user",t.data)}))}),t.deleteToken=function(n){confirm("Bạn chắc chắn muốn xóa token này?")&&l.delete(o+"/"+n).then(function(){t.tokens=_.filter(t.tokens,function(t){return t._id!==n})},function(t){a.alert(t.data||"Không thể kết nối với máy chủ")})},t.updateProfile=function(){t.messageError="",n.updateProfile(t.data,function(n){return n?(t.alertType="danger",t.messageError=n):(t.alertType="success",void(t.messageError="Bạn đã cập nhật thành công!"))})},t.updatePassword=function(){t.messageError="",n.updatePassword({oldPassword:t.oldPassword,newPassword:t.newPassword,reNewPassword:t.reNewPassword},function(n){return n?(t.alertTypeChangePass="danger",t.messageErrorChangePass=n):(t.alertTypeChangePass="success",void(t.messageErrorChangePass="Bạn đã thay đổi mật khẩu thành công!"))})}}})}]),loginModule.controller("resetPasswordController",["$scope","user","$rootScope","$location","app","appInfo","$http",function(t,n,e,a,i,o,r){e.function_title=MAIN_APPLICATION_NAME,e.function_code="",initLabel(e,t,o,"login",r),t.resetPassword=function(){t.messageError="",n.resetPassword(t.email,function(n,e){n?(t.alertType="alert alert-danger",t.messageError=n):(t.alertType="alert alert-success",t.messageError=e)})}}]),loginModule.controller("logoutController",["$scope","$localStorage","api","$location","$rootScope","user","$window","$timeout","appInfo","$http",function(t,n,e,a,i,o,r,c,d,l){i.function_title=MAIN_APPLICATION_NAME,i.function_code="",initLabel(i,t,d,"login",l),o.logout(function(){if(i.token=null,n.remove("token"),n.remove("id_app"),n.remove("endpoint64"),i.app_info=void 0,i.isLogined=!1,id_app=null,i.id_app=void 0,delete i.commands,delete i.cmdmodules,e.init(),a.url("/login"),i.user){var t;if("google"==i.user.server&&(t="https://mail.google.com/mail/u/0/?logout&hl=en"),"facebook"==i.user.server,i.user=void 0,t){var o=r.open(t,"Logout","height=400,width=400");c(function(){o.close()},3e3)}}})}]),loginModule.controller("downloadController",["$scope","$http",function(t,n){n.get(server_url+"/public/versioninfo").then(function(n){t.downloads=n.data})}]),loginModule.config(["$routeProvider","$locationProvider",function(t){t.when("/signup",{templateUrl:"templates/login/templates/signup.html",controller:"signupController"}).when("/resetpassword",{templateUrl:"templates/login/templates/resetpassword.html",controller:"resetPasswordController"}).when("/profile",{templateUrl:"templates/login/templates/profile.html",controller:"profileController"}).when("/login",{templateUrl:"templates/login/templates/login.html",controller:"loginController"}).when("/logout",{templateUrl:"templates/login/templates/callback.html",controller:"logoutController"}).when("/download",{templateUrl:"templates/login/templates/download.html",controller:"downloadController"}).when("/uploadfile/:folder",{templateUrl:"templates/login/templates/upload.html",controller:"uploadController"}).when("/uploadexcel",{templateUrl:"templates/login/templates/upload.html",controller:"uploadExcelController"})}]);var dashboardModule=angular.module("dashboardModule",["ngRoute"]);dashboardModule.controller("homeController",["$scope","$localStorage","user","$rootScope","$location","$timeout","$shttp","api","$window","$interval","appInfo","$uibModal","$filter","$routeParams","options",function(t,n,e,a,i,o,r,c,d,l,_,u,s,p,h){if(a.function_title="Bảng điều khiển",a.function_code="dashboard",a.interface=n.get("interface"),t.model={title:" ",structure:"4-8",rows:[]},initLabel(a,t,_,"DBC",r),p.invb&&n.set("partner",p.invb),!("/download"==i.url().toLowerCase()||i.url().toLowerCase().indexOf("/signup")>=0||i.url().toLowerCase().indexOf("/support")>=0)){if(i.url().indexOf("/~lg/")>=0){a.chv=!0;var f,g,m=i.url().split("/"),v="dashboard";if(m.length>=4&&(g=m[2],f=m[3],m.length>4)){v="";for(var k=4;k<m.length;k++)v=v?v+"/"+m[k]:m[k]}if(g)return n.set("token",g),n.set("id_app",f),c.init(g),void e.getInfo(function(){i.url("/"+v)})}return n.get("token")?void(("/dashboard"==i.url()||"/"==i.url())&&_.info("/dashboard",function(n,e,a){if(n)return void i.url("/login");t.appInfo=a;var o,r;r="DASHBOARD-"+e.email,h.load(f,{condition:{id_func:r}}).then(function(n){n.data.length>0?(t.model=n.data[0].option&&n.data[0].option.model?n.data[0].option.model:JSON.parse(JSON.stringify(dashboarModelDefault)),o=n.data[0]._id):t.model=JSON.parse(JSON.stringify(dashboarModelDefault))},function(t){console.log(t.data)}),t.$on("adfDashboardChanged",function(t,n,e){e&&(o?h.update(f,o,{option:{model:e}}).then(function(){console.log("updated dashboard options")},function(t){console.log("Error update dashboard options",t.data)}):(console.log("create dashboard",e),h.create(f,{option:{model:e},id_app:f,id_func:r}).then(function(t){o=t.data._id},function(t){console.log("Error create dashboard options",t.data)})))})})):(i.url().toLowerCase().indexOf("/login")<0&&i.url().toLowerCase().indexOf("/logout")<0&&i.url().toLowerCase().indexOf("/signup")<0&&(a.w_redirect=i.url()),void i.url("/login"))}}]),dashboardModule.controller("dxdController",["$scope",function(){}]),dashboardModule.controller("adminController",["appInfo","$location","$rootScope","$scope","$http","$uibModal",function(t,n,e,a,i,o){e.function_title="Adminstrator",e.function_code="administrator",initLabel(e,a,t,"DSB",i),t.info("admin",function(t){return t?void n.url("/login"):void(a.broadcast=function(){o.open({templateUrl:"templates/dashboard/templates/broadcast.html",controller:["$scope","$rootScope","$uibModalInstance",function(t,n,e){t.msg={message:"",title:""},t.dismiss=function(){e.close()},t.send=function(){if(t.msg.message&&t.msg.title){var e=server_url+"/api/notification/broadcast";i.post(e,t.msg).then(function(t){n.alert(t.data)},function(t){n.alert(t.data||"Can't connect to server")})}}}],size:"sm",backdrop:"static"})})})}]),dashboardModule.config(["$routeProvider","$locationProvider","$httpProvider",function(t){t.when("/",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"}).when("/lg/:id_app",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"}).when("/dxd",{templateUrl:"templates/dashboard/templates/dxd.html",controller:"dxdController"}).when("/admin",{templateUrl:"templates/dashboard/templates/admin.html",controller:"adminController"}).when("/dashboard",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"})}]);var appModule_edit_add=function(t,n){t.addUser=function(){n.$uibModal.open({templateUrl:"templates/lists/app/templates/add-user.html",controller:["$scope","$controller","$http","$location","parentScope","$uibModalInstance","$window","$routeParams","$timeout","$rootScope",function(t,n,e,a,i,o,r,c,d,l){t.save=function(){e.get(server_url+"/check-user/"+t.email_coll).then(function(n){var a=n.data,r={email:t.email_coll,name:t.name_coll,password:t.password,rePassword:t.re_password};a?i.addParticipant({name_coll:t.name_coll,email_coll:t.email_coll,picture_coll:a.picture,group_id:t.group_id,admin:t.admin},function(t){t||o.close()}):t.auto_create_user&&e.post(server_url+"/signup",r).then(function(n){var e=n.data;l.alert(e),i.addParticipant({name_coll:r.name,email_coll:r.email,group_id:t.group_id,admin:t.admin},function(t){t||o.close()})},function(t){l.alert(t.data)})},function(t){l.alert(t.data)})},t.cancel=function(){o.close()}}],size:"md",backdrop:"static",resolve:{parentScope:function(){return t}}})}},appModule=new baseInput("app","app",["name"],"Thông tin đơn vị, doanh nghiệp",{modal_size:"md",services:function(t){var n={active:function(n){return t.get(server_url+"/api/app/active/"+n)},notaccept:function(n){return t.get(server_url+"/api/app/notaccept/"+n)}};return n},onAdd:appModule_edit_add,onEdit:appModule_edit_add,onView:function(t,n){if(appModule_edit_add(t,n),t.onUpdated=function(t){n.$rootScope.app_info&&(n.$rootScope.app_info=JSON.parse(JSON.stringify(t)))},t.current_user.email===t.data.user_created)t.current_user.appAdmin=!0;else{var e=_.find(t.data.participants,function(n){return n.email==t.current_user.email});t.current_user.appAdmin=e&&e.admin?!0:!1}t.sync=function(){var e=server_url_report+"/api/"+id_app+"/sync";t.$emit("$dataChangeStart"),t.syncing=!0,t.error="",n.$http.get(e).then(function(){t.$emit("$dataChangeSuccess"),t.syncing=!1,n.$rootScope.alert("Chương trình đã thực hiện xong")},function(e){t.syncing=!1;var a=e.data;a||(a="Không thể kết nối với máy chủ"),n.$rootScope.alert(a),t.$emit("$dataChangeError")})},t.createLinkVoiIP=function(e){var a=server_url+"/api/app/getTokenForVoiIP/"+e;t.data.voiIPTokens||(t.data.voiIPTokens=[]),n.$http.get(a).then(function(n){t.data.voiIPTokens.push(n.data.token)},function(t){n.$rootScope.alert(t.data)})},t.deleteLinkVoiIP=function(e,a){t.data.voiIPTokens||(t.data.voiIPTokens=[]),t.data.voiIPTokens=_.reject(t.data.voiIPTokens,function(t){return t===a}),t.update(t.data,function(t){return t?n.$rootScope.alert(t):void 0})},t.deleteTokenSTPAPI=function(){t.data.stp_api_token="",t.data.stp_api_address="",t.update(t.data,function(e){return e?n.$rootScope.alert(e):(id_app==t.data._id.toString()&&n.$rootScope.commands.forEach(function(t){"STP"==t.name&&(t.visible=!1)}),void n.$rootScope.alert("Chương trình đã thực hiện xong"))})},t.getTokenSTPAPI=function(){if(t.data.stp_api_address&&t.current_user.appAdmin){var e=t.data.stp_api_address;n.$uibModal.open({templateUrl:"templates/lists/app/templates/loginSTPAPI.html",controller:["$scope","$uibModalInstance","user","$location","$rootScope","$http","parentScope",function(t,n,a,i,o,r,c){t.data={username:"admin"},t.getToken=function(){t.messageError="";var a=server_url+"/api/"+id_app+"/ent-token?address="+e+"&username="+t.data.username+"&password="+t.data.password;r.get(a).then(function(e){var a=e.data;a?a.indexOf("ERROR")>=0?t.messageError=a:(c.data.stp_api_token=a.split('"').join(""),id_app==c.data._id.toString()&&o.commands&&o.commands.forEach(function(t){"STP"==t.name&&(t.visible=!0)}),n.close()):t.messageError="Không thể kết nối với máy chủ"},function(n){t.messageError=n.data?n.data:"Không kết nối được với server API tại "+e})}}],size:"md",resolve:{parentScope:function(){return t}}})}},t.addParticipant=function(e,a){e.picture_coll||(e.picture_coll="/images/avatar.jpg"),a||(a=function(){}),t.participant=void 0,t.data.participants||(t.data.participants=[]);var i=_.find(t.data.participants,function(t){return t.email==e.email_coll});if(i)return n.$rootScope.alert(e.email_coll+" đã tồn tại"),a(e.email_coll+" đã tồn tại");var o=[];t.data.participants.forEach(function(t){o.push(t)}),o.push({email:e.email_coll,name:e.name_coll,picture:e.picture_coll,group_id:e.group_id,admin:e.admin});var r={_id:t.data._id,participants:o};t.update(r,function(i){return i?(n.$rootScope.alert("Không thể thêm người dùng "+e.email_coll+" cho đơn vị này"),console.log(i),a("Không thể thêm người dùng "+e.email_coll+" cho đơn vị này")):(t.data.participants=o,void a())})},t.deleteParticipant=function(e){t.data.participants||(t.data.participants=[]);var a=_.reject(t.data.participants,function(t){return t.email==e}),i={_id:t.data._id,participants:a};t.update(i,function(i){i?(n.$rootScope.alert("Không thể xóa người dùng "+e+" của đơn vị này"),console.log(i)):t.data.participants=a})},t.open=function(e){var a=e._id,i=e.active;i||n.service.active(a).then(function(){},function(t){console.error("Không thể kích hoạt: ",t.data)}),id_app=a,n.$rootScope.app_info=_.find(t.list,function(t){return t._id==a}),n.$rootScope.id_app=a,n.$localStorage.set("id_app",a),n.$rootScope.w_redirect?(w_redirect=n.$rootScope.w_redirect,delete n.$rootScope.w_redirect,n.$location.url(w_redirect)):n.$rootScope.openDefaultInterface()},t.auth_google=function(){var e=n.$window.open(server_url+"/auth/google","Google authentication","height=400,width=400"),a=n.$interval(function(){try{if(e.location.href&&e.location.href.indexOf("/auth/google/callback")&&e.document.body.innerHTML&&e.document.body.innerHTML.indexOf("access_token")>=0){var i=JSON.parse(e.document.title);t.update({google_drive_email:i.email,google_drive_token:i.access_token,google_drive_refresh_token:i.refresh_token},function(e){return e?n.$rootScope.alert(e):void(t.data.google_drive_refresh_token=access_token)}),n.$interval.cancel(a),e.close()}}catch(o){}},500)},t.delete_google_drive=function(){t.update({google_drive_email:"",google_drive_token:"",google_drive_refresh_token:""},function(n){return n?alert(n):void(t.data.google_drive_refresh_token="")})},t.backupApp=function(t){var e=(server_url_backup_restore||server_url)+"/api/app/backup/"+t+"?access_token="+n.$rootScope.token;n.$timeout(function(){n.$rootScope.downloadFile(e,"backup.zip",function(t){t&&console.log("error backup data",t)})},0),n.$rootScope.toast("Chương trình đang sao lưu dữ liệu. Hãy chờ đợi trong giây lát")},t.restoreAppUrl=function(){return(server_url_backup_restore||server_url)+"/api/app/restore/"+id_app+"?access_token="+n.$rootScope.token},t.$on("$fileUploadSuccess",function(t,e){n.$rootScope.toast(e)}),t.$on("$fileUploadError",function(t,e){n.$rootScope.alert("Lỗi: "+e||"Không thể kết nối với máy chủ")})},has_view:!0});appModule.defaultValues={ngay_dn:new Date(2015,0,1),ngay_ks:new Date(2015,0,1),ngay_ky1:new Date(2015,0,1)},appModule.module.controller("initApp",["$scope","$window","$interval","$http",function(){}]),appModule.init=function(t,n){n("initApp",{$scope:t})},appModule.module.controller("baseAppHomeController",["$scope","$location","$localStorage","$rootScope","app","$window",function(t,n,e,a,i){t.detail=function(n,o){o||i.active(n).then(function(){},function(t){console.error("Không thể kích hoạt: ",t.data)}),id_app=n,a.app_info=_.find(t.list,function(t){return t._id==n}),a.id_app=n,e.set("id_app",n),t.view(n)},t.open=function(o,r){r||i.active(o).then(function(){},function(t){console.error("Không thể kích hoạt: ",t.data)}),id_app=o,a.app_info=_.find(t.list,function(t){return t._id==o}),a.id_app=o,e.set("id_app",o),a.w_redirect?(w_redirect=a.w_redirect,delete a.w_redirect,n.url(w_redirect)):a.openDefaultInterface()}}]),appModule.initHomeController=function(t,n){t("baseAppHomeController",{$scope:n})};var initAddEditController=function(t,n){n.addParticipant=function(t,e){e||(e=function(){}),n.participant=void 0,n.data.participants||(n.data.participants=[]);var a=_.find(n.data.participants,function(n){return n.email==t.email_coll});return a?(alert(t.email_coll+" đã tồn tại"),e(t.email_coll+" đã tồn tại")):(n.data.participants.push({email:t.email_coll,name:t.name_coll,picture:t.picture_coll,admin:t.admin,group_id:t.group_id}),void e())},n.deleteParticipant=function(t){n.data.participants||(n.data.participants=[]),n.data.participants=_.reject(n.data.participants,function(n){return n.email==t})}};appModule.initAddController=function(t,n){initAddEditController(t,n)},appModule.initEditController=function(t,n){initAddEditController(t,n)},appModule.module.controller("appsController",["$scope","$rootScope","$routeParams","$http","user","$location","$uibModal","app","appInfo",function(t,n,e,a,i,o,r,c,d){d.info("app",function(n){if(!n){var i=e.email,o=server_url+"/api/app/apps/"+i;a.get(o).then(function(n){var e=n.data;t.list=e}),t.email=i,t.openProfile=function(t){viewProfile(r,t)},t.addDays=function(t){r.open({templateUrl:"templates/lists/app/templates/add-days.html",controller:["$scope","$uibModalInstance","user","$location","$rootScope","app","$window",function(n,e,a,i,o,r){n.so_ngay=30,n.cancel=function(){e.close()},n.save=function(){var a={};_.extend(a,t);var i=a.expire_date;i=!i||a.so_ngay_con_lai<=0?new Date:new Date(i),i.setDate(i.getDate()+n.so_ngay),a.expire_date=i,r.update(a._id,a._id,a).then(function(n){_.extend(t,n.data),e.close()},function(t){o.alert("Không thể thêm ngày sử dụng cho công ty này\n"+t.data)})}}],size:"lg"})}}})}]),appModule.module.controller("queryController",["$scope","$rootScope","$routeParams","$http","user","$location","$uibModal","app","appInfo",function(t,n,e,a,i,o,r,c,d){n.function_title="Query commander",n.function_code="Query",d.info("app",function(n){if(!n){var e=server_url_report+"/api/"+id_app+"/query/";
t.action="find",t.model="socai",t.run=function(){if(t.action&&t.model){t.result=null,t.error=null,t.cols=null;var n=e+t.model+"/"+t.action+"?1=1";t.q&&(n=n+"&q="+t.q),t.limit&&(n=n+"&limit="+t.limit),t.fields&&(n=n+"&fields="+t.fields),a.get(n).then(function(n){t.result=n.data,_.isArray(t.result)&&t.result.length>0&&(t.cols=_.keys(t.result[0]))},function(n){t.error=n.data})}}}})}]),appModule.module.controller("assignController",["$scope","$rootScope","$routeParams","$http","user","$location","app","appInfo","trangthai",function(t,n,e,a,i,o,r,c,d){initLabel(n,t,c,"APP",a),c.info("app",function(i){i||d.load().then(function(r){var c=r.data;t.getTrangthai=function(t){var n=_.filter(c,function(n){return t&&n.ma_ct==t.toUpperCase()});return n||(n=[]),n};var d=e.id_app,l=e.email;t.email=l,t.name=o.search().name,a.get(server_url+"/api/"+d+"/menu").then(function(e){if(e.data){var o=e.data.menu,r={email:l},c=server_url+"/api/"+d+"/right?q="+JSON.stringify(r),u=[];a.get(c).then(function(e){var r=e.data;o.forEach(function(n){"1"==n.type&&n.input.forEach(function(n){if(n.items)n.items.forEach(function(n){n.module=n.module?n.module:n.path;var e=_.find(r,function(t){return t.module==n.module});if(e)for(var a in e)n[a]=e[a];else n.view=!1,n.add=!1,n.update=!1,n.delete=!1,n.print=!1,n.visible=!1;if(_.isArray(n.trang_thai)&&delete n.trang_thai,!n.trang_thai||_.isEqual({},n.trang_thai)){n.trang_thai={};var i=t.getTrangthai(n.module);for(var o in i)n.trang_thai[o.ma_trang_thai]=!1}n.id_app=d,n.email=l,u.push(n)});else{n.module=n.module?n.module:n.path;var e=_.find(r,function(t){return t.module==n.module});if(e)for(var a in e)n[a]=e[a];else n.view=!1,n.add=!1,n.update=!1,n.delete=!1,n.print=!1,n.visible=!1,n.trang_thai={};if(!n.trang_thai){n.trang_thai={};var i=t.getTrangthai(n.module);for(var o in i)n.trang_thai[o.ma_trang_thai]=!1}n.id_app=d,n.email=l,u.push(n)}}),"2"==n.type&&n.input.forEach(function(n){n.items.forEach(function(n){n.module=n.module?n.module:n.path;var e=_.find(r,function(t){return t.module==n.module});if(e)for(var a in e)n[a]=e[a];else n.view=!1,n.add=!1,n.update=!1,n.delete=!1,n.print=!1,n.visible=!1,n.trang_thai={};if(!n.trang_thai){n.trang_thai={};var i=t.getTrangthai(n.module);for(var o in i)n.trang_thai[o.ma_trang_thai]=!1}n.id_app=d,n.email=l,u.push(n)})}),"3"==n.type&&n.input.forEach(function(n){var e=n.items;e.forEach(function(n){n.items.forEach(function(n){n.module=n.module?n.module:n.path;var e=_.find(r,function(t){return t.module==n.module});if(e)for(var a in e)n[a]=e[a];else n.view=!1,n.add=!1,n.update=!1,n.delete=!1,n.print=!1,n.visible=!1,n.trang_thai={};if(!n.trang_thai){n.trang_thai={};var i=t.getTrangthai(n.module);for(var o in i)n.trang_thai[o.ma_trang_thai]=!1}n.id_app=d,n.email=l,u.push(n)})})})}),t.commands=o,t.save=function(){t.$emit("$dataSaveStart"),async.map(u,function(n,e){t.change(n,2,e)},function(e){return e?(t.$emit("$dataSaveError"),n.alert(e)):(t.$emit("$dataSaveSuccess"),void n.alert("Chương trình đã thực hiện xong"))})},t.change=function(t,e,o){e||(e=1),o||(o=function(){});var r,c=server_url+"/api/"+d+"/right";t._id?(c=c+"/"+t._id,r=a.put(c,t)):r=a.post(c,t),r.then(function(n){var e=n.data;for(var a in e)t[a]=e[a];o(null,t)},function(a){2!==e&&n.alert(JSON.stringify(a.data)),o(i+"\n"+t.module+"/"+t.email)})},t.selectAllRight=function(n){n.add=n.sel,n.update=n.sel,n.delete=n.sel,n.view=n.sel,n.viewOfOther=n.sel;for(var e in n.trang_thai)n.trang_thai[e]=n.sel;t.change(n)},t.selectItems=function(n,e){t.items=n,t.group_title=e}},function(){console.log(c)})}},function(t){console.log("error when get command",t.data)})})})}]),appModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/assign/:id_app/:email",{templateUrl:"templates/lists/app/templates/assign.html",controller:"assignController"}).when("/query",{templateUrl:"templates/lists/app/templates/query.html",controller:"queryController"}).when("/apps/:email",{templateUrl:"templates/lists/app/templates/apps.html",controller:"appsController"})}]);var linkModule=new baseInput("link","link",["ma_dvt","ten_dvt"],"link"),followModule=new baseInput("follow","follow",["ma_dvt","ten_dvt"],"Follow"),colleagueModule=new baseInput("colleague","colleague",["email","email_owner"],"Danh sách đồng nghiệp",{services:function(t){return{active:function(n){return t.get(server_url+"/api/colleague/active/"+n)},notaccept:function(n){return t.get(server_url+"/api/colleague/notaccept/"+n)}}}});colleagueModule.module.controller("basecolleagueHomeController",["$scope","$window","$rootScope","colleague","$uibModal",function(t,n,e,a,i){t.unLink=function(t){a.notaccept(t).then(function(){n.location.reload()},function(t){e.alert(t.data)})},t.active=function(t){a.active(t).then(function(){n.location.reload()},function(t){e.alert(t.data)})},t.sendMessage=function(t){messageModule.quickadd(i,function(){},{email_receiver:t})},t.openProfile=function(t){viewProfile(i,t)}}]),colleagueModule.initHomeController=function(t,n){t("basecolleagueHomeController",{$scope:n})},colleagueModule.initAddController=function(t,n){n.data.content="Hãy chấp nhận lời mời tham gia vào mạng lưới của tôi"};var notificationModule=new baseInput("notification","notification",["email_owner","email_sender","email_receiver","content","title"],"Thông báo",{onLoading:function(t,n){t.approve=function(t){if(t){var e=server_url+"/public/approve/"+t._id;n.$http.get(e).then(function(t){n.$rootScope.alert(t.data)},function(t){n.$rootScope.alert("Không thể duyệt yêu cầu này do: "+(t.data||"Không kết nối được với máy chủ"))})}}},onEdit:function(t,n){t.approve=function(t){if(t){var e=server_url+"/public/approve/"+t._id;n.$http.get(e).then(function(t){n.$rootScope.toast(t.data)},function(t){n.$rootScope.alert("Không thể duyệt yêu cầu này do: "+(t.data||"Không kết nối được với máy chủ"))})}},t.markRead=function(e){e.read=!0,n.service.update(id_app,e._id,{_id:e._id,read:!0}).then(function(){t._data&&(t._data.read=!0)},function(t){console.log(t.data)})},t.markRead(t.data)},onView:function(t,n){t.approve=function(t){if(t){var e=server_url+"/public/approve/"+t._id;n.$http.get(e).then(function(t){n.$rootScope.toast(t.data)},function(t){n.$rootScope.alert("Không thể duyệt yêu cầu này do: "+(t.data||"Không kết nối được với máy chủ"))})}},t.data.content=t.data.content.replace(server_url+"/",""),t.data.read||n.service.update(id_app,t.data._id,{_id:t.data._id,read:!0}).then(function(){t.data.read=!0},function(t){console.log(t.data)}),t.condition={read:!1},t.filter=function(){n.$rootScope.nextTick(function(){t.$emit("$dataChangeStart"),n.service.load(id_app,{condition:t.condition,limit:50}).then(function(n){t.notifications=n.data,t.$emit("$dataChangeSuccess")},function(){t.$emit("$dataChangeError")})})},t.filter(),t.viewNotification=function(n){t.data=n,t.notifications=_.reject(t.notifications,function(t){return t._id==n._id})},t.delete=function(e){n.$rootScope.confirm("Bạn có chắc chắn xóa ghi chú này không?").then(function(a){1===a&&n.service.delete(id_app,e._id).then(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==e._id})},function(t){n.$rootScope.alert(t.data)})})},t.markRead=function(e){e.read=!0,n.service.update(id_app,e._id,{_id:e._id,read:!0}).then(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==e._id})},function(t){n.$rootScope.alert(t.data)})}}});notificationModule.module.factory("notification",["$http",function(t){fields_find=["email_receiver","email_owner","email_sender","content","title"];var n={list:function(n,e,a,i,o,r){var c=server_url+"/api/notification?t=1";if(1==i&&(c+="&count=1"),o&&(c=c+"&page="+o.toString()),r&&(c=c+"&limit="+r.toString()),angular.isObject(e)){var d=JSON.stringify(e);c=c+"&q="+d}else if(e&&""!=e.trim()&&fields_find&&0!=fields_find.length){var l="";fields_find.forEach(function(t){l=""==l?t+"="+e:l+"&"+t+"="+e}),""!=l&&(c=c+"&"+l)}return a&&(c=c+"&fields="+a),t.get(c)},get:function(n,e){return t.get(server_url+"/api/notification/"+e)},create:function(n,e){return t.post(server_url+"/api/notification",e)},update:function(n,e,a){return t.put(server_url+"/api/notification/"+e,a)},"delete":function(n,e){return t.delete(server_url+"/api/notification/"+e)},active:function(n){return t.get(server_url+"/api/notification/active/"+n)},notaccept:function(n){return t.get(server_url+"/api/notification/notaccept/"+n)}};return n.load=function(t,e){return e?n.list(t,e.condition,e.fields,e.count,e.page,e.limit):n.list(t)},n}]),notificationModule.module.directive("dbNotify",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/notification/templates/db.html",controller:["$scope","notification","$rootScope","$location","$uibModal","socket","appInfo","nodeWebkit","$http",function(t,n,e,a,i,o,r,c,d){initLabel(e,t,r,"notification",d),r.info("notification",function(i){i||(t.notifications=[],t.now=new Date,t.token=e.token,t.server_url=server_url,t.app_info=e.app_info,t.condition={read:!1},t.filter=function(){e.nextTick(function(){t.$emit("$dataChangeStart"),n.load(id_app,{condition:t.condition,limit:10}).then(function(n){t.notifications=n.data,t.$emit("$dataChangeSuccess")},function(){t.$emit("$dataChangeError")})})},t.viewNotification=function(t){a.url("notification/view/"+t._id+"?redirect=dashboard")},t.delete=function(a){e.confirm("Bạn có chắc chắn xóa ghi chú này không?").then(function(i){1==i&&n.delete(id_app,a._id).then(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==a._id})},function(t){e.alert(t.data)})})},t.markRead=function(a){a.read=!0,n.update(id_app,a._id,a).then(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==a._id})},function(t){e.alert(t.data)})},o.on("notify:new",function(e){n.get(id_app,e).then(function(n){var a=n.data,i=_.find(t.notifications,function(t){return t._id==e});i||(a.is_new=!0,t.notifications.push(a))},function(t){console.error("Can't get notification\n"+t.data)})}),t.filter({}))})}],link:function(){}}});var messageModule=new baseInput("message","message",["email_owner","email_receiver","email_sender","content"],"Tin nhắn",{services:function(t){var n={list:function(n,e,a,i,o,r){var c=["email_owner","email_receiver","email_sender","content"],d=server_url+"/api/message/colleague/list?t=1";if(1==i&&(d+="&count=1"),o&&(d=d+"&page="+o.toString()),r&&(d=d+"&limit="+r.toString()),angular.isObject(e)){var l=JSON.stringify(e);d=d+"&q="+l}else if(e&&""!=e.trim()&&c&&0!=c.length){var _="";c.forEach(function(t){_=""==_?t+"="+e:_+"&"+t+"="+e}),""!=_&&(d=d+"&"+_)}return a&&(d=d+"&fields="+a),t.get(d)},chat:function(n,e){return t.get(server_url+"/api/message/chat/"+e)},support:function(n,e){return t.post(server_url+"/public/support/"+n,e)},get:function(n,e){return t.get(server_url+"/api/message/"+e)},create:function(n,e){return t.post(server_url+"/api/message",e)},update:function(n,e,a){return t.put(server_url+"/api/message/"+e,a)},"delete":function(n,e){return t.delete(server_url+"/api/message/"+e)}};return n.load=function(t,e){return e?n.list(t,e.condition,e.fields,e.count,e.page,e.limit):n.list(t)},n},onAdd:function(t,n){t.data.email_sender||(t.data.email_sender=n.$rootScope.user.email),t.data.email_owner||(t.data.email_owner=n.$rootScope.user.email)},onSaved:function(t,n){n.email_coll=n.email_receiver,n.picture_coll="/images/avatar.jpg",n.name_coll=n.email_receiver,n.latest_message=n.content,n.latest_message_date=n.date_created,n.latest_message_read=!0}});messageModule.module.controller("baseMessageChatController",["$scope","$location","$routeParams","$rootScope","message","$window","$uibModal","socket","user","appInfo","$http",function(t,n,e,a,i,o,r,c,d,l,u){initLabel(a,t,l,"message",u),l.info("message",function(n){if(!n){var o=(a.user.email,e.email);d.getProfile(o,function(n,e){t.profile=n?{email:o,picture:"/images/avatar.jpg",name:o}:e});var l={};c.on("message:new",function(n){l[n._id]||(l[n._id]=n._id,t.profile&&(n.picture_sender=t.profile.picture,n.name_sender=t.profile.name),t.msgs.push(n),i.update(void 0,n._id,{read:!0}).lean().exec(function(){n.read=!0}))}),t.data={},t.data.email_receiver=o,i.chat(void 0,o).then(function(n){t.msgs=n.data,t.msgs.forEach(function(t){t.read||i.update(void 0,t._id,{read:!0}).lean().exec(function(){t.read=!0})})}),t.send=function(){i.create(void 0,t.data).then(function(n){t.data.content="",t.msgs.push(n.data)},function(t){a.alert(t.data)})},t.enter2send=function(n){13==n.keyCode&&t.send()},t.deleteMsg=function(n){a.confirm("Có chắc chắn xóa tin nhắn này không?").then(function(e){1===e&&i.delete(null,n).then(function(){t.msgs=_.reject(t.msgs,function(t){return t._id==n})},function(){alert("Không thể xóa tin  nhắn này")})})},t.openProfile=function(t){messageModule.viewProfile(r,t)}}})}]),messageModule.module.controller("baseMessageHomeController",["$scope","$location","$routeParams","$rootScope","message","$window",function(t,n){t.chat=function(t){var e=t.email_coll;n.url("message/chat/"+e)}}]),messageModule.initHomeController=function(t,n){t("baseMessageHomeController",{$scope:n})},messageModule.module.controller("supportController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams","socket","message",function(t,n,e,a,i,o,r,c,d,l){var u=c.title,s="guest@"+r.btoa(u),p=s;d.on("connect",function(){d.emit("login",{token:s,email:p})}),t.profile={email:s,name:u},t.msgs=[];var h={};d.on("message:new",function(n){h[n._id]||(h[n._id]=n._id,t.msgs.push(n))}),t.data={title:u},t.data.content="",t.send=function(){l.support(s,t.data).then(function(){var n={};_.extend(n,t.data),n.date_created=new Date,n.email_sender=p,n.name_sender=u,n._id=t.msgs.length,t.msgs.push(n),t.data.content=""},function(t){a.alert(t.data)})},t.enter2send=function(n){13==n.keyCode&&t.send()},t.deleteMsg=function(n){t.msgs=_.reject(t.msgs,function(t){return t._id==n})},t.openProfile=function(t){messageModule.viewProfile($uibModal,t)}}]),messageModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/message/chat/:email",{templateUrl:"templates/lists/message/templates/edit.html",controller:"baseMessageChatController"}).when("/support/:title",{templateUrl:"templates/lists/message/templates/support.html",controller:"supportController"})}]);var usersmanagementModule=new baseInput("users","users",["email","name"],"Quản lý người dùng"),rptModule=new baseInput("rpt","rpt",["ma_cn","ten_mau_in"],"Quản lý mẫu in",{cache_data:!1,onAdd:function(t,n){var e=n.$location.search(),a=e.ma_cn;!e.redirect&&a},onEdit:function(t,n){t.data.ma_cn;!n.$location.search().redirect},onLoad:function(){}});rptModule.module.controller("initrpt",["$scope","$window","$interval","$localStorage",function(t,n,e,a){t.action_upload=server_url+"/api/uploadexcel?json=1&access_token="+a.get("token"),t.$on("$fileUploadSuccess",function(n,e){e.fileUrl&&(t.data.file_mau_in=e.fileUrl)}),t.$on("$fileUploadError",function(n,e){t.error=e}),t.changeFile=function(){var a=n.open("#uploadexcel","Upload file","width=600,height=300"),i=e(function(){"success"==a.document.body.innerHTML&&(t.data.file_mau_in=a.document.title,a.close(),e.cancel(i))},100)}}]),rptModule.init=function(t,n){n("initrpt",{$scope:t})};var templaterptModule=new baseInput("templaterpt","templaterpt",["ma_cn","ten_mau_in"],"Quản lý mẫu in",{cache_data:!1,modal_size:"lg",onAdd:function(t,n){var e=n.$location.search(),a=e.ma_cn;!e.redirect&&a,t.data.exfields={width:203,so_lien:1}},onEdit:function(t,n){t.data.ma_cn;!n.$location.search().redirect},onInput:function(t){t.changeWidthPage=function(n){if(t.data.html_code){var e=$(t.data.html_code);"printView"===e.attr("id")?(e.removeAttr("style"),n&&(e.css("width",n+"mm"),e.css("margin","0px auto"))):e=$(n?"<div id='printView' style='width: "+n+"mm; margin: 0px auto;'>"+t.data.html_code+"</div>":"<div id='printView'>"+t.data.html_code+"</div>"),t.data.html_code=e[0].outerHTML}}},onLoad:function(){}}),parameterModule=new baseInput("parameter","parameter",["name"],"Tham số mẫu in",{cache_data:!1,onAdd:function(t){t.data.type="S"},onLoading:function(){}}),commentModule=new baseInput("comment","comment",["title","content"],"Nhận xét, góp ý",{has_view:!0,onCondition:function(t){t.is_reply=!1,t.id_product=null},onView:function(t,n){var e=t.data;t.replies=[e];var a={is_reply:!0,id_topic:e._id};n.service.load(id_app,{condition:a}).then(function(n){var e=n.data;e.forEach(function(n){t.replies.push(n)})},function(t){console.log(t.data)}),t.reply=function(){var a={content:t.content,is_reply:!0,id_topic:e._id,title:e.title};n.service.create(id_app,a).then(function(n){var e=n.data;t.replies.push(e),t.content=""},function(t){console.log(t.data)})},t.quickedit=function(t){commentModule.quickedit(n.$uibModal,t._id,function(n){_.extend(t,n)})},t.deleteReply=function(e){n.$rootScope.confirm("Có chắc chắn xóa không?").then(function(a){1==a&&n.service.delete(id_app,e._id).then(function(){t.replies=_.reject(t.replies,function(t){return e._id==t._id})},function(t){var e;e=_.isObject(t.data)?JSON.stringify(t.data):t.data,n.$rootScope.alert(e.indexOf("Lỗi:")>=0?e:"Không thể xóa")})})}}});commentModule.module.directive("comment",function(){return{restrict:"E",scope:{link:"=",user:"=",title:"@"},templateUrl:"templates/lists/comment/templates/directive.html",link:function(t,n,e){e.user||console.error("comment directive require 'user' attribute"),e.link||console.error("comment directive require 'link' attribute")},controller:["$scope","$http","$window","$uibModal","$rootScope","$location","appInfo","comment",function(t,n,e,a,i,o,r,c){r.info("comment",function(n,e,r){n||(t.token=i.token,t.server_url=server_url,t.user||(t.user=e),t.openProfile=function(t){viewProfile(a,t)},t.getMembers=function(){i.app_info&&i.app_info.participants&&(members=[],r=i.app_info,r.participants&&(members=_.pluck(r.participants,"email")),members.push(r.user_created),t.members=members)},t.deleteComment=function(n){i.confirm("Bạn có chắc chắn xóa nhận xét này không?").then(function(e){1==e&&c.delete(id_app,n._id).then(function(){t.comments=_.reject(t.comments,function(t){return t._id==n._id})},function(t){t&&i.alert(t)})})},t.editComment=function(t){commentModule.quickedit(a,t._id,function(n){_.extend(t,n)})},t.sendComment=function(n){t.title||(t.title="Comment");var e={id_product:t.idLink,title:t.title,content:n,user_created_obj:t.link.user_created,is_reply:!0};e.url_topic=server_url+"/#"+o.url(),t.link.attends&&(e.attends=t.link.attends),c.create(id_app,e).then(function(n){var e=n.data;t.content="",e&&(t.comments||(t.comments=[]),t.comments.push(e))},function(t){t.data&&i.alert(t.data)})},t.load=function(){c.load(id_app,{filter:{id_product:t.idLink}}).then(function(n){t.comments=n.data},function(){})},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load(),t.getMembers())},!0))})}]}}),commentModule.module.directive("commentCount",function(){return{restrict:"A",scope:{link:"="},link:function(t,n){t.$watch("link",function(e){e&&(t.idLink=t.link._id,t.load(function(t){n.text(t)}))},!0)},controller:["$scope","comment",function(t,n){t.load=function(e){n.load(id_app,{filter:{id_product:t.idLink},count:1}).then(function(t){e(t.data.rows_number)},function(){e(0)})}}]}});var versioninfoModule=new baseInput("versioninfo","versioninfo",["os","app","title"],"Quản lý phiên bản các chương trình"),labelinfoModule=new baseInput("labelinfo","labelinfo",["labelid","textid","texte","textv"],"Khai báo nhãn"),tableinfoModule=new baseInput("tableinfo","tableinfo",["code","title","description"],"Khai báo cấu trúc bảng",{modal_size:"lg"}),forminfoModule=new baseInput("forminfo","forminfo",["code","title","description"],"Khai báo cấu trúc form",{modal_size:"lg"}),trangthaiModule=new baseInput("trangthai","trangthai",["ma_ct","ma_trang_thai","ten_trang_thai"],"Trạng thái chứng từ"),licenseModule=new baseInput("license","license",["partner_email","dia_chi","ten_kh_sd","license"],"Quản lý bản quyền sử dụng",{limit:1e3});licenseModule.loading=function(t){t.$watch("list",function(){var n=_.filter(t.list,function(t){return t.active});t.sub_title="Tổng số key đã cấp: "+t.list.length.toString()+" - số key còn hoạt động: "+n.length.toString()}),t.unactive=function(n){n.active=!1,confirm("Bạn có chắc chắn ngừng hoạt động của bản quyền này không?")&&t.update(n)}};var trialinfoModule=new baseInput("trialinfo","trialinfo",["cty_name","address","phone","email"],"Quản lý dùng thử STP",{limit:1e3});trialinfoModule.loading=function(){};var rptobjectModule=new baseInput("rptobject","rptobject",["code_rpt","ma_obj","ten_obj"],"Khai báo đối tượng báo cáo"),optionsModule=new baseInput("options","options",["id_func"],"Tuỳ chọn"),dmkhModule=new baseInput("dmkh","customer",["ma_kh","ten_kh","dia_chi","dien_thoai","fax","email"],"Khách hàng",{modal_size:"md",has_view:!0,onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{id_kh:t.data._id,ten_kh:t.data.ten_kh})}},onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.visible_to=0,t.data.kh_yn=!0,t.data.ncc_yn=!1},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){STPModules.group.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{group_type:"CUSTOMER"}}).then(function(n){t.groups=n.data,t.groups.push({group_name:"Khác"}),t.groups.forEach(function(t){t.sel=!0})}),STPModules.label.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{label_type:"CUSTOMER"}}).then(function(n){t.contactLabels=n.data,t.contactLabels.push({label_name:null}),t.contactLabels.forEach(function(t){t.sel=!0})}),t.members=[],_.extend(t.members,n.$rootScope.members),t.members.push({name:"Khác"}),t.members.forEach(function(t){t.sel=!0})}),t.btn3_click=function(){var e=[];t.list.forEach(function(t){t.email&&t.sel&&(_.find(e,function(n){return n.address==t.email})||e.push({name:t.ten_kh,address:t.email}))}),e.length>0?STPModules.mailschedule.obj.quickadd(n.$uibModal,function(){},{to:e}):alert("Bạn phải chọn ít nhất một liên lạc")},t.searchAVR=function(){if(t.renderCompleted){t.filter={};var n,e,a=new Date;if("d"==t.time&&(n=new Date,e=new Date),"w"==t.time)var i=a.getDate()-a.getDay()+1,n=new Date(a.setDate(i)),e=new Date(a.setDate(n.getDate()+6));if("m"==t.time&&(n=a,n.setDate(1),e=new Date(n.getFullYear(),n.getMonth()+1,0)),"3m"==t.time){var o=a.getMonth(),r=1;r=3>o?0:6>o?3:6>o?6:9,n=new Date(a.getFullYear(),r,1),e=new Date(a.getFullYear(),r+3,0)}if("y"==t.time&&(n=new Date(a.getFullYear(),0,1),e=new Date(a.getFullYear(),11,31)),n&&e&&(n.setHours(0),n.setMinutes(0),n.setSeconds(0),e.setHours(23),e.setMinutes(59),e.setSeconds(0),t.filter.date_created={$gte:n,$lte:e}),delete t.filter.labels,t.contactLabels&&t.contactLabels.length>0){var c=t.contactLabels.filter(function(t){return t.sel});c.length<t.contactLabels.length&&(t.filter.labels={$in:_.pluck(c,"label_name")})}if(delete t.filter.phu_trach,t.members&&t.members.length>0){var d=t.members.filter(function(t){return t.sel});d.length<t.members.length&&(t.filter.phu_trach={$in:_.pluck(d,"email")})}if(delete t.filter.nh_kh,t.groups&&t.groups.length>0){var l=t.groups.filter(function(t){return t.sel});l.length<t.groups.length&&(t.filter.nh_kh={$in:_.pluck(l,"_id")})}t.advCondition.ten_kh?t.filter.$or=[{ten_kh:{$regex:t.advCondition.ten_kh,$options:"i"}},{ma_kh:{$regex:t.advCondition.ten_kh,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_kh,$options:"i"}},{phu_trach:{$regex:t.advCondition.ten_kh,$options:"i"}},{email:{$regex:t.advCondition.ten_kh,$options:"i"}}]:delete t.filter.$or,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.advCondition.ma_so_thue?t.filter.ma_so_thue={$regex:t.advCondition.ma_so_thue,$options:"i"}:delete t.filter.ma_so_thue,t.search()}},t.enter=function(n){13==n.keyCode&&t.searchAVR()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVR()},t.searchGroup=function(n){t.nh_kh=n._id,t.searchAVR()},t.reportByTime=function(n){t.time=n,t.searchAVR()}}});dmkhModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/dmkh/calling",{templateUrl:"templates/sys/callin.html",controller:["$scope","$rootScope","appInfo","$http","$uibModal","$location",function(t,n,e,a,i,o){initLabel(n,t,e,"dmkh",a),e.info("dmkh",function(n){n||(t.data=o.search(),t.data.dien_thoai=t.data.phone,t.data.ten_nguoi_nhan=t.data.ten_kh,t.editKh=function(n){dmkhModule.quickdetailview(i,n.id_kh,function(n){t.data.id_kh=n._id,_.extend(t.data,n)})},t.addKh=function(n){dmkhModule.quickadd(i,function(n){t.data.id_kh=n._id,_.extend(t.data,n)},{dien_thoai:n.phone,ma_kh:n.phone})},t.addTask=function(t){taskModule.quickadd(i,function(){},{id_kh:t.id_kh,ten_kh:t.ten_kh,ma_kh:t.ma_kh})},t.addSo1=function(t){so1Module.quickadd(i,function(){},t)},t.addHd2=function(t){hd2Module.quickadd(i,function(){$uibModalInstance.close()},t)},t.addHd1=function(t){hd1Module.quickadd(i,function(){$uibModalInstance.close()},t)})})}]})}]),dmkhModule.callIn=function(t,n){t.open({templateUrl:"templates/sys/callin.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(e,a,i,o,r,c,d){initLabel(a,e,d,"SYS",o);try{var l=new Audio("audio/alert.mp3");l.play()}catch(u){}e.data=n,e.data.dien_thoai=n.phone,e.data.ten_nguoi_nhan=e.data.ten_kh,e.close=function(){r.close()},e.editKh=function(n){dmkhModule.quickdetailview(t,n.id_kh,function(t){e.data.id_kh=t._id,_.extend(e.data,t)})},e.addKh=function(n){dmkhModule.quickadd(t,function(t){e.data.id_kh=t._id,_.extend(e.data,t)},{dien_thoai:n.phone,ma_kh:n.phone})},e.addTask=function(n){taskModule.quickadd(t,function(){r.close()},{id_kh:n.id_kh,ten_kh:n.ten_kh,ma_kh:n.ma_kh})},e.addSo1=function(n){so1Module.quickadd(t,function(){r.close()},n)},e.addHd2=function(n){hd2Module.quickadd(t,function(){r.close()},n)},e.addHd1=function(n){hd1Module.quickadd(t,function(){r.close()},n)}}],size:"sm",resolve:{parentScope:function(){}}})};var dmnhkhModule=new baseInput("dmnhkh","dmnhkh",["group_name"],"Nhóm khách hàng",{cache_data:!1}),lienheModule=new baseInput("lienhe","lienhe",["ten_lien_he","dia_chi","dien_thoai","email"],"Liên hệ",{has_view:!0,modal_size:"md",onLoading:function(t,n){n.$rootScope.nextTick(function(){STPModules.group.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{group_type:"LIENHE"}}).then(function(n){t.groups=n.data}),STPModules.label.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{label_type:"LIENHE"}}).then(function(n){t.contactLabels=n.data,t.contactLabels.push({label_name:null}),t.contactLabels.forEach(function(t){t.sel=!0})})}),t.advCondition={},t.searchAVR=function(){if(t.renderCompleted){if(t.filter={},t.nh_lh?t.filter.nh_lh=t.nh_lh:delete t.filter.nh_lh,delete t.filter.labels,t.contactLabels&&t.contactLabels.length>0){var n=t.contactLabels.filter(function(t){return t.sel});n.length<t.contactLabels.length&&(t.filter.labels={$in:_.pluck(n,"label_name")})}t.advCondition.ten_lien_he?t.filter.$or=[{ten_lien_he:{$regex:t.advCondition.ten_lien_he,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_lien_he,$options:"i"}},{email:{$regex:t.advCondition.ten_lien_he,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.search()}},t.searchGroup=function(n){t.nh_lh=n._id,t.searchAVR()},t.searchLabel=function(n){t.label_name=n.label_name,t.searchAVR()},t.enter=function(n){13==n.keyCode&&t.searchAVR()},t.btn3_click=function(){var e=[];t.list.forEach(function(t){t.email&&t.sel&&(_.find(e,function(n){return n.address==t.email})||e.push({name:t.ten_lien_he,address:t.email}))}),e.length>0?STPModules.mailschedule.obj.quickadd(n.$uibModal,function(){},{to:e}):n.$rootScope.alert("Bạn phải chọn ít nhất một liên lạc")},t.setLabel=function(){STPModules.label.obj.quickview(n.$uibModal,{label_type:"LIENHE"},function(){},{templateUrl:"list-view",onListItemClick:function(e,a){var i=e.label_name;async.map(_.filter(t.list,function(t){return t.sel}),function(n,e){n.labels||(n.labels=[]),_.find(n.labels,function(t){return t==i})?e():(n.labels.push(i),t.update(n,function(t){e(t)}))},function(e){return e?n.$rootScope.alert(e):(STPModules.label.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{label_type:"LIENHE"}}).then(function(n){t.contactLabels=n.data}),void n.$rootScope.alert("Chương trình đã thực hiện xong"))}),a.close()}})}},onView:function(t,n){t.addCustomer=function(){dmkhModule.quickadd(n.$uibModal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).then(function(n){_.extend(t.data,n.data)}))})}}}),noteModule=new baseInput("note","note",["title","content"],"Ghi chú",{has_view:!0});noteModule.module.directive("note",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/note/templates/directive.html",controller:["$scope","$http","$location","$window","$uibModal","note","appInfo","$rootScope",function(t,n,e,a,i,o,r,c){r.info("note",function(n){n||(t.server_url=server_url,t.token=c.token,t.addNote=function(){noteModule.quickadd(i,function(n){t.notes.push(n)},{id_link:t.idLink})},t.saveNote=function(n){t.$emit("$dataSaveStart");var e={content:n,id_link:t.idLink};o.create(id_app,e).then(function(n){t.notes.push(n.data),t.content="",t.$emit("$dataSaveSuccess")},function(n){console.log(n.data),t.$emit("$dataSaveError")})},t.viewNote=function(t){e.url("/note/view/"+t._id+"?redirect="+e.url())},t.deleteNote=function(n){c.confirm("Bạn có chắc chắn xóa ghi chú này không?").then(function(e){1==e&&o.delete(id_app,n._id).then(function(){t.notes=_.reject(t.notes,function(t){return t._id==n._id})},function(t){t.data&&c.alert(t.data)})})},t.editNote=function(t){noteModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.load=function(){o.load(id_app,{condition:{id_link:t.idLink}}).then(function(n){t.notes=n.data},function(t){t.data&&c.alert(t.data)})},t.openProfile=function(t){viewProfile(i,t)},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load())},!0))})}],link:function(t,n,e){e.link||console.error("note directive require 'link' attribute")}}});var taskModule=new baseInput("task","task",["ten_cv","mieu_ta","location","phu_trach"],"Công việc",{has_view:!0,modal_size:"md",defaultValues:{start_date:moment().startOf("date").toDate(),due_date:moment().endOf("date").toDate()},defaultConditions:{progress:{$lte:1}},onInput:function(t){t.calProgress=function(){var n=_.filter(t.data.todos,function(t){return 1==t.sel});t.max=t.data.todos?t.data.todos.length:0,t.dynamic=n.length},t.calProgress(),t.$watch("data.todos",function(n,e){n&&!_.isEqual(n,e)&&t.calProgress()},!0),t.repeats=[{id:0,name:"Không lặp lại"},{id:1,name:"Hàng ngày"},{id:2,name:"Hàng tháng"},{id:3,name:"Hàng quý"},{id:4,name:"Hàng năm"}],t.addTodo=function(n,e){13==n.keyCode&&e.title&&(t.data.todos=STP.add(t.data.todos,{sel:!1,title:e.title}),e.title="")}},onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.attends=[t.data.phu_trach],t.data.repeat=0,t.data.priority=1,t.data.progress=2,t.data.visible_to=0},onView:function(t,n){t.calProgress=function(){var n=_.filter(t.data.todos,function(t){return 1==t.sel});t.max=t.data.todos?t.data.todos.length:0,t.dynamic=n.length},t.calProgress(),t.$watch("data",function(e,a){e&&!_.isEqual(e,a)&&n.service.update(id_app,t.data._id,t.data).then(function(n){t.calProgress(),t.onUpdated&&t.onUpdated(n.data)
},function(t){t.data&&n.$rootScope.alert(t.data)})},!0),t.addTodo=function(n,e){13==n.keyCode&&e.title&&(t.data.todos=STP.add(t.data.todos,{sel:!1,title:e.title}),e.title="")},t.data.attendInfos=[],t.data.start_date&&(t.data.start_date=new Date(t.data.start_date)),t.data.due_date&&(t.data.due_date=new Date(t.data.due_date)),t.data.attends&&t.data.attends.forEach(function(e){var a=_.find(n.$rootScope.members,function(t){return t.email==e});a&&t.data.attendInfos.push(a)}),t.complete=function(){t.data.progress=2,n.service.update(id_app,t.data._id,t.data).then(function(){},function(t){t.data&&n.$rootScope.alert(t.data)})},t.addContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(n.$uibModal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).then(function(n){_.extend(t.data,n.data)}))})},t.addProject=function(){dmdtModule.quickadd(n.$uibModal,function(e){e.collection_name="dmdt",t.addLink(e,"ten_dt"),t.data.id_dt||(t.data.id_dt=e._id,n.service.update(id_app,t.data._id,t.data).then(function(n){_.extend(t.data,n.data)}))})}},onLoading:function(t,n){t.today=new Date,t.advCondition={},n.$rootScope.nextTick(function(){STPModules.group.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{group_type:"TASK"}}).then(function(n){t.groups=n.data,t.groups.push({group_name:"Khác"}),t.groups.forEach(function(t){t.sel=!0})}),STPModules.label.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{label_type:"TASK"}}).then(function(n){t.contactLabels=n.data,t.contactLabels.push({label_name:null}),t.contactLabels.forEach(function(t){t.sel=!0})}),t.members=[],_.extend(t.members,n.$rootScope.members),t.members.push({name:"Khác"}),t.members.forEach(function(t){t.sel=!0})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!1},{value:3,text:"Tạm dừng",sel:!1},{value:4,text:"Đang chờ",sel:!1}],t.priorities=[{value:1,text:"Ưu tiên cao",sel:!0},{value:2,text:"Ưu tiên trung bình",sel:!0},{value:3,text:"Ưu tiên thấp",sel:!0}],t.searchAVR=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[],e=[];if(t.progresses.forEach(function(t){t.sel&&n.push(t.value)}),t.priorities.forEach(function(t){t.sel&&e.push(t.value)}),t.filter.progress={$in:n},t.filter.priority={$in:e},delete t.filter.labels,t.contactLabels&&t.contactLabels.length>0){var a=t.contactLabels.filter(function(t){return t.sel});a.length<t.contactLabels.length&&(t.filter.labels={$in:_.pluck(a,"label_name")})}if(delete t.filter.phu_trach,t.members&&t.members.length>0){var i=t.members.filter(function(t){return t.sel});i.length<t.members.length&&(t.filter.phu_trach={$in:_.pluck(i,"email")})}if(delete t.filter.nh_cv,t.groups&&t.groups.length>0){var o=t.groups.filter(function(t){return t.sel});o.length<t.groups.length&&(t.filter.nh_cv={$in:_.pluck(o,"_id")})}var r,c,d=new Date,l=t.time;if("d"==l&&(r=moment(d).startOf("date").toDate(),c=moment(d).endOf("date").toDate()),"w"==l)var r=moment(d).startOf("week").toDate(),c=moment(d).endOf("week").toDate();"m"==l&&(r=moment(d).startOf("month").toDate(),c=moment(d).endOf("month").toDate()),"3m"==l&&(r=moment(d).startOf("quarter").toDate(),c=moment(d).endOf("quarter").toDate()),"y"==l&&(r=moment(d).startOf("year").toDate(),c=moment(d).endOf("quarter").toDate()),r&&c?t.filter.start_date={$gte:r,$lte:c}:delete t.filter.start_date,t.advCondition.ten_cv?t.filter.$or=[{ten_cv:{$regex:t.advCondition.ten_cv,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_cv,$options:"i"}},{location:{$regex:t.advCondition.ten_cv,$options:"i"}},{phu_trach:{$regex:t.advCondition.ten_cv,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.ten_dt?t.filter.ten_dt=t.advCondition.ten_dt:delete t.filter.ten_dt,t.advCondition.priority&&(t.filter.priority=t.advCondition.priority),t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.advCondition.start_date&&(t.filter.start_date={$gte:t.advCondition.start_date}),t.advCondition.due_date?t.filter.due_date={$lte:t.advCondition.due_date}:delete t.filter.due_date,t.search()}},t.reportByTime=function(n){t.time=n,t.searchAVR()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVR()},!0),t.$watch("priorities",function(){t.filter_title="Lọc dữ liệu",t.searchAVR()},!0),t.changeProgress=function(t,e){var a={};_.extend(a,t),a.progress=e,n.service.update(id_app,a._id,a).then(function(n){_.extend(t,n.data)},function(t){t.data&&$rootScope.alert(t.data)})},t.enter=function(n){13==n.keyCode&&t.searchAVR()},n.$controller("initCalendar",{$scope:t})}});taskModule.module.controller("initCalendar",["$scope","$compile","$timeout","uiCalendarConfig","$uibModal","task",function(t,n,e,a,i,o){var r=function(t){var n={title:t.ten_cv,draggable:!0,resizable:!0,item:t},e=t.start_date,a=t.due_date;switch(a||(a=t.start_date),n.start=new Date(e),n.end=new Date(a),n.allDay=n.start.getTime()==n.end.getTime(),n.start.getTime()===n.end.getTime()&&n.end.setHours(n.end.getHours()+1),t.priority){case 1:n.type="important";break;case 2:n.type="warning";break;default:n.type="info"}return 2!==t.progress&&(n.className="chuahoanthanh"),n};t.events=[],t.zevents=[],t.eventsF=function(n,e,a,i){t.loadding=!0;var c={start_date:{$gte:n.toDate(),$lte:e.toDate()}};if(t.contactLabels&&t.contactLabels.length>0){var d=t.contactLabels.filter(function(t){return t.sel});d.length<t.contactLabels.length&&(c.labels={$in:_.pluck(d,"label_name")})}if(t.members&&t.members.length>0){var l=t.members.filter(function(t){return t.sel});l.length&&l.length<t.members.length&&(c.phu_trach={$in:_.pluck(l,"email")})}if(t.groups&&t.groups.length>0){var u=t.groups.filter(function(t){return t.sel});u.length<t.groups.length&&(c.nh_cv={$in:_.pluck(u,"_id")})}var s=o.load2(id_app,{condition:c});s.promise.then(function(n){var e=[];t.loadding=!1;var a=n.data;a.forEach(function(t){e.push(r(t))}),i(e)},function(n){t.loadding=!1,i([]);var e=n.data;$rootScope.alert(e?e.message:"Không kết nối được với máy chủ")})},t.eventClick=function(n){t.view(n.item._id)},t.alertOnDrop=function(n,e){t.alertMessage="Event Dropped to make dayDelta "+e},t.alertOnResize=function(n,e){t.alertMessage="Event Resized to make dayDelta "+e},t.addRemoveEventSource=function(t,n){var e=0;angular.forEach(t,function(a,i){t[i]===n&&(t.splice(i,1),e=1)}),0===e&&t.push(n)},t.remove=function(n){t.events.splice(n,1)},t.changeView=function(t,n){a.calendars[n].fullCalendar("changeView",t)},t.renderCalendar=function(t){e(function(){a.calendars[t]&&a.calendars[t].fullCalendar("render")})},t.eventRender=function(e,a){window.DocumentTouch&&document instanceof window.DocumentTouch||a.qtip({content:"<b>"+e.item.ten_cv+"</b><br/>"+e.item.ten_kh+"<br/>by "+e.item.phu_trach,position:{target:"mouse",adjust:{x:10}}}),n(a)(t)};var c=new Date;t.dayClick=function(n){var e=n.startOf("date").toDate(),a=n.endOf("date").toDate();taskModule.quickadd(i,function(n){var e=r(n);c=e.start,t.uiConfig.calendar.defaultDate=c,t.zevents.push(e)},{start_date:e,due_date:a})},t.uiConfig={calendar:{height:"auto",editable:!0,locale:"vi",header:{left:"month agendaWeek agendaDay listMonth",center:"title",right:"prev,next"},defaultDate:c,ignoreTimezone:!0,navLinks:!0,eventLimit:!0,selectable:!0,selectHelper:!0,eventClick:t.eventClick,eventDrop:t.alertOnDrop,eventResize:t.alertOnResize,eventRender:t.eventRender,dayClick:t.dayClick}},t.eventSources=[t.eventsF],t.refresh=function(){c=a.calendars.myCalendar.fullCalendar("getDate"),t.uiConfig.calendar.defaultDate=c,t.zevents.push({})},t.refresh()}]),taskModule.module.directive("task",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/task/templates/directive.html",controller:["$scope","$shttp","$window","$location","$uibModal","appInfo","$rootScope","task",function($scope,$http,$window,$location,$uibModal,appInfo,$rootScope,task){initLabel($rootScope,$scope,appInfo,"TASK",$http),appInfo.info("task",function(e,u,a){if(!e){$scope.server_url=server_url,$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="task:'ten_cv'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t,{cache:!0}).then(function(t){$scope.list=t.data},function(t){t.data&&_online&&$rootScope.alert(t.data)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).then(function(n){_.extend(e,n.data),e.obj=t,e.title=t.title,$scope.list.push(e)},function(){})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(){})},$scope.getItem=function(t,n,e){$scope.addLink(t,e)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),taskModule.quickadd($uibModal,function(t){t.collection_name="task",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="task/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$rootScope.confirm("Bạn có chắc chắn xóa không?").then(function(n){1===n&&task.delete(id_app,t._id).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})})},$scope.edit=function(t){taskModule.quickedit($uibModal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("task directive require attributes:link,collection")}}}),taskModule.module.directive("dbTask",function(){return{restrict:"E",scope:{config:"=?"},templateUrl:"templates/lists/task/templates/db.html",controller:["$scope","task","$rootScope","$location","appInfo","socket","nodeWebkit","$shttp","$uibModal",function(t,n,e,a,i,o,r,c,d){initLabel(e,t,i,"TASK",c),i.info("task",function(a){a||(t.token=e.token,t.server_url=server_url,t.now=new Date,t.getCondition=function(){if(t.condition={status:!0},t.config&&t.config.group&&(t.condition.nh_cv=t.group),t.config&&t.config.my_job&&(t.condition.phu_trach=e.user.email),t.config&&t.config.attends&&(delete t.condition.phu_trach,t.condition.$or=[{phu_trach:e.user.email},{attends:e.user.email}]),t.config&&t.config.progresses){var n=_.filter(t.config.progresses,function(t){return t.sel});t.condition.progress={$in:_.pluck(n,"code")}}},t.app_info=e.app_info,t.filter=function(e){async.nextTick(function(){t.$emit("$dataChangeStart"),t.getCondition(),e&&_.extend(t.condition,e),n.load(id_app,{condition:t.condition,limit:10,cacheName:"tempData"}).then(function(n){t.dscv=n.data,t.dscv.forEach(function(n){n.todo_done=t.getSels(n)}),t.$emit("$dataChangeSuccess")},function(){t.$emit("$dataChangeError")})})},t.searchTask=function(n){if(13===n.keyCode){var e={ten_cv:{$regex:t.task_msg,$options:"i"},progress:{$in:[0,1,2,3,4]}};t.filter(e)}},t.complete=function(t){n.update(id_app,t._id,{progress:2}).then(function(n){_.extend(t,n.data)},function(t){t.data&&e.alert(t.data)})},t.cancel=function(a){n.update(id_app,a._id,{status:!1}).then(function(){t.dscv&&(t.dscv=_.reject(t.dscv,function(t){return t._id==a._id}))},function(t){t.data&&e.alert(t.data)})},t.viewTask=function(n){taskModule.quickdetailview(d,n,function(e){console.log("updated task"),e&&_.extend(n,e),n.todo_done=t.getSels(n)},function(n){console.log("deleted task"),t.dscv=_.filter(t.dscv,function(t){return t._id!==n._id})})},t.addTask=function(n){taskModule.quickadd(d,function(n){t.dscv.push(n)},{ten_cv:n,nh_cv:t.group})},t.getSels=function(t){var n=_.filter(t.todos,function(t){return 1==t.sel});return n.length},t.$watch("options",function(n){n&&t.app_info&&t.filter()},!0),o.on("task:new",function(e){var a=e._id;t.dscv||(t.dscv=[]),n.get(id_app,a).then(function(n){e=n.data;var i=_.find(t.dscv,function(t){return t._id==a});i||(e.is_new=!0,notificationShowed[e._id+":new"]||(notificationShowed[e._id+":new"]=e,r.notification("Bạn có công việc mới","",{url:"/task/view/"+a})),t.dscv.push(e))})}),o.on("task:update",function(e){var a=e._id;t.dscv||(t.dscv=[]),n.get(id_app,a).then(function(n){e=n.data;var i=_.find(t.dscv,function(t){return t._id==a});i?_.extend(i,e):t.dscv.push(e),notificationShowed[e._id+":update"]||(notificationShowed[e._id+":update"]=e,r.notification("Công việc "+e.ten_cv+" đã được cập nhật","",{url:"/task/view/"+a}))})}),t.filter())})}],link:function(){}}}),taskModule.module.directive("taskDashboard",function(){return{restrict:"E",scope:{group:"@?",run:"=?"},templateUrl:"templates/lists/task/templates/task-dashboard.html",controller:["$scope","task","$rootScope","$uibModal","appInfo","socket","nodeWebkit","$shttp","group","$q",function(t,n,e,a,i,o,r,c,d,l){initLabel(e,t,i,"TASK",c),t.deleted=[],t.saveTask=function(a){a&&n.update(id_app,a._id,{saved:!0}).then(function(){t.dscv=_.filter(t.dscv,function(t){return t._id!==a._id}),t.progresses.forEach(function(n){n.list=_.filter(t.dscv,function(t){return t.progress==n.value})}),e.toast("Công việc '"+a.ten_cv+"' đã được lưu trữ","","warning")},function(t){e.alert(t.data||"Không thể kết nối với máy chủ")})},t.dropToDelete=function(n,e){t.saveTask(t.deleted[e])},t.viewTaskSaved=function(){{var e=t.group;a.open({templateUrl:"templates/lists/task/templates/task-saved.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","appInfo","parentScope",function(t,a,i,o,r,c,d){initLabel(a,t,c,"SYS",o);var l={saved:!0};e&&(l.nh_cv=e),n.load(id_app,{condition:l}).then(function(n){t.tasks=n.data},function(t){console.log("error",t.data)}),t.cellClick=function(e,i){i&&"remove"===i.field?n.update(id_app,e._id,{saved:!1}).then(function(){e.saved=!1,d.dscv.push(e),d.progresses.forEach(function(t){t.list=_.filter(d.dscv,function(n){return n.progress==t.value})}),t.tasks=_.filter(t.tasks,function(t){return t._id!==e._id}),a.toast("Công việc '"+e.ten_cv+"' đã bỏ lưu trữ")},function(t){a.alert(t.data||"Không thể kết nối với máy chủ")}):d.viewTask(e)},t.close=function(){r.close()}}],size:"md",resolve:{parentScope:function(){return t}}})}},t.group&&d.get(id_app,t.group).then(function(n){t.currentGroup=n.data}),STPModules.label.obj.getService(c,l,e).load(id_app,{filter:{label_type:"TASK"}}).then(function(n){t.contactLabels=n.data,t.contactLabels.push({label_name:null}),t.contactLabels.forEach(function(t){t.sel=!0})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0,list:[],defaultValues:{progress:0,ten_cv:""}},{value:1,text:"Đang thực hiện",sel:!0,list:[],defaultValues:{progress:1,ten_cv:""}},{value:2,text:"Hoàn thành",sel:!1,list:[],defaultValues:{progress:2,ten_cv:""}},{value:3,text:"Tạm dừng",sel:!1,list:[],defaultValues:{progress:3,ten_cv:""}},{value:4,text:"Đang chờ",sel:!1,list:[],defaultValues:{progress:4,ten_cv:""}}],t.done=function(t){return t?_.filter(t,function(t){return t.sel}).length:0},t.token=e.token,t.server_url=server_url,t.app_info=e.app_info,t.searchKeyup=function(n,e){13==n.keyCode&&t.filter(e?{ten_cv:{$regex:e,$options:"i"}}:{})},t.filter=function(e){async.nextTick(function(){if(t.$emit("$dataChangeStart"),e||(e={}),t.group&&(e.nh_cv=t.group),e.saved=null,t.contactLabels&&t.contactLabels.length>0){var a=t.contactLabels.filter(function(t){return t.sel});a.length<t.contactLabels.length&&(e.labels={$in:_.pluck(a,"label_name")})}if(t.members&&t.members.length>0){var i=t.members.filter(function(t){return t.sel});i.length<t.members.length&&(e.phu_trach={$in:_.pluck(i,"email")})}n.load(id_app,{condition:e,limit:50}).then(function(n){t.dscv=n.data,t.progresses.forEach(function(n){n.list=_.filter(t.dscv,function(t){return t.progress==n.value})}),t.$emit("$dataChangeSuccess")},function(){t.$emit("$dataChangeError")})})},t.models={selected:null},t.itemMoved=function(a,i){a&&a.splice(i,1),t.progresses.forEach(function(a){var i=0;a.list.forEach(function(o){o.progress=a.value,o.exfields||(o.exfields={}),o.stt=i,i+=1,o._id===t.models.selected._id?(_.find(o.attends,function(t){return t==e.user.email})||o.attends.push(e.user.email),n.update(id_app,o._id,{progress:a.value,attends:o.attends,stt:o.stt}).then(function(){},function(t){t.data&&e.alert(t.data)})):n.update(id_app,o._id,{stt:o.stt}).then(function(){},function(t){t.data&&e.alert(t.data)});var r=_.find(t.dscv,function(t){return t._id==o._id});r&&_.extend(r,o)})})},t.viewTask=function(e){STPModules.task.obj.quickdetailview(a,e,function(){n.get(id_app,e._id).then(function(n){var a=_.find(t.dscv,function(t){return t._id==e._id});a&&_.extend(a,n.data),t.progresses.forEach(function(n){n.list=_.filter(t.dscv,function(t){return t.progress==n.value})})})},function(){t.dscv=_.filter(t.dscv,function(t){return t._id!==e._id}),t.progresses.forEach(function(n){n.list=_.filter(t.dscv,function(t){return t.progress==n.value})})})},o.on("task:new",function(e){var a=e._id;t.dscv||(t.dscv=[]),n.get(id_app,a).then(function(n){e=n.data;var i=_.find(t.dscv,function(t){return t._id==a});i||(e.is_new=!0,notificationShowed[e._id+":new"]||(notificationShowed[e._id+":new"]=e,r.notification("Bạn có công việc mới","",{url:"/task/view/"+a})),t.group&&e.nh_cv==t.group&&t.dscv.push(e)),t.progresses.forEach(function(n){n.list=_.filter(t.dscv,function(t){return t.progress==n.value})})})}),o.on("task:update",function(e){var a=e._id;t.dscv||(t.dscv=[]),n.get(id_app,a).then(function(n){e=n.data;var i=_.find(t.dscv,function(t){return t._id==a});i?_.extend(i,e):t.group&&e.nh_cv==t.group&&t.dscv.push(e),notificationShowed[e._id+":update"]||(notificationShowed[e._id+":update"]=e,r.notification("Công việc "+e.ten_cv+" đã được cập nhật","",{url:"/task/view/"+a})),t.progresses.forEach(function(n){n.list=_.filter(t.dscv,function(t){return t.progress==n.value})})})}),t.addToDoItem=function(a,i,o){if(o||13===a.keyCode){var r={};if(i&&(r=_.extend(r,i)),""==r.ten_cv)return;r.start_date=moment().startOf("date").toDate(),r.due_date=r.start_date,r.repeat=0,t.group&&(r.nh_cv=t.group,t.currentGroup&&(r.visible_to=t.currentGroup.visible_to||0,r.visible_to_users=t.currentGroup.visible_to_users)),r.phu_trach=e.user.email,n.create(id_app,r).then(function(n){e.toast("","Công việc '"+r.ten_cv+"' đã được tạo thành công","","success");var a=n.data;t.dscv.push(a),i.ten_cv="",t.progresses.forEach(function(t){t.value===a.progress&&t.list.push(a)})},function(t){alert(t.data)})}},t.run!==!1&&(t.members=[],_.extend(t.members,e.members),t.members.push({name:"Khác"}),t.members.forEach(function(t){t.sel=!0}),t.filter({})),t.$watch("run",function(n){n&&(t.members=[],_.extend(t.members,e.members),t.members.push({name:"Khác"}),t.members.forEach(function(t){t.sel=!0}),t.filter({}))})}],link:function(){}}}),taskModule.module.component("taskGroup",{bindings:{},templateUrl:"templates/lists/task/templates/task-group.html",controller:["group","$rootScope","$uibModal","appInfo",function(t,n,e,a){var i=this;i.openUrl=n.openUrl,i.add=function(){dmnhtaskModule.quickadd(e,function(t){i.list||(i.list=[]),i.list.push(t)},{group_type:"TASK"})},a.info("task",function(n){n||t.load(id_app,{condition:{group_type:"TASK"}}).then(function(t){i.list=t.data})})}]}),taskModule.module.directive("taskCount",function(){return{restrict:"A",scope:{group:"@"},link:function(t,n){t.$watch("group",function(e){e&&t.load(function(t){n.text(t)})},!0),t.$on("$task:add",function(){t.load(function(t){n.text(t)})})},controller:["$scope","task",function(t,n){t.load=function(e){n.load(id_app,{filter:{nh_cv:t.group,saved:null},count:1}).then(function(t){e(t.data.rows_number)},function(){e(0)})}}]}}),taskModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/task/dashboard/:group_id",{template:"<task-dashboard group='{{group}}' run ='run'></task-dashboard>",controller:["appInfo","$scope","$rootScope","$routeParams",function(t,n,e,a){n.group=a.group_id,n.run=!1,e.function_title="Công việc",e.function_code="TASK",t.info("task",function(t){t||(n.run=!0)})}]})}]),taskModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/task/groups",{template:"<div class='page-frame'><task-group></task-group></div>",controller:["appInfo","$scope","$rootScope","$routeParams",function(t,n,e){e.function_title="Nhóm công việc",e.function_code="TASKGROUP"}]})}]);var dmnhtaskModule=new baseInput("dmnhtask","dmnhtask",["group_name"],"Nhóm công việc",{cache_data:!1}),dokhoModule=new baseInput("dokho","dokho",["ten_dokho"],"Độ khó công việc"),opportunityModule=new baseInput("opportunity","opportunity",["ten_co_hoi","mieu_ta","phu_trach"],"Cơ hội",{has_view:!0,modal_size:"md",onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.visible_to=1,t.data.status_opp=0,t.data.tinh_tren=0,t.tinh_trens=[{id:0,name:"tổng cộng"},{id:1,name:"hàng ngày"},{id:2,name:"hàng tháng"},{id:3,name:"hàng quý"},{id:4,name:"hàng năm"}]},onEdit:function(t){t.tinh_trens=[{id:0,name:"tổng cộng"},{id:1,name:"hàng ngày"},{id:2,name:"hàng tháng"},{id:3,name:"hàng quý"},{id:4,name:"hàng năm"}]},onView:function(t,n){t.tinh_trens=[{id:0,name:"tổng cộng"},{id:1,name:"hàng ngày"},{id:2,name:"hàng tháng"},{id:3,name:"hàng quý"},{id:4,name:"hàng năm"}],t.data.ngay_het_han&&(t.data.ngay_het_han=new Date(t.data.ngay_het_han)),t.addContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(n.$uibModal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).then(function(n){_.extend(t.data,n.data)}))})}},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){STPModules.group.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{group_type:"OPP"}}).then(function(n){t.groups=n.data,t.groups.push({group_name:"Khác"}),t.groups.forEach(function(t){t.sel=!0})}),STPModules.label.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{label_type:"OPP"}}).then(function(n){t.contactLabels=n.data,t.contactLabels.push({label_name:null}),t.contactLabels.forEach(function(t){t.sel=!0})}),t.members=[],_.extend(t.members,n.$rootScope.members),t.members.push({name:"Khác"}),t.members.forEach(function(t){t.sel=!0})}),t.status_opps=[{value:0,text:"Đang theo dõi",sel:!0},{value:1,text:"Thành công",sel:!0},{value:2,text:"Thất bại",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Quên",sel:!0}],t.searchAVR=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[];if(t.status_opps.forEach(function(t){t.sel&&n.push(t.value)}),t.filter.status_opp={$in:n},delete t.filter.labels,t.contactLabels&&t.contactLabels.length>0){var e=t.contactLabels.filter(function(t){return t.sel});e.length<t.contactLabels.length&&(t.filter.labels={$in:_.pluck(e,"label_name")})}if(delete t.filter.phu_trach,t.members&&t.members.length>0){var a=t.members.filter(function(t){return t.sel});a.length<t.members.length&&(t.filter.phu_trach={$in:_.pluck(a,"email")})}if(delete t.filter.nh_co_hoi,t.groups&&t.groups.length>0){var i=t.groups.filter(function(t){return t.sel});i.length<t.groups.length&&(t.filter.nh_co_hoi={$in:_.pluck(i,"_id")})}t.advCondition.ten_co_hoi?t.filter.$or=[{ten_co_hoi:{$regex:t.advCondition.ten_co_hoi,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_co_hoi,$options:"i"}},{location:{$regex:t.advCondition.ten_co_hoi,$options:"i"}},{phu_trach:{$regex:t.advCondition.ten_co_hoi,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.status_opp&&(t.filter.status_opp=t.advCondition.status_opp),t.advCondition.start_date&&(t.filter.start_date={$gte:t.advCondition.start_date}),t.advCondition.due_date?t.filter.due_date={$lte:t.advCondition.due_date}:delete t.filter.due_date,t.search()}},t.reportByTime=function(n){t.time=n,t.searchAVR()},t.$watch("status_opps",function(){t.filter_title="Lọc dữ liệu",t.searchAVR()},!0),t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVR()},t.searchGroup=function(n){t.nh_co_hoi=n._id,t.searchAVR()},t.changeStatus_opp=function(t,e){var a={};_.extend(a,t),a.status_opp=e,n.service.update(id_app,a._id,a).then(function(n){_.extend(t,n.data)},function(t){t.data&&n.$rootScope.alert(t.data)})},t.enter=function(n){13==n.keyCode&&t.searchAVR()}}});opportunityModule.module.directive("opportunity",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/opportunity/templates/directive.html",controller:["$scope","$http","$rootScope","$location","$uibModal","appInfo",function($scope,$http,$rootScope,$location,$uibModal,appInfo){appInfo.info("opportunity",function(e,u,a){if(!e){$scope.server_url=server_url,$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="opportunity:'ten_co_hoi'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).then(function(t){$scope.list=t.data},function(t){t.data&&_online&&$rootScope.alert(t.data)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).then(function(n){_.extend(e,n.data),e.obj=t,e.title=t.title,$scope.list.push(e)},function(){})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(){})},$scope.getItem=function(t,n,e){$scope.addLink(t,e)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),opportunityModule.quickadd($uibModal,function(t){t.collection_name="opportunity",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="opportunity/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$rootScope.confirm("Bạn có chắc chắn xóa không?").then(function(n){1===n&&$http.delete(server_url+"/api/"+id_app+"/opportunity/"+t._id).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})})},$scope.edit=function(t){opportunityModule.quickedit($uibModal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("opportunity directive require attributes:link,collection")}}});var groupModule=new baseInput("group","group",["group_name","group_type"],"Nhóm",{cache_data:!1}),labelModule=new baseInput("label","label",["label_name","label_type"],"Nhãn",{cache_data:!1}),reasonModule=new baseInput("reason","reason",["reason_name"],"Lý do"),fileModule=new baseInput("file","file",["mieu_ta","ten_file_goc"],"Quản lý tệp dữ liệu",{onLoading:function(t,n){addFile=function(){var e=n.$window.open("#file/addfile","Add File","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=300"),a=0;stop=n.$interval(function(){if("OK"==e.document.title){n.$interval.cancel(stop),stop=void 0;var i=JSON.parse(e.document.body.innerText);return t.list.push(i),void e.close()}return"ERROR"==e.document.title?(n.$interval.cancel(stop),stop=void 0,n.$rootScope.alert(e.document.body.innerText),void e.close()):(a+=500,void(a>3e5&&stop&&(n.$interval.cancel(stop),stop=void 0)))},500)}}});fileModule.module.controller("addFileController",["$scope","$localStorage","user","$rootScope","$location","app",function(t,n,e,a,i){a.hide_nav=!0,t.data={},_.extend(t.data,i.search()),t.action=server_url+"/api/"+n.get("id_app")+"/file?access_token="+n.get("token")}]),fileModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/file/addfile",{templateUrl:"templates/lists/file/templates/form-add-file.html",controller:"addFileController"})}]),fileModule.module.directive("fileUpload",function(){return{restrict:"A",scope:{list:"=?",json:"=?",fileUpload:"="},controller:["$scope","$http","$localStorage","$rootScope",function(t,n,e){t.upload=function(a,i,o){t.$emit("$fileUploadStart"),o||(o={}),o.return="JSON",t.fileUpload||(t.fileUpload=server_url+"/api/"+e.get("id_app")+"/file"),n({method:"POST",url:t.fileUpload,headers:{"Content-Type":void 0},transformRequest:function(n){var e=new FormData;if(n.data)for(var a in n.data)e.append(a,n.data[a]);return e.append(t.name,n.fileRaw),e},data:{data:o,fileRaw:a}}).then(function(n){t.$emit("$fileUploadSuccess",n.data),i(null,n.data)},function(n){console.log("error upload file",n),t.$emit("$fileUploadError",n.data),i(n.data)})}}],link:function(t,n,e){t.name=e.name,t.name||(t.name="file"),n.bind("change",function(e){var a=e.target.files;async.map(a,function(n,e){t.upload(n,function(n,a){return n?e(n):(t.list||(t.list=[]),t.list.push(a),void e())},t.json)},function(){n.val("")})})}}}),fileModule.module.directive("imageUpload",["$rootScope",function(t){return{restrict:"A",scope:{model:"=",modelThumb:"=",json:"=",ngUploaded:"&",folder:"@"},controller:["$scope","$http","$localStorage",function(t,n){t.upload=function(e,a,i){t.$emit("$fileUploadStart"),i||(i={}),i.return="JSON",t.folder||(t.folder="products"),n({method:"POST",url:server_url+"/api/uploadfile?json=1&folder="+t.folder,headers:{"Content-Type":void 0},transformRequest:function(t){var n=new FormData;if(t.data)for(var e in t.data)n.append(e,t.data[e]);return n.append("file",t.fileRaw),n},data:{data:i,fileRaw:e}}).then(function(n){t.$emit("$fileUploadSuccess"),a(null,n.data)},function(n){t.$emit("$fileUploadError"),a(n.data)})}}],link:function(n,e){e.bind("change",function(a){var i=a.target.files;async.map(i,function(t,e){n.upload(t,function(t,a){return t?e(t):(n.model=a.image,n.modelThumb=a.thumb,n.onUploaded&&n.onUploaded({$image:a.image,$thumb:a.thumb}),void e())},n.json)},function(n){n&&t.alert(n),e.val("")})})}}}]),fileModule.module.directive("file",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/file/templates/directive.html",controller:["$scope","$http","$location","$window","$uibModal","$interval","appInfo","$rootScope","file",function(t,n,e,a,i,o,r,c,d){r.info("file",function(n){n||(t.token=c.token,t.id_app=id_app,t.server_url=server_url,t.downloadFile=c.downloadFile,t.addfile=function(){var n=a.open("#file/addfile?id_link="+t.link._id,"Add File","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=300"),e=0;stop=o(function(){if("OK"==n.document.title){o.cancel(stop),stop=void 0;var a=JSON.parse(n.document.body.innerText);
return t.files.push(a),void n.close()}return"ERROR"==n.document.title?(o.cancel(stop),stop=void 0,c.alert(n.document.body.innerText),void n.close()):(e+=500,void(e>3e5&&stop&&(o.cancel(stop),stop=void 0)))},500)},t.deletefile=function(n){c.confirm("Bạn có chắc chắn xóa file này không?").then(function(e){1==e&&d.delete(id_app,n._id).then(function(){t.files=_.reject(t.files,function(t){return t._id==n._id})},function(t){t.data&&c.alert(t.data)})})},t.load=function(){d.load(id_app,{filter:{id_link:t.idLink}}).then(function(n){t.files=n.data},function(t){t.data&&_online&&c.alert(t.data)})},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load(),t.dataLink={id_link:t.idLink,collection_link:t.link.collection_name},t.dataLink.url_topic=server_url+"/#"+e.url(),t.dataLink.title_topic=c.title_view)},!0),t.$on("$fileUploadError",function(t,n){c.alert(n)}),t.openProfile=function(t){viewProfile(i,t)})})}],link:function(t,n,e){e.link||console.error("comment directive require 'link' attribute")}}});var mailaccountModule=new baseInput("mailaccount","mailaccount",["username","fullname"],"Tài khoản email",{has_view:!1,onAdd:function(t){t.data.smtp={ssl:!0,port:465},t.data.imap={tls:!0,port:993},t.$watch("data.username",function(n){if(n&&n.indexOf("@")>0&&n.indexOf(".")>0){var e=n.split("@")[1];t.data.smtp.host="smtp."+e,t.data.imap.host="imap."+e}})}});mailaccountModule.module.directive("mailAccount",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailaccount/templates/directive.html",controller:["$scope","$http","$location","$window","$uibModal","mailaccount","appInfo","socket","$rootScope",function(t,n,e,a,i,o,r,c,d){initLabel(d,t,r,"mailbox",n),r.info("mailbox",function(n){n||(t.server_url=server_url,t.addmailaccount=function(){mailaccountModule.quickadd(i,function(n){t.mailaccounts.push(n)},{id_link:t.idLink})},t.viewmailaccount=function(t){e.url("/mailaccount/view/"+t._id+"?redirect="+e.url())},t.connect=function(t){t.status_code=9,t.status_string="Đang xử lý",t.status=!0,o.update(id_app,t._id,t).then(function(){},function(){t.error=null,t.status_code=-1,t.status_string="Không thể kết nối với máy chủ mail"})},t.disconnect=function(t){t.status_code=9,t.status_string="Đang xử lý",t.status=!1,o.update(id_app,t._id,{status:!1,status_code:0,status_string:"Không kết nối"}).then(function(){})},t.deletemailaccount=function(n){d.confirm("Bạn có chắc chắn xóa tài khoản này không?").then(function(e){1===e&&o.delete(id_app,n._id).then(function(){t.mailaccounts=_.reject(t.mailaccounts,function(t){return t._id==n._id})},function(t){var n=t.data;n||(n="Không thể kết nối với máy chủ"),a.alert(n)})})},t.editmailaccount=function(t){mailaccountModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.load=function(){o.load(id_app,{condition:{id_link:t.idLink}}).then(function(n){var e=n.data;t.mailaccounts=e},function(t){var t=res.data;t||(t="Không thể kết nối với máy chủ"),a.alert(t)})},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.load())},!0),c.on("email:disconnected",function(n){var e=n._id;if(console.log("ngat ket noi"),t.mailaccounts){var a=_.find(t.mailaccounts,function(t){return t._id==e});a&&(a.error=null,a.status_code=0,a.status_string="Đã ngắt kết nối")}}),c.on("email:connected",function(n){var e=n._id;if(console.log("ket noi"),t.mailaccounts){var a=_.find(t.mailaccounts,function(t){return t._id==e});a&&(a.error=null,a.status_code=1,a.status_string="Đang kết nối")}}),c.on("email:error",function(n){var e=n._id;if(t.mailaccounts){var a=_.find(t.mailaccounts,function(t){return t._id==e});a&&(a.error=null,a.status_code=-1,a.status_string="Không thể kết nối với máy chủ mail")}}))})}],link:function(t,n,e){e.link||console.error("mail-account directive require 'link' attribute")}}});var mailbox_tab_current="received";mailaccountModule.module.controller("mailboxController",["$scope","$rootScope","$location","$uibModal","appInfo","$http",function(t,n,e,a,i,o){n.function_title="Mail Box",n.function_code="mailbox",initLabel(n,t,i,"mailbox",o),i.info("mailbox",function(n,e){n||(t.current_user=e,t.add=function(){mailscheduleModule.quickadd(a,function(n){t.mailScheduleAdded=n,t.selectTab("schedule")})},t.selectTab=function(n){mailbox_tab_current=n,t.tab_active_schedule="schedule"==mailbox_tab_current,t.tab_active_account="account"==mailbox_tab_current,t.tab_active_template="template"==mailbox_tab_current,t.tab_active_received="received"==mailbox_tab_current,t.tab_active_sent="sent"==mailbox_tab_current,t.tab_active_schedule||t.tab_active_account||t.tab_active_template||t.tab_active_sent||(t.tab_active_received=!0)},t.selectTab(mailbox_tab_current))})}]),mailaccountModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/mailbox",{templateUrl:"templates/lists/mailaccount/templates/mailbox.html",controller:"mailboxController"})}]);var mailreceivedModule=new baseInput("mailreceived","mailreceived",["subject","small_text"],"Email đã nhận",{modal_size:"lg",has_view:!0,onView:function(t,n){t.downloadFile=function(e){var a=server_url_report+"/api/attachments/"+t.data._id+"/"+e.contentId+"?access_token="+n.$rootScope.token,i=e.fileName;n.$rootScope.downloadFile(a,i)};var e={_id:t.data._id,read:!0};n.service.update(id_app,t.data._id,e).then(function(n){_.extend(t.data,n.data)},function(t){n.$rootScope.alert(t.data)}),t.createTask=function(){taskModule.quickadd(n.$uibModal,function(n){n.collection_name="task",t.addLink(n,"ten_cv")},{ten_cv:t.data.subject,mieu_ta:t.data.mail.html})},t.createContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{ten_lien_he:t.data.from[0].name,email:t.data.from[0].address})},t.createCustomer=function(){dmkhModule.quickadd(n.$uibModal,function(n){n.collection_name="dmkh",t.addLink(n,"ten_kh")},{ten_kh:t.data.from[0].name,email:t.data.from[0].address})},t.reply=function(){var e=t.data.from,a=(t.data.to,"Trả lời: "+t.data.subject),i=t.data.mail.html.toString(),o="<div><br/>--lúc "+t.data.date_created.toLocaleString()+" <b>"+t.data.from[0].name+"&lt;"+t.data.from[0].address+"&gt; </b> đã viết--<br/></div><blockquote>"+i+"</blockquote>";mailscheduleModule.quickadd(n.$uibModal,function(){},{to:e,subject:a,use_template:!1,mail:{html:o},send_type:0,repeat:0})}}}),mailreceived_current_page=1;mailreceivedModule.module.directive("mailReceived",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailreceived/templates/directive.html",controller:["$scope","$rootScope","$http","$location","$window","$uibModal","mailreceived","socket","appInfo",function(t,n,e,a,i,o,r,c,d){d.info("mailreceived",function(e){e||(t.downloadFile=n.downloadFile,t.server_url=server_url,t.location=a.url(),t.current_page=mailreceived_current_page,t.mailreceiveds=[],t.pageChanged=function(n){t.current_page=n,mailreceived_current_page=n},t.condition={txtsearch:"",account_id:""},t.viewmailreceived=function(t){a.url("/mailreceived/view/"+t._id+"?redirect="+a.url())},t.deletemailreceived=function(e){i.confirm("Bạn có chắc chắn xóa email này không?")&&r.delete(id_app,e._id).then(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==e._id})},function(t){n.alert(t.data)})},t.service=r,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,read,account_id,attachments",t.search=function(){var n={};t.condition.account_id&&(n.account_id=t.condition.account_id),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailreceiveds)for(var n=0;n<t.mailreceiveds.length;n++){var e=t.mailreceiveds[n];e.sel=t.isSelectAll}},t.isSelected=function(){if(!t.mailreceiveds)return!1;for(var n=0;n<t.mailreceiveds.length;n++){var e=t.mailreceiveds[n];if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailreceiveds&&i.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var e=_.filter(t.mailreceiveds,function(t){return t.sel});e.forEach(function(e){r.delete(id_app,e._id).then(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==e._id})},function(t){n.alert(t.data)})})}},t.linkSelected=function(){i.alert("Chức năng này đang được xây dựng")},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search())},!0))})}],link:function(t,n,e){e.link||console.error("mail-received directive require 'link' attribute")}}}),mailreceivedModule.module.directive("dbInbox",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/mailreceived/templates/db.html",controller:["$scope","mailreceived","$rootScope","$location","$uibModal","socket","appInfo","nodeWebkit","$http",function(t,n,e,a,i,o,r,c,d){initLabel(e,t,r,"mailreceived",d),r.info("mailreceived",function(r){r||(t.downloadFile=e.downloadFile,t.now=new Date,t.isSelectAll=!1,t.selectAll=function(){if(t.mailreceiveds)for(var n=0;n<t.mailreceiveds.length;n++){var e=t.mailreceiveds[n];e.sel=t.isSelectAll}},t.app_info=e.app_info,t.condition={read:null},t.filter=function(){e.nextTick(function(){t.$emit("$dataChangeStart"),n.load(id_app,{condition:t.condition,limit:10}).then(function(n){t.mailreceiveds=n.data,t.$emit("$dataChangeSuccess")},function(){t.$emit("$dataChangeError")})})},t.viewMail=function(t){a.url("mailreceived/view/"+t._id+"?redirect=dashboard")},t.delete=function(a){confirm("Bạn có chắc chắn xóa email này không?")&&n.delete(id_app,a._id).then(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==a._id})},function(t){e.alert(t.data)})},t.markRead=function(a){n.update(id_app,a._id,{_id:a._id,read:!0}).then(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==a._id})},function(t){e.alert(t.data)})},t.createTask=function(n){taskModule.quickadd(i,function(n){n.collection_name="task",t.addLink(n,"ten_cv")},{ten_cv:n.subject,mieu_ta:n.mail.html})},t.createContact=function(n){lienheModule.quickadd(i,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{ten_lien_he:n.from[0].name,email:n.from[0].address})},t.getEmail=function(a){t.mailreceiveds||(t.mailreceiveds=[]),n.load(id_app,{condition:{_id:a}}).then(function(n){var e=n.data;if(1==e.length){e[0].is_new=!0;var i=_.find(t.mailreceiveds,function(t){return t._id==a});i||(t.mailreceiveds.push(e[0]),c.notification("Bạn có email mới","","/mailreceived/view"+a))}},function(t){e.alert(t.data)})},o.on("email",function(n){t.getEmail(n._id)}),t.filter({}))})}],link:function(){}}});var mailsentModule=new baseInput("mailsent","mailsent",["subject","small_text"],"Email đã gửi",{modal_size:"lg",has_view:!0,onAdd:function($scope,options){$scope.data.to=$scope.data.to?eval($scope.data.to):[],$scope.data.html="",$scope.selectContact=function(t){var n={id:t._id,name:t.ten_lien_he,address:t.email},e=_.find($scope.data.to,function(t){return t.id==n.id});e||$scope.data.to.push(n),$scope.ten_lien_he="",$scope.email=""},$scope.removeContact=function(t){$scope.data.to=_.reject($scope.data.to,function(n){return _.isEqual(t,n)})},$scope.selectTemplate=function(t){t&&t.mail&&($scope.data.subject=t.subject,$scope.data.mail.html=t.mail.html)},$scope.title="Soạn email"},onEdit:function(t){t.data.to||(t.data.to=[]),t.selectContact=function(n){var e={id:n._id,name:n.ten_lien_he,address:n.email},a=_.find(t.data.to,function(t){return t.id==e.id});a||t.data.to.push(e),t.ten_lien_he="",t.email=""},t.removeContact=function(n){t.data.to=_.reject(t.data.to,function(t){return _.isEqual(n,t)})},t.selectTemplate=function(n){n&&n.mail&&(t.data.subject=n.subject,t.data.mail.html=n.mail.html)},t.title="Soạn email"},onSave:function(t,n,e,a){e.$uibModal.open({templateUrl:"templates/lists/mailsent/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailsent","$location","mailsentConfig","$uibModalInstance","$window","$routeParams","$timeout","$rootScope",function(t,e,i,o,r,c,d){t.data=n,t.save=function(){a(null,n),d.close()},t.cancel=function(){a(),d.dismiss("cancel")}}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}});mailsentModule.defaultValues={mail:{text:"",html:""},repeat:0,schedule:new Date,send_type:0};var mailsent_current_page=1;mailsentModule.module.directive("mailSent",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailsent/templates/directive.html",controller:["$scope","$http","$location","$window","$uibModal","mailsent","socket","appInfo","$rootScope",function(t,n,e,a,i,o,r,c,d){initLabel(d,t,c,"mailSent",n),c.info("mailSent",function(n){n||(t.server_url=server_url,t.location=e.url(),t.condition={txtsearch:"",account_id:""},t.current_page=mailsent_current_page,t.pageChanged=function(n){t.current_page=n,mailsent_current_page=n},t.viewmailsent=function(t){e.url("/mailsent/view/"+t._id+"?redirect="+e.url())},t.deletemailsent=function(n){d.confirm("Bạn có chắc chắn xóa email này không?").then(function(e){1===e&&o.delete(id_app,n._id).then(function(){t.mailsents=_.reject(t.mailsents,function(t){return t._id==n._id})},function(t){d.alert(t.data)})})},t.service=o,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,sent,schedule,account_id,repeat,attachments",t.getEmail=function(n,e){o.load(id_app,{condition:{_id:n},fields:t.fields}).then(function(t){var n=t.data;1==n.length&&e(n[0])},function(t){d.alert(t.data)})},t.search=function(){var n={};t.condition.account_id&&(n.account_id=t.condition.account_id),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailsents)for(var n=0;n<t.mailsents.length;n++){var e=t.mailsents[n];e.sel=t.isSelectAll}},t.isSelected=function(){if(!t.mailsents)return!1;for(var n=0;n<t.mailsents.length;n++){var e=t.mailsents[n];if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){t.mailsents&&d.confirm("Bạn có chắc chắn xóa những email đã chọn không?").then(function(n){if(1==n){var e=_.filter(t.mailsents,function(t){return t.sel});e.forEach(function(n){o.delete(id_app,n._id).then(function(){t.mailsents=_.reject(t.mailsents,function(t){return t._id==n._id})},function(t){d.alert(t.data)})})}})},t.linkSelected=function(){d.alert("Chức năng này đang được xây dựng")},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search(),r.on("email_sent",function(n){t.condition.txtsearch||t.getEmail(n,function(n){t.mailsents||(t.mailsents=[]),t.condition.account_id&&t.condition.account_id!=n.account_id||t.mailsents.push(n)})}))},!0))})}],link:function(t,n,e){e.link||console.error("mail-sent directive require 'link' attribute")}}});var mailscheduleModule=new baseInput("mailschedule","mailschedule",["subject","small_text"],"Email chờ gửi",{has_view:!0,modal_size:"lg",onAdd:function($scope,options){$scope.data.to=$scope.data.to?eval($scope.data.to):[],$scope.data.html="",$scope.selectContact=function(t){var n={id:t._id,name:t.ten_lien_he,address:t.email,contact:t},e=_.find($scope.data.to,function(t){return t.id==n.id});e||$scope.data.to.push(n),$scope.ten_lien_he="",$scope.email=""},$scope.removeContact=function(t){$scope.data.to=_.reject($scope.data.to,function(n){return _.isEqual(t,n)})},$scope.selectTemplate=function(t){t&&t.mail?($scope.data.subject=t.subject,$scope.data.mail.html=t.mail.html,$scope.data.attachments=t.attachments):($scope.data.subject="",$scope.data.mail.html="",$scope.data.attachments=[])},$scope.title="Soạn email"},onEdit:function(t){t.data.to||(t.data.to=[]),t.selectContact=function(n){var e={id:n._id,name:n.ten_lien_he,address:n.email,contact:n},a=_.find(t.data.to,function(t){return t.id==e.id});a||t.data.to.push(e),t.ten_lien_he="",t.email=""},t.removeContact=function(n){t.data.to=_.reject(t.data.to,function(t){return _.isEqual(n,t)})},t.selectTemplate=function(n){n&&n.mail&&(t.data.subject=n.subject,t.data.mail.html=n.mail.html)},t.title="Soạn email"},onSave:function(t,n,e,a){e.$uibModal.open({templateUrl:"templates/lists/mailschedule/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailschedule","$location","mailscheduleConfig","$uibModalInstance","$window","$routeParams","$timeout","$rootScope",function(t,e,i,o,r,c,d){t.data=n,t.save=function(){a(null,n),d.close()},t.cancel=function(){a(),d.close()},t.send_types=[{id:0,name:"Ngay bây giờ"},{id:1,name:"Chọn một thời gian cụ thể"}],t.repeats=[{id:0,name:"Không lặp lại"},{id:1,name:"Hàng ngày"},{id:2,name:"Hàng tháng"},{id:3,name:"Hàng quý"},{id:4,name:"Hàng năm"}]}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}});mailscheduleModule.defaultValues={mail:{text:"",html:""},repeat:0,schedule:new Date,send_type:0},mailscheduleModule.module.directive("mailSchedule",function(){return{restrict:"E",scope:{link:"=",mailScheduleAdded:"="},templateUrl:"templates/lists/mailschedule/templates/schedule.html",controller:["$scope","$http","$location","$window","$uibModal","mailschedule","socket","appInfo","$rootScope",function(t,n,e,a,i,o,r,c,d){initLabel(d,t,c,"mailSchedule",n),c.info("mailSchedule",function(n){n||(t.server_url=server_url,t.condition={txtsearch:"",account_id:""},t.viewmailschedule=function(t){e.url("/mailschedule/view/"+t._id+"?redirect="+e.url())},t.deletemailschedule=function(n){d.confirm("Bạn có chắc chắn xóa email này không?").then(function(e){1===e&&o.delete(id_app,n._id).then(function(){t.mailschedules=_.reject(t.mailschedules,function(t){return t._id==n._id})},function(t){d.alert(t.data)})})},t.service=o,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,sent,schedule,account_id,repeat,error,nextRunAt",t.getEmail=function(n,e){o.load(id_app,{condition:{_id:n},fields:t.fields}).then(function(t){var n=t.dataa;1==n.length&&e(n[0])},function(t){d.alert(t.data)})},t.search=function(){var n={};t.condition.account_id&&(n.account_id=t.condition.account_id),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailschedules)for(var n=0;n<t.mailschedules.length;n++){var e=t.mailschedules[n];e.sel=t.isSelectAll}},t.isSelected=function(){if(!t.mailschedules)return!1;for(var n=0;n<t.mailschedules.length;n++){var e=t.mailschedules[n];if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){t.mailschedules&&d.confirm("Bạn có chắc chắn xóa những email đã chọn không?").then(function(n){if(1===n){var e=_.filter(t.mailschedules,function(t){return t.sel});e.forEach(function(n){o.delete(id_app,n._id).then(function(){t.mailschedules=_.reject(t.mailschedules,function(t){return t._id==n._id})},function(t){d.alert(t.data)})})}})},t.linkSelected=function(){d.alert("Chức năng này đang được xây dựng")},t.editmailschedule=function(t){mailscheduleModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search(),r.on("email_schedule",function(n){t.condition.txtsearch||t.getEmail(n,function(n){t.mailschedules||(t.mailschedules=[]),t.condition.account_id&&t.condition.account_id!=n.account_id||t.mailschedules.push(n)})}))},!0))})}],link:function(t,n,e){e.link||console.error("mail-schedule directive require 'link' attribute"),t.$watch("mailScheduleAdded",function(n){n&&(t.mailschedules||(t.mailschedules=[]),t.mailschedules.push(n))},!0)}}});var mailtemplateModule=new baseInput("mailtemplate","mailtemplate",["subject","name","small_text"],"Email mẫu",{modal_size:"lg",onAdd:function(t){t.data.html=""}});mailtemplateModule.defaultValues={mail:{text:"",html:""}},mailtemplateModule.module.directive("mailTemplate",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailtemplate/templates/directive.html",controller:["$scope","$http","$location","$window","$uibModal","mailtemplate","appInfo","$rootScope",function(t,n,e,a,i,o,r,c){initLabel(c,t,r,"mailTemplate",n),r.info("mailTemplate",function(n){n||(t.server_url=server_url,t.condition={txtsearch:"",nhom:""},t.viewmailtemplate=function(t){e.url("/mailtemplate/view/"+t._id+"?redirect="+e.url())},t.deletemailtemplate=function(n){c.confirm("Bạn có chắc chắn xóa email này không?").then(function(e){1==e&&o.delete(id_app,n._id).then(function(){t.mailtemplates=_.reject(t.mailtemplates,function(t){return t._id==n._id})},function(t){c.alert(t.data)})})},t.service=o,t.limit=20,t.fields="name,subject,user_created,date_created,small_text,nhom",t.search=function(){var n={};t.condition.nhom&&(n.nhom=t.condition.nhom),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({name:{$regex:t.condition.txtsearch,$options:"i"}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailtemplates)for(var n=0;n<t.mailtemplates.length;n++){var e=t.mailtemplates[n];e.sel=t.isSelectAll}},t.isSelected=function(){if(!t.mailtemplates)return!1;for(var n=0;n<t.mailtemplates.length;n++){var e=t.mailtemplates[n];if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){t.mailtemplates&&c.confirm("Bạn có chắc chắn xóa những email đã chọn không?").then(function(n){if(1===n){var e=_.filter(t.mailtemplates,function(t){return t.sel});e.forEach(function(n){o.delete(id_app,n._id).then(function(){t.mailtemplates=_.reject(t.mailtemplates,function(t){return t._id==n._id})},function(t){c.alert(t.data)})})}})},t.linkSelected=function(){a.alert("Chức năng này đang được xây dựng")},t.editmailtemplate=function(t){mailtemplateModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.add=function(){mailtemplateModule.quickadd(i,function(n){t.mailtemplates||(t.mailtemplates=[]),t.mailtemplates.push(n)})},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search())},!0))})}],link:function(t,n,e){e.link||console.error("mail-template directive require 'link' attribute")}}});var contractModule=new baseInput("contract","contract",["so_hd","ten_hd"],"Hợp đồng",{has_view:!0,modal_size:"md",onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.progress=0,t.data.loai_hd="1"},onInput:function(t){t.tinhTienDotThanhToan=function(){t.data.dot_thanh_toan&&t.data.dot_thanh_toan.forEach(function(n){n.tien_nt=STP.round(t.data.tien_nt*n.ty_le/100,t.f_tien_nt)})}},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){STPModules.group.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{group_type:"CONTRACT"}}).then(function(n){t.groups=n.data,t.groups.push({group_name:"Khác"}),t.groups.forEach(function(t){t.sel=!0})}),STPModules.label.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{label_type:"CONTRACT"}}).then(function(n){t.contactLabels=n.data,t.contactLabels.push({label_name:null}),t.contactLabels.forEach(function(t){t.sel=!0})}),t.members=[],_.extend(t.members,n.$rootScope.members),t.members.push({name:"Khác"}),t.members.forEach(function(t){t.sel=!0})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.searchAVR=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[];if(t.progresses.forEach(function(t){t.sel&&n.push(t.value)}),t.filter.progress={$in:n},delete t.filter.labels,t.contactLabels&&t.contactLabels.length>0){var e=t.contactLabels.filter(function(t){return t.sel});e.length<t.contactLabels.length&&(t.filter.labels={$in:_.pluck(e,"label_name")})}if(delete t.filter.phu_trach,t.members&&t.members.length>0){var a=t.members.filter(function(t){return t.sel});a.length<t.members.length&&(t.filter.phu_trach={$in:_.pluck(a,"email")})}if(delete t.filter.nh_hd,t.groups&&t.groups.length>0){var i=t.groups.filter(function(t){return t.sel});i.length<t.groups.length&&(t.filter.nh_hd={$in:_.pluck(i,"_id")})}var o,r,c=new Date,d=t.time;if("d"==d&&(o=new Date,r=new Date),"w"==d)var l=c.getDate()-c.getDay()+1,o=new Date(c.setDate(l)),r=new Date(c.setDate(o.getDate()+6));if("m"==d&&(o=c,o.setDate(1),r=new Date(o.getFullYear(),o.getMonth()+1,0)),"3m"==d){var u=c.getMonth(),s=1;s=3>u?0:6>u?3:6>u?6:9,o=new Date(c.getFullYear(),s,1),r=new Date(c.getFullYear(),s+3,0)}"y"==d&&(o=new Date(c.getFullYear(),0,1),r=new Date(c.getFullYear(),11,31)),o&&r?(o.setHours(0),o.setMinutes(0),o.setSeconds(0),r.setHours(23),r.setMinutes(59),r.setSeconds(0),t.filter.ngay_hd={$gte:o,$lte:r}):delete t.filter.ngay_hd,t.advCondition.ten_hd?t.filter.$or=[{ten_hd:{$regex:t.advCondition.ten_hd,$options:"i"}},{so_hd:{$regex:t.advCondition.ten_hd,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.advCondition.ngay_hd&&(t.filter.ngay_hd=t.advCondition.ngay_hd),t.advCondition.ngay_nt&&(t.filter.ngay_nt=t.advCondition.ngay_nt),t.search()}},t.enter=function(n){13==n.keyCode&&t.searchAVR()},t.reportByTime=function(n){t.time=n,t.searchAVR()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVR()},t.searchGroup=function(n){t.nh_hd=n._id,t.searchAVR()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVR()},!0),t.changeProgress=function(t,e){var a={};_.extend(a,t),a.progress=e,n.service.update(id_app,a._id,a).then(function(n){var e=n.data;_.extend(t,e)},function(t){t.data&&$options.$rootScope.alert(t.data)})}},onView:function(t,n){t.f_tien_nt=n.$rootScope.app_info.f_tien_nt,t.addContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.tinhTienDotThanhToan=function(){t.data.dot_thanh_toan&&t.data.dot_thanh_toan.forEach(function(n){n.tien_nt=STP.round(t.data.tien_nt*n.ty_le/100,t.f_tien_nt)})},t.addCustomer=function(){dmkhModule.quickadd(n.$uibModal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).then(function(n){var e=n.data;_.extend(t.data,e)}))})}}});contractModule.defaultValues={ngay_hd:new Date,ma_nt:"VND"},contractModule.module.directive("contract",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/contract/templates/directive.html",controller:["$scope","$shttp","$window","$location","$uibModal","appInfo","$rootScope","contract",function($scope,$http,$window,$location,$uibModal,appInfo,$rootScope,contract){appInfo.info("contract",function(e,u,appinfo){if(!e){$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="contract:'ten_hd'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t,{cache:!0}).then(function(t){$scope.list=t.data},function(t){t.data&&_online&&$rootScope.alert(t.data)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).then(function(n){_.extend(e,n.data),e.obj=t,e.title=t.title,$scope.list.push(e)},function(){})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(){})},$scope.getItem=function(t){$scope.addLink(t)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),contractModule.quickadd($uibModal,function(t){t.collection_name="contract",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="contract/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$rootScope.confirm("Bạn có chắc chắn xóa không?").then(function(n){1==n&&contract.delete(id_app,t._id).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})})},$scope.edit=function(t){contractModule.quickedit($uibModal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("contract directive require attributes:link,collection")}}});var warrantyModule=new baseInput("warranty","warranty",["mieu_ta"],"Bảo hành",{has_view:!1});warrantyModule.defaultValues={unit_time:2,ma_nt:"VND",reminder_yn:!0,start_date:new Date},warrantyModule.module.directive("warranty",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/warranty/templates/directive.html",controller:["$scope","$http","$location","$window","$uibModal","warranty","appInfo","$rootScope",function(t,n,e,a,i,o,r,c){r.info("warranty",function(n){n||(t.addwarranty=function(){warrantyModule.quickadd(i,function(n){t.warrantys.push(n)},{id_hd:t.idLink})},t.viewwarranty=function(t){e.url("/warranty/view/"+t._id+"?redirect="+e.url())},t.deletewarranty=function(n){c.confirm("Bạn có chắc chắn xóa bảo hành này không?").then(function(e){1==e&&o.delete(id_app,n._id).then(function(){t.warrantys=_.reject(t.warrantys,function(t){return t._id==n._id})},function(t){c.alert(t.data)})})},t.editwarranty=function(t){warrantyModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.load=function(){o.load(id_app,{condition:{id_hd:t.idLink}}).then(function(n){t.warrantys=n.data},function(t){c.alert(t.data)})},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load())},!0))})}],link:function(t,n,e){e.link||console.error("warranty directive require 'link' attribute")}}});var campaignModule=new baseInput("campaign","campaign",["title"],"Chiến dịch",{has_view:!0,onView:function(t,n){var e,a=[],i=function(t){t.children&&t.children.forEach(function(n){a.push(n),n.title=n.title?n.title.split(")").join("_").split("(").join("_"):"","+"==n.title?(e=t._id?e+"\n"+t._id+"---"+n._id+"(("+n.title+"))":e+"\n"+n._id+"(("+n.title+"))",e=e+"\nclick "+n._id+" addStep",e=e+"\nstyle "+n._id+" fill:silver"):(e=t._id?e+"\n"+t._id+"-->"+n._id+"("+(n.exfields&&n.exfields.icon?"fa:"+n.exfields.icon+" ":"")+n.title+")":e+"\n"+n._id+"("+(n.exfields&&n.exfields.icon?"fa:"+n.exfields.icon+" ":"")+n.title+")",e=e+"\nclick "+n._id+" editStep",e=e+"\nstyle "+n._id+" fill:white,stroke:#1AB394,stroke-width:2px"),i(n)})};window.editStep=function(e){STPModules.step.obj.quickview(n.$uibModal,{},function(){},{templateUrl:"list-view",onLoadView:function(i,o,r){i.formShare=function(n){if(!n||!n._id)return{url:"",frame:""};var e=server_url+"/v2/form.html#!?id="+n._id+"&cid="+t.data._id,a='<iframe src="'+e+'" frameborder="0" scrolling="auto" allowfullscreen style="display: block;margin-left: auto;margin-right: auto;"></iframe>';return{url:e,frame:a}},i.selectedStep=_.find(a,function(t){return t._id==e}),i.selectStep=function(t){JSON.parse(JSON.stringify(t));i.setSelectedRow(t),i.selectedStep={p_id:i.selectedStep.p_id,children:i.selectedStep.children},_.extend(i.selectedStep,t),i.selectedStep._id_o=i.selectedStep._id,i.selectedStep._id=e+i.selectedStep._id+moment().format("YYYYMMDDhhmmss")
},i.ok=function(){var o=_.find(a,function(t){return t._id==i.selectedStep.p_id});o?(o.children=_.filter(o.children,function(t){return t._id!=e}),o.children.push(i.selectedStep),n.service.update(t.data.id_app,t.data._id,t.data).then(function(){r.close()},function(t){console.log(t.data)})):r.close()},i.remove=function(){if(i.selectedStep){var o=_.find(a,function(t){return t._id==i.selectedStep.p_id});o&&o.children?(o.children=_.filter(o.children,function(t){return t._id!=e}),"bg_begin"!==o._id&&i.selectedStep.children.forEach(function(t){_.filter(a,function(n){return n.p_id==t._id}).forEach(function(t){t.p_id=o._id,o.children.push(t)})}),n.service.update(t.data.id_app,t.data._id,t.data).then(function(){r.close()},function(t){console.log(t.data)})):r.close()}else r.close()}}})},window.addStep=function(e){STPModules.step.obj.quickview(n.$uibModal,{},function(){},{templateUrl:"list-view",onLoadView:function(i,o,r){i.formShare=function(n){var e=server_url+"/v2/form.html#!?id="+n._id+"&cid="+t.data._id,a='<iframe src="'+e+'" frameborder="0" scrolling="auto" allowfullscreen style="display: block;margin-left: auto;margin-right: auto;"></iframe>';return{url:e,frame:a}},i.selectedStep,i.selectStep=function(t){var n=JSON.parse(JSON.stringify(t));i.setSelectedRow(n),i.selectedStep={},_.extend(i.selectedStep,n),i.selectedStep.p_id=e,i.selectedStep._id_o=i.selectedStep._id,i.selectedStep._id=e+i.selectedStep._id+moment().format("YYYYMMDDhhmmss")},i.ok=function(){if(i.selectedStep){var o=_.find(a,function(t){return t._id==e}),c=[];"bg_begin"==e?(o.children&&o.children.length>0?(c=JSON.parse(JSON.stringify(o.children[0].children)),c.forEach(function(t){t.children=[]})):c=[{_id:"bg_"+i.selectedStep._id,title:"+",children:[]}],i.selectedStep.children=c,o.children.push(i.selectedStep)):(c=o.children,i.selectedStep.children=[{_id:"bg_"+i.selectedStep._id,title:"+",children:c}],o.children=[i.selectedStep]),n.service.update(t.data.id_app,t.data._id,t.data,function(t){console.log(t)})}r.close()},i.remove=function(){r.close()}}})};var o=function(){e="graph TD",t.data.steps||(t.data.steps={_id:"begin",title:"Bắt đầu",children:[{_id:"bg_begin",title:"+",children:[]}]}),a=[t.data.steps],e=e+"\n"+t.data.steps._id+"("+t.data.steps.title+")",e=e+"\nstyle "+t.data.steps._id+" fill:white,stroke:#34AADC,stroke-width:2px",i(t.data.steps);var o=n.$interval(function(){var t=document.querySelector("#graphDiv");if(t){for(;t.firstChild;)t.removeChild(t.firstChild);var a=document.createElement("div");a.className="mermaid",a.appendChild(document.createTextNode(e)),t.appendChild(a),mermaid.init(),n.$interval.cancel(o)}},300)};o(),t.$watch("data",function(t){t&&o()},!0)}}),stepModule=new baseInput("step","step",["title"],"Bước",{has_view:!1}),formModule=new baseInput("form","form",["title","name","subtitle","description"],"Biểu mẫu",{modal_size:"lg",onAdd:function(){},onLoading:function(t,n){t.share=function(e){n.$uibModal.open({templateUrl:"templates/sys/share-form.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","appInfo",function(t,n,a,i,o,r){initLabel(n,t,r,"SYS",i),t.form=e,t.url=server_url+"/form.html#!?id="+e._id,t.frame='<iframe src="'+t.url+'" frameborder="0" scrolling="auto" allowfullscreen style="display: block;margin-left: auto;margin-right: auto;width:100%"></iframe>',t.close=function(){o.close()}}],size:"md",resolve:{parentScope:function(){return t}}})}}});formModule.defaultValues={title:"Tiêu đề form",success_message:"Cảm ơn bạn đã đăng ký",email_address_already_exists:"Địa chỉ email này thật sự đã tồn tại",error_message:"Không thể gửi thông tin đăng ký",fields:[{label:"Họ và tên",type:"ten_lien_he",required:!0},{label:"Địa chỉ email",type:"email",required:!0}]},formModule.module.component("renderForm",{bindings:{data:"=",design:"<"},restrict:"E",templateUrl:"templates/sys/render-form.html",controller:["$rootScope",function(t){this.innerHeight=t.innerHeight,this.innerWidth=7*t.innerWidth/12}]});var formvalueModule=new baseInput("formvalue","formvalue",["title","name","subtitle","description"],"Dữ liệu biểu mẫu",{onAdd:function(){},onLoading:function(){}}),hlinkModule=new baseInput("hlink","hlink",["name"],"Liên kết",{onAdd:function(){},onLoading:function(){}}),hlinkvalueModule=new baseInput("hlinkvalue","hlinkvalue",["name"],"Liên kết đã click",{onAdd:function(){},onLoading:function(){}}),waiteventModule=new baseInput("waitevent","waitevent",["name"],"Chờ đợi sự kiện",{onAdd:function(){},onEdit:function(){}});waiteventModule.defaultValues={name:"",repeat:0,type:"after_seconds",after_seconds:0};var dmnvModule=new baseInput("dmnv","dmnv",["ma_nv","ten_nv","dia_chi","dien_thoai","fax","email"],"Nhân viên",{modal_size:"md",has_view:!0,onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{id_nv:t.data._id,ten_nv:t.data.ten_nv})}},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'DMNV'}",{cache:!0}).then(function(n){t.groups=n.data})}),t.btn3_click=function(){var e=[];t.list.forEach(function(t){t.email&&t.sel&&e.push({name:t.ten_nv,address:t.email})}),e.length>0?n.$location.url("mailschedule/add?to="+JSON.stringify(e)+"&redirect="+n.$location.url()):alert("Bạn phải chọn ít nhất một nhân viên")},t.searchAVR=function(){t.renderCompleted&&(t.filter={},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_nv?t.filter.nh_nv=t.nh_nv:delete t.filter.nh_nv,t.advCondition.ten_nv?t.filter.$or=[{ten_nv:{$regex:t.advCondition.ten_nv,$options:"i"}},{ma_nv:{$regex:t.advCondition.ten_nv,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_nv,$options:"i"}},{email:{$regex:t.advCondition.ten_nv,$options:"i"}}]:delete t.filter.$or,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.search())},t.enter=function(n){13==n.keyCode&&t.searchAVR()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVR()},t.searchGroup=function(n){t.nh_nv=n._id,t.searchAVR()},t.reportByTime=function(n){t.time=n,t.searchAVR()}}}),dmbanModule=new baseInput("dmban","dmban",["ma_ban","ten_ban"],"Quản lý bán lẻ theo bàn",{limit:1e3,onInput:function(t){t.ma_kho=dmbanModule.ma_kho}});dmbanModule.loaded=function(t){t.detectGroup(),t.list.forEach(function(t){var n=100;window.innerWidth<500&&(n=window.innerWidth/3-6),t.css={}}),t.getPBL()},dmbanModule.loading=function(t,n){t.today=new Date,t.groupBy="ARIA",t.groups=[],t.emptyOrNull=function(t){return!t.ma_nhom},t.detectGroup=function(){"ARIA"==t.groupBy?(t.groups=t.areas,t.list.forEach(function(t){t.ma_nhom=t.nh_ban})):(t.groups=t.types,t.list.forEach(function(t){t.ma_nhom=t.loai_ban}))},t.$watch("groupBy",function(n,e){n!==e&&t.detectGroup()}),t.$watch("list",function(n,e){n!==e&&t.detectGroup()},!0),t.$watch("ten_kho",function(){dmbanModule.ten_kho=t.ten_kho}),t.$watch("ma_kho",function(){dmbanModule.ma_kho=t.ma_kho,n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'TABLE',ma_kho:'"+t.ma_kho+"'}").then(function(n){t.areas=n.data,t.detectGroup()})}),n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'TABLE_TYPE',ma_kho:'"+t.ma_kho+"'}").then(function(n){t.types=n.data,t.detectGroup()})})}),t.showCalendar=function(e){n.$uibModal.open({templateUrl:"templates/sys/calendar.html",controller:["$scope","$rootScope","appInfo","$controller","$http","$uibModalInstance","$window","pbl","$uibModal","calendarConfig","parentScope",function(t,n,a,i,o,r,c,d,l,u,s){initLabel(n,t,a,"CALENDAR",o),u.i18nStrings.weekNumber="Tuần {week}",t.cancel=function(){r.close()},t.ban=e,t.close=function(){r.close()},t.vm={};var p=t.vm;p.calendarView="day",p.viewDate=s.today,t.thang=p.viewDate.getMonth(),t.nam=p.viewDate.getFullYear(),p.events=[],p.isCellOpen=!0,p.eventClicked=function(t){pblModule.quickedit(l,t.item._id,function(n){var e=f(n);_.extend(t,e)})},p.eventEdited=function(t){pblModule.quickedit(l,t.item._id,function(n){var e=f(n);_.extend(t,e)})},p.eventDeleted=function(t){n.confirm("Bạn có chắc chắn xóa không?").then(function(e){1===e&&d.delete(id_app,t.item._id).then(function(n){n.data;p.events=_.filter(p.events,function(n){return n.item._id!==t.item._id})},function(t){n.alert(t.data)})})},p.eventTimesChanged=function(){};var h=function(t,n){return t.getFullYear()==n.getFullYear()&&t.getMonth()==n.getMonth()&&t.getDay()==n.getDay()?!0:!1};p.timespanClicked=function(n){if("day"===p.calendarView)t.add(n);else if("month"===p.calendarView){var e=_.filter(p.events,function(t){return h(n,t.startsAt)});0===e.length&&t.add(n)}},p.toggle=function(t,n,e){t.preventDefault(),t.stopPropagation(),e[n]=!e[n]},p.viewChangeClicked=function(t,n){return console.log(t,n),!0};var f=function(t){var n={title:"Số chứng từ: "+t.so_ct+", khách hàng: "+(t.ten_kh?t.ten_kh:"Vãng lai"),draggable:!0,resizable:!0,item:t},e=t.tu_ngay;e||(e=t.ngay_ct);var a=t.den_ngay;switch(a||(a=t.ngay_ct),n.startsAt=new Date(e),n.endsAt=new Date(a),n.startsAt.getTime()===n.endsAt.getTime()&&n.endsAt.setHours(n.endsAt.getHours()+1),t.trang_thai){case 0:n.type="warning";break;case 1:n.type="important";break;default:n.type="info"}return n};t.add=function(t){t||(t=new Date),pblModule.quickadd(l,function(t){p.events.push(f(t))},{ma_ban:e.ma_ban,ngay_ct:t,tu_ngay:t,den_ngay:t,ma_kho:dmbanModule.ma_kho,ten_kho:dmbanModule.ten_kho})},t.load=function(){t.loadding=!0,p.events=[];var n,a;"year"===p.calendarView?(n=0,a=11):(n=t.thang,a=t.thang);var i=new Date(t.nam,n,1),o=new Date(t.nam,a+1,0),r={ma_ban:e.ma_ban,ngay_ct:{$gte:i,$lte:o}},c=d.load2(id_app,{condition:r});c.promise.then(function(n){p.events=[],t.loadding=!1;var e=n.data;e.forEach(function(t){p.events.push(f(t))})},function(n){t.loadding=!1;var e=n.data;alert(e?e.message:"Không kết nối được với máy chủ")})},t.load(),t.$watch("vm.viewDate",function(n){n&&(t.thang=n.getMonth(),t.nam=n.getFullYear())},!0),t.$watch("thang",function(n,e){n&&n!==e&&t.load()},!0),t.$watch("nam",function(n,e){n&&n!==e&&t.load()},!0),t.$watch("vm.calendarView",function(n,e){n&&n!==e&&t.load()},!0)}],size:"lg",resolve:{parentScope:function(){return t}}})},n.$controller("dsbanController",{$scope:t})},dmbanModule.module.controller("dsbanController",["$scope","$rootScope","appInfo","$http","pbl","socket","nodeWebkit",function(t,n,e,a,i,o){t.pbls=[],t.pblSync=function(){t.pbls=_.filter(t.pbls,function(n){if(!n.tu_ngay||!n.den_ngay||!n.ma_ban)return!1;var e=new Date(n.tu_ngay);e.setHours(0),e.setMinutes(0);var a=new Date(n.den_ngay);return a.setHours(23),a.setMinutes(59),t.today.getTime()>=e.getTime()&&t.today.getTime()<=a.getTime()});var n=100;window.innerWidth<500&&(n=window.innerWidth/3-6),t.list.forEach(function(n){var e=_.find(t.pbls,function(t){return t.ma_ban===n.ma_ban&&1==t.trang_thai});n.css={},e?(n.trang_thai=1,n.css["background-color"]="#FACDCF"):(e=_.find(t.pbls,function(t){return t.ma_ban===n.ma_ban&&0==t.trang_thai}),e?(n.trang_thai=0,n.css["background-color"]="#F8FACD"):(e=_.find(t.pbls,function(t){return t.ma_ban===n.ma_ban&&2==t.trang_thai}),e?(n.trang_thai=2,n.css["background-color"]="white"):(n.trang_thai=-1,n.css["background-color"]="white")))})},t.getPBL=function(){r();var n={tu_ngay:{$lte:t.cuoi_ngay},den_ngay:{$gte:t.dau_ngay}};i.load(id_app,{condition:n}).then(function(n){t.pbls=n.data,t.pblSync()},function(t){t.data&&alert(t.data)})};var r=function(){var n=t.today.getTime();t.cuoi_ngay=new Date(n),t.cuoi_ngay.setHours(23),t.cuoi_ngay.setMinutes(59),t.cuoi_ngay.setSeconds(59),t.dau_ngay=new Date(n),t.dau_ngay.setHours(0),t.dau_ngay.setMinutes(0),t.dau_ngay.setSeconds(0)};t.$watch("today",function(n,e){n&&n!==e&&(r(),t.getPBL())}),o.on("pbl:new",function(n){i.get(id_app,n._id).then(function(n){t.pbls.push(n.data),t.pblSync()},function(t){console("error get pbl",t.data)})}),o.on("pbl:update",function(n){i.get(id_app,n._id).then(function(e){var a=_.find(t.pbls,function(t){return t._id===n._id});a?_.extend(a,e.data):t.pbls.push(e.data),t.pblSync()},function(t){console("error get pbl",t.data)})}),o.on("pbl:delete",function(n){t.pbls=_.reject(t.pbls,function(t){return t._id===n._id}),t.pblSync()}),t.selectBan=function(n){r(),t.selectedRow=n}}]),dmbanModule.module.directive("dsban",[function(){return{templateUrl:"templates/lists/dmban/templates/dsban.html",controller:"dsbanController"}}]);var dmcaModule=new baseInput("dmca","dmca",["ma_ca","ten_ca"],"Danh mục ca",{has_view:!1}),giaocaModule=new baseInput("giaoca","giaoca",["ma_ca","ma_kho","nhan_vien"],"Giao ca",{has_view:!1,onInput:function(t,n){t.getTienHang=function(){if(t.data.ma_kho&&t.data.ma_ca&&t.data.nhan_vien){var e=server_url_report+"/api/"+id_app+"/getdttheoca?t=1";e=e+"&ma_ca="+t.data.ma_ca,e=e+"&ma_kho="+t.data.ma_kho,e=e+"&nhan_vien="+t.data.nhan_vien,e=e+"&tu_ngay="+moment(t.data.tu_ngay).format("YYYY-MM-DD"),e=e+"&den_ngay="+moment(t.data.den_ngay).format("YYYY-MM-DD"),n.$http.get(e).then(function(n){t.data.tien_hang=n.data.tien_hang,t.data.da_giao=n.data.da_giao,t.data.tien_giao||(t.data.tien_giao=t.data.tien_hang-t.data.da_giao)},function(t){n.$rootScope.alert(t.data?t.data:"Không kết nối được với máy chủ")})}},t.$watch("data.ma_ca",function(n,e){n&&n!==e&&t.getTienHang()}),t.$watch("data.ma_kho",function(n,e){n&&n!==e&&t.getTienHang()}),t.$watch("data.tu_ngay",function(n,e){n&&n!==e&&t.getTienHang()}),t.$watch("data.den_ngay",function(n,e){n&&n!==e&&t.getTienHang()}),t.getTienHang()}}),nhadatModule=new baseInput("nhadat","nhadat",["ten_nd"],"Nhà đất",{has_view:!0,onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.progress=0},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'NHADAT'}").then(function(n){t.groups=n.data})}),t.progresses=[{value:0,text:"Đang bán",sel:!0},{value:1,text:"Bán gấp",sel:!0},{value:2,text:"Ngưng bán",sel:!0},{value:3,text:"Đã bán",sel:!0}],t.searchAVG=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[];t.progresses.forEach(function(t){t.sel&&n.push(t.value)}),t.filter.progress={$in:n},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_nd?t.filter.nh_nd=t.nh_nd:delete t.filter.nh_nd;var e,a,i=new Date,o=t.time;if("d"==o&&(e=new Date,a=new Date),"w"==o)var r=i.getDate()-i.getDay()+1,e=new Date(i.setDate(r)),a=new Date(i.setDate(e.getDate()+6));if("m"==o&&(e=i,e.setDate(1),a=new Date(e.getFullYear(),e.getMonth()+1,0)),"3m"==o){var c=i.getMonth(),d=1;d=3>c?0:6>c?3:6>c?6:9,e=new Date(i.getFullYear(),d,1),a=new Date(i.getFullYear(),d+3,0)}"y"==o&&(e=new Date(i.getFullYear(),0,1),a=new Date(i.getFullYear(),11,31)),e&&a?(e.setHours(0),e.setMinutes(0),e.setSeconds(0),a.setHours(23),a.setMinutes(59),a.setSeconds(0),t.filter.date_created={$gte:e,$lte:a}):delete t.filter.date_created,t.advCondition.ten_nd?t.filter.$or=[{ten_nd:{$regex:t.advCondition.ten_nd,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_nd,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.tinh_thanh?t.filter.tinh_thanh=t.advCondition.tinh_thanh:delete t.filter.tinh_thanh,t.advCondition.quan_huyen?t.filter.quan_huyen=t.advCondition.quan_huyen:delete t.filter.quan_huyen,t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.search()}},t.reportByTime=function(n){t.time=n,t.searchAVG()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVG()},t.searchGroup=function(n){t.nh_nd=n._id,t.searchAVG()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.changeProgress=function(t,e){var a={};_.extend(a,t),a.progress=e,n.service.update(id_app,a._id,a).then(function(n){_.extend(t,n.data)},function(t){t.data&&n.$rootScope.alert(t.data)})},t.enter=function(n){13==n.keyCode&&t.searchAVG()}},onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(n.$uibModal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).then(function(n){_.extend(t.data,n.data)}))})}}});nhadatModule.module.directive("nhadat",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/nhadat/templates/directive.html",controller:["$scope","$http","$window","$location","$uibModal","appInfo","$rootScope",function($scope,$http,$window,$location,$uibModal,appInfo,$rootScope){appInfo.info("nhadat",function(e,u,appinfo){if(!e){$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="nhadat:'ten_nd'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).then(function(t){$scope.list=t.data},function(t){t.data&&$rootScope.alert(t.data)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).then(function(n){_.extend(e,n.data),e.obj=t,e.title=t.title,$scope.list.push(e)},function(t){t.data&&$rootScope.alert(t)})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})},$scope.getItem=function(t){$scope.addLink(t)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),nhadatModule.quickadd($uibModal,function(t){t.collection_name="nhadat",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="nhadat/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$rootScope.confirm("Bạn có chắc chắn xóa không?").then(function(n){1==n&&$http.delete(server_url+"/api/"+id_app+"/nhadat/"+t._id).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})})},$scope.edit=function(t){nhadatModule.quickedit($uibModal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("nhadat directive require attributes:link,collection")}}});var dvcsModule=new baseInput("dvcs","dvcs",["ten_dvcs"],"Danh mục đơn vị cơ sở",{modal_size:"sm"}),dmtcModule=new baseInput("dmtc","tc",["ma_tc","ten_tc"],"Danh mục tính chất thuế"),dmdvtModule=new baseInput("dmdvt","dmdvt",["ma_dvt","ten_dvt"],"Danh mục đơn vị tính",{modal_size:"sm"}),dmqddvtModule=new baseInput("dmqddvt","dmqddvt",["ma_vt","ma_dvt"],"Danh mục quy đổi đơn vị tính"),dmvtModule=new baseInput("dmvt","dmvt",["ma_vt","ten_vt","ma_vt2"],"Danh mục vật tư, hàng hóa",{modal_size:"md",has_view:!0,onLoading:function(t,n){t.view="grid",t.setView=function(n){t.view=n},t.printBarcode=function(){n.$uibModal.open({template:"<div style='height:"+(innerHeight-10).toString()+"px'><div class='scrollable'><div class='scrollable-content'><barcode data='list' field-code='ma_vt'  field-price='gia_ban_le' field-qty='sl_nhap' field-label='ten_vt' on-close='cancel()'></barcode></div></div></div>",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(t,n,e,a,i){t.list=[],t.cancel=function(){i.close()}}],size:"md",resolve:{parentScope:function(){return t}}})},n.$rootScope.nextTick(function(){STPModules.dmnvt.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app).then(function(n){t.groups=n.data})}),t.searchGroup=function(n){t.ma_nvt=n._id;var e=t.filter;e||(e={}),t.ma_nvt?e.ma_nvt=t.ma_nvt:delete e.ma_nvt,t.changeFilter({filter:e})},t.searchType=function(n){t.type_filter=n;var e=t.filter;e||(e={}),delete e.hot,delete e.bestseller,delete e.banner_small,delete e.banner_large,n&&(e[n]=!0),t.changeFilter({filter:e})}}});dmvtModule.defaultValues={gia_xuat:"1",tk_vt:"1561"},dmvtModule.init=function(t){t.updatePrice=function(n){n.gia_ban_le&&n.ty_le_ck&&(n.tien_ck=STP.round(n.gia_ban_le*n.ty_le_ck,0)),t.update(n)},t.$watch("data.ty_le_ck",function(){t.isDataLoaded&&t.data.gia_ban_le&&t.data.ty_le_ck&&(t.data.tien_ck=STP.round(t.data.ty_le_ck*t.data.gia_ban_le/100,0))}),t.$watch("data.gia_ban_le",function(){t.isDataLoaded&&t.data.gia_ban_le&&t.data.ty_le_ck&&(t.data.tien_ck=STP.round(t.data.ty_le_ck*t.data.gia_ban_le/100,0))})};var listItemsGrid={};dmvtModule.module.directive("products",["$rootScope",function(t){return{restrict:"E",scope:{onSelect:"&",buy:"=?",tyGia:"=?",where:"=?",loaiGia:"@?",scrollable:"=?"},templateUrl:function(){return"templates/lists/dmvt/templates/gridview.html"},controller:["$scope","$http","$uibModal","dmvt","$cordovaBarcodeScanner","$window","$localStorage",function(n,e,a,i,o,r,c){n.STP=t.STP,n.server_url=t.server_url,n.app_info=t.app_info,n.list=[],n.showNumberProducts=12,n.currentView=c.get("productView"),n.currentView||(n.currentView="gridview"),n.changeView=function(){n.currentView="gridview"==n.currentView?"listview":"gridview",c.set("productView",n.currentView)},n.loaiGia||(n.loaiGia=n.buy?"M":"B"),n.limitOpts={limit:18,begin:0},n.loadPage=function(){n.limitOpts.limit=n.limitOpts.limit+5},n.f_gia=t.app_info.options.f_gia_nt||2,n.f_tien=t.app_info.options.f_tien_nt||2,n.tyGia||(n.tyGia=1),1===n.tyGia&&(n.f_gia=t.app_info.options.f_gia||0,n.f_tien=t.app_info.options.f_tien||0),n.$watch("tyGia",function(e){if(e&&listItemsGrid[id_app]){n.list=JSON.parse(JSON.stringify(listItemsGrid[id_app]));var a=e;1==a?(n.f_gia=t.app_info.options.f_gia||0,n.f_tien=t.app_info.options.f_tien||0):(n.f_gia=t.app_info.options.f_gia_nt||2,n.f_tien=t.app_info.options.f_tien_nt||2),n.list.forEach(function(t){t.gia_ban_le=STP.round(t.gia_ban_le/a,n.f_gia),t.gia_mua=STP.round(t.gia_mua/a,n.f_gia),t.tien_ck=STP.round(t.tien_ck/a,n.f_tien)})}}),n.filter=function(e,a,o){a||(a=100),n.limitOpts.limit=a,n.$emit("$dataChangeStart"),i.load(id_app,{condition:e,limit:a}).then(function(t){listItemsGrid[id_app]=t.data;var e=JSON.parse(JSON.stringify(listItemsGrid[id_app])),a=n.tyGia?n.tyGia:1;e.forEach(function(t){t.gia_ban_le=STP.round(t.gia_ban_le/a,n.f_gia),t.gia_mua=STP.round(t.gia_mua/a,n.f_gia),t.tien_ck=STP.round(t.tien_ck/a,n.f_tien)}),n.list=JSON.parse(JSON.stringify(e)),n.$emit("$dataChangeSuccess"),o&&o(null,t.data)},function(e){return n.$emit("$dataChangeError"),e?void(o?o(e.message):t.alert(e.message)):t.alert("Không kết nối được với máy chủ")})},n.searchKeyup=function(e,i){i&&13==e.keyCode&&(n.condition="",n.filter(i,n.showNumberProducts,function(e,o){return e?t.alert(e):void(o&&o.length>0?1===o.length?n.onClick(o[0],function(){n.focus()}):n.focus():t.confirm("Không tìm thấy sản phẩm này, bạn có muốn tạo không?").then(function(t){var e=t;1===e?dmvtModule.quickadd(a,function(t){var e=n.tyGia?n.tyGia:1;t.gia_ban_le=STP.round(t.gia_ban_le/e,n.f_gia),t.gia_mua=STP.round(t.gia_mua/e,n.f_gia),t.tien_ck=STP.round(t.tien_ck/e,n.f_tien),n.onClick(t,function(){n.focus()})},{ma_vt:i},function(){n.condition="",n.focus()}):(n.condition="",n.focus())}))}))},n.searchBarcode=function(){document.addEventListener("deviceready",function(){o.scan().then(function(e){e.text&&(n.condition=e.text,n.filter(n.condition,n.showNumberProducts,function(e,i){return e?t.alert(e):void(i&&i.length>0?1==i.length&&n.onClick(i[0],function(){n.searchBarcode()}):t.confirm("Không tìm thấy sản phẩm này, bạn có muốn tạo không?").then(function(t){var e=t;1===e?dmvtModule.quickadd(a,function(t){var e=n.tyGia?n.tyGia:1;t.gia_ban_le=STP.round(t.gia_ban_le/e,n.f_gia),t.gia_mua=STP.round(t.gia_mua/e,n.f_gia),t.tien_ck=STP.round(t.tien_ck/e,n.f_tien),n.onClick(t,function(){n.searchBarcode()})},{ma_vt:n.condition},function(){n.searchBarcode()}):n.searchBarcode()}))}))},function(){})},!1)},n.onClick=function(e,i){if(i||(i=function(){}),n.onSelect)if(t.toast("Đã chọn "+e.ten_vt),e.ma_lo_yn||e.ma_tt1_yn||e.ma_tt2_yn||e.ma_tt3_yn){a.open({templateUrl:"templates/lists/dmvt/templates/select-lo.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","parentScope","appInfo",function(t,n,a,o,r,c,d){initLabel(n,t,d,"DMVT",o),t.buy=c.buy,t.item=e,t.parameters={ma_vt:e.ma_vt},c.where&&_.extend(t.parameters,c.where),t.cancel=function(){r.close(),i()},t.select=function(t){e.ma_lo=t.ma_lo||"",e.ma_kho=t.ma_kho||"",e.ma_tt1=t.ma_tt1||"",e.ma_tt2=t.ma_tt2||"",e.ma_tt3=t.ma_tt3||"",e.han_sd=t.han_sd,c.onSelect({$item:e}),r.close(),i()}}],size:"md",resolve:{parentScope:function(){return n}}})}else e.ma_lo=e.ma_lo||"",e.ma_kho=e.ma_kho||"",e.ma_tt1=e.ma_tt1||"",e.ma_tt2=e.ma_tt2||"",e.ma_tt3=e.ma_tt3||"",n.onSelect({$item:e}),i()},n.add=function(){dmvtModule.quickadd(a,function(t){n.list.push(t)})},0===n.list.length&&n.filter("",n.showNumberProducts)}],link:function(t){t.focus=function(){}}}}]);var dmnvtModule=new baseInput("dmnvt","dmnvt",["ten_nvt"],"Danh mục nhóm sản phẩm"),dmkhoModule=new baseInput("dmkho","dmkho",["ma_kho","ten_kho"],"Danh mục kho"),dmvatModule=new baseInput("dmvat","vat",["ma_thue","ten_thue","tk_thue_no","tk_thue_co"],"Danh mục thuế GTGT");dmvatModule.defaultValues={thue_suat:0};var dmntModule=new baseInput("dmnt","currency",["ma_nt","ten_nt"],"Danh mục ngoại tệ",{modal_size:"sm"}),dmtkModule=new baseInput("dmtk","account",["tk","ten_tk","tk_me","ma_nt"],"Danh mục tài khoản",{has_view:!1});dmtkModule.defaultValues={ma_nt:"VND"};var dmkcModule=new baseInput("dmkc","dmkc",["tk_chuyen","tk_nhan","ten_bt"],"Khai báo bút toán kết chuyển cuối kỳ");dmkcModule.defaultValues={loai_kc:"1",stt:1};var dmcpmhModule=new baseInput("dmcpmh","dmcpmh",["ma_cp","ten_cp"],"Danh mục chi phí mua hàng"),cdtkModule=new baseInput("cdtk","cdtk",["tk","ma_dvcs"],"Số dư đầu kỳ tài khoản");cdtkModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_no1=t.data.du_no00,t.data.du_co00=0,t.data.du_co1=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_co1=t.data.du_co00,t.data.du_no00=0,t.data.du_no1=0)})},cdtkModule.defaultValues={du_no00:0,du_no1:0,du_co00:0,du_co1:0};var cdkhModule=new baseInput("cdkh","cdkh",["tk","ma_kh","ma_dvcs"],"Số dư đầu kỳ công nợ khách hàng");cdkhModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_no1=t.data.du_no00,t.data.du_co00=0,t.data.du_co1=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_co1=t.data.du_co00,t.data.du_no00=0,t.data.du_no1=0)})},cdkhModule.defaultValues={du_no00:0,du_no1:0,du_co00:0,du_co1:0};var cdvtModule=new baseInput("cdvt","cdvt",["ma_vt","ma_kho","ma_dvcs"],"Số dư đầu kỳ vật tư");cdvtModule.defaultValues={ton00:0,du00:0,du_nt00:0};var tontucthoiModule=new baseInput("tontucthoi","tontucthoi",["ma_vt","ma_kho","ma_dvcs","ma_lo","ma_tt1","ma_tt2","ma_tt3"],"Tồn tức thời vật tư");tontucthoiModule.defaultValues={ton00:0,du00:0,du_nt00:0};var cddtModule=new baseInput("cddt","cddt",["tk","ma_dvcs","ma_dt"],"Số dư đầu kỳ vụ việc");cddtModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_co00=0,t.data.du_co_nt00=0)}),t.$watch("data.du_no_nt00",function(){t.isDataLoaded&&(t.data.du_co00=0,t.data.du_co_nt00=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_no00=0,t.data.du_no_nt00=0)}),t.$watch("data.du_co_nt00",function(){t.isDataLoaded&&(t.data.du_no00=0,t.data.du_no_nt00=0)})},cddtModule.defaultValues={du_no00:0,du_co00:0,du_no_nt00:0,du_co_nt:0};var dmphiModule=new baseInput("dmphi","dmphi",["ma_phi","ten_phi"],"Danh mục phí"),dmqct_input=function(t,n){t.modules=[],n.$http.get(server_url+"/api/modules").then(function(n){n.data.forEach(function(n){!n.type||"V"!=n.type&&"L"!=n.type||t.modules.push(n)})})},dmqctModule=new baseInput("dmqct","dmqct",["ma_ct","ten_qct"],"Danh mục quyển chứng từ",{onAdd:function(t,n){dmqct_input(t,n),t.data.field="so_ct",t.data.den_so=999999},onEdit:dmqct_input}),ptthanhtoanModule=new baseInput("ptthanhtoan","ptthanhtoan",["ten"],"Danh mục phương thức thanh toán");angular.module("vatvaoModule",[]).directive("ngVatvao",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",tkDuThue:"=",tTienNt:"=",tTien:"=",tenVt:"=",maKh:"="},templateUrl:"templates/vouchers/vatvao/templates/table.html",controller:["$scope","$uibModal","dmkh","dmvat","$timeout","$http","$rootScope","appInfo",function(t,n,e,a,i,o,r,c){initLabel(r,t,c,"VATVAO",o),t.STP=STP,t.status={isOpened:!1},t.openUrl=r.openUrl,t.f_sl=r.app_info.options.f_sl||2,t.f_ty_gia=r.app_info.options.f_ty_gia||0,t.f_gia=r.app_info.options.f_gia||0,t.f_tien=r.app_info.options.f_tien||0,1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt,t.$watch("ngMasterData.ty_gia",function(){1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt}),t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.delete1Row=function(n){var e=_.reject(t.ngData,function(t){return t.line===n.line});t.ngData.length=0;var a=0;e.forEach(function(n){n.line=a,t.ngData.push(n),a++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.ngMasterData&&(t.dt_current.ngay_hd=t.ngMasterData.ngay_ct,t.tkDuThue&&(t.dt_current.tk_du_thue=t.tkDuThue),t.tTienNt&&(t.dt_current.t_tien_nt=t.tTienNt),t.tTien&&(t.dt_current.t_tien=t.tTien),t.tenVt&&(t.dt_current.ten_vt=t.tenVt),(t.maKh||t.ngMasterData.ma_kh)&&(t.dt_current.ma_kh=t.maKh||t.ngMasterData.ma_kh,t.dt_current.ten_kh=t.ngMasterData.ten_kh,e.list(id_app,{ma_kh:t.maKh}).then(function(n){var e=n.data;1==e.length&&(t.dt_current.ten_kh=e[0].ten_kh,t.dt_current.dia_chi=e[0].dia_chi,t.dt_current.ma_so_thue=e[0].ma_so_thue)}))),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=_.find(t.ngData,function(t){return t.line==n}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/vatvao/templates/edit.html",controller:["$scope","$uibModalInstance","parentScope",function(t,n,e){t.STP=STP,t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.round=e.round,t.f_sl=e.f_sl,t.f_gia=e.f_gia,t.f_tien=e.f_tien,t.f_ty_gia=e.f_ty_gia,t.f_gia_nt=e.f_gia_nt,t.f_tien_nt=e.f_tien_nt,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.close()}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1
})}}],link:function(t){t.$watch("dt_current.thue_suat",function(){t.status.isOpened&&(t.dt_current.t_thue_nt=STP.round(t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.f_tien_nt),t.dt_current.t_thue=STP.round(t.dt_current.t_thue_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.t_thue_nt",function(){t.status.isOpened&&(t.dt_current.t_thue=STP.round(t.dt_current.t_thue_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.t_tien_nt",function(){t.status.isOpened&&(t.dt_current.t_tien=STP.round(t.dt_current.t_tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.t_thue_nt=STP.round(t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.f_tien_nt),t.dt_current.t_thue=STP.round(t.dt_current.t_thue_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.t_tien",function(){t.status.isOpened&&(t.dt_current.t_thue=STP.round(t.dt_current.t_tien*t.dt_current.thue_suat/100,t.f_tien))})}}}]),angular.module("vatraModule",[]).directive("ngVatra",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",tkDuThue:"=",tTienNt:"=",tTien:"=",tenVt:"=",maKh:"="},templateUrl:"templates/vouchers/vatra/templates/table.html",controller:["$scope","$uibModal","dmkh","dmvat","$timeout","$http","$rootScope","appInfo",function(t,n,e,a,i,o,r,c){initLabel(r,t,c,"VATRA",o),t.STP=STP,t.status={isOpened:!1},t.openUrl=r.openUrl,t.f_sl=r.app_info.options.f_sl||2,t.f_ty_gia=r.app_info.options.f_ty_gia||0,t.f_gia=r.app_info.options.f_gia||0,t.f_tien=r.app_info.options.f_tien||0,1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt,t.$watch("ngMasterData.ty_gia",function(){1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt}),t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.delete1Row=function(n){var e=_.reject(t.ngData,function(t){return t.line===n.line});t.ngData.length=0;var a=0;e.forEach(function(n){n.line=a,t.ngData.push(n),a++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.ngMasterData&&(t.dt_current.ngay_hd=t.ngMasterData.ngay_ct,t.tkDuThue&&(t.dt_current.tk_du_thue=t.tkDuThue),t.tTienNt&&(t.dt_current.t_tien_nt=t.tTienNt),t.tTien&&(t.dt_current.t_tien=t.tTien),t.tenVt&&(t.dt_current.ten_vt=t.tenVt),(t.maKh||t.ngMasterData.ma_kh)&&(t.dt_current.ma_kh=t.maKh||t.ngMasterData.ma_kh,t.dt_current.ten_kh=t.ngMasterData.ten_kh,e.list(id_app,{ma_kh:t.maKh||t.ngMasterData.ma_kh}).then(function(n){var e=n.data;1==e.length&&(t.dt_current.ten_kh=e[0].ten_kh,t.dt_current.dia_chi=e[0].dia_chi,t.dt_current.ma_so_thue=e[0].ma_so_thue)}))),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=_.find(t.ngData,function(t){return t.line==n}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/vatra/templates/edit.html",controller:["$scope","$uibModalInstance","parentScope",function(t,n,e){t.STP=STP,t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.round=e.round,t.f_sl=e.f_sl,t.f_gia=e.f_gia,t.f_tien=e.f_tien,t.f_ty_gia=e.f_ty_gia,t.f_gia_nt=e.f_gia_nt,t.f_tien_nt=e.f_tien_nt,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.close()}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.thue_suat",function(){t.status.isOpened&&(t.dt_current.t_thue_nt=STP.round(t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.f_tien_nt),t.dt_current.t_thue=STP.round(t.dt_current.t_thue_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.t_thue_nt",function(){t.status.isOpened&&(t.dt_current.t_thue=STP.round(t.dt_current.t_thue_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.t_tien_nt",function(){t.status.isOpened&&(t.dt_current.t_tien=STP.round(t.dt_current.t_tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.t_thue_nt=STP.round(t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.f_tien_nt),t.dt_current.t_thue=STP.round(t.dt_current.t_thue_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.t_tien",function(){t.status.isOpened&&(t.dt_current.t_thue=STP.round(t.dt_current.t_tien*t.dt_current.thue_suat/100,t.f_tien))})}}}]),angular.module("tdttcoModule",[]).directive("ngTdttco",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"="},templateUrl:"templates/vouchers/tdttco/templates/table.html",controller:["$scope","$uibModal","dmkh","dmvat","$timeout","$http","$rootScope","appInfo",function(t,n,e,a,i,o,r,c){initLabel(r,t,c,"TDTTCO",o),t.STP=STP,t.status={isOpened:!1},t.openUrl=r.openUrl,t.f_sl=r.app_info.options.f_sl||2,t.f_ty_gia=r.app_info.options.f_ty_gia||0,t.f_gia=r.app_info.options.f_gia||0,t.f_tien=r.app_info.options.f_tien||0,1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt,t.$watch("ngMasterData.ty_gia",function(){1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt}),t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.delete1Row=function(n){var e=_.reject(t.ngData,function(t){return t.line===n.line});t.ngData.length=0;var a=0;e.forEach(function(n){n.line=a,t.ngData.push(n),a++})},t.getInvoice=function(){if(!t.ngMasterData.ma_kh)return r.alert("Phải nhập một khách hàng trước khi lấy hóa đơn");var n=server_url+"/api/"+id_app+"/getinvoice2pay?ma_kh="+t.ngMasterData.ma_kh;t.ngMasterData._id&&(n=n+"&id_ct="+t.ngMasterData._id),o.get(n).then(function(n){t.ngData=n.data,0==t.ngData.length&&r.alert("Không có hóa đơn nào cần chi cho khách hàng này")},function(t){r.alert("Không thể lấy được thông tin hóa đơn"),console.log(t.data)})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=n,t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/tdttco/templates/edit.html",controller:["$scope","$uibModalInstance","parentScope",function(t,n,e){t.STP=STP,t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.round=e.round,t.f_sl=e.f_sl,t.f_gia=e.f_gia,t.f_tien=e.f_tien,t.f_ty_gia=e.f_ty_gia,t.f_gia_nt=e.f_gia_nt,t.f_tien_nt=e.f_tien_nt,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.close()}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_nt",function(){t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=STP.round(t.dt_current.tien/t.dt_current.ty_gia_hd,t.f_tien_nt)))}),t.$watch("dt_current.tien",function(){t.status.isOpened&&0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=STP.round(t.dt_current.tien/t.dt_current.ty_gia_hd,t.f_tien_nt))})}}}]),angular.module("tdttnoModule",[]).directive("ngTdttno",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"="},templateUrl:"templates/vouchers/tdttno/templates/table.html",controller:["$scope","$uibModal","dmkh","dmvat","$timeout","$http","$rootScope","appInfo",function(t,n,e,a,i,o,r,c){initLabel(r,t,c,"TDTTNO",o),t.STP=STP,t.status={isOpened:!1},t.openUrl=r.openUrl,t.f_sl=r.app_info.options.f_sl||2,t.f_ty_gia=r.app_info.options.f_ty_gia||0,t.f_gia=r.app_info.options.f_gia||0,t.f_tien=r.app_info.options.f_tien||0,1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt,t.$watch("ngMasterData.ty_gia",function(){1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt}),t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.delete1Row=function(n){var e=_.reject(t.ngData,function(t){return t.line===n.line});t.ngData.length=0;var a=0;e.forEach(function(n){n.line=a,t.ngData.push(n),a++})},t.getInvoice=function(){if(!t.ngMasterData.ma_kh)return r.alert("Phải nhập một khách hàng trước khi lấy hóa đơn");var n=server_url+"/api/"+id_app+"/getinvoice2receive?ma_kh="+t.ngMasterData.ma_kh;t.ngMasterData._id&&(n=n+"&id_ct="+t.ngMasterData._id),o.get(n).then(function(n){t.ngData=n.data,0==t.ngData.length&&r.alert("Không có hóa đơn nào cần thu cho khách hàng này")},function(t){r.alert("Không thể lấy được thông tin hóa đơn"),console.log(t.data)})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=n,t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/tdttno/templates/edit.html",controller:["$scope","$uibModalInstance","parentScope",function(t,n,e){t.STP=STP,t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.round=e.round,t.f_sl=e.f_sl,t.f_gia=e.f_gia,t.f_tien=e.f_tien,t.f_ty_gia=e.f_ty_gia,t.f_gia_nt=e.f_gia_nt,t.f_tien_nt=e.f_tien_nt,t.status=e.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.close()}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_nt",function(){t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=STP.round(t.dt_current.tien/t.dt_current.ty_gia_hd,t.f_tien_nt)))}),t.$watch("dt_current.tien",function(){t.status.isOpened&&0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=STP.round(t.dt_current.tien/t.dt_current.ty_gia_hd,t.f_tien_nt))})}}}]),angular.module("ctcpmhModule",[]).directive("ngCtcpmh",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",allocate:"&"},templateUrl:"templates/vouchers/ctcpmh/templates/table.html",controller:["$scope","$uibModal","dmkh","dmvat","$timeout","$http","$rootScope","appInfo",function(t,n,e,a,i,o,r,c){initLabel(r,t,c,"CTCPMH",o),t.status={isOpened:!1},t.STP=STP,t.openUrl=r.openUrl,t.f_sl=r.app_info.options.f_sl||2,t.f_ty_gia=r.app_info.options.f_ty_gia||0,t.f_gia=r.app_info.options.f_gia||0,t.f_tien=r.app_info.options.f_tien||0,1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt,t.$watch("ngMasterData.ty_gia",function(){1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt}),t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.delete1Row=function(n){var e=_.reject(t.ngData,function(t){return t.line===n.line});t.ngData.length=0;var a=0;e.forEach(function(n){n.line=a,t.ngData.push(n),a++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.openDetail("sm")},t.editDetail=function(n){t.dt_master=_.find(t.ngData,function(t){return t.line==n}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("sm")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/ctcpmh/templates/edit.html",controller:["$scope","$uibModalInstance","parentScope",function(t,n,e){t.STP=STP,t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.round=e.round,t.f_sl=e.f_sl,t.f_gia=e.f_gia,t.f_tien=e.f_tien,t.f_ty_gia=e.f_ty_gia,t.f_gia_nt=e.f_gia_nt,t.f_tien_nt=e.f_tien_nt,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.close()}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_cp_nt",function(){t.status.isOpened&&(t.dt_current.tien_cp=STP.round(t.dt_current.tien_cp_nt*t.ngMasterData.ty_gia,t.f_tien))})}}}]),angular.module("ctcpbhModule",[]).directive("ngCtcpbh",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",allocate:"&"},templateUrl:"templates/vouchers/ctcpbh/templates/table.html",controller:["$scope","$uibModal","dmkh","dmvat","$timeout","$http","$rootScope","appInfo",function(t,n,e,a,i,o,r,c){initLabel(r,t,c,"CTCPBH",o),t.status={isOpened:!1},t.STP=STP,t.openUrl=r.openUrl,t.f_sl=r.app_info.options.f_sl||2,t.f_ty_gia=r.app_info.options.f_ty_gia||0,t.f_gia=r.app_info.options.f_gia||0,t.f_tien=r.app_info.options.f_tien||0,1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt,t.$watch("ngMasterData.ty_gia",function(){1==t.ngMasterData.ty_gia?(t.f_gia_nt=r.app_info.options.f_gia||0,t.f_tien_nt=r.app_info.options.f_tien||0):(t.f_gia_nt=r.app_info.options.f_gia_nt||2,t.f_tien_nt=r.app_info.options.f_tien_nt||2),t.round=t.f_tien_nt}),t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.delete1Row=function(n){var e=_.reject(t.ngData,function(t){return t.line===n.line});t.ngData.length=0;var a=0;e.forEach(function(n){n.line=a,t.ngData.push(n),a++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.openDetail("sm")},t.editDetail=function(n){t.dt_master=_.find(t.ngData,function(t){return t.line==n}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("sm")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/ctcpbh/templates/edit.html",controller:["$scope","$uibModalInstance","parentScope",function(t,n,e){t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.round=e.round,t.f_sl=e.f_sl,t.f_gia=e.f_gia,t.f_tien=e.f_tien,t.f_ty_gia=e.f_ty_gia,t.f_gia_nt=e.f_gia_nt,t.f_tien_nt=e.f_tien_nt,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.close()}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_cp_nt",function(){t.status.isOpened&&(t.dt_current.tien_cp=STP.round(t.dt_current.tien_cp_nt*t.ngMasterData.ty_gia,t.f_tien))})}}}]);var pktModule=new baseVoucher("pkt","pkt",[],"Phiếu kế toán");pktModule.defaultValues={vatvaos:[],vatras:[]},pktModule.defaultValues4Detail={tien_nt:0,tien:0},pktModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pktModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pktModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,t.f_tien))})},pktModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.vatras,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var pkcModule=new baseVoucher("pkc","pkc",[],"Phiếu kết chuyển cuối kỳ");pkcModule.defaultValues={},pkcModule.defaultValues4Detail={tien_nt:0,tien:0},pkcModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pkcModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pkcModule.watchDetail=function(t){t.createKC=function(){_.isDate(t.ngMasterData.ngay_ct)||(t.ngMasterData.ngay_ct=new Date(t.ngMasterData.ngay_ct)),t.ngMasterData.details=[];var n=server_url_report+"/api/"+id_app+"/getdk4pkc?id_ct="+t.ngMasterData._id;n+="&thang="+t.ngMasterData.ngay_ct.getMonth().toString(),n+="&nam="+t.ngMasterData.ngay_ct.getFullYear().toString(),t.ngMasterData.kc_dvcs&&(n=n+"&ma_dvcs="+t.ngMasterData.ma_dvcs),t.$http.get(n).then(function(n){t.messageError=void 0,t.ngMasterData.details=n.data},function(n){t.alertType="alert alert-danger",t.messageError=n.data})}},pkcModule.watchMaster=function(){};var kbbtpbModule=new baseVoucher("kbbtpb","kbbtpb",[],"Khai báo bút toán phân bổ");kbbtpbModule.defaultValues={};var ppbModule=new baseVoucher("ppb","ppb",[],"Phiếu phân bổ chi phí");ppbModule.defaultValues={},ppbModule.defaultValues4Detail={tien_nt:0,tien:0},ppbModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},ppbModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},ppbModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,0))}),t.dmkc=function(){t.$window.open("#kbbtpb","Khai báo bút toán phân bổ chi phí","width=800,height=400")},t.createKC=function(){t.$uibModal.open({templateUrl:"templates/vouchers/ppb/templates/form-select-invoice.html",controller:["$scope","$uibModalInstance","parentScope","$filter",function(n,e,a,i){n.condition={tu_ngay:new Date,den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.masters=[],n.details=[],n.invoiceClick=function(t){n.details=[];var e=_.find(n.masters,function(n){return n._id==t});n.details=e.details},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url+"/api/"+id_app+"/getbtpb?ma_dvcs="+n.ngMasterData.ma_dvcs+"&ngay_ct="+i("date")(n.ngMasterData.ngay_ct,"yyyy-MM-dd");n.ngMasterData._id&&(e=e+"&id_ct="+n.ngMasterData._id),t.$http.get(e).then(function(t){n.masters=t.data},function(t){n.masters=[],alert(t.data)})},n.ok=function(){a.ngMasterData.details=[];var t=0;n.masters.forEach(function(e){if(e.sel){var i=e.tien,o=0,r=0;e.details.forEach(function(t){r+=t.he_so});for(var c=0;c<e.details.length;c++){var d=e.details[c];if(d.line=t,d.tk_co=e.tk_co,a.ngMasterData.details.push(d),r?(d.tien_nt=STP.round(d.he_so/r*i,n.f_tien),d.tien=d.tien_nt):(d.tien_nt=0,d.tien=0),o=d.tien_nt+o,o>i){d.tien_nt=d.tien_nt-(o-i);break}t++}}}),e.close()},n.cancel=function(){e.close()},n.loadInvoice()}],size:"lg",resolve:{parentScope:function(){return t}}})}},ppbModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)})})};var dnmModule=new baseVoucher("dnm","dnm",["so_ct","ma_hd","dien_giai","ma_kh","ten_kh"],"Đề nghị mua hàng",{onLoading:function(t,n){t.tinhtienhang=function(t,e){var a=1;e.ty_gia&&(a=e.ty_gia);var i="VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,o="VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt,r=n.$rootScope.app_info.options.f_tien;t.gia=STP.round(t.gia_nt*a,i),t.tien_nt=STP.round(t.so_luong*t.gia_nt,o),t.tien=STP.round(t.tien_nt*a,r),t.tien_ck_nt=STP.round(t.tien_nt*t.ty_le_ck/100,o),t.tien_ck=STP.round(t.tien_ck_nt*a,r),t.thue_suat_nk=t.thue_suat_nk||0,t.gia_von_nk_nt=t.gia_von_nk_nt||(t.thue_suat_nk?t.gia_nt:0),t.gia_von_nk=STP.round(t.gia_von_nk_nt*a,o),t.tien_hang_nk_nt=STP.round(t.gia_von_nk_nt*t.so_luong,o),t.tien_hang_nk=STP.round(t.tien_hang_nk_nt*a,r),t.tien_thue_nk_nt=STP.round(t.thue_suat_nk*t.tien_hang_nk_nt/100,o),t.tien_thue_nk=STP.round(t.tien_thue_nk_nt*a,r),t.tt_nt=t.tien_nt-t.tien_ck_nt+t.tien_thue_nk_nt,t.tt=t.tien-t.tien_ck+t.tien_thue_nk},t.printBarcode=function(){var e=JSON.parse(JSON.stringify(t.list));e=_.filter(e,function(t){return t.sel});var a=[];if(e.forEach(function(t){a=a.concat(t.details)}),0==a.length)return void n.$rootScope.alert("Bạn hãy chọn ít nhất một phiếu để in");for(var i=0;i<a.length;i++)a[i].line=i;async.map(a,function(t,e){dmvtModule.getService(n.$http,n.$q,n.$rootScope).load(id_app,{condition:{ma_vt:t.ma_vt}}).then(function(n){1==n.data.length&&(t.gia_ban_le=n.data[0].gia_ban_le),e()},function(){e()})},function(){n.$uibModal.open({template:"<div style='height:"+(innerHeight-10).toString()+"px'><div class='scrollable'><div class='scrollable-content'><barcode data='list' field-code='ma_vt'  field-price='gia_nt' field-qty='so_luong' field-label='ten_vt' on-close='cancel()'></barcode></div></div></div>",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(t,n,e,i,o){t.list=a,t.cancel=function(){o.close()}}],size:"md",resolve:{parentScope:function(){return t}}})})},t.createPN=function(t){var e=JSON.parse(JSON.stringify(t));e.id_dnm=e._id,e.ngay_ct=new Date,delete e._id,delete e.so_ct;var a=0,i=n.$rootScope.app_info.options.f_tien,o="VND"==t.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt;e.details=_.filter(e.details,function(t){return t.so_luong>t.sl_da_nhap}),e.details.forEach(function(t){t.sl_nhap=n.$rootScope.app_info.options.sl_nhap_sl_hop_dong?t.so_luong-(t.sl_da_nhap||0):0,t.gia_von=t.gia,t.gia_von_nt=t.gia_nt,t.tien_hang=STP.round(t.gia_von*t.sl_nhap,i),t.tien_hang_nt=STP.round(t.gia_von_nt*t.sl_nhap,o),t.tien_ck=t.tien_ck||0,t.tien_ck_nt=t.tien_ck_nt||0,t.tien_phi=t.tien_phi||0,t.tien_phi_nt=t.tien_phi_nt||0,t.gia_von_nk=t.gia_von_nk||0,t.gia_von_nk_nt=t.gia_von_nk_nt||0,t.tien_hang_nk=t.gia_von_nk*t.sl_nhap,t.tien_hang_nk_nt=t.gia_von_nk_nt*t.sl_nhap,t.thue_suat_nk=t.thue_suat_nk||0,t.tien_thue_nk=STP.round(t.tien_hang_nk*t.thue_suat_nk/100,i),t.tien_thue_nk_nt=STP.round(t.tien_hang_nk_nt*t.thue_suat_nk/100,o),(t.tien_hang_nk_nt||t.tien_thue_nk_nt)&&(a=1),t.tien_nhap=t.tien_hang-t.tien_ck+t.tien_phi+t.tien_thue_nk,t.tien_nhap_nt=t.tien_hang_nt-t.tien_ck_nt+t.tien_phi_nt+t.tien_thue_nk_nt});var r=a?pn9Module:pn1Module;r.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)},t.createContract=function(t){var e=JSON.parse(JSON.stringify(t));e.id_dnm=e._id,delete e._id,delete e.so_ct,e.ngay_ct=new Date,purchase_contractModule.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)},t.createShipBook=function(t){var e={};_.extend(e,t),e.id_dnm=e._id,e.ngay_ct=new Date,e.ngay_tau_di=new Date,e.ngay_sx=new Date,e.ma_kh="",e.ten_kh="",e.trang_thai="1",e.t_thue_nt=0,e.t_thue=0,e.ma_thue="",e.thue_suat=0,e.tk_thue_co="",e.details.forEach(function(t){t.tien_nt=0,t.tien=0,t.gia_nt=0,t.gia=0,t.tien_ck=0,t.tien_ck_nt=0,t.exfields_detail||(t.exfields_detail={}),t.exfields_detail.tien_phi_nt=0,t.exfields_detail.tien_phi=0,t.exfields_detail.tien_phi_khac_nt=0,t.exfields_detail.tien_phi_khac=0}),delete e._id,shipbookModule.quickadd(n.$uibModal,function(n){t.id_shipbook=n._id},e)},t.createVanChuyen=function(t){var e={};_.extend(e,t),e.id_dnm=e._id,e.ngay_ct=new Date,e.ngay_van_chuyen=new Date,e.ngay_sx=new Date,e.ma_kh="",e.ten_kh="",e.trang_thai="1",e.t_thue_nt=0,e.t_thue=0,e.ma_thue="",e.thue_suat=0,e.tk_thue_co="",delete e._id,e.details.forEach(function(t){t.tien_nt=0,t.tien=0,t.gia_nt=0,t.gia=0,t.tien_ck=0,t.tien_ck_nt=0,t.exfields_detail||(t.exfields_detail={})}),vanchuyenModule.quickadd(n.$uibModal,function(n){t.id_vanchuyen=n._id},e)}},onInput:function(t,n){var e=1,a=function(a,i){t.data.ty_gia&&(e=t.data.ty_gia);var o={},r=_.filter(t.data.details,function(t){return!(t.ma_vt!==a.ma_vt||t.ma_lo!=a.ma_lo&&(t.ma_lo||a.ma_lo)||t.han_sd!=a.han_sd&&(t.han_sd||a.han_sd)||t.ma_tt1!=a.ma_tt1&&(t.ma_tt1||a.ma_tt1)||t.ma_tt2!=a.ma_tt2&&(t.ma_tt2||a.ma_tt2)||t.ma_tt3!=a.ma_tt3&&(t.ma_tt3||a.ma_tt3))});if(r.length>0)return o=r[0],o.so_luong=Number(o.so_luong)+1,i(o);if(o={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},dnmModule.defaultValues4Detail)for(var c in dnmModule.defaultValues4Detail)o[c]=dnmModule.defaultValues4Detail[c];if(t.data.options)for(var c in t.data.options)t.data.options[c]&&(o[c]=t.data.options[c]);o.so_luong=1,o.thue_suat_nk=a.thue_suat_nk||0;var d=null;n.$rootScope.prompt("Giá mua:",a.gia_mua?a.gia_mua:0).then(function(r){var c=r.buttonIndex;if(1==c){if(d=r.input1,null==d)return i();if(d=Number(d)){if(a.gia_mua!==d){a.gia_mua=d;var l=server_url+"/api/"+id_app+"/dmvt/"+a._id;n.$http.put(l,a).then(function(){},function(t){console.log("can't update price for product",t.data)})}o.gia=STP.round(d*e,t.f_gia),o.gia_nt=d}o.ty_le_ck=0,o.line=t.data.details.length,t.data.details.push(o),i(o)}else i()})};t.tinhtienhang=function(a){t.data.ty_gia&&(e=t.data.ty_gia),a.gia=STP.round(a.gia_nt*e,t.f_gia),a.tien_nt=STP.round(a.so_luong*a.gia_nt,t.f_tien_nt),a.tien=STP.round(a.tien_nt*e,t.f_tien),a.tien_ck_nt=STP.round(a.tien_nt*a.ty_le_ck/100,t.f_tien_nt),a.tien_ck=STP.round(a.tien_ck_nt*e,t.f_tien),a.thue_suat_nk=a.thue_suat_nk||0,a.gia_von_nk_nt=a.gia_von_nk_nt||(a.thue_suat_nk?a.gia_nt:0),a.gia_von_nk=STP.round(a.gia_von_nk_nt*e,t.f_tien_nt),a.tien_hang_nk_nt=STP.round(a.gia_von_nk_nt*a.so_luong,t.f_tien_nt),a.tien_hang_nk=STP.round(a.tien_hang_nk_nt*e,t.f_tien),a.tien_thue_nk_nt=STP.round(a.thue_suat_nk*a.tien_hang_nk_nt/100,t.f_tien_nt),a.tien_thue_nk=STP.round(a.tien_thue_nk_nt*e,t.f_tien),a.tt_nt=a.tien_nt-a.tien_ck_nt+a.tien_thue_nk_nt,a.tt=a.tien-a.tien_ck+a.tien_thue_nk,dnmModule.tinhCkvt(n.$http,t.data,a)},t.select=function(n){a(n,function(n){n&&t.tinhtienhang(n)})}}});dnmModule.defaultValues={},dnmModule.defaultValues4Detail={so_luong:0,ty_le_ck:0,gia_nt:0,gia:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_hang_nk:0,tien_hang_nk_nt:0,tien_thue_nk:0,tien_thue_nk_nt:0,thue_suat_nk:0,tt_nt:0,tt:0},dnmModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},dnmModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ma_hd:{$regex:t.vcondition.ma_hd,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},dnmModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia=STP.round(e.gia_nt*n,t.f_gia),e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.gia_von_nk=STP.round(e.gia_von_nk_nt*n,t.f_tien),e.tien_hang_nk=STP.round(e.tien_hang_nk_nt*n,t.f_tien),e.tien_thue_nk=STP.round(e.tien_thue_nk_nt*n,t.f_tien),e.tt=STP.round(e.tt_nt*n,t.f_tien)})})};var bg2Module=new baseVoucher("bg2","bg2",[],"Báo giá của nhà cung cấp",{onLoading:function(t,n){t.tinhtienhang=function(t,e){var a=1;e.ty_gia&&(a=e.ty_gia);var i="VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,o="VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt,r=n.$rootScope.app_info.options.f_tien;t.gia=STP.round(t.gia_nt*a,i),t.tien_nt=STP.round(t.so_luong*t.gia_nt,o),t.tien=STP.round(t.tien_nt*a,r),t.tien_ck_nt=STP.round(t.tien_nt*t.ty_le_ck/100,o),t.tien_ck=STP.round(t.tien_ck_nt*a,r),t.thue_suat_nk=t.thue_suat_nk||0,t.gia_von_nk_nt=t.gia_von_nk_nt||(t.thue_suat_nk?t.gia_nt:0),t.gia_von_nk=STP.round(t.gia_von_nk_nt*a,r),t.tien_hang_nk_nt=STP.round(t.gia_von_nk_nt*t.so_luong,o),t.tien_hang_nk=STP.round(t.tien_hang_nk_nt*a,r),t.tien_thue_nk_nt=STP.round(t.thue_suat_nk*t.tien_hang_nk_nt/100,o),t.tien_thue_nk=STP.round(t.tien_thue_nk_nt*a,r),t.tt_nt=t.tien_nt-t.tien_ck_nt+t.tien_thue_nk_nt,t.tt=t.tien-t.tien_ck+t.tien_thue_nk},t.createContract=function(t){var e=JSON.parse(JSON.stringify(t));e.id_bao_gia=e._id,delete e._id,delete e.so_ct,purchase_contractModule.quickadd(n.$uibModal,function(e){t.id_contract=e._id,n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)},t.createBG1=function(t){var e=JSON.parse(JSON.stringify(t));e.details.forEach(function(t){t.gia=t.gia_ban_de_nghi,t.gia_nt=t.gia_ban_de_nghi_nt,t.tien=t.gia*t.so_luong,t.tien_nt=t.gia_nt*t.so_luong,t.tien_ck=0,t.tien_ck_nt=0,t.ty_le_ck=0,t.tt=0,t.tt_nt=0}),e.id_bao_gia_mua=e._id,e.ma_kh="",e.ten_kh="",delete e._id,bg1Module.quickadd(n.$uibModal,function(e){t.id_bao_gia_mua=e._id,n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onInput:function(t,n){var e=1,a=function(a,i){t.data.ty_gia&&(e=t.data.ty_gia);var o={},r=_.filter(t.data.details,function(t){return!(t.ma_vt!==a.ma_vt||t.ma_lo!=a.ma_lo&&(t.ma_lo||a.ma_lo)||t.han_sd!=a.han_sd&&(t.han_sd||a.han_sd)||t.ma_tt1!=a.ma_tt1&&(t.ma_tt1||a.ma_tt1)||t.ma_tt2!=a.ma_tt2&&(t.ma_tt2||a.ma_tt2)||t.ma_tt3!=a.ma_tt3&&(t.ma_tt3||a.ma_tt3))
});if(r.length>0)return o=r[0],o.so_luong=Number(o.so_luong)+1,i(o);if(o={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},bg2Module.defaultValues4Detail)for(var c in bg2Module.defaultValues4Detail)o[c]=bg2Module.defaultValues4Detail[c];if(t.data.options)for(var c in t.data.options)t.data.options[c]&&(o[c]=t.data.options[c]);o.thue_suat_nk=a.thue_suat_nk||0,o.so_luong=1;var d=null;n.$rootScope.prompt("Giá mua:",a.gia_mua?a.gia_mua:0).then(function(r){var c=r.buttonIndex;if(1==c){if(d=r.input1,null==d)return i();if(d=Number(d)){if(a.gia_mua!==d){a.gia_mua=d;var l=server_url+"/api/"+id_app+"/dmvt/"+a._id;n.$http.put(l,a).then(function(){},function(t){console.log("can't update price for product",t.data)})}o.gia=STP.round(d*e,t.f_tien),o.gia_nt=d}o.ty_le_ck=0,o.line=t.data.details.length,t.data.details.push(o),i(o)}else i()})};t.tinhtienhang=function(n){t.data.ty_gia&&(e=t.data.ty_gia),n.gia=STP.round(n.gia_nt*e,t.f_gia),n.tien_nt=STP.round(n.so_luong*n.gia_nt,t.f_tien_nt),n.tien=STP.round(n.tien_nt*e,t.f_tien),n.tien_ck_nt=STP.round(n.tien_nt*n.ty_le_ck/100,t.f_tien_nt),n.tien_ck=STP.round(n.tien_ck_nt*e,t.f_tien),n.thue_suat_nk=n.thue_suat_nk||0,n.gia_von_nk_nt=n.gia_von_nk_nt||(n.thue_suat_nk?n.gia_nt:0),n.gia_von_nk=STP.round(n.gia_von_nk_nt*e,t.f_tien),n.tien_hang_nk_nt=STP.round(n.gia_von_nk_nt*n.so_luong,t.f_tien_nt),n.tien_hang_nk=STP.round(n.tien_hang_nk_nt*e,t.f_tien),n.tien_thue_nk_nt=STP.round(n.thue_suat_nk*n.tien_hang_nk_nt/100,t.f_tien_nt),n.tien_thue_nk=STP.round(n.tien_thue_nk_nt*e,t.f_tien),n.tt_nt=n.tien_nt-n.tien_ck_nt+n.tien_thue_nk_nt,n.tt=n.tien-n.tien_ck+n.tien_thue_nk},t.select=function(n){a(n,function(n){n&&t.tinhtienhang(n)})}}});bg2Module.defaultValues={},bg2Module.defaultValues4Detail={so_luong:0,ty_le_ck:0,gia_nt:0,gia:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_hang_nk:0,tien_hang_nk_nt:0,tien_thue_nk:0,tien_thue_nk_nt:0,thue_suat_nk:0,tt_nt:0,tt:0},bg2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},bg2Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},bg2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia=STP.round(e.gia_nt*n,t.f_gia),e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.gia_von_nk=STP.round(e.gia_von_nk_nt*n,t.f_tien),e.tien_hang_nk=STP.round(e.tien_hang_nk_nt*n,t.f_tien),e.tien_thue_nk=STP.round(e.tien_thue_nk_nt*n,t.f_tien),e.tt=STP.round(e.tt_nt*n,t.f_tien)})})};var purchase_contractModule=new baseVoucher("purchase_contract","purchase_contract",["so_ct","ma_hd","dien_giai","ma_kh","ten_kh"],"Hợp đồng mua hàng",{onLoading:function(t,n){t.tinhtienhang=function(t,e){var a=1;e.ty_gia&&(a=e.ty_gia);var i="VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,o="VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt,r=n.$rootScope.app_info.options.f_tien;t.gia=STP.round(t.gia_nt*a,i),t.tien_nt=STP.round(t.so_luong*t.gia_nt,o),t.tien=STP.round(t.tien_nt*a,r),t.tien_ck_nt=STP.round(t.tien_nt*t.ty_le_ck/100,o),t.tien_ck=STP.round(t.tien_ck_nt*a,r),t.thue_suat_nk=t.thue_suat_nk||0,t.gia_von_nk_nt=t.gia_von_nk_nt||(t.thue_suat_nk?t.gia_nt:0),t.gia_von_nk=STP.round(t.gia_von_nk_nt*a,o),t.tien_hang_nk_nt=STP.round(t.gia_von_nk_nt*t.so_luong,o),t.tien_hang_nk=STP.round(t.tien_hang_nk_nt*a,r),t.tien_thue_nk_nt=STP.round(t.thue_suat_nk*t.tien_hang_nk_nt/100,o),t.tien_thue_nk=STP.round(t.tien_thue_nk_nt*a,r),t.tt_nt=t.tien_nt-t.tien_ck_nt+t.tien_thue_nk_nt,t.tt=t.tien-t.tien_ck+t.tien_thue_nk},t.printBarcode=function(){var e=JSON.parse(JSON.stringify(t.list));e=_.filter(e,function(t){return t.sel});var a=[];if(e.forEach(function(t){a=a.concat(t.details)}),0==a.length)return void n.$rootScope.alert("Bạn hãy chọn ít nhất một phiếu để in");for(var i=0;i<a.length;i++)a[i].line=i;async.map(a,function(t,e){dmvtModule.getService(n.$http,n.$q,n.$rootScope).load(id_app,{condition:{ma_vt:t.ma_vt}}).then(function(n){1==n.data.length&&(t.gia_ban_le=n.data[0].gia_ban_le),e()},function(){e()})},function(){n.$uibModal.open({template:"<div style='height:"+(innerHeight-10).toString()+"px'><div class='scrollable'><div class='scrollable-content'><barcode data='list' field-code='ma_vt'  field-price='gia_nt' field-qty='so_luong' field-label='ten_vt' on-close='cancel()'></barcode></div></div></div>",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(t,n,e,i,o){t.list=a,t.cancel=function(){o.close()}}],size:"md",resolve:{parentScope:function(){return t}}})})},t.createPN=function(t){var e=JSON.parse(JSON.stringify(t));e.id_contract=e._id,e.ngay_ct=new Date,delete e._id,delete e.so_ct;var a=0,i=n.$rootScope.app_info.options.f_tien,o="VND"==t.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt;e.details=_.filter(e.details,function(t){return t.so_luong>t.sl_da_nhap}),e.details.forEach(function(t){t.sl_nhap=n.$rootScope.app_info.options.sl_nhap_sl_hop_dong?t.so_luong-(t.sl_da_nhap||0):0,t.gia_von=t.gia,t.gia_von_nt=t.gia_nt,t.tien_hang=STP.round(t.gia_von*t.sl_nhap,i),t.tien_hang_nt=STP.round(t.gia_von_nt*t.sl_nhap,o),t.tien_ck=t.tien_ck||0,t.tien_ck_nt=t.tien_ck_nt||0,t.tien_phi=t.tien_phi||0,t.tien_phi_nt=t.tien_phi_nt||0,t.gia_von_nk=t.gia_von_nk||0,t.gia_von_nk_nt=t.gia_von_nk_nt||0,t.tien_hang_nk=t.gia_von_nk*t.sl_nhap,t.tien_hang_nk_nt=t.gia_von_nk_nt*t.sl_nhap,t.thue_suat_nk=t.thue_suat_nk||0,t.tien_thue_nk=STP.round(t.tien_hang_nk*t.thue_suat_nk/100,i),t.tien_thue_nk_nt=STP.round(t.tien_hang_nk_nt*t.thue_suat_nk/100,o),(t.tien_hang_nk_nt||t.tien_thue_nk_nt)&&(a=1),t.tien_nhap=t.tien_hang-t.tien_ck+t.tien_phi+t.tien_thue_nk,t.tien_nhap_nt=t.tien_hang_nt-t.tien_ck_nt+t.tien_phi_nt+t.tien_thue_nk_nt});var r=a?pn9Module:pn1Module;r.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)},t.createShipBook=function(t){var e={};_.extend(e,t),e.id_contract=e._id,e.ngay_ct=new Date,e.ngay_tau_di=new Date,e.ngay_sx=new Date,e.ma_kh="",e.ten_kh="",e.trang_thai="1",e.t_thue_nt=0,e.t_thue=0,e.ma_thue="",e.thue_suat=0,e.tk_thue_co="",e.details.forEach(function(t){t.tien_nt=0,t.tien=0,t.gia_nt=0,t.gia=0,t.tien_ck=0,t.tien_ck_nt=0,t.exfields_detail||(t.exfields_detail={}),t.exfields_detail.tien_phi_nt=0,t.exfields_detail.tien_phi=0,t.exfields_detail.tien_phi_khac_nt=0,t.exfields_detail.tien_phi_khac=0}),delete e._id,shipbookModule.quickadd(n.$uibModal,function(n){t.id_shipbook=n._id},e)},t.createVanChuyen=function(t){var e={};_.extend(e,t),e.id_contract=e._id,e.ngay_ct=new Date,e.ngay_van_chuyen=new Date,e.ngay_sx=new Date,e.ma_kh="",e.ten_kh="",e.trang_thai="1",e.t_thue_nt=0,e.t_thue=0,e.ma_thue="",e.thue_suat=0,e.tk_thue_co="",delete e._id,e.details.forEach(function(t){t.tien_nt=0,t.tien=0,t.gia_nt=0,t.gia=0,t.tien_ck=0,t.tien_ck_nt=0,t.exfields_detail||(t.exfields_detail={})}),vanchuyenModule.quickadd(n.$uibModal,function(n){t.id_vanchuyen=n._id},e)}},onInput:function(t,n){var e=1,a=function(a,i){t.data.ty_gia&&(e=t.data.ty_gia);var o={},r=_.filter(t.data.details,function(t){return!(t.ma_vt!==a.ma_vt||t.ma_lo!=a.ma_lo&&(t.ma_lo||a.ma_lo)||t.han_sd!=a.han_sd&&(t.han_sd||a.han_sd)||t.ma_tt1!=a.ma_tt1&&(t.ma_tt1||a.ma_tt1)||t.ma_tt2!=a.ma_tt2&&(t.ma_tt2||a.ma_tt2)||t.ma_tt3!=a.ma_tt3&&(t.ma_tt3||a.ma_tt3))});if(r.length>0)return o=r[0],o.so_luong=Number(o.so_luong)+1,i(o);if(o={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},purchase_contractModule.defaultValues4Detail)for(var c in purchase_contractModule.defaultValues4Detail)o[c]=purchase_contractModule.defaultValues4Detail[c];if(t.data.options)for(var c in t.data.options)t.data.options[c]&&(o[c]=t.data.options[c]);o.so_luong=1,o.thue_suat_nk=a.thue_suat_nk||0;var d=null;n.$rootScope.prompt("Giá mua:",a.gia_mua?a.gia_mua:0).then(function(r){var c=r.buttonIndex;if(1==c){if(d=r.input1,null==d)return i();if(d=Number(d)){if(a.gia_mua!==d){a.gia_mua=d;var l=server_url+"/api/"+id_app+"/dmvt/"+a._id;n.$http.put(l,a).then(function(){},function(t){console.log("can't update price for product",t.data)})}o.gia=STP.round(d*e,t.f_gia),o.gia_nt=d}o.ty_le_ck=0,o.line=t.data.details.length,t.data.details.push(o),i(o)}else i()})};t.tinhtienhang=function(n){t.data.ty_gia&&(e=t.data.ty_gia),n.gia=STP.round(n.gia_nt*e,t.f_gia),n.tien_nt=STP.round(n.so_luong*n.gia_nt,t.f_tien_nt),n.tien=STP.round(n.tien_nt*e,t.f_tien),n.tien_ck_nt=STP.round(n.tien_nt*n.ty_le_ck/100,t.f_tien_nt),n.tien_ck=STP.round(n.tien_ck_nt*e,t.f_tien),n.thue_suat_nk=n.thue_suat_nk||0,n.gia_von_nk_nt=n.gia_von_nk_nt||(n.thue_suat_nk?n.gia_nt:0),n.gia_von_nk=STP.round(n.gia_von_nk_nt*e,t.f_tien_nt),n.tien_hang_nk_nt=STP.round(n.gia_von_nk_nt*n.so_luong,t.f_tien_nt),n.tien_hang_nk=STP.round(n.tien_hang_nk_nt*e,t.f_tien),n.tien_thue_nk_nt=STP.round(n.thue_suat_nk*n.tien_hang_nk_nt/100,t.f_tien_nt),n.tien_thue_nk=STP.round(n.tien_thue_nk_nt*e,t.f_tien),n.tt_nt=n.tien_nt-n.tien_ck_nt+n.tien_thue_nk_nt,n.tt=n.tien-n.tien_ck+n.tien_thue_nk},t.select=function(n){a(n,function(n){n&&t.tinhtienhang(n)})}}});purchase_contractModule.defaultValues={},purchase_contractModule.defaultValues4Detail={so_luong:0,ty_le_ck:0,gia_nt:0,gia:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_hang_nk:0,tien_hang_nk_nt:0,tien_thue_nk:0,tien_thue_nk_nt:0,thue_suat_nk:0,tt_nt:0,tt:0},purchase_contractModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},purchase_contractModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ma_hd:{$regex:t.vcondition.ma_hd,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},purchase_contractModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia=STP.round(e.gia_nt*n,t.f_gia),e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.gia_von_nk=STP.round(e.gia_von_nk_nt*n,t.f_tien),e.tien_hang_nk=STP.round(e.tien_hang_nk_nt*n,t.f_tien),e.tien_thue_nk=STP.round(e.tien_thue_nk_nt*n,t.f_tien),e.tt=STP.round(e.tt_nt*n,t.f_tien)})})};var shipbookModule=new baseVoucher("shipbook","shipbook",[],"Book tàu",{onLoading:function(t,n){STPModules.trangthai.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{ma_ct:"SHIPBOOK"}}).then(function(n){t.trang_thai=n.data}),t.createPN=function(t){var e={};_.extend(e,t),e.id_contract=e._id,e.ngay_ct=new Date,delete e.so_ct,delete e._id;var a=0;e.details.forEach(function(t){t.sl_nhap=t.so_luong,t.gia_von=t.gia,t.gia_von_nt=t.gia_nt,t.tien_hang=t.tien,t.tien_hang_nt=t.tien_nt,t.tien_ck=t.tien_ck||0,t.tien_ck_nt=t.tien_ck_nt||0,t.tien_phi=t.tien_phi||0,t.tien_phi_nt=t.tien_phi_nt||0,t.gia_von_nk=t.gia_von_nk||0,t.gia_von_nk_nt=t.gia_von_nk_nt||0,t.tien_hang_nk=t.tien_hang_nk||0,t.tien_hang_nk_nt=t.tien_hang_nk_nt||0,t.thue_suat_nk=t.thue_suat_nk||0,t.tien_thue_nk=t.tien_hang_nk||0,t.tien_thue_nk_nt=t.tien_hang_nk_nt||0,(t.tien_hang_nk_nt||t.tien_thue_nk_nt)&&(a=1),t.tien_nhap=t.tien_hang-t.tien_ck+t.tien_phi+t.tien_thue_nk,t.tien_nhap_nt=t.tien_hang_nt-t.tien_ck_nt+t.tien_phi_nt+t.tien_thue_nk_nt});var i=a?pn9Module:pn1Module;i.quickadd(n.$uibModal,function(n){a?t.id_pn9=n._id:t.id_pn1=n._id},e)}},onInput:function(t,n){STPModules.trangthai.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{ma_ct:"SHIPBOOK"}}).then(function(n){t.ds_trang_thai=n.data}),t.phanbo=function(){var n=0;t.data.details.forEach(function(t){n+=t.so_luong||0});var e=0,a=0;t.data.details.forEach(function(i){i.tien_nt=0===n?0:STP.round(i.so_luong/n*t.data.tien_cuoc_nt,t.f_tien_nt),i.tien=STP.round(i.tien_nt*t.data.ty_gia,t.f_tien),i.gia_nt=i.so_luong?STP.round(i.tien_nt/i.so_luong,t.f_gia_nt):0,i.gia=STP.round(i.gia_nt*t.data.ty_gia,t.f_gia),a+=i.tien_nt,e+=1,e==t.data.details.length&&(i.tien_nt=i.tien_nt+(t.data.tien_cuoc_nt-a),i.tien=STP.round(i.tien_nt*t.data.ty_gia,t.f_tien))})},t.phanboProfitshare=function(){var n=("VND"===t.data.ma_nt?0:2,0);t.data.details.forEach(function(t){n+=t.so_luong||0});var e=0,a=0;t.data.details.forEach(function(i){i.exfields_detail||(i.exfields_detail={}),i.exfields_detail.tien_phi_nt=0===n?0:STP.round(i.so_luong/n*(t.data.exfields.tien_phi_nt||0),t.f_tien_nt),i.exfields_detail.tien_phi=STP.round(i.exfields_detail.tien_phi_nt*t.data.ty_gia,t.f_tien),a+=i.exfields_detail.tien_phi_nt,e+=1,e==t.data.details.length&&(i.exfields_detail.tien_phi_nt=i.exfields_detail.tien_phi_nt+(t.data.exfields.tien_phi_nt-a),i.exfields_detail.tien_phi=STP.round(i.exfields_detail.tien_phi_nt*t.data.ty_gia,t.f_tien))})},t.phanboPhiKhac=function(){var n=("VND"===t.data.ma_nt?0:2,0);t.data.details.forEach(function(t){n+=t.so_luong||0});var e=0,a=0;t.data.details.forEach(function(i){i.exfields_detail||(i.exfields_detail={}),i.exfields_detail.tien_phi_khac_nt=0===n?0:STP.round(i.so_luong/n*(t.data.exfields.tien_phi_khac_nt||0),t.f_tien_nt),i.exfields_detail.tien_phi_khac=STP.round(i.exfields_detail.tien_phi_khac_nt*t.data.ty_gia,t.f_tien),a+=i.exfields_detail.tien_phi_khac_nt,e+=1,e==t.data.details.length&&(i.exfields_detail.tien_phi_khac_nt=i.exfields_detail.tien_phi_khac_nt+(t.data.exfields.tien_phi_khac_nt-a),i.exfields_detail.tien_phi_khac=STP.round(i.exfields_detail.tien_phi_khac_nt*t.data.ty_gia,t.f_tien))})};var e=1,a=function(a,i){t.data.ty_gia&&(e=t.data.ty_gia);var o={},r=_.filter(t.data.details,function(t){return!(t.ma_vt!==a.ma_vt||t.ma_lo!=a.ma_lo&&(t.ma_lo||a.ma_lo)||t.han_sd!=a.han_sd&&(t.han_sd||a.han_sd)||t.ma_tt1!=a.ma_tt1&&(t.ma_tt1||a.ma_tt1)||t.ma_tt2!=a.ma_tt2&&(t.ma_tt2||a.ma_tt2)||t.ma_tt3!=a.ma_tt3&&(t.ma_tt3||a.ma_tt3))});if(r.length>0)return o=r[0],o.so_luong=Number(o.so_luong)+1,i(o);if(o={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},shipbookModule.defaultValues4Detail)for(var c in shipbookModule.defaultValues4Detail)o[c]=shipbookModule.defaultValues4Detail[c];if(t.data.options)for(var c in t.data.options)t.data.options[c]&&(o[c]=t.data.options[c]);o.so_luong=1,o.thue_suat_nk=a.thue_suat_nk||0;var d=null;n.$rootScope.prompt("Giá mua:",a.gia_mua?a.gia_mua:0).then(function(r){var c=r.buttonIndex;if(1==c){if(d=r.input1,null==d)return i();if(d=Number(d)){if(a.gia_mua!==d){a.gia_mua=d;var l=server_url+"/api/"+id_app+"/dmvt/"+a._id;n.$http.put(l,a).then(function(){},function(t){console.log("can't update price for product",t.data)})}o.gia=d*e,o.gia_nt=d}o.ty_le_ck=0,o.line=t.data.details.length,t.data.details.push(o),i(o)}else i()})};t.tinhtienhang=function(n){t.data.ty_gia&&(e=t.data.ty_gia);var a=2;1==e&&(a=0),n.gia=STP.round(n.gia_nt*e,t.f_gia),n.tien_nt=STP.round(n.so_luong*n.gia_nt,t.f_tien_nt),n.tien=STP.round(n.tien_nt*e,t.f_tien),n.tien_ck_nt=STP.round(n.tien_nt*n.ty_le_ck/100,t.f_tien_nt),n.tien_ck=STP.round(n.tien_ck_nt*e,t.f_tien),n.thue_suat_nk=n.thue_suat_nk||0,n.gia_von_nk_nt=n.gia_von_nk_nt||(n.thue_suat_nk?n.gia_nt:0),n.gia_von_nk=STP.round(n.gia_von_nk_nt*e,t.f_gia),n.tien_hang_nk_nt=STP.round(n.gia_von_nk_nt*n.so_luong,t.f_tien_nt),n.tien_hang_nk=STP.round(n.tien_hang_nk_nt*e,t.f_tien),n.tien_thue_nk_nt=STP.round(n.thue_suat_nk*n.tien_hang_nk_nt/100,t.f_tien_nt),n.tien_thue_nk=STP.round(n.tien_thue_nk_nt*e,t.f_tien),n.tt_nt=n.tien_nt-n.tien_ck_nt+n.tien_thue_nk_nt,n.tt=n.tien-n.tien_ck+n.tien_thue_nk},t.select=function(e){a(e,function(e){e&&(t.tinhtienhang(e),n.$rootScope.toast("Đã thêm sản phẩm "+e.ten_vt))})}}});shipbookModule.defaultValues={trang_thai:"1",ngay_sx:new Date,ngay_tau_di:new Date,tien_cuoc_nt:0,tien_cuoc:0,t_thue:0,t_thue_nt:0,tien_cuoc_ck:0,tien_cuoc_ck_nt:0,ty_le_cuoc_ck:0},shipbookModule.defaultValues4Detail={so_luong:0,ty_le_ck:0,gia_nt:0,gia:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_hang_nk:0,tien_hang_nk_nt:0,tien_thue_nk:0,tien_thue_nk_nt:0,thue_suat_nk:0,tt_nt:0,tt:0},shipbookModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},shipbookModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}};var vanchuyenModule=new baseVoucher("vanchuyen","vanchuyen",[],"Vận chuyển",{onLoading:function(t,n){STPModules.trangthai.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{ma_ct:"VANCHUYEN"}}).then(function(n){t.trang_thai=n.data}),t.createPN=function(t){var e={};_.extend(e,t),e.id_contract=e._id,e.ngay_ct=new Date,delete e._id;var a=0;e.details.forEach(function(t){t.sl_nhap=t.so_luong,t.gia_von=t.gia,t.gia_von_nt=t.gia_nt,t.tien_hang=t.tien,t.tien_hang_nt=t.tien_nt,t.tien_ck=t.tien_ck||0,t.tien_ck_nt=t.tien_ck_nt||0,t.tien_phi=t.tien_phi||0,t.tien_phi_nt=t.tien_phi_nt||0,t.gia_von_nk=t.gia_von_nk||0,t.gia_von_nk_nt=t.gia_von_nk_nt||0,t.tien_hang_nk=t.tien_hang_nk||0,t.tien_hang_nk_nt=t.tien_hang_nk_nt||0,t.thue_suat_nk=t.thue_suat_nk||0,t.tien_thue_nk=t.tien_hang_nk||0,t.tien_thue_nk_nt=t.tien_hang_nk_nt||0,(t.tien_hang_nk_nt||t.tien_thue_nk_nt)&&(a=1),t.tien_nhap=t.tien_hang-t.tien_ck+t.tien_phi+t.tien_thue_nk,t.tien_nhap_nt=t.tien_hang_nt-t.tien_ck_nt+t.tien_phi_nt+t.tien_thue_nk_nt});var i=a?pn9Module:pn1Module;i.quickadd(n.$uibModal,function(n){a?t.id_pn9=n._id:t.id_pn1=n._id},e)}},onInput:function(t,n){STPModules.trangthai.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{ma_ct:"VANCHUYEN"}}).then(function(n){t.ds_trang_thai=n.data}),t.phanbo=function(){var n=0;t.data.details.forEach(function(t){n+=t.so_luong||0});var e=0,a=0;t.data.details.forEach(function(i){i.tien_nt=0===n?0:STP.round(i.so_luong/n*t.data.tien_cuoc_nt,t.f_tien_nt),i.tien=STP.round(i.tien_nt*t.data.ty_gia,t.f_tien),i.gia_nt=i.so_luong?STP.round(i.tien_nt/i.so_luong,t.f_gia_nt):0,i.gia=STP.round(i.gia_nt*t.data.ty_gia,t.f_gia),a+=i.tien_nt,e+=1,e==t.data.details.length&&(i.tien_nt=i.tien_nt+(t.data.tien_cuoc_nt-a),i.tien=STP.round(i.tien_nt*t.data.ty_gia,t.f_tien))})};var e=1,a=function(a,i){t.data.ty_gia&&(e=t.data.ty_gia);var o={},r=_.filter(t.data.details,function(t){return!(t.ma_vt!==a.ma_vt||t.ma_lo!=a.ma_lo&&(t.ma_lo||a.ma_lo)||t.han_sd!=a.han_sd&&(t.han_sd||a.han_sd)||t.ma_tt1!=a.ma_tt1&&(t.ma_tt1||a.ma_tt1)||t.ma_tt2!=a.ma_tt2&&(t.ma_tt2||a.ma_tt2)||t.ma_tt3!=a.ma_tt3&&(t.ma_tt3||a.ma_tt3))});if(r.length>0)return o=r[0],o.so_luong=Number(o.so_luong)+1,i(o);if(o={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},vanchuyenModule.defaultValues4Detail)for(var c in vanchuyenModule.defaultValues4Detail)o[c]=vanchuyenModule.defaultValues4Detail[c];if(t.data.options)for(var c in t.data.options)t.data.options[c]&&(o[c]=t.data.options[c]);o.so_luong=1,o.thue_suat_nk=a.thue_suat_nk||0;var d=null;n.$rootScope.prompt("Giá mua:",a.gia_mua?a.gia_mua:0).then(function(r){var c=r.buttonIndex;if(1==c){if(d=r.input1,null==d)return i();if(d=Number(d)){if(a.gia_mua!==d){a.gia_mua=d;var l=server_url+"/api/"+id_app+"/dmvt/"+a._id;n.$http.put(l,a).then(function(){},function(t){console.log("can't update price for product",t.data)})}o.gia=d*e,o.gia_nt=d}o.ty_le_ck=0,o.line=t.data.details.length,t.data.details.push(o),i(o)}else i()})};t.tinhtienhang=function(n){t.data.ty_gia&&(e=t.data.ty_gia);var a=2;1==e&&(a=0),n.gia=STP.round(n.gia_nt*e,t.f_gia),n.tien_nt=STP.round(n.so_luong*n.gia_nt,t.f_tien_nt),n.tien=STP.round(n.tien_nt*e,t.f_tien),n.tien_ck_nt=STP.round(n.tien_nt*n.ty_le_ck/100,t.f_tien_nt),n.tien_ck=STP.round(n.tien_ck_nt*e,t.f_tien),n.thue_suat_nk=n.thue_suat_nk||0,n.gia_von_nk_nt=n.gia_von_nk_nt||(n.thue_suat_nk?n.gia_nt:0),n.gia_von_nk=STP.round(n.gia_von_nk_nt*e,t.f_gia),n.tien_hang_nk_nt=STP.round(n.gia_von_nk_nt*n.so_luong,t.f_tien_nt),n.tien_hang_nk=STP.round(n.tien_hang_nk_nt*e,t.f_tien),n.tien_thue_nk_nt=STP.round(n.thue_suat_nk*n.tien_hang_nk_nt/100,t.f_tien_nt),n.tien_thue_nk=STP.round(n.tien_thue_nk_nt*e,t.f_tien),n.tt_nt=n.tien_nt-n.tien_ck_nt+n.tien_thue_nk_nt,n.tt=n.tien-n.tien_ck+n.tien_thue_nk},t.select=function(e){a(e,function(e){e&&(t.tinhtienhang(e),n.$rootScope.toast("Đã thêm sản phẩm "+e.ten_vt))})}}});vanchuyenModule.defaultValues={trang_thai:"1",ngay_sx:new Date,ngay_tau_di:new Date,tien_cuoc_nt:0,tien_cuoc:0,t_thue:0,t_thue_nt:0,tien_cuoc_ck:0,tien_cuoc_ck_nt:0,ty_le_cuoc_ck:0},vanchuyenModule.defaultValues4Detail={so_luong:0,ty_le_ck:0,gia_nt:0,gia:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_hang_nk:0,tien_hang_nk_nt:0,tien_thue_nk:0,tien_thue_nk_nt:0,thue_suat_nk:0,tt_nt:0,tt:0},vanchuyenModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},vanchuyenModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}};var pn1Module=new baseVoucher("pn1","pn1",[],"Phiếu nhập mua hàng trong nước",{onLoading:function(t,n){t.tinhtienhang=function(t,e){var a=1;e.ty_gia&&(a=e.ty_gia);var i="VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,o="VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt,r=n.$rootScope.app_info.options.f_tien;t.gia_von=STP.round(t.gia_von_nt*a,i),t.tien_hang_nt=STP.round(t.sl_nhap*t.gia_von_nt,o),t.tien_hang=STP.round(t.tien_hang_nt*a,r),t.tien_ck_nt=STP.round(t.tien_hang_nt*t.ty_le_ck/100,o),t.tien_ck=STP.round(t.tien_ck_nt*a,r),t.tien_nhap_nt=t.tien_hang_nt-t.tien_ck_nt+t.tien_phi_nt,t.tien_nhap=t.tien_hang-t.tien_ck+t.tien_phi},t.printBarcode=function(){var e=JSON.parse(JSON.stringify(t.list));e=_.filter(e,function(t){return t.sel});var a=[];if(e.forEach(function(t){a=a.concat(t.details)}),0==a.length)return void n.$rootScope.alert("Bạn hãy chọn ít nhất một phiếu để in");for(var i=0;i<a.length;i++)a[i].line=i;async.map(a,function(t,e){dmvtModule.getService(n.$http,n.$q,n.$rootScope).load(id_app,{condition:{ma_vt:t.ma_vt}}).then(function(n){1==n.data.length&&(t.gia_ban_le=n.data[0].gia_ban_le),e()},function(){e()})},function(){n.$uibModal.open({template:"<div style='height:"+(innerHeight-10).toString()+"px'><div class='scrollable'><div class='scrollable-content'><barcode data='list' field-code='ma_vt'  field-price='gia_ban_le' field-qty='sl_nhap' field-label='ten_vt' on-close='cancel()'></barcode></div></div></div>",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(t,n,e,i,o){t.list=a,t.cancel=function(){o.close()}}],size:"md",resolve:{parentScope:function(){return t}}})})}},onInput:function(t,n){var e=1;t.ma_ntChange=function(e){e&&(n.app_info.options||(n.app_info.options={}),1===e?(t.f_tien_nt=n.app_info.options.f_tien||0,t.f_gia_nt=n.app_info.options.f_gia||0):(t.f_tien_nt=n.app_info.options.f_tien_nt||2,t.f_gia_nt=n.app_info.options.f_gia_nt||2),t.round=t.f_tien_nt,angular.forEach(t.data.details,function(n){n.gia_von_nt=STP.round(n.gia_von/e,t.f_gia_nt),n.tien_hang_nt=STP.round(n.tien_hang/e,t.f_tien_nt),n.tien_phi_nt=STP.round(n.tien_phi/e,t.f_tien_nt),n.tien_ck_nt=STP.round(n.tien_ck/e,t.f_tien_nt),n.tien_nhap_nt=STP.round(n.tien_nhap/e,t.f_tien_nt)}),angular.forEach(t.data.vatvaos,function(n){n.t_tien_nt=STP.round(n.t_tien/e,t.f_tien_nt),n.t_thue_nt=STP.round(n.t_thue/e,t.f_tien_nt)}),angular.forEach(t.data.ctcpmhs,function(n){n.tien_cp_nt=STP.round(n.tien_cp/e,t.f_tien_nt)}),t.data.ty_gia=e)};var a=function(a,i){t.data.ty_gia&&(e=t.data.ty_gia);var o={},r=_.filter(t.data.details,function(t){return!(t.ma_vt!==a.ma_vt||t.ma_lo!=a.ma_lo&&(t.ma_lo||a.ma_lo)||t.han_sd!=a.han_sd&&(t.han_sd||a.han_sd)||t.ma_tt1!=a.ma_tt1&&(t.ma_tt1||a.ma_tt1)||t.ma_tt2!=a.ma_tt2&&(t.ma_tt2||a.ma_tt2)||t.ma_tt3!=a.ma_tt3&&(t.ma_tt3||a.ma_tt3))});if(r.length>0)return o=r[0],o.sl_nhap=Number(o.sl_nhap)+1,i(o);if(o={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},pn1Module.defaultValues4Detail)for(var c in pn1Module.defaultValues4Detail)o[c]=pn1Module.defaultValues4Detail[c];if(t.data.options)for(var c in t.data.options)t.data.options[c]&&(o[c]=t.data.options[c]);o.sl_nhap=1;var d=null;n.$rootScope.prompt("Giá mua:",a.gia_mua?a.gia_mua:0).then(function(r){var c=r.buttonIndex;if(1==c){if(d=r.input1,null==d)return i();if(d=Number(d)){if(a.gia_mua!==d){a.gia_mua=d;var l=server_url+"/api/"+id_app+"/dmvt/"+a._id;n.$http.put(l,a).then(function(){},function(t){console.log("can't update price for product",t.data)})}o.gia_von=STP.round(d*e,t.f_gia),o.gia_von_nt=d}o.ty_le_ck=0,o.tien_phi_nt=0,o.tien_phi=0,o.line=t.data.details.length,t.data.details.push(o),i(o)}else i()})};t.tinhtienhang=function(a){t.data.ty_gia&&(e=t.data.ty_gia),a.gia_von=STP.round(a.gia_von_nt*e,t.f_gia),a.tien_hang_nt=STP.round(a.sl_nhap*a.gia_von_nt,t.f_tien_nt),a.tien_hang=STP.round(a.tien_hang_nt*e,t.f_tien),a.tien_ck_nt=STP.round(a.tien_hang_nt*a.ty_le_ck/100,t.f_tien_nt),a.tien_ck=STP.round(a.tien_ck_nt*e,t.f_tien),a.tien_nhap_nt=a.tien_hang_nt-a.tien_ck_nt+a.tien_phi_nt,a.tien_nhap=a.tien_hang-a.tien_ck+a.tien_phi,pn1Module.tinhCkvt(n.$http,t.data,a)},t.select=function(n){a(n,function(n){n&&t.tinhtienhang(n)})}}});pn1Module.defaultValues={vatvaos:[]},pn1Module.defaultValues4Detail={sl_nhap:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,tien_phi_nt:0,tien_phi:0,tien_nhap_nt:0,tien_nhap:0},pn1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn1Module.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return t.vcondition.ma_vt&&(n.details={$elemMatch:{ma_vt:t.vcondition.ma_vt}}),n},pn1Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_hang_nt=STP.round(t.dt_current.gia_von_nt*t.dt_current.sl_nhap,t.f_tien_nt))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=STP.round(t.dt_current.gia_von*t.dt_current.sl_nhap,t.f_tien))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=STP.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,t.f_tien),t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.tien_phi_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_phi=STP.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_phi",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)})},pn1Module.watchMaster=function(t,n){t.allocate=function(e){for(var a=t.data.t_cp_cpb_nt,i=t.data.t_cp_cpb,o=0,r=0;r<t.data.details.length;r++)o+=t.data.details[r][e];if(0!=o){var c=0,d=0,r=0;for(r=0;r<t.data.details.length;r++)t.data.details[r].tien_phi_nt=STP.round(t.data.details[r][e]/o*a,t.f_tien_nt),t.data.details[r].tien_phi=STP.round(t.data.details[r][e]/o*i,t.f_tien),c+=t.data.details[r].tien_phi_nt,d+=t.data.details[r].tien_phi,r===t.data.details.length-1&&(t.data.details[r].tien_phi_nt=t.data.details[r].tien_phi_nt+(a-c),t.data.details[r].tien_phi=t.data.details[r].tien_phi+(i-d)),t.data.details[r].tien_nhap_nt=t.data.details[r].tien_hang_nt-t.data.details[r].tien_ck_nt+t.data.details[r].tien_phi_nt,t.data.details[r].tien_nhap=t.data.details[r].tien_hang-t.data.details[r].tien_ck+t.data.details[r].tien_phi}n.$rootScope.toast("Chương trình đã thực hiện xong")}};var pn2Module=new baseVoucher("pn2","pn2",[],"Phiếu mua dịch vụ");pn2Module.defaultValues={vatvaos:[]},pn2Module.defaultValues4Detail={tien_nt:0,tien:0},pn2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn2Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn2Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0))})},pn2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)})})};var pn3Module=new baseVoucher("pn3","pn3",[],"Phiếu nhập chi phí mua hàng");pn3Module.defaultValues={vatvaos:[]},pn3Module.defaultValues4Detail={tien_ck_nt:0,tien_ck:0},pn3Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn3Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn3Module.watchDetail=function(t){t.$watch("dt_current.tien_phi_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_phi=STP.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,0))}),t.getPN=function(){t.$uibModal.open({templateUrl:"templates/vouchers/pn3/templates/form-select-invoice.html",controller:["$scope","$uibModalInstance","parentScope","$filter","$rootScope",function(n,e,a,i,o){n.condition={tu_ngay:new Date,den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.masters=[],n.details=[],n.invoiceClick=function(t){n.details=[];
var e=_.find(n.masters,function(n){return n._id==t});n.details=e.details},n.selectAllDetail=function(t){t.details.forEach(function(n){n.sel=t.sel})},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url+"/api/"+id_app+"/getpn2fee?";e=e+"tu_ngay="+i("date")(n.condition.tu_ngay,"yyyy-MM-dd"),e=e+"&den_ngay="+i("date")(n.condition.den_ngay,"yyyy-MM-dd"),n.condition.so_ct&&(e=e+"&so_ct="+n.condition.so_ct),t.$http.get(e).then(function(t){n.masters=t.data},function(t){n.masters=[],o.alert(t.data)})},n.ok=function(){a.ngMasterData.details=[];var t=0;n.masters.forEach(function(n){n.sel&&n.details.forEach(function(n){n.sel&&(n.line=t,a.ngMasterData.details.push(n),t++)})}),e.close()},n.cancel=function(){e.close()}}],size:"lg",resolve:{parentScope:function(){return t}}})}},pn3Module.watchMaster=function(t){t.allocate=function(n){for(var e=t.data.t_cp_cpb_nt,a=t.data.t_cp_cpb,i=0,o=0;o<t.data.details.length;o++)i+=t.data.details[o][n];if(0!=i){var r=0,c=0,o=0;for(o=0;o<t.data.details.length;o++)t.data.details[o].tien_phi_nt=STP.round(t.data.details[o][n]/i*e,t.round),t.data.details[o].tien_phi=STP.round(t.data.details[o][n]/i*a,t.f_tien),r+=t.data.details[o].tien_phi_nt,c+=t.data.details[o].tien_phi,o===t.data.details.length-1&&(t.data.details[o].tien_phi_nt=t.data.details[o].tien_phi_nt+(e-r),t.data.details[o].tien_phi=t.data.details[o].tien_phi+(a-c)),t.data.details[o].tien_nhap_nt=t.data.details[o].tien_hang_nt-t.data.details[o].tien_ck_nt+t.data.details[o].tien_phi_nt,t.data.details[o].tien_nhap=t.data.details[o].tien_hang-t.data.details[o].tien_ck+t.data.details[o].tien_phi}alert("Chương trình đã thực hiện xong")},t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien_phi=STP.round(e.tien_phi_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.ctcpmhs,function(e){e.tien_cp=STP.round(e.tien_cp_nt*n,t.f_tien)}))})};var pn5Module=new baseVoucher("pn5","pn5",[],"Phiếu xuất trả lại nhà cung cấp");pn5Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},pn5Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},pn5Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn5Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn5Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_xuat_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=STP.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_xuat_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.getInvoice=function(){t.$uibModal.open({templateUrl:"templates/vouchers/pn5/templates/form-select-invoice.html",controller:["$scope","$uibModalInstance","parentScope","$filter","$rootScope",function(n,e,a,i,o){n.condition={tu_ngay:new Date,den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.masters=[],n.details=[],n.invoiceClick=function(t){n.details=[];var e=_.find(n.masters,function(n){return n._id==t});n.details=e.details},n.selectAllDetail=function(t){t.details.forEach(function(n){n.sel=t.sel})},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url+"/api/"+id_app+"/getpn2return?ma_kh="+n.ngMasterData.ma_kh;e=e+"&tu_ngay="+i("date")(n.condition.tu_ngay,"yyyy-MM-dd"),e=e+"&den_ngay="+i("date")(n.condition.den_ngay,"yyyy-MM-dd"),n.condition.so_ct&&(e=e+"&so_ct="+n.condition.so_ct),n.ngMasterData._id&&(e=e+"&id_ct="+n.ngMasterData._id),t.$http.get(e).then(function(t){n.masters=t.data},function(t){n.masters=[],o.alert(t.data)})},n.ok=function(){a.ngMasterData.details=[];var t=0;n.masters.forEach(function(n){n.sel&&n.details.forEach(function(n){n.sel&&(n.line=t,a.ngMasterData.details.push(n),t++)})}),e.close()},n.cancel=function(){e.close()}}],size:"lg",resolve:{parentScope:function(){return t}}})}},pn5Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien_hang=STP.round(e.tien_hang_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.tien_xuat=STP.round(e.tien_xuat_nt*n,t.f_tien)}),t.data.t_thue=STP.round(t.data.t_thue_nt*n,t.f_tien))}),t.$watch("data.thue_suat",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=STP.round(t.data.t_thue_nt*t.data.ty_gia,t.f_tien))}),t.$watch("data.t_tien_hang_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=STP.round(t.data.t_thue_nt*t.data.ty_gia,t.f_tien))}),t.$watch("data.t_tien_hang",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=STP.round((t.data.t_tien_hang-t.data.t_ck)*t.data.thue_suat/100,t.f_tien))})};var pn9Module=new baseVoucher("pn9","pn9",[],"Phiếu nhập khẩu",{onLoading:function(t,n){t.tinhtienhang=function(t,e){var a=1;e.ty_gia&&(a=e.ty_gia);var i=("VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,"VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt),o=n.$rootScope.app_info.options.f_tien;t.tien_hang_nt=STP.round(t.sl_nhap*t.gia_von_nt,i),t.tien_hang=STP.round(t.tien_hang_nt*a,o),t.tien_hang_nk_nt=STP.round(t.sl_nhap*t.gia_von_nk_nt,i),t.tien_hang_nk=STP.round(t.tien_hang_nk_nt*a,o),t.tien_thue_nk_nt=STP.round(t.tien_hang_nk_nt*t.thue_suat_nk/100,i),t.tien_thue_nk=STP.round(t.tien_thue_nk_nt*a,o),t.tien_ck_nt=STP.round(t.tien_hang_nt*t.ty_le_ck/100,i),t.tien_ck=STP.round(t.tien_ck_nt*a,o),t.tien_nhap_nt=t.tien_hang_nt-t.tien_ck_nt+t.tien_thue_nk_nt+t.tien_phi_nt,t.tien_nhap=t.tien_hang-t.tien_ck+t.tien_thue_nk+t.tien_phi}},onInput:function(t,n){var e=1;t.ma_ntChange=function(e){e&&(n.app_info.options||(n.app_info.options={}),1===e?(t.f_tien_nt=n.app_info.options.f_tien||0,t.f_gia_nt=n.app_info.options.f_gia||0):(t.f_tien_nt=n.app_info.options.f_tien_nt||2,t.f_gia_nt=n.app_info.options.f_gia_nt||2),t.round=t.f_tien_nt,angular.forEach(t.data.details,function(n){n.gia_von_nt=STP.round(n.gia_von/e,t.f_gia_nt),n.gia_von_nk_nt=STP.round(n.gia_von_nk/e,t.f_gia_nt),n.tien_hang_nt=STP.round(n.tien_hang/e,t.f_tien_nt),n.tien_hang_nk_nt=STP.round(n.tien_hang_nk/e,t.f_tien_nt),n.tien_phi_nt=STP.round(n.tien_phi/e,t.f_tien_nt),n.tien_ck_nt=STP.round(n.tien_ck/e,t.f_tien_nt),n.tien_thue_nk_nt=STP.round(n.tien_thue_nk/e,t.f_tien_nt),n.tien_nhap_nt=STP.round(n.tien_nhap/e,t.f_tien_nt)}),angular.forEach(t.data.vatvaos,function(n){n.t_tien_nt=STP.round(n.t_tien/e,t.f_tien_nt),n.t_thue_nt=STP.round(n.t_thue/e,t.f_tien_nt)}),angular.forEach(t.data.ctcpmhs,function(n){n.tien_cp_nt=STP.round(n.tien_cp/e,t.f_tien_nt)}),t.data.ty_gia=e)};var a=function(a,i){t.data.ty_gia&&(e=t.data.ty_gia);var o={},r=_.filter(t.data.details,function(t){return!(t.ma_vt!==a.ma_vt||t.ma_lo!=a.ma_lo&&(t.ma_lo||a.ma_lo)||t.han_sd!=a.han_sd&&(t.han_sd||a.han_sd)||t.ma_tt1!=a.ma_tt1&&(t.ma_tt1||a.ma_tt1)||t.ma_tt2!=a.ma_tt2&&(t.ma_tt2||a.ma_tt2)||t.ma_tt3!=a.ma_tt3&&(t.ma_tt3||a.ma_tt3))});if(r.length>0)return o=r[0],o.sl_nhap=Number(o.sl_nhap)+1,i(o);if(o={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},pn1Module.defaultValues4Detail)for(var c in pn1Module.defaultValues4Detail)o[c]=pn1Module.defaultValues4Detail[c];if(t.data.options)for(var c in t.data.options)t.data.options[c]&&(o[c]=t.data.options[c]);o.sl_nhap=1,o.thue_suat_nk=a.thue_suat_nk||0,n.$rootScope.prompt("Giá mua:",a.gia_mua?a.gia_mua:0).then(function(r){if(1==r.buttonIndex){var c=r.input1;if(null==c)return i();if(c=Number(c)){if(a.gia_mua!==c){a.gia_mua=c;var d=server_url+"/api/"+id_app+"/dmvt/"+a._id;n.$http.put(d,a).then(function(){},function(t){console.log("can't update price for product",t.data)})}o.gia_von=STP.round(c*e,t.f_gia),o.gia_von_nt=c,o.gia_von_nk=STP.round(c*e,t.f_gia),o.gia_von_nk_nt=c}o.ty_le_ck=0,o.tien_phi_nt=0,o.tien_phi=0,o.line=t.data.details.length,o.thue_suat_nk=a.thue_suat_nk?a.thue_suat_nk:0,t.data.details.push(o),i(o)}else i()})};t.tinhtienhang=function(a){t.data.ty_gia&&(e=t.data.ty_gia),a.tien_hang_nt=STP.round(a.sl_nhap*a.gia_von_nt,t.f_tien_nt),a.tien_hang=STP.round(a.tien_hang_nt*e,t.f_tien),a.tien_hang_nk_nt=STP.round(a.sl_nhap*a.gia_von_nk_nt,t.f_tien_nt),a.tien_hang_nk=STP.round(a.tien_hang_nk_nt*e,t.f_tien),a.tien_thue_nk_nt=STP.round(a.tien_hang_nk_nt*a.thue_suat_nk/100,t.f_tien_nt),a.tien_thue_nk=STP.round(a.tien_thue_nk_nt*e,t.f_tien),a.tien_ck_nt=STP.round(a.tien_hang_nt*a.ty_le_ck/100,t.f_tien_nt),a.tien_ck=STP.round(a.tien_ck_nt*e,t.f_tien),a.tien_nhap_nt=a.tien_hang_nt-a.tien_ck_nt+a.tien_thue_nk_nt+a.tien_phi_nt,a.tien_nhap=a.tien_hang-a.tien_ck+a.tien_thue_nk+a.tien_phi,pn9Module.tinhCkvt(n.$http,t.data,a)},t.select=function(n){a(n,function(n){n&&t.tinhtienhang(n)})}}});pn9Module.defaultValues={vatvaos:[]},pn9Module.defaultValues4Detail={sl_nhap:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,tien_von_nk_nt:0,tien_von_nk:0,tien_hang_nk_nt:0,tien_hang_nk:0,thue_suat_nk:0,tien_thue_nk_nt:0,tien_thue_nk:0,tien_phi_nt:0,tien_phi:0,tien_nhap_nt:0,tien_nhap:0},pn9Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn9Module.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return t.vcondition.ma_vt&&(n.details={$elemMatch:{ma_vt:t.vcondition.ma_vt}}),n},pn9Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien_nt),t.dt_current.tien_hang_nk_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nk_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_hang_nt=STP.round(t.dt_current.gia_von_nt*t.dt_current.sl_nhap,t.f_tien_nt),t.dt_current.gia_von_nk_nt=t.dt_current.gia_von_nt)}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=STP.round(t.dt_current.gia_von*t.dt_current.sl_nhap,t.f_tien))}),t.$watch("dt_current.gia_von_nk_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von_nk=STP.round(t.dt_current.gia_von_nk_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_hang_nk_nt=STP.round(t.dt_current.gia_von_nk_nt*t.dt_current.sl_nhap,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nk=STP.round(t.dt_current.gia_von_nk*t.dt_current.sl_nhap,t.f_tien))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=STP.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt+t.dt_current.tien_thue_nk_nt)}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,t.f_tien),t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi+t.dt_current.tien_thue_nk)}),t.$watch("dt_current.tien_hang_nk_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nk=STP.round(t.dt_current.tien_hang_nk_nt*t.ngMasterData.ty_gia,t.f_tien_nt),t.dt_current.tien_thue_nk_nt=STP.round(t.dt_current.tien_hang_nk_nt*t.dt_current.thue_suat_nk/100,t.f_tien_nt))}),t.$watch("dt_current.tien_hang_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_thue_nk=STP.round(t.dt_current.tien_hang_nk*t.dt_current.thue_suat_nk/100,t.f_tien))}),t.$watch("dt_current.thue_suat_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_thue_nk_nt=STP.round(t.dt_current.tien_hang_nk_nt*t.dt_current.thue_suat_nk/100,t.f_tien_nt))}),t.$watch("dt_current.tien_thue_nk_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_thue_nk=STP.round(t.dt_current.tien_thue_nk_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt+t.dt_current.tien_thue_nk_nt)}),t.$watch("dt_current.tien_thue_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi+t.dt_current.tien_thue_nk)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.tien_phi_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_phi=STP.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_phi",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)})},pn9Module.watchMaster=function(t,n){t.allocate=function(e){for(var a=t.data.t_cp_cpb_nt,i=t.data.t_cp_cpb,o=0,r=0;r<t.data.details.length;r++)o+=t.data.details[r][e];if(0!=o){var c=0,d=0,r=0;for(r=0;r<t.data.details.length;r++)t.data.details[r].tien_phi_nt=STP.round(t.data.details[r][e]/o*a,t.f_tien_nt),t.data.details[r].tien_phi=STP.round(t.data.details[r][e]/o*i,t.f_tien),c+=t.data.details[r].tien_phi_nt,d+=t.data.details[r].tien_phi,r===t.data.details.length-1&&(t.data.details[r].tien_phi_nt=t.data.details[r].tien_phi_nt+(a-c),t.data.details[r].tien_phi=t.data.details[r].tien_phi+(i-d)),t.data.details[r].tien_nhap_nt=t.data.details[r].tien_hang_nt-t.data.details[r].tien_ck_nt+t.data.details[r].tien_phi_nt,t.data.details[r].tien_nhap=t.data.details[r].tien_hang-t.data.details[r].tien_ck+t.data.details[r].tien_phi}"browser"===n.$rootScope.platform()?n.$rootScope.alert("Chương trình đã thực hiện xong"):n.$rootScope.toast("Chương trình đã thực hiện xong")}};var pnkModule=new baseVoucher("pnk","pnk",[],"Phiếu nhập kho nội bộ",{onLoading:function(t,n){t.printBarcode=function(){var e=JSON.parse(JSON.stringify(t.list));e=_.filter(e,function(t){return t.sel});var a=[];if(e.forEach(function(t){a=a.concat(t.details)}),0==a.length)return void n.$rootScope.alert("Bạn hãy chọn ít nhất một phiếu để in");for(var i=0;i<a.length;i++)a[i].line=i;async.map(a,function(t,e){dmvtModule.getService(n.$http,n.$q,n.$rootScope).load(id_app,{condition:{ma_vt:t.ma_vt}}).then(function(n){1==n.data.length&&(t.gia_ban_le=n.data[0].gia_ban_le),e()},function(){e()})},function(){n.$uibModal.open({template:"<div style='height:"+(innerHeight-10).toString()+"px'><div class='scrollable'><div class='scrollable-content'><barcode data='list' field-code='ma_vt'  field-price='gia_ban_le' field-qty='sl_nhap' field-label='ten_vt' on-close='cancel()'></barcode></div></div></div>",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","$window","appInfo",function(t,n,e,i,o){t.list=a,t.cancel=function(){o.close()}}],size:"md",resolve:{parentScope:function(){return t}}})})}},onInput:function(t){var n=1;t.select=function(e){t.data.ty_gia&&(n=t.data.ty_gia);var a={},i=_.filter(t.data.details,function(t){return t.ma_vt===e.ma_vt&&t.ma_lo===e.ma_lo&&t.han_sd===e.han_sd&&t.ma_tt1==e.ma_tt1&&t.ma_tt2==e.ma_tt2&&t.ma_tt3==e.ma_tt3});if(i.length>0)a=i[0],a.sl_nhap+=1;else{if(a={ma_vt:e.ma_vt,ten_vt:e.ten_vt,ma_dvt:e.ma_dvt,tk_vt:e.tk_vt,ma_lo:e.ma_lo,han_sd:e.han_sd,ma_tt1:e.ma_tt1,ma_tt2:e.ma_tt2,ma_tt3:e.ma_tt3},pn1Module.defaultValues4Detail)for(var o in pn1Module.defaultValues4Detail)a[o]=pn1Module.defaultValues4Detail[o];if(t.data.options)for(var o in t.data.options)t.data.options[o]&&(a[o]=t.data.options[o]);a.sl_nhap=1;var r=e.gia_mua?e.gia_mua:0;a.gia_von=STP.round(r*n,t.f_gia),a.gia_von_nt=r,a.line=t.data.details.length,t.data.details.push(a)}a.tien_nhap_nt=STP.round(a.sl_nhap*a.gia_von_nt,t.f_tien_nt),a.tien_nhap=STP.round(a.tien_nhap_nt*n,t.f_tien)}}});pnkModule.defaultValues={ma_gd:"0"},pnkModule.defaultValues4Detail={sl_nhap:0,pn_gia_tb:!0,gia_von_nt:0,gia_von:0,tien_nhap_nt:0,tien_nhap:0},pnkModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pnkModule.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return t.vcondition.ma_vt&&(n.details={$elemMatch:{ma_vt:t.vcondition.ma_vt}}),n},pnkModule.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_nhap_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von,t.f_tien))}),t.$watch("dt_current.tien_nhap_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=STP.round(t.dt_current.tien_nhap_nt*t.ngMasterData.ty_gia,t.f_tien))})},pnkModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia_von=STP.round(e.gia_von_nt*n,t.f_gia),e.tien_nhap=STP.round(e.tien_nhap_nt*n,t.f_tien)})})};var pxkModule=new baseVoucher("pxk","pxk",[],"Phiếu xuất kho nội bộ",{onInput:function(t){var n=1;t.select=function(e){t.data.ty_gia&&(n=t.data.ty_gia);var a={},i=_.filter(t.data.details,function(t){return t.ma_vt===e.ma_vt&&t.ma_kho===e.ma_kho&&t.ma_lo===e.ma_lo&&t.han_sd===e.han_sd&&t.ma_tt1==e.ma_tt1&&t.ma_tt2==e.ma_tt2&&t.ma_tt3==e.ma_tt3});if(i.length>0)a=i[0],a.sl_xuat+=1;else{if(a={ma_vt:e.ma_vt,ma_kho:e.ma_kho,ten_kho:e.ma_kho,ten_vt:e.ten_vt,ma_dvt:e.ma_dvt,tk_vt:e.tk_vt,ma_lo:e.ma_lo,han_sd:e.han_sd,ma_tt1:e.ma_tt1,ma_tt2:e.ma_tt2,ma_tt3:e.ma_tt3},pn1Module.defaultValues4Detail)for(var o in pn1Module.defaultValues4Detail)a[o]=pn1Module.defaultValues4Detail[o];if(t.data.options)for(var o in t.data.options)t.data.options[o]&&(a[o]=t.data.options[o]);a.sl_xuat=1;var r=e.gia_mua?e.gia_mua:0;a.gia_von=STP.round(r*n,t.f_gia),a.gia_von_nt=r,a.line=t.data.details.length,t.data.details.push(a)}a.tien_xuat_nt=STP.round(a.sl_xuat*a.gia_von_nt,t.f_tien_nt),a.tien_xuat=STP.round(a.tien_xuat_nt*n,t.f_tien)}}});pxkModule.defaultValues={},pxkModule.defaultValues4Detail={sl_xuat:0,px_gia_dd:!1,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pxkModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pxkModule.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return t.vcondition.ma_vt&&(n.details={$elemMatch:{ma_vt:t.vcondition.ma_vt}}),n},pxkModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von,t.f_tien))}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,t.f_tien))})},pxkModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia_von=STP.round(e.gia_von_nt*n,t.f_gia),e.tien_xuat=STP.round(e.tien_xuat_nt*n,t.f_tien)})})};var pkkModule=new baseVoucher("pkk","pkk",[],"Kiểm kê kho",{onInput:function(t,n){var e=1;t.toncuoikyvattu=function(){if(t.data._id)return void n.$rootScope.alert("Chỉ lấy được danh sách tồn kho khi tạo phiếu mới");t.data.ma_kho||n.$rootScope.alert("Hãy chọn một kho trước"),t.data.details=[];var e=server_url_report+"/api/"+id_app+"/ckvt?groupBy=ma_vt&groupBy=ma_tt1&groupBy=ma_tt2&groupBy=ma_tt3&groupBy=ma_lo&groupBy=han_sd&ma_kho="+t.data.ma_kho+"&den_ngay="+moment(t.data.ngay_ct).format("YYYY-MM-DD");n.$http.get(e).then(function(n){var e=_.filter(n.data,function(t){return t.ton00});e.forEach(function(n){if(nrow={ma_vt:n.ma_vt,ten_vt:n.ten_vt,ma_dvt:n.ma_dvt,tk_vt:n.tk_vt,ma_lo:n.ma_lo,han_sd:n.han_sd,ma_tt1:n.ma_tt1,ma_tt2:n.ma_tt2,ma_tt3:n.ma_tt3},pn1Module.defaultValues4Detail)for(var e in pn1Module.defaultValues4Detail)nrow[e]=pn1Module.defaultValues4Detail[e];if(t.data.options)for(var e in t.data.options)t.data.options[e]&&(nrow[e]=t.data.options[e]);nrow.sl_ton_tt=0,nrow.sl_ton_ss=n.ton00;var a=STP.round(0!==n.ton00?n.du00/n.ton00:0,t.f_gia);nrow.gia_von=a,nrow.gia_von_nt=a,nrow.line=t.data.details.length,t.data.details.push(nrow)})},function(t){var e=t.data;_.isObject(e)&&(e=e.message),e||(e="Không kết nối được với máy chủ"),n.$rootScope.alert("Không thể lấy được số dư cuối kỳ của các sản phẩm. Lỗi: "+e)})},t.select=function(a){t.data.ty_gia&&(e=t.data.ty_gia);var i={};a.ma_tt1=a.ma_tt1||"",a.ma_tt2=a.ma_tt2||"",a.ma_tt3=a.ma_tt3||"",a.ma_lo=a.ma_lo||"";var o=_.filter(t.data.details,function(t){return t.ma_vt===a.ma_vt&&t.ma_lo===a.ma_lo&&t.ma_tt1==a.ma_tt1&&t.ma_tt2==a.ma_tt2&&t.ma_tt3==a.ma_tt3});if(o.length>0)i=o[0],i.sl_ton_tt+=1;else{if(i={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},pn1Module.defaultValues4Detail)for(var r in pn1Module.defaultValues4Detail)i[r]=pn1Module.defaultValues4Detail[r];if(t.data.options)for(var r in t.data.options)t.data.options[r]&&(i[r]=t.data.options[r]);i.sl_ton_tt=1,i.sl_ton_ss=0;var c=server_url_report+"/api/"+id_app+"/ckvt?ma_vt="+i.ma_vt+"&ma_kho="+t.data.ma_kho+"&den_ngay="+moment(t.data.ngay_ct).format("YYYY-MM-DD");n.$http.get(c).then(function(t){1===t.data.length&&(i.sl_ton_ss=t.data[0].ton00)},function(t){var e=t.data;_.isObject(e)&&(e=e.message),e||(e="Không kết nối được với máy chủ"),n.$rootScope.alert("Không thể lấy được số dư cuối kỳ của sản phẩm <b>"+i.ten_vt+"</b><div style='color:red'>Lỗi: "+e+"</div>")});var d=a.gia_mua?a.gia_mua:0;i.gia_von=STP.round(d*e,t.f_gia),i.gia_von_nt=d,i.line=t.data.details.length,t.data.details.push(i)}i.tien_xuat_nt=STP.round(i.sl_xuat*i.gia_von_nt,t.f_tien_nt),i.tien_xuat=STP.round(i.tien_xuat_nt*e,t.f_tien)}}});pkkModule.defaultValues={},pkkModule.defaultValues4Detail={sl_xuat:0,sl_ton_ss:0,sl_ton_tt:0,px_gia_dd:!1,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0,ma_tt1:"",ma_tt2:"",ma_tt3:"",ma_lo:""},pkkModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pkkModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pkkModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von,t.f_tien))}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,t.f_tien))})},pkkModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia_von=STP.round(e.gia_von_nt*n,t.f_gia),e.tien_xuat=STP.round(e.tien_xuat_nt*n,t.f_tien)})})};var pdnModule=new baseVoucher("pdn","pdn",[],"Phiếu đề nghị xuất điều chuyển",{onLoading:function(t,n){t.taoPXC=function(t){var e=JSON.parse(JSON.stringify(t));e.ma_ct="PXC",e.id_dn=t._id,e.details=_.filter(e.details,function(t){return t.sl_xuat>t.sl_da_xuat}),e.details.forEach(function(t){t.sl_dn=t.sl_xuat,t.sl_xuat=n.$rootScope.app_info.options.sl_xuat_sl_dn?t.sl_dn-t.sl_da_xuat:0}),delete e._id,delete e.so_ct,pxcModule.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onInput:function(t,n){var e=1;t.select=function(a){t.data.ty_gia&&(e=t.data.ty_gia);var i={},o=_.filter(t.data.details,function(t){return t.ma_vt===a.ma_vt&&t.ma_lo===a.ma_lo&&t.han_sd===a.han_sd&&t.ma_tt1==a.ma_tt1&&t.ma_tt2==a.ma_tt2&&t.ma_tt3==a.ma_tt3});if(o.length>0)i=o[0],i.sl_xuat+=1;else{if(i={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,tk_du:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},pn1Module.defaultValues4Detail)for(var r in pn1Module.defaultValues4Detail)i[r]=pn1Module.defaultValues4Detail[r];if(t.data.options)for(var r in t.data.options)t.data.options[r]&&(i[r]=t.data.options[r]);i.sl_xuat=1;var c=a.gia_mua?a.gia_mua:0;i.gia_von=STP.round(c*e,t.f_gia),i.gia_von_nt=c,i.line=t.data.details.length,t.data.details.push(i)}i.tien_xuat_nt=STP.round(i.sl_xuat*i.gia_von_nt,t.f_tien_nt),i.tien_xuat=STP.round(i.tien_xuat_nt*e,t.f_tien),pdnModule.tinhCkvt(n.$http,t.data,i,t.data.ma_kho_x)}}});pdnModule.defaultValues={},pdnModule.defaultValues4Detail={sl_xuat:0,px_gia_dd:!1,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pdnModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pdnModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pdnModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von,t.f_tien))}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,t.f_tien))})},pdnModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia_von=STP.round(e.gia_von_nt*n,t.f_gia),e.tien_xuat=STP.round(e.tien_xuat_nt*n,t.f_tien)})})};var pxcModule=new baseVoucher("pxc","pxc",[],"Phiếu xuất điều chuyển",{onLoading:function(t,n){t.taoPNC=function(t){var e=JSON.parse(JSON.stringify(t));e.details=_.filter(e.details,function(t){return t.sl_xuat>t.sl_da_nhap}),e.details.forEach(function(t){t.sl_xuat_pxc=t.sl_xuat,t.sl_xuat=t.sl_xuat_pxc-t.sl_da_nhap,pncModule.tinhCkvt(n.$http,e,t,e.ma_kh_n)}),e.ma_ct="PNC",e.id_px=t._id,delete e._id,pncModule.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onInput:function(t,n){var e=1;t.select=function(a){t.data.ty_gia&&(e=t.data.ty_gia);var i={},o=_.filter(t.data.details,function(t){return t.ma_vt===a.ma_vt&&t.ma_lo===a.ma_lo&&t.han_sd===a.han_sd&&t.ma_tt1===a.ma_tt1&&t.ma_tt2===a.ma_tt2&&t.ma_tt3===a.ma_tt3});if(o.length>0)i=o[0],i.sl_xuat+=1;else{if(i={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,tk_du:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},pn1Module.defaultValues4Detail)for(var r in pn1Module.defaultValues4Detail)i[r]=pn1Module.defaultValues4Detail[r];if(t.data.options)for(var r in t.data.options)t.data.options[r]&&(i[r]=t.data.options[r]);i.sl_xuat=1;var c=a.gia_mua?a.gia_mua:0;i.gia_von=STP.round(c*e,t.f_gia),i.gia_von_nt=c,i.line=t.data.details.length,t.data.details.push(i)}i.tien_xuat_nt=STP.round(i.sl_xuat*i.gia_von_nt,t.f_tien_nt),i.tien_xuat=STP.round(i.tien_xuat_nt*e,t.f_tien),pxcModule.tinhCkvt(n.$http,t.data,i,t.data.ma_kho_x)}}});pxcModule.defaultValues={},pxcModule.defaultValues4Detail={sl_xuat:0,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pxcModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pxcModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}
},pxcModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.f_tien_nt))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von,t.f_tien))}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,t.f_tien))})},pxcModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.gia_von=STP.round(e.gia_von_nt*n,t.f_gia),e.tien_xuat=STP.round(e.tien_xuat_nt*n,t.f_tien)})})};var pncModule=new baseVoucher("pnc","pnc",[],"Phiếu nhập điều chuyển",{onInput:function(t,n){var e=1;t.select=function(a){t.data.ty_gia&&(e=t.data.ty_gia);var i={},o=_.filter(t.data.details,function(t){return t.ma_vt===a.ma_vt&&t.ma_lo===a.ma_lo&&t.han_sd===a.han_sd&&t.ma_tt1==a.ma_tt1&&t.ma_tt2==a.ma_tt2&&t.ma_tt3==a.ma_tt3});if(o.length>0)i=o[0],i.sl_xuat+=1;else{if(i={ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_dvt:a.ma_dvt,tk_vt:a.tk_vt,tk_du:a.tk_vt,ma_lo:a.ma_lo,han_sd:a.han_sd,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3},pn1Module.defaultValues4Detail)for(var r in pn1Module.defaultValues4Detail)i[r]=pn1Module.defaultValues4Detail[r];if(t.data.options)for(var r in t.data.options)t.data.options[r]&&(i[r]=t.data.options[r]);i.sl_xuat=1;var c=a.gia_mua?a.gia_mua:0;i.gia_von=c*e,i.gia_von_nt=c,i.line=t.data.details.length,t.data.details.push(i)}i.tien_xuat_nt=i.sl_xuat*i.gia_von_nt,i.tien_xuat=STP.round(i.tien_xuat_nt*e,0),pncModule.tinhCkvt(n.$http,t.data,i,t.data.ma_kh_n),n.$rootScope.toast("Đã thêm sản phẩm "+i.ten_vt)},t.getpxc4pnc=function(){n.$uibModal.open({templateUrl:"templates/vouchers/pnc/templates/form-select-pxc.html",controller:["$scope","$uibModalInstance","parentScope","$filter","$rootScope","$http",function(t,n,e,a,i,o){t.STP=STP,t.condition={tu_ngay:new Date(moment().format("YYYY-MM-01")),den_ngay:new Date},t.loadPXC=function(){t.masters=[];var n=server_url_report+"/api/"+id_app+"/getpxc4pnc?t=1";t.condition.so_ct&&(n=n+"&so_ct="+t.condition.so_ct),t.condition.ma_kho_n&&(n=n+"&ma_kho_n="+t.condition.ma_kho_n),t.condition.ma_kho_x&&(n=n+"&ma_kho_x="+t.condition.ma_kho_x),e.data._id&&(n=n+"&id_ct="+e.data._id),n=n+"&tu_ngay="+a("date")(t.condition.tu_ngay,"yyyy-MM-dd"),n=n+"&den_ngay="+a("date")(t.condition.den_ngay,"yyyy-MM-dd"),o.get(n).then(function(n){t.masters=n.data,0==t.masters.length&&i.alert("Không tìm thấy phiếu xuất điều chuyển")},function(n){t.masters=[],n.data&&i.alert(n.data)})},t.ok=function(t){e.data._id&&(t._id=e.data._id),e.data=t,n.close()},t.cancel=function(){n.close()}}],size:"lg",resolve:{parentScope:function(){return t}}})}}});pncModule.defaultValues={},pncModule.defaultValues4Detail={sl_xuat:0,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pncModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pncModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pncModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von,0))}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=STP.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,0))})},pncModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.gia_von=STP.round(t.gia_von_nt*n,0),t.tien_xuat=STP.round(t.tien_xuat_nt*n,0)})})};var pc0Module=new baseVoucher("pc0","pc0",[],"Đề nghị chi",{giaodichs:[{ma_gd:1,ten_gd:"Tiền mặt"},{ma_gd:2,ten_gd:"Chuyển khoản"}],onLoading:function(t,n){t.createPN=function(t){var e=JSON.parse(JSON.stringify(t));e.id_pc0=e._id,e.trang_thai="5",e.ngay_ct=new Date,delete e._id,delete e.so_ct;var a=pc1Module;a.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onEdit:function(t){t.select(t.data.tdttcos&&t.data.tdttcos.length>0?"chi_hd":"chi_kh")},onInit:function(t){t.select_chi_kh=!0,t.select_chi_hd=!1,t.select_vat_vao=!1,t.select=function(n){t.select_chi_kh="chi_kh"==n,t.select_chi_hd="chi_hd"==n,t.select_vat_vao="vat_vao"==n}}});pc0Module.defaultValues={vatvaos:[],ma_gd:"1"},pc0Module.defaultValues4Detail={tien_nt:0,tien:0},pc0Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pc0Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pc0Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,t.f_tien))})},pc0Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.vatras,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var pc1Module=new baseVoucher("pc1","pc1",[],"Phiếu chi tiền",{giaodichs:[{ma_gd:1,ten_gd:"Tiền mặt"},{ma_gd:2,ten_gd:"Chuyển khoản"}],onEdit:function(t){t.select(t.data.tdttcos&&t.data.tdttcos.length>0?"chi_hd":"chi_kh")},onInit:function(t){t.select_chi_kh=!0,t.select_chi_hd=!1,t.select_vat_vao=!1,t.select=function(n){t.select_chi_kh="chi_kh"==n,t.select_chi_hd="chi_hd"==n,t.select_vat_vao="vat_vao"==n}}});pc1Module.defaultValues={vatvaos:[],ma_gd:"1"},pc1Module.defaultValues4Detail={tien_nt:0,tien:0},pc1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pc1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pc1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,t.f_tien))})},pc1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.vatras,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var pt1Module=new baseVoucher("pt1","pt1",[],"Phiếu thu tiền",{giaodichs:[{ma_gd:1,ten_gd:"Tiền mặt"},{ma_gd:2,ten_gd:"Chuyển khoản"}],onEdit:function(t){t.select(t.data.tdttnos&&t.data.tdttnos.length>0?"thu_hd":"thu_kh")},onInit:function(t){t.select_thu_kh=!0,t.select_thu_hd=!1,t.select=function(n){t.select_thu_kh="thu_kh"==n,t.select_thu_hd="thu_hd"==n}}});pt1Module.defaultValues={ma_gd:"1"},pt1Module.defaultValues4Detail={tien_nt:0,tien:0},pt1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pt1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pt1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,t.f_tien))})},pt1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.vatras,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var pc3Module=new baseVoucher("pc3","pc3",[],"Đề nghị tạm ứng",{giaodichs:[{ma_gd:1,ten_gd:"Tiền mặt"},{ma_gd:2,ten_gd:"Chuyển khoản"}],onLoading:function(t,n){t.createPN=function(t){var e=JSON.parse(JSON.stringify(t));e.id_pc3=e._id,e.ngay_ct=new Date,delete so_ct,delete e._id,delete e.trang_thai;var a=pc2Module;a.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onEdit:function(t){t.select(t.data.tdttcos&&t.data.tdttcos.length>0?"chi_hd":"chi_kh")},onInit:function(t){t.select_chi_kh=!0,t.select_chi_hd=!1,t.select_vat_vao=!1,t.select=function(n){t.select_chi_kh="chi_kh"==n,t.select_chi_hd="chi_hd"==n,t.select_vat_vao="vat_vao"==n}}});pc3Module.defaultValues={vatvaos:[],ma_gd:"1"},pc3Module.defaultValues4Detail={tien_nt:0,tien:0},pc3Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pc3Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pc3Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,t.f_tien))})},pc3Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.vatras,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var pc2Module=new baseVoucher("pc2","pc2",[],"Phiếu chi tạm ứng",{giaodichs:[{ma_gd:1,ten_gd:"Tiền mặt"},{ma_gd:2,ten_gd:"Chuyển khoản"}],onLoading:function(t,n){t.createPN=function(t){var e={};_.extend(e,t),e.id_pc2=e._id,e.ngay_ct=new Date,delete e.so_ct,delete e.trang_thai,delete e._id,e.details.forEach(function(t){t.tk_co=t.tk_no,t.tk_no="",t.tien_tu_nt=t.tien_nt,t.tien_tu=t.tien});var a=pn6Module;a.quickadd(n.$uibModal,function(e){t.id_pn6=e._id,n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onEdit:function(t){t.select(t.data.tdttcos&&t.data.tdttcos.length>0?"chi_hd":"chi_kh")},onInit:function(t){t.select_chi_kh=!0,t.select_chi_hd=!1,t.select_vat_vao=!1,t.select=function(n){t.select_chi_kh="chi_kh"==n,t.select_chi_hd="chi_hd"==n,t.select_vat_vao="vat_vao"==n}}});pc2Module.defaultValues={vatvaos:[],ma_gd:"1"},pc2Module.defaultValues4Detail={tien_nt:0,tien:0},pc2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pc2Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pc2Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,t.f_tien))})},pc2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.vatras,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var pn6Module=new baseVoucher("pn6","pn6",[],"Phiếu thanh toán tạm ứng");pn6Module.defaultValues={vatvaos:[],vatras:[]},pn6Module.defaultValues4Detail={tien_nt:0,tien:0},pn6Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pn6Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn6Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,t.f_tien))})},pn6Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}),angular.forEach(t.data.vatras,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var bg1Module=new baseVoucher("bg1","bg1",[],"Báo giá",{onLoading:function(t,n){t.tinhtienhang=function(t,e){e.ty_gia||(e.ty_gia=1);var a=("VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,"VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt),i=n.$rootScope.app_info.options.f_tien;t.tien_nt=STP.round(t.so_luong*t.gia_nt,a),t.tien=STP.round(t.tien_nt*e.ty_gia,i),t.tien_ck_nt=STP.round(t.tien_nt*t.ty_le_ck/100,a),t.tien_ck=STP.round(t.tien_ck_nt*e.ty_gia,i)},t.createContract=function(t){var e=JSON.parse(JSON.stringify(t));e.id_bao_gia=e._id,delete e._id,delete e.so_ct,sale_contractModule.quickadd(n.$uibModal,function(e){t.id_contract=e._id,n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onInput:function(t){t.$watch("data.t_tien_nt",function(n){void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.f_tien_nt))}),t.$watch("data.thue_suat",function(n){void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.f_tien_nt))}),t.$watch("data.t_ck_nt",function(n){void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.f_tien_nt))}),t.tinhtienhang=function(n){t.data.ty_gia||(t.data.ty_gia=1),n.tien_nt=STP.round(n.so_luong*n.gia_nt,t.f_tien_nt),n.tien=STP.round(n.tien_nt*t.data.ty_gia,t.f_tien),n.tien_ck_nt=STP.round(n.tien_nt*n.ty_le_ck/100,t.f_tien_nt),n.tien_ck=STP.round(n.tien_ck_nt*t.data.ty_gia,t.f_tien)},t.updateRows=function(){t.data.details.forEach(function(n){t.select(n,n.so_luong)})},t.select=function(n,e){var a,i,o,r=0;t.data.ty_gia||(t.data.ty_gia=1),t.dt_current={};var c=_.filter(t.data.details,function(t){return!(t.ma_vt!=n.ma_vt||t.ma_tt1!=n.ma_tt1&&(t.ma_tt1||n.ma_tt1)||t.ma_tt2!=n.ma_tt2&&(t.ma_tt2||n.ma_tt2)||t.ma_tt3!=n.ma_tt3&&(t.ma_tt3||n.ma_tt3))});if(c.length>0)t.dt_current=c[0],t.dt_current.so_luong=void 0!==e&&null!==e?e:t.dt_current.so_luong+1,t.dt_current.gia=STP.round(t.dt_current.gia_nt*t.data.ty_gia,t.f_gia),t.dt_current.cs_ck1||(t.dt_current.cs_ck1={ty_le_ck:t.dt_current.ty_le_ck,tien_ck:0});else{if(t.dt_current={ma_vt:n.ma_vt,ten_vt:n.ten_vt,ma_dvt:n.ma_dvt,tk_vt:n.tk_vt,tk_dt:n.tk_dt,tk_gv:n.tk_gv,tk_ck:n.tk_ck,ma_tt1:n.ma_tt1,ma_tt2:n.ma_tt2,ma_tt3:n.ma_tt3},bg1Module.defaultValues4Detail&&_.extend(t.dt_current,bg1Module.defaultValues4Detail),t.data.options)for(var d in t.data.options)t.data.options[d]&&(t.dt_current[d]=t.data.options[d]);t.dt_current.so_luong=void 0!==e&&null!==e?e:1,t.dt_current.gia_nt=n.gia_ban_nt||n.gia_ban_le,t.dt_current.gia=STP.round(t.dt_current.gia_nt*t.data.ty_gia,t.f_gia),t.dt_current.gia_von_nt=n.gia_von_nt||n.gia_mua,t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.line=t.data.details.length,0!==e&&t.data.details.push(t.dt_current),t.dt_current.cs_ck1=n.cs_ck1||{ty_le_ck:n.ty_le_ck,tien_ck:n.tien_ck},t.dt_current.cs_ck2=n.cs_ck2||n.ck_sl_tu2,t.dt_current.cs_km=n.cs_km||n.promotion}if(a=t.dt_current.cs_ck1.ty_le_ck,i=t.dt_current.cs_ck1.tien_ck,t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(r=n.so_luong+r)}),t.dt_current.cs_ck2&&t.dt_current.cs_ck2.length>0&&(o=_.filter(t.dt_current.cs_ck2,function(n){return n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&(n.ma_kh===t.data.ma_kh||n.nh_kh===t.data.nh_kh)}),0==o.length&&(o=_.filter(t.dt_current.cs_ck2,function(t){return t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0&&(o=_.sortBy(o,function(t){return-t.sl_tu}),a=o[0].ty_le_ck,i=o[0].tien_ck)),!a&&t.dt_current.gia&&(a=100*STP.round(i/t.dt_current.gia,2)),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.ty_le_ck=a,t.tinhtienhang(n))}),t.dt_current.cs_km)if(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.ma_kh&&n.ma_kh===t.data.ma_kh}),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.nh_kh&&n.nh_kh===t.data.nh_kh})),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(t){return(t.ma_vt||t.ma_nvt)&&t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0){if(o=_.sortBy(o,function(t){return-t.sl_tu}),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.promotion=[])}),t.dt_current.promotion=JSON.parse(JSON.stringify(o[0])),t.dt_current.promotion.sl_tu&&!t.dt_current.promotion.sl_den&&t.dt_current.promotion.details_km){var l=(r-r%t.dt_current.promotion.sl_tu)/t.dt_current.promotion.sl_tu;l>1&&t.dt_current.promotion.details_km.forEach(function(t){t.sl_km=l*t.sl_km})}}else t.dt_current.promotion={}}}});bg1Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0,t_ck_nt:0,tk_ck:0},bg1Module.defaultValues4Detail={so_luong:0,ty_le_ck:0,gia_nt:0,gia:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0},bg1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},bg1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},bg1Module.watchDetail=function(t){t.$watch("dt_current.so_luong",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nt=STP.round(t.dt_current.so_luong*t.dt_current.gia_nt,t.f_tien_nt),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.gia_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia=STP.round(t.dt_current.gia_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_nt=STP.round(t.dt_current.so_luong*t.dt_current.gia_nt,t.f_tien_nt),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.gia",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.gia*t.dt_current.so_luong,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))})},bg1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien)}),t.data.t_thue=STP.round(t.data.t_thue_nt*n,t.f_tien))})};var sale_contractModule=new baseVoucher("sale_contract","sale_contract",["ma_hd","so_ct","dien_giai","ma_kh","ten_kh"],"Hợp đồng bán hàng",{onLoading:function(t,n){t.tinhtienhang=function(t,e){e.ty_gia||(e.ty_gia=1);var a=("VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,"VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt),i=n.$rootScope.app_info.options.f_tien;t.tien_nt=STP.round(t.so_luong*t.gia_nt,a),t.tien=STP.round(t.tien_nt*e.ty_gia,i),t.tien_ck_nt=STP.round(t.tien_nt*t.ty_le_ck/100,a),t.tien_ck=STP.round(t.tien_ck_nt*e.ty_gia,i)},t.createHD2=function(t){var e=n.$rootScope.app_info.options.f_tien,a="VND"==t.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt,i=JSON.parse(JSON.stringify(t));i.id_contract=i._id,delete i._id,delete i.so_ct,i.ngay_ct=new Date,i.t_thue&&(i.ngay_hd=i.ngay_ct),i.details=_.filter(i.details,function(t){return t.so_luong>t.sl_da_xuat}),i.details.forEach(function(t){t.sl_xuat=n.$rootScope.app_info.options.sl_xuat_sl_hop_dong?t.so_luong-(t.sl_da_xuat||0):0,t.gia_ban=t.gia,t.gia_ban_nt=t.gia_nt,t.tien_nt=STP.round(t.sl_xuat*t.gia_ban_nt,a),t.tien=STP.round(t.sl_xuat*t.gia_ban_nt,e)}),hd2Module.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},i)}},onInput:function(t){t.tinhtienhang=function(n){t.data.ty_gia||(t.data.ty_gia=1),n.tien_nt=STP.round(n.so_luong*n.gia_nt,t.f_tien_nt),n.tien=STP.round(n.tien_nt*t.data.ty_gia,t.f_tien),n.tien_ck_nt=STP.round(n.tien_nt*n.ty_le_ck/100,t.f_tien_nt),n.tien_ck=STP.round(n.tien_ck_nt*t.data.ty_gia,t.f_tien)},t.$watch("data.t_tien_nt",function(n){void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.f_tien_nt))}),t.$watch("data.thue_suat",function(n){void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.f_tien_nt))}),t.$watch("data.t_ck_nt",function(n){void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.f_tien_nt))}),t.updateRows=function(){t.data.details.forEach(function(n){t.select(n,n.so_luong)})},t.select=function(n,e){var a,i,o,r=0;t.data.ty_gia||(t.data.ty_gia=1),t.dt_current={};var c=_.filter(t.data.details,function(t){return!(t.ma_vt!=n.ma_vt||t.ma_tt1!=n.ma_tt1&&(t.ma_tt1||n.ma_tt1)||t.ma_tt2!=n.ma_tt2&&(t.ma_tt2||n.ma_tt2)||t.ma_tt3!=n.ma_tt3&&(t.ma_tt3||n.ma_tt3))});if(c.length>0)t.dt_current=c[0],t.dt_current.so_luong=void 0!==e&&null!==e?e:t.dt_current.so_luong+1,t.dt_current.gia=STP.round(t.dt_current.gia_nt*t.data.ty_gia,t.f_gia),t.dt_current.cs_ck1||(t.dt_current.cs_ck1={ty_le_ck:t.dt_current.ty_le_ck,tien_ck:0});else{if(t.dt_current={ma_vt:n.ma_vt,ten_vt:n.ten_vt,ma_dvt:n.ma_dvt,tk_vt:n.tk_vt,tk_dt:n.tk_dt,tk_gv:n.tk_gv,tk_ck:n.tk_ck,ma_tt1:n.ma_tt1,ma_tt2:n.ma_tt2,ma_tt3:n.ma_tt3},sale_contractModule.defaultValues4Detail&&_.extend(t.dt_current,sale_contractModule.defaultValues4Detail),t.data.options)for(var d in t.data.options)t.data.options[d]&&(t.dt_current[d]=t.data.options[d]);t.dt_current.so_luong=void 0!==e&&null!==e?e:1,t.dt_current.gia_nt=n.gia_ban_nt||n.gia_ban_le,t.dt_current.gia=STP.round(t.dt_current.gia_nt*t.data.ty_gia,t.f_gia),t.dt_current.gia_von_nt=n.gia_von_nt||n.gia_mua,t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.line=t.data.details.length,0!==e&&t.data.details.push(t.dt_current),t.dt_current.cs_ck1=n.cs_ck1||{ty_le_ck:n.ty_le_ck,tien_ck:n.tien_ck},t.dt_current.cs_ck2=n.cs_ck2||n.ck_sl_tu2,t.dt_current.cs_km=n.cs_km||n.promotion}if(a=t.dt_current.cs_ck1.ty_le_ck,i=t.dt_current.cs_ck1.tien_ck,t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(r=n.so_luong+r)}),t.dt_current.cs_ck2&&t.dt_current.cs_ck2.length>0&&(o=_.filter(t.dt_current.cs_ck2,function(n){return n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&(n.ma_kh===t.data.ma_kh||n.nh_kh===t.data.nh_kh)}),0==o.length&&(o=_.filter(t.dt_current.cs_ck2,function(t){return t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0&&(o=_.sortBy(o,function(t){return-t.sl_tu}),a=o[0].ty_le_ck,i=o[0].tien_ck)),!a&&t.dt_current.gia&&(a=100*STP.round(i/t.dt_current.gia,2)),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.ty_le_ck=a,t.tinhtienhang(n))}),t.dt_current.cs_km)if(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.ma_kh&&n.ma_kh===t.data.ma_kh}),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.nh_kh&&n.nh_kh===t.data.nh_kh})),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(t){return(t.ma_vt||t.ma_nvt)&&t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0){if(o=_.sortBy(o,function(t){return-t.sl_tu}),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.promotion=[])}),t.dt_current.promotion=JSON.parse(JSON.stringify(o[0])),t.dt_current.promotion.sl_tu&&!t.dt_current.promotion.sl_den&&t.dt_current.promotion.details_km){var l=(r-r%t.dt_current.promotion.sl_tu)/t.dt_current.promotion.sl_tu;l>1&&t.dt_current.promotion.details_km.forEach(function(t){t.sl_km=l*t.sl_km})}}else t.dt_current.promotion={}}}});sale_contractModule.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0,t_ck_nt:0,tk_ck:0},sale_contractModule.defaultValues4Detail={so_luong:0,ty_le_ck:0,gia_nt:0,gia:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0},sale_contractModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},sale_contractModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ma_hd:{$regex:t.vcondition.ma_hd,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},sale_contractModule.watchDetail=function(t){t.$watch("dt_current.so_luong",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nt=STP.round(t.dt_current.so_luong*t.dt_current.gia_nt,t.f_tien_nt),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.gia_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia=STP.round(t.dt_current.gia_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_nt=STP.round(t.dt_current.so_luong*t.dt_current.gia_nt,t.f_tien_nt),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.gia",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.gia*t.dt_current.so_luong,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.f_tien_nt),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))})},sale_contractModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien)}),t.data.t_thue=STP.round(t.data.t_thue_nt*n,t.f_tien))})};var hd2Module=new baseVoucher("hd2","hd2",[],"Hóa đơn bán hàng",{onLoading:function(t,n){t.tinhtienhang=function(t,e){e.ty_gia||(e.ty_gia=1);var a=("VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,"VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt),i=n.$rootScope.app_info.options.f_tien;t.tien_nt=STP.round(t.sl_xuat*t.gia_ban_nt,a),t.tien=STP.round(t.tien_nt*e.ty_gia,i),t.tien_ck_nt=STP.round(t.tien_nt*t.ty_le_ck/100,a),t.tien_ck=STP.round(t.tien_ck_nt*e.ty_gia,i),t.tien_xuat_nt=STP.round(t.sl_xuat*(t.gia_von?t.gia_von:0),i),t.tien_xuat=t.tien_xuat_nt}},onInput:function(t,n){t.ma_ntChange=function(e){e&&(n.app_info.options||(n.app_info.options={}),1===e?(t.f_tien_nt=n.app_info.options.f_tien||0,t.f_gia_nt=n.app_info.options.f_gia||0):(t.f_tien_nt=n.app_info.options.f_tien_nt||2,t.f_gia_nt=n.app_info.options.f_gia_nt||2),t.round=t.f_tien_nt,angular.forEach(t.data.details,function(n){n.gia_ban_nt=STP.round(n.gia_ban/e,t.round),n.tien_nt=STP.round(n.tien/e,t.round),n.tien_ck_nt=STP.round(n.tien_ck/e,t.round)}),t.data.t_thue_nt=STP.round(t.data.t_thue/e,t.round),t.data.ty_gia=e)},t.tinhtienhang=function(e){t.data.ty_gia||(t.data.ty_gia=1),e.tien_nt=STP.round(e.sl_xuat*e.gia_ban_nt,t.f_tien_nt),e.tien=STP.round(e.tien_nt*t.data.ty_gia,t.f_tien),e.tien_ck_nt=STP.round(e.tien_nt*e.ty_le_ck/100,t.f_tien_nt),e.tien_ck=STP.round(e.tien_ck_nt*t.data.ty_gia,t.f_tien),e.tien_xuat_nt=STP.round(e.sl_xuat*(e.gia_von?e.gia_von:0),t.f_tien),e.tien_xuat=e.tien_xuat_nt,hd2Module.tinhCkvt(n.$http,t.data,e)
},t.updateRows=function(){t.data.details.forEach(function(n){t.select(n,n.sl_xuat)})},t.select=function(n,e){var a,i,o,r=0;t.data.ty_gia||(t.data.ty_gia=1),t.dt_current={};var c=_.filter(t.data.details,function(t){return!(t.ma_vt!=n.ma_vt||t.ma_lo!=n.ma_lo&&(t.ma_lo||n.ma_lo)||t.han_sd!=n.han_sd&&(t.han_sd||n.han_sd)||t.ma_tt1!=n.ma_tt1&&(t.ma_tt1||n.ma_tt1)||t.ma_tt2!=n.ma_tt2&&(t.ma_tt2||n.ma_tt2)||t.ma_tt3!=n.ma_tt3&&(t.ma_tt3||n.ma_tt3))});if(c.length>0)t.dt_current=c[0],t.dt_current.sl_xuat=void 0!==e&&null!==e?e:t.dt_current.sl_xuat+1,t.dt_current.gia_ban=STP.round(t.dt_current.gia_ban_nt*t.data.ty_gia,t.f_gia),t.dt_current.cs_ck1||(t.dt_current.cs_ck1={ty_le_ck:0,tien_ck:0});else{if(t.dt_current={ma_vt:n.ma_vt,ten_vt:n.ten_vt,ma_dvt:n.ma_dvt,tk_vt:n.tk_vt,tk_dt:n.tk_dt,tk_gv:n.tk_gv,tk_ck:n.tk_ck,ma_lo:n.ma_lo,han_sd:n.han_sd,ma_tt1:n.ma_tt1,ma_tt2:n.ma_tt2,ma_tt3:n.ma_tt3},hd2Module.defaultValues4Detail&&_.extend(t.dt_current,hd2Module.defaultValues4Detail),t.data.options)for(var d in t.data.options)t.data.options[d]&&(t.dt_current[d]=t.data.options[d]);t.dt_current.sl_xuat=void 0!==e&&null!==e?e:1,t.dt_current.gia_ban_nt=n.gia_ban_nt||n.gia_ban_le,t.dt_current.gia_ban=STP.round(t.dt_current.gia_ban_nt*t.data.ty_gia,t.f_gia),t.dt_current.gia_von_nt=n.gia_von_nt||n.gia_mua,t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.line=t.data.details.length,0!==e&&t.data.details.push(t.dt_current),t.dt_current.cs_ck1=n.cs_ck1||{ty_le_ck:n.ty_le_ck,tien_ck:n.tien_ck},t.dt_current.cs_ck2=n.cs_ck2||n.ck_sl_tu2,t.dt_current.cs_km=n.cs_km||n.promotion}if(a=t.dt_current.cs_ck1.ty_le_ck,i=t.dt_current.cs_ck1.tien_ck,t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(r=n.sl_xuat+r)}),t.dt_current.cs_ck2&&t.dt_current.cs_ck2.length>0&&(o=_.filter(t.dt_current.cs_ck2,function(n){return n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&(n.ma_kh===t.data.ma_kh||n.nh_kh===t.data.nh_kh)}),0==o.length&&(o=_.filter(t.dt_current.cs_ck2,function(t){return t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0&&(o=_.sortBy(o,function(t){return-t.sl_tu}),a=o[0].ty_le_ck,i=o[0].tien_ck)),!a&&t.dt_current.gia_ban&&(a=100*STP.round(i/t.dt_current.gia_ban,2)),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.ty_le_ck=a,t.tinhtienhang(n))}),t.dt_current.cs_km)if(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.ma_kh&&n.ma_kh===t.data.ma_kh}),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.nh_kh&&n.nh_kh===t.data.nh_kh})),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(t){return(t.ma_vt||t.ma_nvt)&&t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0){if(o=_.sortBy(o,function(t){return-t.sl_tu}),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.promotion=[])}),t.dt_current.promotion=JSON.parse(JSON.stringify(o[0])),t.dt_current.promotion.sl_tu&&!t.dt_current.promotion.sl_den&&t.dt_current.promotion.details_km){var l=(r-r%t.dt_current.promotion.sl_tu)/t.dt_current.promotion.sl_tu;l>1&&t.dt_current.promotion.details_km.forEach(function(t){t.sl_km=l*t.sl_km})}}else t.dt_current.promotion={}}}});hd2Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0,t_ck_nt:0,t_ck:0},hd2Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},hd2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd2Module.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return t.vcondition.ma_vt&&(n.details={$elemMatch:{ma_vt:t.vcondition.ma_vt}}),n},hd2Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_ban=STP.round(t.dt_current.gia_ban_nt*t.ngMasterData.ty_gia,t.f_gia),t.dt_current.tien_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))})},hd2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.tien_xuat=e.tien_xuat_nt}),t.data.t_thue=STP.round(t.data.t_thue_nt*n,t.f_tien))}),t.$watch("data.thue_suat",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=STP.round(t.data.t_thue_nt*t.data.ty_gia,t.f_tien))}),t.$watch("data.t_tien_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=STP.round(t.data.t_thue_nt*t.data.ty_gia,t.f_tien),t.data.t_tt_nt=t.data.t_tien_nt-t.data.t_ck_nt+t.data.t_thue_nt)}),t.$watch("data.t_tien",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=STP.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,t.f_tien),t.data.t_tt=t.data.t_tien-t.data.t_ck+t.data.t_thue)}),t.$watch("data.t_ck_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=STP.round(t.data.t_thue_nt*t.data.ty_gia,t.f_tien),t.data.t_tt_nt=t.data.t_tien_nt-t.data.t_ck_nt+t.data.t_thue_nt)}),t.$watch("data.t_ck",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=STP.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,t.f_tien),t.data.t_tt=t.data.t_tien-t.data.t_ck+t.data.t_thue)}),t.$watch("data.t_thue_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_tt_nt=t.data.t_tien_nt-t.data.t_ck_nt+t.data.t_thue_nt)}),t.$watch("data.t_thue",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_tt=t.data.t_tien-t.data.t_ck+t.data.t_thue)})};var hd1Module=new baseVoucher("hd1","hd1",[],"Hóa đơn bán dịch vụ");hd1Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},hd1Module.defaultValues4Detail={ty_le_ck:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0},hd1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))})},hd1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=STP.round(t.tien_hang_nt*n,0),t.tien_ck=STP.round(t.tien_ck_nt*n,0)}),t.data.t_thue=STP.round(t.data.t_thue_nt*n,t.f_tien))}),t.$watch("data.thue_suat",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=STP.round(t.data.t_thue_nt*t.data.ty_gia,t.f_tien))}),t.$watch("data.t_tien_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=STP.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=STP.round(t.data.t_thue_nt*t.data.ty_gia,t.f_tien))}),t.$watch("data.t_tien",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=STP.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,t.f_tien))})};var hd3Module=new baseVoucher("hd3","hd3",[],"Phiếu nhập hàng bán bị trả lại",{onInput:function(t,n){t.selectItem=function(e,a,i){if(i||(i=function(){}),a.ma_lo_yn||a.ma_tt1_yn||a.ma_tt2_yn||a.ma_tt3_yn){n.$uibModal.open({templateUrl:"templates/lists/dmvt/templates/select-lo.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","parentScope","appInfo",function(t,n,o,r,c,d,l){initLabel(n,t,l,"DMVT",r),t.item=a,t.parameters={ma_vt:a.ma_vt,ma_kho:e.ma_kho},t.cancel=function(){c.close(),i()},t.select=function(t){a.ma_lo=t.ma_lo,a.ma_kho=t.ma_kho,a.ma_tt1=t.ma_tt1,a.ma_tt2=t.ma_tt2,a.ma_tt3=t.ma_tt3,a.han_sd=t.han_sd,e.details_doi=STP.add(e.details_doi,{ma_vt:a.ma_vt,ten_vt:a.ten_vt,ma_lo:a.ma_lo,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3,han_sd:a.han_sd,sl_xuat:1,gia_ban_nt:a.gia_ban_le,ma_dvt:a.ma_dvt,tien_nt:a.gia_ban_le},null,{ma_vt:a.ma_vt,ma_lo:a.ma_lo,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3,han_sd:a.han_sd},["sl_xuat","tien_nt"]),c.close(),i()}}],size:"md",resolve:{parentScope:function(){return t}}})}else e.details_doi=STP.add(e.details_doi,{ma_vt:a.ma_vt,ten_vt:a.ten_vt,sl_xuat:1,gia_ban_nt:a.gia_ban_le,ma_dvt:a.ma_dvt,tien_nt:a.gia_ban_le},null,{ma_vt:a.ma_vt},["sl_xuat","tien_nt"]),i()}}});hd3Module.defaultValues={vatvaos:[]},hd3Module.defaultValues4Detail={sl_nhap:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_nhap_nt:0,tien_nhap:0},hd3Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd3Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd3Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nhap_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien))}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_ban=STP.round(t.dt_current.gia_ban_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_ban,t.f_tien))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt,0),t.dt_current.tien_nhap_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien))}),t.$watch("dt_current.tien_nhap_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=STP.round(t.dt_current.tien_nhap_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.getInvoice=function(){t.$uibModal.open({templateUrl:"templates/vouchers/hd3/templates/form-select-invoice.html",controller:["$scope","$uibModalInstance","parentScope","$filter","$rootScope",function(n,e,a,i,o){n.STP=STP,n.condition={tu_ngay:new Date(moment().format("YYYY-MM-01")),den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.condition.ma_kh=n.ngMasterData.ma_kh,n.condition.ten_kh=n.ngMasterData.ten_kh,n.masters=[],n.details=[],n.selectAllDetail=function(t){t.details.forEach(function(n){n.sel=t.sel})},n.invoiceClick=function(t){n.details=[];var e=_.find(n.masters,function(n){return n._id==t});n.details=e.details},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url_report+"/api/"+id_app+"/getinvoice2return?t=1";n.condition.ma_kh&&(e=e+"&ma_kh="+n.condition.ma_kh),n.ngMasterData._id&&(e=e+"&id_ct="+n.ngMasterData._id),e=e+"&tu_ngay="+i("date")(n.condition.tu_ngay,"yyyy-MM-dd"),e=e+"&den_ngay="+i("date")(n.condition.den_ngay,"yyyy-MM-dd"),n.condition.so_ct&&(e=e+"&so_ct="+n.condition.so_ct),n.condition.so_hd&&(e=e+"&so_hd="+n.condition.so_hd),t.$http.get(e).then(function(t){n.masters=t.data},function(t){n.masters=[],t.data&&o.alert(t.data)})},n.ok=function(){n.condition.ma_kh&&(a.ngMasterData.ma_kh=n.condition.ma_kh,a.ngMasterData.ten_kh=n.condition.ten_kh),a.ngMasterData.details=[];var t=0;n.masters.forEach(function(n){n.sel&&n.details.forEach(function(n){n.sel&&(n.line=t,a.ngMasterData.details.push(n),t++)})}),e.close()},n.cancel=function(){e.close()}}],size:"lg",resolve:{parentScope:function(){return t}}})}},hd3Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.tien_nhap=STP.round(e.tien_nhap_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var hd7Module=new baseVoucher("hd7","hd7",[],"Trả lại hoặc đổi hàng",{onInput:function(t,n){t.selectItem=function(e,a,i){if(a.ma_vt)if(i||(i=function(){}),a.ma_lo_yn||a.ma_tt1_yn||a.ma_tt2_yn||a.ma_tt3_yn){n.$uibModal.open({templateUrl:"templates/lists/dmvt/templates/select-lo.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","parentScope","appInfo",function(t,n,o,r,c,d,l){initLabel(n,t,l,"DMVT",r),t.item=a,t.parameters={ma_vt:a.ma_vt,ma_kho:e.ma_kho},t.cancel=function(){c.close(),i()},t.select=function(t){a.ma_lo=t.ma_lo,a.ma_kho=t.ma_kho,a.ma_tt1=t.ma_tt1,a.ma_tt2=t.ma_tt2,a.ma_tt3=t.ma_tt3,a.han_sd=t.han_sd,e.details_doi=STP.add(e.details_doi,{ma_vt:a.ma_vt,ten_vt:a.ten_vt,tk_vt:a.tk_vt,tk_gv:a.tk_gv,ma_lo:a.ma_lo,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3,han_sd:a.han_sd,sl_xuat:1,gia_ban_nt:a.gia_ban_le,ma_dvt:a.ma_dvt,tien_nt:a.gia_ban_le},null,{ma_vt:a.ma_vt,ma_lo:a.ma_lo,ma_tt1:a.ma_tt1,ma_tt2:a.ma_tt2,ma_tt3:a.ma_tt3,han_sd:a.han_sd},["sl_xuat","tien_nt"]),c.close(),i()}}],size:"md",resolve:{parentScope:function(){return t}}})}else e.details_doi=STP.add(e.details_doi,{ma_vt:a.ma_vt,ten_vt:a.ten_vt,sl_xuat:1,gia_ban_nt:a.gia_ban_le,ma_dvt:a.ma_dvt,tien_nt:a.gia_ban_le,tk_vt:a.tk_vt,tk_gv:a.tk_gv},null,{ma_vt:a.ma_vt},["sl_xuat","tien_nt"]),i()}}});hd7Module.defaultValues={vatvaos:[]},hd7Module.defaultValues4Detail={sl_nhap:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_nhap_nt:0,tien_nhap:0},hd7Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd7Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd7Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nhap_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien))}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_ban=STP.round(t.dt_current.gia_ban_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_ban,t.f_tien))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt,t.f_tien),t.dt_current.tien_nhap_nt=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=STP.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.f_tien))}),t.$watch("dt_current.tien_nhap_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=STP.round(t.dt_current.tien_nhap_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,t.f_tien))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.getInvoice=function(){t.$uibModal.open({templateUrl:"templates/vouchers/hd7/templates/form-select-invoice.html",controller:["$scope","$uibModalInstance","parentScope","$filter","$rootScope",function(n,e,a,i,o){n.STP=STP,n.condition={tu_ngay:moment().startOf("month").toDate(),den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.condition.ma_kh=n.ngMasterData.ma_kh,n.condition.ten_kh=n.ngMasterData.ten_kh,n.masters=[],n.details=[],n.selectAllDetail=function(t){t.details.forEach(function(n){n.sel=t.sel})},n.invoiceClick=function(t){n.details=[];var e=_.find(n.masters,function(n){return n._id==t});n.details=e.details},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url_report+"/api/"+id_app+"/getinvoice2return_bl?t=1";n.condition.ma_kh&&(e=e+"&ma_kh="+n.condition.ma_kh),n.ngMasterData._id&&(e=e+"&id_ct="+n.ngMasterData._id),e=e+"&tu_ngay="+i("date")(n.condition.tu_ngay,"yyyy-MM-dd"),e=e+"&den_ngay="+i("date")(n.condition.den_ngay,"yyyy-MM-dd"),n.condition.so_ct&&(e=e+"&so_ct="+n.condition.so_ct),n.condition.so_hd&&(e=e+"&so_hd="+n.condition.so_hd),t.$http.get(e).then(function(t){n.masters=t.data},function(t){n.masters=[],t.data&&o.alert(t.data)})},n.ok=function(){a.ngMasterData.ma_kh=n.condition.ma_kh,a.ngMasterData.ten_kh=n.condition.ten_kh,a.ngMasterData.details=[];var t=0;n.masters.forEach(function(n){n.sel&&n.details.forEach(function(n){n.sel&&(n.line=t,a.ngMasterData.details.push(n),t++)})}),e.close()},n.cancel=function(){e.close()}}],size:"lg",resolve:{parentScope:function(){return t}}})}},hd7Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.tien_nhap=STP.round(e.tien_nhap_nt*n,t.f_tien)}),angular.forEach(t.data.vatvaos,function(e){e.t_tien=STP.round(e.t_tien_nt*n,t.f_tien),e.t_thue=STP.round(e.t_thue_nt*n,t.f_tien)}))})};var pblModule=new baseVoucher("pbl","pbl",[],"Phiếu bán lẻ",{onLoading:function(t,n){t.tinhtienhang=function(t,e){e.ty_gia||(e.ty_gia=1);var a=("VND"==e.ma_nt?n.$rootScope.app_info.options.f_gia:n.$rootScope.app_info.options.f_gia_nt,"VND"==e.ma_nt?n.$rootScope.app_info.options.f_tien:n.$rootScope.app_info.options.f_tien_nt),i=n.$rootScope.app_info.options.f_tien,o=a;t.tien_hang_nt=STP.round(t.sl_xuat*t.gia_ban_nt,o),t.tien_hang=STP.round(t.tien_hang_nt*e.ty_gia,i),t.tien_ck_nt=STP.round(t.tien_hang_nt*t.ty_le_ck/100,o),t.tien_ck=STP.round(t.tien_ck_nt*e.ty_gia,i),t.tien_nt=t.tien_hang-t.tien_ck,t.tien=STP.round(t.tien_nt*e.ty_gia,i),t.tien_xuat_nt=STP.round(t.sl_xuat*(t.gia_von?t.gia_von:0),i),t.tien_xuat=t.tien_xuat_nt},t.giaoca=function(){var e={ma_kho:n.config.ma_kho,ma_ca:n.config.ma_ca,tu_ngay:moment().startOf("date").toDate(),den_ngay:moment().endOf("date").toDate(),nhan_vien:t.current_user.email};giaocaModule.quickadd(n.$uibModal,function(){delete n.config.ma_ca},e)},t.thanhtoan=function(e){n.$uibModal.open({templateUrl:"templates/vouchers/pbl/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailschedule","$location","mailscheduleConfig","$uibModalInstance","$window","$routeParams","$timeout","$rootScope","pbl","parentScope",function(t,n,a,i,o,r,c,d,l,u,s,p,h){t.data=e,t.data.tien_thu=t.data.t_tt,t.data.con_no=0,t.save=function(){e.trang_thai=2,p.update(id_app,e._id,e).then(function(t){_.extend(e,t.data),c.close(),h.printRpt&&h.printRpt("",e)},function(t){s.alert(t.data||"Không kết nối được với máy chủ")})},t.cancel=function(){c.close()},t.$watch("data.tien_thu",function(n){n&&(t.data.con_no=t.data.t_tt-t.data.tien_thu)})}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})},t.traLai=function(t){var e=JSON.parse(JSON.stringify(t));e.details.forEach(function(t){t.id_hd=e._id,t.sl_nhap=t.sl_xuat,delete t.sl_xuat,t.tien_nhap_nt=t.tien_xuat_nt,t.tien_nhap=t.tien_xuat,delete t.tien_xuat_nt,delete t.tien_xuat}),e.id_pbl=e._id,delete e._id,delete e.ma_ct,delete e.ngay_ct,delete e.so_ct,delete e.trang_thai,hd7Module.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onAdd:function(t,n){var e=t.data;if(!e.ma_kho||!e.ma_ca)if(n.config.ma_ca&&n.config.ma_kho)e.ma_kho=n.config.ma_kho,e.ma_ca=n.config.ma_ca;else{n.$uibModal.open({templateUrl:"templates/vouchers/pbl/templates/ca-selector.html",controller:["$scope","$controller","$http","$uibModalInstance","$routeParams","$rootScope",function(t,a,i,o){t.data=e,t.cancel=function(){n.config.ma_kho=e.ma_kho,n.config.ma_ca=e.ma_ca,o.close()}}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}},onInput:function(t,n){n.$controller("calcTime",{$scope:t}),t.tinhtienhang=function(e){t.data.ty_gia||(t.data.ty_gia=1);var a=t.f_tien_nt;e.tien_hang_nt=STP.round(e.sl_xuat*e.gia_ban_nt,a),e.tien_hang=STP.round(e.tien_hang_nt*t.data.ty_gia,t.f_tien),e.tien_ck_nt=STP.round(e.tien_hang_nt*e.ty_le_ck/100,a),e.tien_ck=STP.round(e.tien_ck_nt*t.data.ty_gia,t.f_tien),e.tien_nt=e.tien_hang-e.tien_ck,e.tien=STP.round(e.tien_nt*t.data.ty_gia,t.f_tien),e.tien_xuat_nt=STP.round(e.sl_xuat*(e.gia_von?e.gia_von:0),t.f_tien),e.tien_xuat=e.tien_xuat_nt,pblModule.tinhCkvt(n.$http,t.data,e)},t.updateRows=function(){t.data.details.forEach(function(n){t.select(n,n.sl_xuat)})},t.select=function(n,e){var a,i,o,r=0;0===t.data.ty_gia&&(t.data.ty_gia=1),t.dt_current={};var c=_.filter(t.data.details,function(t){return!(t.ma_vt!=n.ma_vt||t.ma_lo!=n.ma_lo&&(t.ma_lo||n.ma_lo)||t.han_sd!=n.han_sd&&(t.han_sd||n.han_sd)||t.ma_tt1!=n.ma_tt1&&(t.ma_tt1||n.ma_tt1)||t.ma_tt2!=n.ma_tt2&&(t.ma_tt2||n.ma_tt2)||t.ma_tt3!=n.ma_tt3&&(t.ma_tt3||n.ma_tt3))});if(c.length>0)t.dt_current=c[0],t.dt_current.sl_xuat=void 0!==e&&null!==e?e:t.dt_current.sl_xuat+1,t.dt_current.cs_ck1||(t.dt_current.cs_ck1={ty_le_ck:0,tien_ck:0});else{if(t.dt_current={ma_vt:n.ma_vt,ten_vt:n.ten_vt,ma_dvt:n.ma_dvt,tk_vt:n.tk_vt,tk_dt:n.tk_dt,tk_gv:n.tk_gv,tk_ck:n.tk_ck,ma_lo:n.ma_lo,han_sd:n.han_sd,ma_tt1:n.ma_tt1,ma_tt2:n.ma_tt2,ma_tt3:n.ma_tt3},pblModule.defaultValues4Detail&&_.extend(t.dt_current,pblModule.defaultValues4Detail),t.data.options)for(var d in t.data.options)t.data.options[d]&&(t.dt_current[d]=t.data.options[d]);t.dt_current.sl_xuat=void 0!==e&&null!==e?e:1,t.dt_current.gia_ban_nt=n.gia_ban_nt||n.gia_ban_le,t.dt_current.gia_ban=STP.round(t.dt_current.gia_ban_nt*t.data.ty_gia,t.f_gia),t.dt_current.gia_von_nt=n.gia_von_nt||n.gia_mua,t.dt_current.gia_von=STP.round(t.dt_current.gia_von_nt,t.f_gia),t.dt_current.line=t.data.details.length,0!==e&&t.data.details.push(t.dt_current),t.dt_current.cs_ck1=n.cs_ck1||{ty_le_ck:n.ty_le_ck,tien_ck:n.tien_ck},t.dt_current.cs_ck2=n.cs_ck2||n.ck_sl_tu2,t.dt_current.cs_km=n.cs_km||n.promotion}if(a=t.dt_current.cs_ck1.ty_le_ck,i=t.dt_current.cs_ck1.tien_ck,t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(r=n.sl_xuat+r)}),t.dt_current.cs_ck2&&t.dt_current.cs_ck2.length>0&&(o=_.filter(t.dt_current.cs_ck2,function(n){return n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&(n.ma_kh===t.data.ma_kh||n.nh_kh===t.data.nh_kh)}),0==o.length&&(o=_.filter(t.dt_current.cs_ck2,function(t){return t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0&&(o=_.sortBy(o,function(t){return-t.sl_tu}),a=o[0].ty_le_ck,i=o[0].tien_ck)),!a&&t.dt_current.gia_ban&&(a=100*STP.round(i/t.dt_current.gia_ban,2)),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.ty_le_ck=a,t.tinhtienhang(n))}),t.dt_current.cs_km)if(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.ma_kh&&n.ma_kh===t.data.ma_kh}),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(n){return(n.ma_vt||n.ma_nvt)&&n.sl_tu<=r&&(!n.sl_den||n.sl_den>=r)&&n.nh_kh&&n.nh_kh===t.data.nh_kh})),0==o.length&&(o=_.filter(t.dt_current.cs_km,function(t){return(t.ma_vt||t.ma_nvt)&&t.sl_tu<=r&&(!t.sl_den||t.sl_den>=r)&&!t.ma_kh&&!t.nh_kh})),o.length>0){if(o=_.sortBy(o,function(t){return-t.sl_tu}),t.data.details.forEach(function(n){n.ma_vt===t.dt_current.ma_vt&&(n.promotion=[])}),t.dt_current.promotion=JSON.parse(JSON.stringify(o[0])),t.dt_current.promotion.sl_tu&&!t.dt_current.promotion.sl_den&&t.dt_current.promotion.details_km){var l=(r-r%t.dt_current.promotion.sl_tu)/t.dt_current.promotion.sl_tu;l>1&&t.dt_current.promotion.details_km.forEach(function(t){t.sl_km=l*t.sl_km})}}else t.dt_current.promotion={}}},onSave:function(t,n,e,a){if(2==n.trang_thai){e.$uibModal.open({templateUrl:"templates/vouchers/pbl/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailschedule","$location","mailscheduleConfig","$uibModalInstance","$window","$routeParams","$timeout","$rootScope",function(t,e,i,o,r,c,d){t.data=n,t.data.tien_thu=t.data.t_tt,t.data.con_no=0,t.save=function(){a(null,n),d.close()},t.cancel=function(){d.close()},t.$watch("data.tien_thu",function(n){n&&(t.data.con_no=t.data.t_tt-t.data.tien_thu)})}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}else a(null,n)}});pblModule.module.controller("calcTime",["$scope","$interval",function(t,n){var e=n(function(){t.data&&1===t.data.trang_thai&&(t.data.den_ngay=new Date)},1e3);t.$on("$destroy",function(){n.cancel(e),e=void 0})}]),pblModule.defaultValues={ty_le_ck_hd:0,tien_ck_hd:0,trang_thai:"2",tu_ngay:new Date,den_ngay:new Date},pblModule.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},pblModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:"",ma_kho:""},pblModule.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return t.vcondition.ma_kho&&(n.ma_kho=t.vcondition.ma_kho),t.vcondition.ma_kh&&(n.ma_kh=t.vcondition.ma_kh),t.vcondition.ma_vt&&(n.details={$elemMatch:{ma_vt:t.vcondition.ma_vt}}),n
},pblModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=STP.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,t.f_tien))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=STP.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,t.f_tien),t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)})},pblModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.tien_hang=STP.round(e.tien_hang_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.tien_xuat=e.tien_xuat_nt})}),t.$watch("data.den_ngay",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.ngay_ct=t.data.den_ngay)})},pblModule.module.directive("dbPbl",function(){return{restrict:"E",scope:{},templateUrl:"templates/vouchers/pbl/templates/db.html",controller:["$scope","pbl","$rootScope","$location","appInfo","socket","nodeWebkit","$http","$uibModal",function(t,n,e,a,i,o,r,c,d){initLabel(e,t,i,"pbl",c),i.info("pbl",function(a){if(!a){t.token=e.token,t.server_url=server_url,t.now=new Date,t.app_info=e.app_info,t.dssanpham=[];var i=function(n){t.dssanpham=_.reject(t.dssanpham,function(t){return t.m_id===n._id}),(0==n.trang_thai||1==n.trang_thai)&&n.details.forEach(function(e){for(var a in n)"details"!==a&&"_id"!==a&&(e[a]=n[a]);if(e.picture){var i=e.picture.split(".");e.m_id=n._id,e.picture_thumb=e.picture+".thumb."+i[i.length-1]}else e.picture_thumb="/getfile/others/noimage.png";t.dssanpham.push(e)})},c={trang_thai:{$in:[0,1]}};t.refresh=function(){t.pbls={},t.dssanpham=[],n.load(id_app,{condition:c}).then(function(n){n.data.forEach(function(n){t.pbls[n._id]=n,i(n)})},function(t){t.data&&console.log("error load don hang",t.data)})},t.complete=function(e){e.sl_ht=e.sl_xuat;var a=t.pbls[e.m_id];a?(a.not_update=!0,a.details.forEach(function(t){t.line==e.line&&t.ma_vt==e.ma_vt&&(t.sl_ht=t.sl_xuat)}),n.update(id_app,a._id,a).then(function(t){_.extend(a,t.data)},function(t){t.data&&alert(t.data)})):alert("Không tìm thấy đơn hàng")},t.cancel=function(e){e.het_hang=!0;var a=t.pbls[e.m_id];a?(a.not_update=!0,a.details.forEach(function(t){t.line==e.line&&t.ma_vt==e.ma_vt&&(t.het_hang=!0)}),n.update(id_app,a._id,a).then(function(t){_.extend(a,t.data)},function(t){t.data&&alert(t.data)})):alert("Không tìm thấy đơn hàng")},t.view=function(n){var e=t.pbls[n.m_id];pblModule.quickedit(d,n.m_id,function(t){_.extend(e,t)})},o.on("pbl:new",function(e){var a=e._id;t.pbls||(t.pbls={}),n.get(id_app,a).then(function(n){e=n.data;var o=t.pbls[e._id];o||(e.is_new=!0,e.is_update=!1,notificationShowed[e._id+":new"]||(notificationShowed[e._id+":new"]=e,r.notification("Bạn có đơn hàng mới","",{url:"/pbl/edit/"+a})),i(e),t.pbls[e._id]=e)})}),o.on("pbl:update",function(e){var a=e._id;t.pbls||(t.pbls={});var o=t.pbls[a];return o&&o.not_update?void(o.not_update=!1):void n.get(id_app,a).then(function(n){return e=n.data,2==e.trang_thai||9==e.trang_thai?(t.dssanpham=_.reject(t.dssanpham,function(t){return t.m_id==e._id}),void delete t.pbls[a]):(t.pbls[a]=e,e.is_update=!0,e.is_new=!1,i(e),void(notificationShowed[e._id+":update"]||(notificationShowed[e._id+":update"]=e,r.notification("Đơn hàng đã được cập nhật","",{url:"/pbl/edit/"+a}))))})}),t.refresh()}})}],link:function(){}}});var so1Module=new baseVoucher("so1","so1",[],"Đơn đặt hàng",{onInput:function(t,n){STPModules.trangthai.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{ma_ct:"SO1"}}).then(function(n){t.ds_trang_thai=n.data}),t.select=function(n){var e={},a=_.filter(t.data.details,function(t){return t.ma_vt===n.ma_vt&&t.ma_lo===n.ma_lo&&t.han_sd===n.han_sd&&t.ma_tt1==n.ma_tt1&&t.ma_tt2==n.ma_tt2&&t.ma_tt3==n.ma_tt3});if(a.length>0)e=a[0],e.sl_xuat+=1;else{if(e={ma_vt:n.ma_vt,ten_vt:n.ten_vt,ma_dvt:n.ma_dvt,tk_vt:n.tk_vt,ma_lo:n.ma_lo,han_sd:n.han_sd,ma_tt1:n.ma_tt1,ma_tt2:n.ma_tt2,ma_tt3:n.ma_tt3},pblModule.defaultValues4Detail&&_.extend(e,pblModule.defaultValues4Detail),t.data.options)for(var i in t.data.options)t.data.options[i]&&(e[i]=t.data.options[i]);e.sl_xuat=1,e.gia_ban_nt=n.gia_ban_le,e.gia_ban=n.gia_ban_le,e.line=t.data.details.length,t.data.details.push(e)}e.tien_hang_nt=STP.round(e.sl_xuat*e.gia_ban_nt,t.f_tien_nt),e.tien_hang=e.tien_hang_nt,n.tien_ck?(e.tien_ck_nt=STP.round(e.sl_xuat*n.tien_ck,t.f_tien_nt),e.tien_ck=STP.round(e.sl_xuat*n.tien_ck,t.f_tien)):n.ty_le_ck?(e.tien_ck_nt=STP.round(e.tien_hang_nt*n.ty_le_ck/100,t.f_tien_nt),e.tien_ck=e.tien_ck_nt):(e.tien_ck_nt=0,e.tien_ck=0),e.tien_nt=e.tien_hang_nt-e.tien_ck_nt,e.tien=e.tien_hang-e.tien_ck,e.tien_xuat=0}}});so1Module.defaultValues={ty_le_ck_hd:0,tien_ck_hd:0},so1Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_xuat_nt:0,tien_xuat:0,gia_von_nt:0,gia_von:0,px_gia_dd:!1},so1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:"",trang_thai:""},so1Module.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return t.vcondition.ma_vt&&(n.details={$elemMatch:{ma_vt:t.vcondition.ma_vt}}),n},so1Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=STP.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,t.f_tien))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=STP.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,t.f_tien))}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,t.f_tien),t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=STP.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=STP.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=STP.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,t.f_tien),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)})},so1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(e){e.tien_hang=STP.round(e.tien_hang_nt*n,t.f_tien),e.tien_ck=STP.round(e.tien_ck_nt*n,t.f_tien),e.tien_xuat=e.tien_xuat_nt}),t.data.t_thue=STP.round(t.data.t_thue_nt*n,t.f_tien))}),t.$watch("data.ty_le_ck_hd",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.tien_ck_hd=STP.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.ty_le_ck_hd/100,t.f_tien))}),t.$watch("data.t_tien_hang_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.tien_ck_hd=STP.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.ty_le_ck_hd/100,t.f_tien))})},so1Module.module.directive("saleOrder",function(){return{restrict:"E",scope:{condition:"=?",run:"=?",trangThai:"=?"},templateUrl:"templates/vouchers/so1/templates/db.html",controller:["$scope","so1","$rootScope","$interval","$location","appInfo","$http","$uibModal",function(t,n,e,a,i,o,r,c){initLabel(e,t,o,"SO1",r),o.info("so1",function(i){if(!i){t.now=new Date,t.app_info=e.app_info,t.editOrder=function(t){so1Module.quickedit(c,t,function(n){_.extend(t,n)})},t.add=function(){var n={};_.extend(n,t.condition),so1Module.quickadd(c,function(n){t.orders.push(n)},n)};var o;t.filter=function(a){a&&(o=a);var i={};_.extend(i,t.condition),t.trangThai&&(i.trang_thai=t.trangThai),console.log("filter",i),e.nextTick(function(){o&&_.extend(i,o),delete i.ten_kh,n.load(id_app,{condition:i,limit:10}).then(function(n){t.orders=n.data})})},t.$watch("run",function(n){n&&!_.isEqual(n,0)&&t.filter()}),t.intv&&(a.cancel(t.intv),t.intv=void 0),t.intv=a(t.filter,3e5)}})}],link:function(){}}});var rptbaocaokhachhang=new baseRpt("baocaokhachhang","baocaokhachhang","Báo cáo khách hàng",{onLoading:function(t,n){var e=(n.$filter,n.$location);t.gotoKH=function(t){e.url("dmkh/view/"+t._id)}}});rptbaocaokhachhang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tinh_thanh="",t.phu_trach=""};var rptcongviectheonv=new baseRpt("congviectheonv","congviectheonv","Đánh giá công việc theo nhân viên",{onLoading:function(t,n){n.$filter,n.$location;t.drilldown=function(t){t.phu_trach}}});rptcongviectheonv.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptcongviectheokh=new baseRpt("congviectheokh","congviectheokh","Phân tích công việc theo khách hàng",{onLoading:function(t,n){n.$filter,n.$location;t.drilldown=function(t){t.phu_trach}}});rptcongviectheokh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var module=angular.module("searchModule",["ngRoute"]);module.controller("searchController",["$scope","$rootScope","$location","$http","$routeParams","dmkh","dmvt","dmtk","lienhe","task","contract","dmdt","$window","$localStorage","appInfo",function(t,n,e,a,i,o,r,c,d,l,_,u,s,p,h){t.word=i.word,n.searchword=t.word,n.function_title="Tìm",n.function_sub_title=t.word,n.function_code="Search",h.info("SEARCH",function(i){if(!i){t.viewProduct=function(t){n.openUrl("dmvt/view/"+t+"?redirect="+e.url())},t.viewCustomer=function(t){n.openUrl("dmkh/view/"+t+"?redirect="+e.url())},t.viewAccount=function(t){n.openUrl("dmtk/view/"+t+"?redirect="+e.url())},t.viewContact=function(t){n.openUrl("lienhe/view/"+t+"?redirect="+e.url())},t.viewTask=function(t){n.openUrl("task/view/"+t+"?redirect="+e.url())},t.viewContract=function(t){n.openUrl("contract/view/"+t+"?redirect="+e.url())},t.viewProject=function(t){n.openUrl("dmdt/view/"+t+"?redirect="+e.url())},t.viewVoucher=function(t,e){if(t&&e){var a="/"+t.toLowerCase()+"/edit/"+e;n.openUrl(a)}},t.functions=[];var s=t.word.toLowerCase();n.commands&&n.commands.forEach(function(n){n.input.forEach(function(n){n.path?n.visible&&n.header.toLowerCase().indexOf(s)>=0&&t.functions.push(n):n.items&&n.items.forEach(function(n){n.visible&&n.header.toLowerCase().indexOf(s)>=0&&t.functions.push(n)})})}),o.list(id_app,t.word,null,null,1,50).then(function(n){var e=n.data;t.customers=e;var i=[];e.forEach(function(t){i.push(t.ma_kh)}),c.list(id_app,t.word,null,null,1,50).then(function(n){var e=n.data;t.accounts=e;var o=[];e.forEach(function(t){o.push(t.tk)});var r=p.get("token"),c={$or:[]};c.$or.push({dien_giai:{$regex:t.word,$options:"i"}}),c.$or.push({so_ct:{$regex:t.word,$options:"i"}}),c.$or.push({ma_ct:{$regex:t.word,$options:"i"}}),c.$or.push({ma_kh:{$regex:t.word,$options:"i"}}),c.$or.push({tk_no:{$regex:t.word,$options:"i"}}),c.$or.push({tk_co:{$regex:t.word,$options:"i"}}),i.length>0&&(c.$or.push({ma_kh_no:{$in:i}}),c.$or.push({ma_kh_co:{$in:i}})),o.length>0&&(c.$or.push({tk_no:{$in:o}}),c.$or.push({tk_co:{$in:o}}));var d=server_url+"/api/"+id_app+"/bkct?access_token="+r+"&q="+JSON.stringify(c);a.get(d).then(function(n){t.vouchers=n.data})})},function(){}),r.list(id_app,t.word,null,null,1,50).then(function(n){t.products=n.data},function(){}),d.list(id_app,t.word,null,null,1,50).then(function(n){t.contacts=n.data},function(){}),_.list(id_app,t.word,null,null,1,50).then(function(n){t.contracts=n.data},function(){}),u.list(id_app,t.word,null,null,1,50).then(function(n){t.projects=n.data},function(){}),l.list(id_app,t.word,null,null,1,50).then(function(n){t.dscv=n.data},function(){})}})}]),module.config(["$routeProvider","$locationProvider",function(t){t.when("/search/:word",{templateUrl:"templates/reports/search/templates/browser.html",controller:"searchController"})}]);var rptbkct=new baseRpt("bkct","bkct","Bảng kê chứng từ",{onAfterLoadData:function(t,n){var e=[];n.forEach(function(t){if(!t.bold){var n={};n["Số chứng từ"]=t.so_ct,n["Ngày chứng từ"]=t.ngay_ct,n["Mã chứng từ"]=t.ma_ct,n["Diễn giải"]=t.dien_giai,n["Khách hàng(nợ)"]=t.ten_kh_no,n["Khách hàng(có)"]=t.ten_kh_co,n["Nhóm khách hàng(nợ)"]=t.ten_nh_kh_no,n["Nhóm khách hàng(có)"]=t.ten_nh_kh_co,n["Bộ phận"]=t.ten_bp,n["Vụ việc"]=t.ten_dt,n["Hợp đồng"]=t.ten_hd,n.Phí=t.ten_phi,n["Nhân viên"]=t.ten_nv,n["TK nợ"]=t.tk_no,n["TK có"]=t.tk_co,n.Tiền=t.tien,n["Tiền ngoại tệ"]=t.tien_nt,n["Mã ngoại tệ"]=t.ma_nt,n["Tỷ giá"]=t.ty_gia,e.push(n)}}),t.data_pivot=e}});rptbkct.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptbkct.module.directive("bkctView",function(){return{restrict:"E",templateUrl:"templates/reports/bkct/templates/view.html"}}),rptbkct.module.directive("bkct",function(){return{restrict:"E",scope:{condition:"@",run:"="},templateUrl:"templates/reports/bkct/templates/view.html",controller:["$scope","$http","$filter","$location","$rootScope","appInfo",function($scope,$http,$filter,$location,$rootScope,appInfo){initLabel($rootScope,$scope,appInfo,"bkct",$http),$scope.getData=function(){$scope.data=[];var condition=eval("({"+$scope.condition+"})");rptbkct.getData($http,$filter,condition,function(t,n){t?console.log(t):$scope.data=n})},$scope.viewVoucher=function(t,n){if(t&&n){var e=t.toLowerCase()+"/edit/"+n+"?redirect=back";$rootScope.openUrl(e)}},$scope.order=function(t,n){$scope.data=$filter("orderBy")($scope.data,t,n)}}],link:function(t){t.$watch("run",function(){t.run&&t.getData()})}}});var rptscttk=new baseRpt("scttk","scttk","Sổ chi tiết tài khoản");rptscttk.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptscttk.afterLoadData=function(t){t.title="Sổ chi tiết tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptsocaitk=new baseRpt("socaitk","socaitk","Sổ cái tài khoản");rptsocaitk.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsocaitk.afterLoadData=function(t){t.title="Sổ cái tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptsoquy=new baseRpt("soquy","soquy","Sổ quỹ");rptsoquy.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="111"},rptsoquy.afterLoadData=function(){};var rptsoquy=new baseRpt("sotiengui","sotiengui","Sổ tiền gửi ngân hàng");rptsoquy.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="112"},rptsoquy.afterLoadData=function(){};var rptsochut=new baseRpt("sochut","sochut","Sổ chữ T tài khoản",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.tk_du){var i="/bkct?tk="+t.condition.tk;i=i+"&tk_du="+a.tk_du,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptsochut.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsochut.afterLoadData=function(t){t.title="Sổ chữ T tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptcdpstk=new baseRpt("cdpstk","cdpstk","Cân đối phát sinh tài khoản",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.tk&&""!=n.tk){var i="/scttk?tk="+n.tk;i=i+"&ten_tk="+n.ten_tk,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptcdpstk.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptcdpstk.useExcelTemplate=!0;var rptsonkc=new baseRpt("sonkc","sonkc","Sổ nhật ký chung",{onAfterLoadData:function(){},onInit:function(t){t.tableInfo=[{header:"Số chứng từ",name:"so_ct"},{header:"Ngày chứng từ",name:"ngay_ct",type:"date",f:"dd/MM/yyyy",className:"r-text-right"},{header:"Diễn giải",name:"dien_giai"},{header:"Tài khoản",name:"tk"},{header:"Tài khoản đối ứng",name:"tk_du"},{header:"PS nợ",name:"ps_no",className:"r-text-right"},{header:"PS có",name:"ps_co",className:"r-text-right"},{header:"Mã khách",name:"ma_kh"},{header:"Tên khách",name:"ten_kh"}]}});rptsonkc.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptsonktt=new baseRpt("sonktt","sonktt","Nhật ký thu tiền");rptsonktt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk_no="111,112"};var rptsonkct=new baseRpt("sonkct","sonkct","Nhật ký chi tiền");rptsonkct.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk_co="111,112"};var rptsonkmh=new baseRpt("sonkmh","sonkmh","Nhật ký mua hàng");rptsonkmh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptsonkbh=new baseRpt("sonkbh","sonkbh","Nhật ký bán hàng");rptsonkbh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptsctcnkh=new baseRpt("sctcnkh","sctcnkh","Sổ chi tiết công nợ khách hàng");rptsctcnkh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date,t.den_ngay=n},rptsctcnkh.afterLoadData=function(t){t.title="Sổ chi tiết công nợ khách hàng: "+t.condition.ma_kh+" - "+t.condition.ten_kh},rptsctcnkh.useExcelTemplate=!0;var rptcdpskh=new baseRpt("cdpskh","cdpskh","Cân đối phát sinh theo khách hàng",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_kh){var i="/sctcnkh?tk="+t.condition.tk;i=i+"&ten_tk="+t.condition.ten_tk,i=i+"&ma_kh="+a.ma_kh,i=i+"&ten_kh="+a.ten_kh,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptcdpskh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.groupBy=["ma_kh"]};var rptdutoanthuchitheodt=new baseRpt("dutoanthuchitheodt","dutoanthuchitheodt","Dự toán thu chi theo đối tượng",{onLoading:function(){}});rptdutoanthuchitheodt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptsctdt=new baseRpt("sctdt","sctdt","Sổ chi tiết vụ việc, dự án");rptsctdt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsctdt.afterLoadData=function(t){t.title="Sổ chi tiết vụ việc, dự án: "+t.condition.ma_dt+" - "+t.condition.ten_dt},rptsctdt.useExcelTemplate=!0;var rptcdpsdt=new baseRpt("cdpsdt","cdpsdt","Cân đối phát sinh theo vụ việc",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_dt){var i="/sctdt?tk="+t.condition.tk;i=i+"&ten_tk="+t.condition.ten_tk,i=i+"&ma_dt="+n.ma_dt,i=i+"&ten_dt="+n.ten_dt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptcdpsdt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptcdpsdt.useExcelTemplate=!0;var rptbkvatvao=new baseRpt("bkvatvao","bkvatvao","BẢNG KÊ HOÁ ĐƠN, CHỨNG TỪ HÀNG HOÁ, DỊCH VỤ MUA VÀO");rptbkvatvao.init=function(t){t.sorts=[{ma:"ngay_hd",text:"Ngày hóa đơn"},{ma:"ngay_ct",text:"Ngày chứng từ"}]},rptbkvatvao.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.sort="ngay_hd"},rptbkvatvao.setParameters=function(t){t.tong_tien_nt=0,t.tong_thue_nt=0,t.data&&t.data.forEach(function(n){n.t_tien_nt&&5==n.sysorder&&(t.tong_tien_nt+=n.t_tien_nt),n.t_thue_nt&&5==n.sysorder&&(t.tong_thue_nt+=n.t_thue_nt)})};var rptbkvatra=new baseRpt("bkvatra","bkvatra","BẢNG KÊ HOÁ ĐƠN, CHỨNG TỪ HÀNG HOÁ, DỊCH VỤ BÁN RA");rptbkvatra.init=function(t){t.sorts=[{ma:"ngay_hd",text:"Ngày hóa đơn"},{ma:"ngay_ct",text:"Ngày chứng từ"}]},rptbkvatra.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.sort="ngay_hd"},rptbkvatra.setParameters=function(t){t.tong_tien_nt=0,t.tong_thue_nt=0,t.data&&t.data.forEach(function(n){n.t_tien_nt&&5==n.sysorder&&(t.tong_tien_nt+=n.t_tien_nt),n.t_thue_nt&&5==n.sysorder&&(t.tong_thue_nt+=n.t_thue_nt)})};var kbmtkgtgtModule=new baseInput("kbmtkgtgt","kbmtkgtgt",["ma_so","chi_tieu"],"Khai báo mẫu tờ khai thuế GTGT",{modal_size:"md"});kbmtkgtgtModule.defaultValues={cach_tinh:"2",bang_du_lieu:"vatvao",phan_loai:"1",print:!0,kieu_gia_tri:"0"};var rpttkgtgt=new baseRpt("tkgtgt","tkgtgt","Tờ khai thuế GTGT");rpttkgtgt.defaultCondition=function(t){var n=new Date;t.tu_thang=n.getMonth()+1,t.den_thang=n.getMonth()+1,t.nam=n.getFullYear()};var rptbcdkt=new baseRpt("bcdkt","bcdkt","Bảng cân đối kế toán");rptbcdkt.defaultCondition=function(t){var n=new Date;t.den_ngay=n};var kbmbcdktModule=new baseInput("kbmbcdkt","kbmbcdkt",["ma_so","chi_tieu"],"Khai báo mẫu bảng cân đối kế toán",{modal_size:"md"});kbmbcdktModule.defaultValues={cach_tinh:"2",phan_loai:"1"};var kbmkqhdkdModule=new baseInput("kbmkqhdkd","kbmkqhdkd",["ma_so","chi_tieu"],"Khai báo mẫu kết quả hoạt động kinh doanh",{modal_size:"md"});kbmkqhdkdModule.defaultValues={cach_tinh:"2"};var rptkqhdkd=new baseRpt("kqhdkd","kqhdkd","Kết quả hoạt động kinh doanh");rptkqhdkd.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var kbmlcttttModule=new baseInput("kbmlctttt","kbmlctttt",["ma_so","chi_tieu"],"Khai báo mẫu báo cáo lưu chuyển tiền tệ phương pháp trực tiếp",{modal_size:"md"});kbmlcttttModule.defaultValues={cach_tinh:"1",phan_loai:"1"};var rptlctttt=new baseRpt("lctttt","lctttt","Lưu chuyển tiền tệ phương pháp trực tiếp");rptlctttt.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var kbmlcttgtModule=new baseInput("kbmlcttgt","kbmlcttgt",["ma_so","chi_tieu"],"Khai báo mẫu báo cáo lưu chuyển tiền tệ phương pháp gián tiếp",{modal_size:"md"});kbmlcttgtModule.defaultValues={cach_tinh:"1",phan_loai:"1"};var rptlcttgt=new baseRpt("lcttgt","lcttgt","Lưu chuyển tiền tệ phương pháp gián tiếp");rptlcttgt.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var rptthnxt=new baseRpt("thnxt","thnxt","Tổng hợp nhập xuất tồn",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_vt){var i="/sctvt?ma_vt="+a.ma_vt;i=i+"&ten_vt="+a.ten_vt,a.ma_lo&&(i=i+"&ma_lo="+a.ma_lo),a.ma_tt1&&(i=i+"&ma_tt1="+a.ma_tt1),a.ma_tt2&&(i=i+"&ma_tt2="+a.ma_tt2),a.ma_tt3&&(i=i+"&ma_tt3="+a.ma_tt3),a.ma_kho?i=i+"&ma_kho="+a.ma_kho:t.condition.ma_kho&&(i=i+"&ma_kho="+t.condition.ma_kho),i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),t.condition.ma_dvcs&&(i=i+"&ma_dvcs="+t.condition.ma_dvcs),i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptthnxt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.ma_kho="",t.ma_vt="",t.groupBy=["ma_vt"]};var rptthnxt_sl=new baseRpt("thnxt_sl","thnxt_sl","Tổng hợp nhập xuất tồn",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_vt){var i="/sctvt_sl?ma_vt="+a.ma_vt;i=i+"&ten_vt="+a.ten_vt,a.ma_lo&&(i=i+"&ma_lo="+a.ma_lo),a.ma_tt1&&(i=i+"&ma_tt1="+a.ma_tt1),a.ma_tt2&&(i=i+"&ma_tt2="+a.ma_tt2),a.ma_tt3&&(i=i+"&ma_tt3="+a.ma_tt3),a.ma_kho?i=i+"&ma_kho="+a.ma_kho:t.condition.ma_kho&&(i=i+"&ma_kho="+t.condition.ma_kho),i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),t.condition.ma_dvcs&&(i=i+"&ma_dvcs="+t.condition.ma_dvcs),i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptthnxt_sl.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.ma_kho="",t.ma_vt="",t.groupBy=["ma_vt"]};var rptckvttheokho=new baseRpt("ckvttheokho","ckvttheokho","Tồn theo kho",{onLoading:function(t,n){n.$filter,n.$location}});rptckvttheokho.defaultCondition=function(t){var n=new Date;t.den_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.ma_kho="",t.ma_vt=""};var rptsctvt=new baseRpt("sctvt","sctvt","Sổ chi tiết vật tư");rptsctvt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsctvt.afterLoadData=function(t){t.title="Sổ chi tiết vật tư: "+t.condition.ma_vt+" - "+t.condition.ten_vt};var rptsctvt_sl=new baseRpt("sctvt_sl","sctvt_sl","Sổ chi tiết vật tư");rptsctvt_sl.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsctvt_sl.afterLoadData=function(t){t.title="Sổ chi tiết vật tư: "+t.condition.ma_vt+" - "+t.condition.ten_vt};var rpttinhgiatb=new baseRpt("tinhgiatb","tinhgiatb","Tính giá trung bình",{stream:!0});rpttinhgiatb.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString())},rpttinhgiatb.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.tu_thang=(n.getMonth()+1).toString(),t.den_thang=(n.getMonth()+1).toString()};var rptkcsns=new baseRpt("kcsns","kcsns","Kết chuyển sang năm sau",{onFetchData:function(){alert("Chương trình đã thực hiện xong")}});rptkcsns.init=function(t){t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString());t.namChanged=function(){t.condition.sang_nam=Number(t.condition.nam)+1},t.namChanged()},rptkcsns.defaultCondition=function(t){var n=new Date;t.nam=(n.getFullYear()-1).toString(),t.sang_nam=Number(t.nam)+1};var rptpttct=new baseRpt("pttct","pttct","Phân tích theo chỉ tiêu");rptpttct.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var rptptcttct=new baseRpt("ptcttct","ptcttct","Phân tích chi tiết theo chỉ tiêu");rptptcttct.defaultCondition=function(t){{var n=new Date,e=n.getFullYear(),a=n.getMonth();n.getDate()}t.tu_ngay=new Date(e,a,1),t.den_ngay=n};var rptpttctkho=new baseRpt("pttctkho","pttctkho","Phân tích đối tượng theo chỉ tiêu");rptpttctkho.defaultCondition=function(t){{var n=new Date,e=n.getFullYear(),a=n.getMonth();n.getDate()}t.tu_ngay=new Date(e,a,1),t.den_ngay=n};var rptpttctkho2=new baseRpt("pttctkho2","pttctkho2","Phân tích đối tượng theo chỉ tiêu");rptpttctkho2.defaultCondition=function(t){{var n=new Date,e=n.getFullYear(),a=n.getMonth();n.getDate()}t.tu_ngay=new Date(e,a,1),t.den_ngay=n};var rptptbitralai=new baseRpt("ptbitralai","ptbitralai","Phân tích hàng bán bị trả lại",{onLoading:function(t,n){n.$filter,n.$location}});rptptbitralai.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptptdonhang=new baseRpt("ptdonhang","ptdonhang","Phân tích đơn hàng",{onLoading:function(t,n){n.$filter,n.$location}});rptptdonhang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptformModule=new baseInput("rptform","rptform",["rptform_name","rptform_type"],"Mẫu báo cáo theo chỉ tiêu",{onSaved:function(t,n,e){e.$rootScope.openUrl("kbmpttct",{id_rptform:n._id})}}),kbmpttctModule=new baseInput("kbmpttct","kbmpttct",["ma_so","chi_tieu"],"Khai báo mẫu phân tích theo chỉ tiêu",{modal_size:"md",onInput:function(t,n){var e=server_url+"/api/"+id_app+"/rptform/"+t.data.id_rptform+"?fields=rptform_type";n.$http.get(e).then(function(n){n.data&&(t.rptform_type=n.data.rptform_type)},function(t){console.log(t.data,e)})}});kbmpttctModule.defaultValues={cach_tinh:"2"};var ctdsModule=new baseInput("ctds","ctds",["ma_nv","ma_kho","ma_dvcs"],"Kế hoạch");ctdsModule.init=function(){},ctdsModule.defaultValues={chi_tieu:0,nam:(new Date).getFullYear(),thang:(new Date).getMonth()+1};var rptsosanhkhvatt=new baseRpt("sosanhkhvatt","sosanhkhvatt","So sánh kế hoạch và thực tế",{onAfterLoadData:function(t,n){var e=[];n.forEach(function(t){if(!t.bold){var n={};n["Nhóm kế hoạch"]=t.group_name,n.Năm=t.nam,n.Tháng=t.thang,n["Kho/cửa hàng"]=t.ten_kho,n["Nhân viên"]=t.ten_nv,n["Bộ phận"]=t.ten_bp,n["Vụ việc/dự án"]=t.ten_dt,n.Phí=t.ten_phi,n["Kế hoạch"]=t.chi_tieu,n["Thực tế"]=t.ps,n["Chênh lệch"]=t.cl,e.push(n)}}),t.data_pivot=e}});rptsosanhkhvatt.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear(),t.tu_thang=n.getMonth()+1,t.den_thang=n.getMonth()+1},rptsosanhkhvatt.module.directive("sosanhkhvattView",function(){return{restrict:"E",templateUrl:"templates/reports/sosanhkhvatt/templates/view.html"}});var kehoachdtcpModule=new baseInput("kehoachdtcp","kehoachdtcp",["ma_dvcs","kieu_ky","ma_phi"],"Kế hoạch doanh thu, chi phí");
kehoachdtcpModule.init=function(){},kehoachdtcpModule.defaultValues={chi_tieu:0,nam:(new Date).getFullYear(),kieu_ky:"tuan",ky:1};var rptsctdtcp=new baseRpt("sctdtcp","sctdtcp","Phân tích dòng tiền theo doanh thu chi phí",{onLoading:function(){}});rptsctdtcp.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth()-1,1),t.den_ngay=new Date(n.getFullYear(),n.getMonth(),0),t.ma_phi="",t.ten_phi="",t.tk="111",t.reportBy="tuan"};var dmgiabanModule=new baseInput("dmgiaban","dmgiaban",["ma_vt","ma_nvt","ma_kh","nh_kh"],"Danh mục giá bán"),dmkhuyenmaiModule=new baseInput("dmkhuyenmai","dmkhuyenmai",["ma_vt","ma_nvt","ma_kh","nh_kh"],"Chính sách khuyến mãi",{modal_size:"md"}),dmchietkhauModule=new baseInput("dmchietkhau","dmchietkhau",["ma_vt","ma_nvt","ma_kh","nh_kh"],"Chính sách chiết khấu"),rptdtbanletheongay=new baseRpt("dtbanletheongay","dtbanletheongay","Doanh thu bán lẻ theo ngày",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){var i=new Date(a.ngay_ct);if(_.isDate(i)){var o="/ctbanle?ma_ct=PBL,SO1&";o=o+"tu_ngay="+e("date")(i,"yyyy-MM-dd"),o=o+"&den_ngay="+e("date")(i,"yyyy-MM-dd"),t.condition.ma_dvcs&&(o=o+"&ma_dvcs="+t.condition.ma_dvcs),t.condition.ma_kho&&(o=o+"&ma_kho="+t.condition.ma_kho),o+="&isDrillDown=true",n.$rootScope.openUrl(o)}}}});rptdtbanletheongay.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptdtbanletheothang=new baseRpt("dtbanletheothang","dtbanletheothang","Doanh thu bán lẻ theo tháng",{onLoading:function(t,n){for(var e=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)e.push(i.toString());t.nams=e;{var o=n.$filter;n.$location}t.drilldown=function(e){var a=Number(e.thang),i=Number(t.condition.nam);if(a>0&&12>=a){var r="/ctbanle?ma_ct=PBL,SO1&";r=r+"tu_ngay="+o("date")(new Date(i,a-1,1),"yyyy-MM-dd"),r=r+"&den_ngay="+o("date")(new Date(i,a,0),"yyyy-MM-dd"),t.condition.ma_dvcs&&(r=r+"&ma_dvcs="+t.condition.ma_dvcs),t.condition.ma_kho&&(r=r+"&ma_kho="+t.condition.ma_kho),r+="&isDrillDown=true",n.$rootScope.openUrl(r)}}}});rptdtbanletheothang.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString()};var rptdtbanletheoquy=new baseRpt("dtbanletheoquy","dtbanletheoquy","Doanh thu bán lẻ theo quý",{onLoading:function(t,n){for(var e=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)e.push(i.toString());t.nams=e;{var o=n.$filter;n.$location}t.drilldown=function(e){var a=Number(e.quy);if(a>0&&5>a){var i=3*a,r=i-2,c=Number(t.condition.nam),d="/ctbanle?ma_ct=PBL,SO1&";d=d+"tu_ngay="+o("date")(new Date(c,r-1,1),"yyyy-MM-dd"),d=d+"&den_ngay="+o("date")(new Date(c,i,0),"yyyy-MM-dd"),t.condition.ma_dvcs&&(d=d+"&ma_dvcs="+t.condition.ma_dvcs),t.condition.ma_kho&&(d=d+"&ma_kho="+t.condition.ma_kho),d+="&isDrillDown=true",n.$rootScope.openUrl(d)}}}});rptdtbanletheoquy.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString()};var rptdtbanletheonam=new baseRpt("dtbanletheonam","dtbanletheonam","Doanh thu bán lẻ theo năm",{onLoading:function(t,n){for(var e=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)e.push(i.toString());t.nams=e;{var o=n.$filter;n.$location}t.drilldown=function(e){var a=Number(e.nam);if(a>=t.condition.tu_nam&&a<=t.condition.den_nam){var i="/ctbanle?ma_ct=PBL,SO1&";i=i+"tu_ngay="+o("date")(new Date(a,0,1),"yyyy-MM-dd"),i=i+"&den_ngay="+o("date")(new Date(a,12,0),"yyyy-MM-dd"),t.condition.ma_dvcs&&(i=i+"&ma_dvcs="+t.condition.ma_dvcs),t.condition.ma_kho&&(i=i+"&ma_kho="+t.condition.ma_kho),i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptdtbanletheonam.defaultCondition=function(t){var n=new Date;t.tu_nam=(n.getFullYear()-1).toString(),t.den_nam=n.getFullYear().toString()};var rptdtbanletheovt=new baseRpt("dtbanletheovt","dtbanletheovt","Doanh thu bán lẻ theo sản phẩm",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_vt){var i="/ctbanle?ma_ct=PBL,SO1&";i=i+"ma_vt="+a.ma_vt,i=i+"&ten_vt="+a.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),t.condition.ma_dvcs&&(i=i+"&ma_dvcs="+t.condition.ma_dvcs),t.condition.ma_kho&&(i=i+"&ma_kho="+t.condition.ma_kho),i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptdtbanletheovt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptdtbanletheokho=new baseRpt("dtbanletheokho","dtbanletheokho","Doanh thu bán lẻ theo kho/cửa hàng",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_kho){var i="/ctbanle?ma_ct=PBL,SO1&";i=i+"ma_kho="+a.ma_kho,i=i+"&ten_kho="+a.ten_kho,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptdtbanletheokho.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptdtbanletheokh=new baseRpt("dtbanletheokh","dtbanletheokh","Doanh thu bán lẻ theo khách hàng",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_kh){var i="/ctbanle?ma_ct=PBL,SO1&ma_kh="+a.ma_kh;i=i+"&ten_kh="+a.ten_kh,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),t.condition.ma_dvcs&&(i=i+"&ma_dvcs="+t.condition.ma_dvcs),t.condition.ma_kho&&(i=i+"&ma_kho="+t.condition.ma_kho),i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptdtbanletheokh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptdtbanletheonv=new baseRpt("dtbanletheonv","dtbanletheonv","Doanh thu bán lẻ theo nhân viên",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.user_created){var i="/ctbanle?ma_ct=PBL,SO1&user_created="+a.user_created;i=i+"&name="+a.name,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),t.condition.ma_dvcs&&(i=i+"&ma_dvcs="+t.condition.ma_dvcs),t.condition.ma_kho&&(i=i+"&ma_kho="+t.condition.ma_kho),i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rptdtbanletheonv.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptctbanle=new baseRpt("ctbanle","ctbanle","Chi tiết bán hàng",{onAfterLoadData:function(t,n){var e=[];n.forEach(function(t){if(!t.bold){var n={};n["Số chứng từ"]=t.so_ct,n["Ngày chứng từ"]=moment(t.ngay_ct).format("DD/MM/YYYY"),n["Mã chứng từ"]=t.ma_ct,n["Diễn giải"]=t.dien_giai,n["Khách hàng"]=t.ten_kh,n["Nhóm khách"]=t.ten_nh_kh,n["Mã kho"]=t.ma_kho,n["Tên kho"]=t.ten_kho,n["Mã sản phẩm"]=t.ma_vt,n["Tên sản phẩm"]=t.ten_vt,n["Nhóm sản phẩm"]=t.ten_nvt,n.Lô=t.ma_lo,n["Hạn sử dụng"]=t.han_sd,n["Thuộc tính 1"]=t.ma_tt1,n["Thuộc tính 2"]=t.ma_tt2,n["Thuộc tính 3"]=t.ma_tt3,n["Bộ phận"]=t.ten_bp,n["Vụ việc"]=t.ten_dt,n["Hợp đồng"]=t.ten_hd,n.Phí=t.ten_phi,n["Nhân viên"]=t.ten_nv,n["SL bán"]=t.sl_xuat,n["Tiền hàng"]=t.tien,n["Tiền chiết khấu"]=t.tien_ck,n["Doanh thu"]=t.doanh_thu,n["SL trả lại"]=t.sl_nhap,n["Tiền trả lại"]=t.tien_tl,e.push(n)}}),t.data_pivot=e}});rptctbanle.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpthangbanbitralai=new baseRpt("hangbanbitralai","hangbanbitralai","Tổng hợp hàng bán bị trả lại",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_vt){var i="/cthangbanbitralai?";i=i+"ma_vt="+a.ma_vt,i=i+"&ten_vt="+a.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rpthangbanbitralai.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptcthangbanbitralai=new baseRpt("cthangbanbitralai","cthangbanbitralai","Chi tiết hàng bán bị trả lại");rptcthangbanbitralai.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpttonghopbanhang=new baseRpt("tonghopbanhang","tonghopbanhang","Tổng hợp bán hàng",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_vt){var i="/ctbanle?";i=i+"ma_vt="+a.ma_vt,i=i+"&ten_vt="+a.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rpttonghopbanhang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptchitietthutientheohoadon=new baseRpt("chitietthutientheohoadon","chitietthutientheohoadon","Chi tiết thu tiền theo hóa đơn",{onLoading:function(t,n){n.$filter,n.$location}});rptchitietthutientheohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptchitietthutientheohoadon.useExcelTemplate=!0;var rptchitietchitientheohoadon=new baseRpt("chitietchitientheohoadon","chitietchitientheohoadon","Chi tiết chi tiền theo hóa đơn",{onLoading:function(t,n){n.$filter,n.$location}});rptchitietchitientheohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptchitietchitientheohoadon.useExcelTemplate=!0;var rpthoadonbanhantheohantt=new baseRpt("hoadonbanhangtheohantt","hoadonbanhangtheohantt","Hóa đơn bán hàng theo hạn thanh toan",{onLoading:function(t,n){n.$filter,n.$location}});rpthoadonbanhantheohantt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rpthoadonbanhantheohantt.useExcelTemplate=!0;var rptphanbothutienchohoadon=new baseRpt("phanbothutienchohoadon","phanbothutienchohoadon","Phân bổ tiền thu cho các hóa đơn",{onLoading:function(t,n){n.$filter,n.$location;t.select=function(e){t.current_pt=e,t.data.forEach(function(t){t.selected=!1}),e.selected=!0,t.invoices=[];var a=server_url+"/api/"+id_app+"/phanbothutienchohoadon/invoices?id_ct="+e._id+"&ma_kh="+e.ma_kh;n.$http.get(a).then(function(n){t.invoices=n.data},function(){n.$rootScope.alert("Không thể lấy hóa đơn của khách hàng này")})},t.tinhthanhtoanqd=function(n){n.thanh_toan_qd=STP.round(n.tien_nt_alloc*t.current_pt.ty_gia/n.ty_gia_hd,2)},t.phanbotudong=function(){var e=0,a=t.current_pt.t_tien_nt;t.invoices.forEach(function(n){n.tien_nt_bk=n.tien_nt,n.con_lai_nt<a?(n.tien_nt_alloc=n.con_lai_nt,n.tien_nt=n.con_lai_nt):(n.tien_nt_alloc=a,n.tien_nt=a),n.tien=n.tien_nt_alloc*t.current_pt.ty_gia,n.thanh_toan_qd=STP.round(n.tien/n.ty_gia_hd,2),e+=n.tien_nt_alloc,a-=n.tien_nt_alloc,n.id_ct=t.current_pt._id,n.ngay_ct=t.current_pt.ngay_ct,n.so_ct=t.current_pt.so_ct,n.ma_ct="PT1",n.ma_nt=t.current_pt.ma_nt,n.ty_gia=t.current_pt.ty_gia,n.status=t.current_pt.status,n.tk_no=t.current_pt.tk_no});var i=server_url+"/api/"+id_app+"/phanbothutienchohoadon/save";n.$http.post(i,t.invoices).then(function(){t.current_pt.da_phan_bo_nt=e,t.current_pt.con_lai_nt=a},function(e){t.invoices.forEach(function(t){t.tien_nt=t.tien_nt_bk}),n.$rootScope.alert("Không thể lưu phân bổ này\n"+e.data)})},t.allocate4invoice=function(e){if(e.tien_nt_alloc>e.con_lai_nt)return void n.$rootScope.alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền còn phải thu");if(e.tien_nt_alloc>t.current_pt.con_lai_nt+e.tien_nt)return void n.$rootScope.alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền chưa phân bổ của phiếu thu hiện tại");e.id_ct=t.current_pt._id,e.ngay_ct=t.current_pt.ngay_ct,e.so_ct=t.current_pt.so_ct,e.ma_ct="PT1",e.ma_nt=t.current_pt.ma_nt,e.ty_gia=t.current_pt.ty_gia,e.status=t.current_pt.status,e.tk_no=t.current_pt.tk_no,e.tien_nt_bk=e.tien_nt,e.tien_nt=e.tien_nt_alloc,e.tien=e.tien_nt_alloc*e.ty_gia;var a=server_url+"/api/"+id_app+"/phanbothutienchohoadon/save";n.$http.post(a,[e]).then(function(){t.current_pt.da_phan_bo_nt=t.current_pt.da_phan_bo_nt+(e.tien_nt-e.tien_nt_bk),t.current_pt.con_lai_nt=t.current_pt.t_tien_nt-t.current_pt.da_phan_bo_nt},function(t){e.tien_nt=e.tien_nt_bk,n.$rootScope.alert("Không thể lưu phân bổ này\n"+t.data)})}},onStartGetData:function(t,n){t.invoices=[],n()}});rptphanbothutienchohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptctmuahang=new baseRpt("ctmuahang","ctmuahang","Chi tiết mua hàng",{onAfterLoadData:function(t,n){var e=[];n.forEach(function(t){if(!t.bold){var n={};n["Số chứng từ"]=t.so_ct,n["Ngày chứng từ"]=moment(t.ngay_ct).format("DD/MM/YYYY"),n["Mã chứng từ"]=t.ma_ct,n["Diễn giải"]=t.dien_giai,n["Nhà cung cấp"]=t.ten_kh,n["Nhóm nhà cung cấp"]=t.ten_nh_kh,n["Mã kho"]=t.ma_kho,n["Tên kho"]=t.ten_kho,n["Mã sản phẩm"]=t.ma_vt,n["Tên sản phẩm"]=t.ten_vt,n["Nhóm sản phẩm"]=t.ten_nvt,n.Lô=t.ma_lo,n["Hạn sử dụng"]=t.han_sd,n["Thuộc tính 1"]=t.ma_tt1,n["Thuộc tính 2"]=t.ma_tt2,n["Thuộc tính 3"]=t.ma_tt3,n["Bộ phận"]=t.ten_bp,n["Vụ việc"]=t.ten_dt,n["Hợp đồng"]=t.ten_hd,n.Phí=t.ten_phi,n["Nhân viên"]=t.ten_nv,n["SL mua"]=t.sl_nhap,n["Tiền hàng"]=t.tien_hang,n["Tiền phí"]=t.tien_phi,n["Tiền chiết khấu"]=t.tien_ck,n["Tiền nhập"]=t.tien_nhap,e.push(n)}}),t.data_pivot=e}});rptctmuahang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpttonghopmuahang=new baseRpt("tonghopmuahang","tonghopmuahang","Tổng hợp mua hàng",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_vt){var i="/ctmuahang?";i=i+"ma_vt="+a.ma_vt,i=i+"&ten_vt="+a.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rpttonghopmuahang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rpttonghoptralaihang=new baseRpt("tonghoptralaihang","tonghoptralaihang","Tổng hợp trả lại nhà cung cấp",{onLoading:function(t,n){{var e=n.$filter;n.$location}t.drilldown=function(a){if(a.ma_vt){var i="/cttralaihang?";i=i+"ma_vt="+a.ma_vt,i=i+"&ten_vt="+a.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",n.$rootScope.openUrl(i)}}}});rpttonghoptralaihang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptcttralaihang=new baseRpt("cttralaihang","cttralaihang","Chi tiết trả lại nhà cung cấp");rptcttralaihang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpthoadonbanhantheohantt=new baseRpt("hoadonmuahangtheohantt","hoadonmuahangtheohantt","Hóa đơn mua hàng theo hạn thanh toan",{onLoading:function(t,n){n.$filter,n.$location}});rpthoadonbanhantheohantt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rpthoadonbanhantheohantt.useExcelTemplate=!0;var rptphanbochitienchohoadon=new baseRpt("phanbochitienchohoadon","phanbochitienchohoadon","Phân bổ tiền chi cho các hóa đơn",{onLoading:function(t,n){n.$filter,n.$location;t.select=function(e){t.current_pt=e,t.data.forEach(function(t){t.selected=!1}),e.selected=!0,t.invoices=[];var a=server_url+"/api/"+id_app+"/phanbochitienchohoadon/invoices?id_ct="+e._id+"&ma_kh="+e.ma_kh;n.$http.get(a).then(function(n){t.invoices=n.data},function(){n.$rootScope.alert("Không thể lấy hóa đơn của khách hàng này")})},t.tinhthanhtoanqd=function(n){n.thanh_toan_qd=STP.round(n.tien_nt_alloc*t.current_pt.ty_gia/n.ty_gia_hd,2)},t.phanbotudong=function(){var e=0,a=t.current_pt.t_tien_nt;t.invoices.forEach(function(n){n.tien_nt_bk=n.tien_nt,n.con_lai_nt<a?(n.tien_nt_alloc=n.con_lai_nt,n.tien_nt=n.con_lai_nt):(n.tien_nt_alloc=a,n.tien_nt=a),n.tien=n.tien_nt_alloc*t.current_pt.ty_gia,n.thanh_toan_qd=STP.round(n.tien/n.ty_gia_hd,2),e+=n.tien_nt_alloc,a-=n.tien_nt_alloc,n.id_ct=t.current_pt._id,n.ngay_ct=t.current_pt.ngay_ct,n.so_ct=t.current_pt.so_ct,n.ma_ct="PC1",n.ma_nt=t.current_pt.ma_nt,n.ty_gia=t.current_pt.ty_gia,n.status=t.current_pt.status,n.tk_co=t.current_pt.tk_co});var i=server_url+"/api/"+id_app+"/phanbochitienchohoadon/save";n.$http.post(i,t.invoices).then(function(){t.current_pt.da_phan_bo_nt=e,t.current_pt.con_lai_nt=a},function(e){t.invoices.forEach(function(t){t.tien_nt=t.tien_nt_bk}),n.$rootScope.alert("Không thể lưu phân bổ này\n"+e.data)})},t.allocate4invoice=function(e){if(e.tien_nt_alloc>e.con_lai_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền còn phải chi");if(e.tien_nt_alloc>t.current_pt.con_lai_nt+e.tien_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền chưa phân bổ của phiếu chi hiện tại");e.id_ct=t.current_pt._id,e.ngay_ct=t.current_pt.ngay_ct,e.so_ct=t.current_pt.so_ct,e.ma_ct="PC1",e.ma_nt=t.current_pt.ma_nt,e.ty_gia=t.current_pt.ty_gia,e.status=t.current_pt.status,e.tk_co=t.current_pt.tk_co,e.tien_nt_bk=e.tien_nt,e.tien_nt=e.tien_nt_alloc,e.tien=e.tien_nt_alloc*e.ty_gia;var a=server_url+"/api/"+id_app+"/phanbochitienchohoadon/save";n.$http.post(a,[e]).then(function(){t.current_pt.da_phan_bo_nt=t.current_pt.da_phan_bo_nt+(e.tien_nt-e.tien_nt_bk),t.current_pt.con_lai_nt=t.current_pt.t_tien_nt-t.current_pt.da_phan_bo_nt},function(t){e.tien_nt=e.tien_nt_bk,n.$rootScope.alert("Không thể lưu phân bổ này\n"+t.data)})}},onStartGetData:function(t,n){t.invoices=[],n()}});rptphanbochitienchohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptbkshipbook=new baseRpt("bkshipbook","bkshipbook","Bảng kê chi phí cước tàu");rptbkshipbook.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptbkvanchuyen=new baseRpt("bkvanchuyen","bkvanchuyen","Bảng kê chi phí cước tàu");rptbkvanchuyen.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var dmbpModule=new baseInput("dmbp","dmbp",["ma_bp","ten_bp"],"Danh mục bộ phận",{has_view:!0,onLoading:function(t){var n,e=function(t,a){var i=_.filter(t,function(t){return t.exfields&&t.exfields.ma_bp==a.ma_bp});i.forEach(function(i){n=n+"\n"+a.ma_bp+"-->"+i.ma_bp+"("+i.ten_bp+")",e(t,i)})};t.callback=function(t){alert(t)};var a=function(t){var a=document.querySelector("#graphDiv");if(a){n="graph TD";var i=_.filter(t,function(t){return!t.exfields||!t.exfields.ma_bp});for(i.forEach(function(a){n=n+"\n"+a.ma_bp+"("+a.ten_bp+")",n=n+"\nstyle "+a.ma_bp+" fill:#9f6",e(t,a)}),t.forEach(function(t){n=n+"\nclick "+t.ma_bp+' "#!/dmbp/view/'+t._id+'"'});a.firstChild;)a.removeChild(a.firstChild);var o=document.createElement("div");o.className="mermaid",o.appendChild(document.createTextNode(n)),a.appendChild(o),mermaid.init()}};t.$watch("list",function(t,n){t&&!_.isEqual(t,n)&&a(t)},!0)}}),dmdtModule=new baseInput("dmdt","dmdt",["ma_dt","ten_dt"],"Vụ việc, dự án, công trình",{has_view:!0,modal_size:"md",onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.progress=0},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){STPModules.group.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{group_type:"PROJECT"}}).then(function(n){t.groups=n.data,t.groups.push({group_name:"Khác"}),t.groups.forEach(function(t){t.sel=!0})}),STPModules.label.obj.getService(n.$http,n.$q,n.$rootScope).load(id_app,{filter:{label_type:"PROJECT"}}).then(function(n){t.contactLabels=n.data,t.contactLabels.push({label_name:null}),t.contactLabels.forEach(function(t){t.sel=!0})}),t.members=[],_.extend(t.members,n.$rootScope.members),t.members.push({name:"Khác"}),t.members.forEach(function(t){t.sel=!0})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.searchAVR=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[];if(t.progresses.forEach(function(t){t.sel&&n.push(t.value)}),t.filter.progress={$in:n},delete t.filter.labels,t.contactLabels&&t.contactLabels.length>0){var e=t.contactLabels.filter(function(t){return t.sel});e.length<t.contactLabels.length&&(t.filter.labels={$in:_.pluck(e,"label_name")})}if(delete t.filter.phu_trach,t.members&&t.members.length>0){var a=t.members.filter(function(t){return t.sel});a.length<t.members.length&&(t.filter.phu_trach={$in:_.pluck(a,"email")})}if(delete t.filter.nh_dt,t.groups&&t.groups.length>0){var i=t.groups.filter(function(t){return t.sel});i.length<t.groups.length&&(t.filter.nh_dt={$in:_.pluck(i,"_id")})}var o,r,c=new Date,d=t.time;if("d"==d&&(o=new Date,r=new Date),"w"==d)var l=c.getDate()-c.getDay()+1,o=new Date(c.setDate(l)),r=new Date(c.setDate(o.getDate()+6));if("m"==d&&(o=c,o.setDate(1),r=new Date(o.getFullYear(),o.getMonth()+1,0)),"3m"==d){var u=c.getMonth(),s=1;s=3>u?0:6>u?3:6>u?6:9,o=new Date(c.getFullYear(),s,1),r=new Date(c.getFullYear(),s+3,0)}"y"==d&&(o=new Date(c.getFullYear(),0,1),r=new Date(c.getFullYear(),11,31)),o&&r?(o.setHours(0),o.setMinutes(0),o.setSeconds(0),r.setHours(23),r.setMinutes(59),r.setSeconds(0),t.filter.date_created={$gte:o,$lte:r}):delete t.filter.date_created,t.advCondition.ten_dt?t.filter.$or=[{ten_dt:{$regex:t.advCondition.ten_dt,$options:"i"}},{ma_dt:{$regex:t.advCondition.ten_dt,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_dt,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),console.log(t.filter),t.search()}},t.reportByTime=function(n){t.time=n,t.searchAVR()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVR()},t.searchGroup=function(n){t.nh_dt=n._id,t.searchAVR()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVR()},!0),t.changeProgress=function(t,e){var a={};_.extend(a,t),a.progress=e,n.service.update(id_app,a._id,a).then(function(n){_.extend(t,n.data)},function(t){t.data&&n.$rootScope.alert(t.data)})},t.enter=function(n){13==n.keyCode&&t.searchAVR()}},onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$uibModal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(n.$uibModal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).then(function(n){_.extend(t.data,n.data)}))})}}});dmdtModule.module.directive("dmdt",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/dmdt/templates/directive.html",controller:["$scope","$shttp","$window","$location","$uibModal","appInfo","$rootScope","dmdt",function($scope,$http,$window,$location,$uibModal,appInfo,$rootScope,dmdt){appInfo.info("dmdt",function(e,u,appinfo){if(!e){$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="dmdt:'ten_dt'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).then(function(t){$scope.list=t.data},function(t){t.data&&_online&&$rootScope.alert(t.data)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n,{cache:!0}).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).then(function(n){_.extend(e,n.data),e.obj=t,e.title=t.title,$scope.list.push(e)},function(t){t.data&&$rootScope.alert(t.data)})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})},$scope.getItem=function(t){$scope.addLink(t)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),dmdtModule.quickadd($uibModal,function(t){t.collection_name="dmdt",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="dmdt/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$rootScope.confirm("Bạn có chắc chắn xóa không?").then(function(n){1===n&&dmdt.delete(id_app,t._id).then(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})})},$scope.edit=function(t){dmdtModule.quickedit($uibModal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("dmdt directive require attributes:link,collection")}}});var dmloaitsModule=new baseInput("dmloaits","dmloaits",["ma_loai_ts","ten_loai_ts"],"Danh mục loại tài sản"),dmtanggiamtsModule=new baseInput("dmtanggiamts","dmtanggiamts",["ma_tang_giam_ts","ten_tang_giam_ts"],"Danh mục tăng giảm tài sản");dmtanggiamtsModule.defaultValues={kieu:"1"};var dmnguonvonModule=new baseInput("dmnguonvon","dmnguonvon",["ma_nguon_von","ten_nguon_von"],"Danh mục nguồn vốn"),qtsModule=new baseVoucher("qts","qts",["so_the_ts","ten_ts"],"Khai báo tài sản cố định");qtsModule.defaultValues={so_ky_kh:0,lam_tron_kh:0,ngay_tang:new Date,pp_tinh_kh:"1",ma_gd:"1"},qtsModule.defaultValues4Detail={nguyen_gia:0,gia_tri_da_kh:0,gia_tri_con_lai:0,gia_tri_kh_ky:0,tinh_kh_gia_tri_con_lai:!0},qtsModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",ten_ts:"",so_the_ts:""},qtsModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},so_the_ts:{$regex:t.vcondition.so_the_ts,$options:"i"},ten_ts:{$regex:t.vcondition.ten_ts,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},qtsModule.watchDetail=function(t){t.$watch("dt_current.nguyen_gia",function(n,e){n&&n!=e&&(t.dt_current.gia_tri_con_lai=t.dt_current.nguyen_gia-t.dt_current.gia_tri_da_kh,t.ngMasterData.tinh_kh_gia_tri_con_lai||(t.dt_current.gia_tri_kh_ky=STP.round(t.dt_current.nguyen_gia/t.ngMasterData.so_ky_kh,0)))}),t.$watch("dt_current.gia_tri_da_kh",function(n,e){n&&n!=e&&(t.dt_current.gia_tri_con_lai=t.dt_current.nguyen_gia-t.dt_current.gia_tri_da_kh)}),t.$watch("dt_current.gia_tri_con_lai",function(n,e){n&&n!=e&&0!=t.ngMasterData.so_ky_kh&&t.ngMasterData.tinh_kh_gia_tri_con_lai&&(t.dt_current.gia_tri_kh_ky=STP.round(t.dt_current.gia_tri_con_lai/t.ngMasterData.so_ky_kh,0))})},qtsModule.watchMaster=function(t){t.$watch("data.tinh_kh_gia_tri_con_lai",function(n){t.data.details.forEach(n?function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=STP.round(n.gia_tri_con_lai/t.data.so_ky_kh,0))}:function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=STP.round(n.nguyen_gia/t.data.so_ky_kh,0))})}),t.$watch("data.so_ky_kh",function(n){n&&t.data.details.forEach(t.data.tinh_kh_gia_tri_con_lai?function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=STP.round(n.gia_tri_con_lai/t.data.so_ky_kh,0))}:function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=STP.round(n.nguyen_gia/t.data.so_ky_kh,0))})})};var calc_qtsdieuchinh=function(t){t.$watch("data.nguyen_gia",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_con_lai=t.data.nguyen_gia-t.data.gia_tri_da_kh)}),t.$watch("data.gia_tri_da_kh",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_con_lai=t.data.nguyen_gia-t.data.gia_tri_da_kh)}),t.$watch("data.gia_tri_con_lai",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_kh_ky=0!=t.data.so_ky_kh?STP.round(t.data.gia_tri_con_lai/t.data.so_ky_kh,0):0)}),t.$watch("data.so_ky_kh",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_kh_ky=0!=t.data.so_ky_kh?STP.round(t.data.gia_tri_con_lai/t.data.so_ky_kh,0):0)})},qtsdieuchinhModule=new baseInput("qtsdieuchinh","qtsdieuchinh",["so_the_ts","so_ct"],"Điều chỉnh giá trị tài sản",{onAdd:function(t){calc_qtsdieuchinh(t)},onEdit:function(t){calc_qtsdieuchinh(t)}});qtsdieuchinhModule.defaultValues={so_ky_kh:0,ky:(new Date).getMonth()+1,nam:(new Date).getFullYear(),ngay_ct:new Date,ngay_ct:new Date,nguyen_gia:0,gia_tri_da_kh:0,gia_tri_con_lai:0,gia_tri_kh_ky:0};var rpttinhkhauhaots=new baseRpt("tinhkhauhaots","tinhkhauhaots","Tính khấu hao tài sản");rpttinhkhauhaots.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString())},rpttinhkhauhaots.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.thang=(n.getMonth()+1).toString(),t.tinh_kh_theo_ngay=!0};var hspbtsModule=new baseInput("hspbts","hspbts",["so_the_ts","ma_bp"],"Khai báo hệ số phân bổ tài sản");hspbtsModule.loading=function(t){var n=(new Date).getFullYear();t.nams=[];for(var e=n-10;n+10>e;e++)t.nams.push(e);t.condition={nam:n,thang:(new Date).getMonth()+1}},hspbtsModule.defaultValues={he_so:0,thang:(new Date).getMonth()+1,nam:(new Date).getFullYear()},hspbtsModule.init=function(t){t.thangs=[1,2,3,4,5,6,7,8,9,10,11,12],t.nams=[];for(var n=new Date,e=n.getFullYear()-10;e<n.getFullYear()+10;e++)t.nams.push(e)};var dckhauhaotsModule=new baseInput("dckhauhaots","dckhauhaots",["so_the_ts"],"Điều chỉnh khấu hao tài sản");dckhauhaotsModule.loading=function(t){var n=(new Date).getFullYear();t.nams=[];for(var e=n-10;n+10>e;e++)t.nams.push(e);t.condition={nam:n,thang:(new Date).getMonth()+1}};var pkhModule=new baseVoucher("pkh","pkh",[],"Phiếu khấu hao tài sản");pkhModule.defaultValues={},pkhModule.defaultValues4Detail={tien_nt:0,tien:0},pkhModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pkhModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pkhModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=STP.round(n*t.ngMasterData.ty_gia,0))}),t.createBT=function(){_.isDate(t.ngMasterData.ngay_ct)||(t.ngMasterData.ngay_ct=new Date(t.ngMasterData.ngay_ct)),t.ngMasterData.details=[];var n=server_url+"/api/"+id_app+"/getkhauhao?id_ct="+t.ngMasterData._id;n+="&thang="+t.ngMasterData.ngay_ct.getMonth().toString(),n+="&nam="+t.ngMasterData.ngay_ct.getFullYear().toString(),t.ngMasterData.kc_dvcs&&(n=n+"&ma_dvcs="+t.ngMasterData.ma_dvcs),t.$http.get(n).then(function(n){t.messageError=void 0,t.ngMasterData.details=n.data},function(n){t.alertType="alert alert-danger",t.messageError=n.data})}},pkhModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(e){e.tien=STP.round(e.tien_nt*n,t.f_tien)})})};var rptbangtinhkhauhao=new baseRpt("bangtinhkhauhao","bangtinhkhauhao","Bảng tính khấu hao");rptbangtinhkhauhao.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptbangtinhkhauhao.defaultCondition=function(t){var n=new Date;
t.nam=n.getFullYear().toString(),t.thang=(n.getMonth()+1).toString(),t.ma_gd="1"};var rptsotaisan=new baseRpt("sotaisan","sotaisan","Sổ tài sản");rptsotaisan.init=function(t){t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptsotaisan.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.ma_gd="1"};var rptchitiettaisan=new baseRpt("chitiettaisan","chitiettaisan","Sổ Chi tiết tài sản");rptchitiettaisan.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptchitiettaisan.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.ma_gd="1",t.thang=n.getMonth()+1};var congdoansxModule=new baseInput("congdoansx","congdoansx",["ma_cong_doan","ten_cong_doan"],"Danh mục công đoạn sản xuất",{has_view:!1}),dinhmucsxModule=new baseVoucher("dinhmucsx","dinhmucsx",[],"Định mức sản xuất",{});dinhmucsxModule.defaultValues={loai_dinh_muc:3,trang_thai:"0"},dinhmucsxModule.defaultValues4Detail={sl_xuat:0,loai_dinh_muc:1,ty_le_hao_hut:0},dinhmucsxModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",ma_sp:"",dien_giai:""},dinhmucsxModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},ma_sp:{$regex:t.vcondition.ma_sp,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}};var lenhsxModule=new baseVoucher("lenhsx","lenhsx",[],"Lệnh sản xuất",{});lenhsxModule.defaultValues={trang_thai:"0"},lenhsxModule.defaultValues4Detail={sl_sx:0},lenhsxModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},lenhsxModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}};var kehoachmhModule=new baseVoucher("kehoachmh","kehoachmh",[],"Kế hoạch mua hàng",{onLoading:function(t,n){t.createContract=function(t){var e=JSON.parse(JSON.stringify(t));e.id_kehoachmh=e._id,e.details.forEach(function(t){t.so_luong=t.sl_ke_hoach-t.sl_contract}),delete e._id,delete e.so_ct,delete e.trang_thai,delete e.ngay_ct,purchase_contractModule.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)},t.createDnm=function(t){var e=JSON.parse(JSON.stringify(t));e.id_kehoachmh=e._id,e.details.forEach(function(t){t.so_luong=t.sl_ke_hoach-t.sl_dnm}),delete e._id,delete e.so_ct,delete e.trang_thai,delete e.ngay_ct,dnmModule.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onInput:function(t,n){t.tinhKeHoach=function(){var e=server_url_report+"/api/"+id_app+"/uoctinhnvl?tu_ngay="+moment(t.data.kh_tu_ngay).format("YYYY-MM-DD")+"&den_ngay="+moment(t.data.kh_den_ngay).format("YYYY-MM-DD");n.$http.get(e).then(function(e){t.data.details=e.data,n.$rootScope.toast("Chương trình đã thự hiện xong")},function(t){n.$rootScope.alert(t.data||"Không thể kết nối được với máy chủ")})}},onSave:function(t,n,e,a){console.log(n),a(null,n)}});kehoachmhModule.defaultValues={loai_ke_hoach:1},kehoachmhModule.defaultValues4Detail={sl_nhu_cau:0,sl_da_cap_phat:0,sl_ke_hoach:0,sl_da_nhap:0,sl_contract:0},kehoachmhModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},kehoachmhModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}};var lenhcapphatModule=new baseVoucher("lenhcapphat","lenhcapphat",[],"Lệnh cấp phát vật tư",{onLoading:function(t,n){t.createPXK=function(t){var e=JSON.parse(JSON.stringify(t));e.id_lenhcapphat=e._id,e.details.forEach(function(t){t.sl_xuat=t.so_luong-t.sl_da_xuat,t.gia_von_nt=t.gia_nt||0,t.gia_von=t.gia||0,t.tien_xuat_nt=STP.round((t.tien_nt||0)*t.sl_xuat,0),t.tien_xuat=t.tien_xuat_nt}),delete e._id,delete e.so_ct,delete e.trang_thai,delete e.ngay_ct,pxkModule.quickadd(n.$uibModal,function(){n.service.get(id_app,t._id).then(function(n){_.extend(t,n.data)})},e)}},onInput:function(t,n){t.tinh=function(){n.$rootScope.alert("Chương trình đã thực hiện xong")}},onSave:function(t,n,e,a){var i=0;for(i=0;i<t.data.details.length;i++)if(t.data.details[i].ton_kho<t.data.details[i].so_luong)return a("Vật tư "+t.data.details[i].ten_vt+" không đủ để thực hiện lệnh cấp phát");a(null,t.data)}});lenhcapphatModule.defaultValues={},lenhcapphatModule.defaultValues4Detail={so_luong:0},lenhcapphatModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},lenhcapphatModule.watchDetail=function(t){t.getInvoice=function(){t.$uibModal.open({templateUrl:"templates/vouchers/lenhcapphat/templates/form-select-invoice.html",controller:["$scope","$uibModalInstance","parentScope","$filter","$rootScope","$http",function(t,n,e,a,i,o){t.STP=STP,t.condition={tu_ngay:new Date(moment().format("YYYY-MM-01")),den_ngay:new Date},t.ngData=e.ngData,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.condition.id_contract=t.ngMasterData.id_contract,t.condition.so_ct_contract=t.ngMasterData.so_ct_contract,t.condition.id_lenhsx=t.ngMasterData.id_lenhsx,t.condition.so_ct_lenhsx=t.ngMasterData.so_ct_lenhsx,t.masters=[],t.details=[],t.selectAllDetail=function(t){t.details.forEach(function(n){n.sel=t.sel})},t.invoiceClick=function(n){t.details=[];var e=_.find(t.masters,function(t){return t._id==n});t.details=e.details},t.loadInvoice=function(){t.masters=[],t.details=[];var n=server_url_report+"/api/"+id_app+"/getkehoachmh4lenhcp?t=1";t.condition.id_lenhsx&&(n=n+"&id_lenhsx="+t.condition.id_lenhsx),t.ngMasterData._id&&(n=n+"&id_ct="+t.ngMasterData._id),n=n+"&tu_ngay="+a("date")(t.condition.tu_ngay,"yyyy-MM-dd"),n=n+"&den_ngay="+a("date")(t.condition.den_ngay,"yyyy-MM-dd"),t.condition.so_ct&&(n=n+"&so_ct="+t.condition.so_ct),e.ngMasterData.ma_kho&&(n=n+"&ma_kho="+e.ngMasterData.ma_kho),t.condition.id_contract&&(n=n+"&id_contract="+t.condition.id_contract),o.get(n).then(function(n){t.masters=n.data},function(n){t.masters=[],n.data&&i.alert(n.data)})},t.ok=function(){t.condition.id_lenhsx&&(e.ngMasterData.id_lenhsx=t.condition.id_lenhsx,e.ngMasterData.so_ct_lenhsx=t.condition.so_ct_lenhsx),t.condition.id_contract&&(e.ngMasterData.id_contract=t.condition.id_contract,e.ngMasterData.so_ct_contract=t.condition.so_ct_contract),e.ngMasterData.details=[];var a=0;t.masters.forEach(function(t){t.sel&&t.details.forEach(function(t){t.sel&&(t.line=a,e.tinhCkvt(t),e.ngMasterData.details.push(t),a++)})}),n.close()},t.cancel=function(){n.close()}}],size:"lg",resolve:{parentScope:function(){return t}}})}},lenhcapphatModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}};var dmytModule=new baseInput("dmyt","dmyt",["ma_yt","ten_yt","tk_no","tk_co"],"Danh mục yếu tố chi phí");dmytModule.defaultValues={cong_tru:"1",pt_tinh_hs_pb:"1",pt_phan_bo:"1"};var ytdd_dkModule=new baseInput("ytdd_dk","ytdd_dk",["ma_yt","ma_sp","ma_dvcs","ma_bp","ma_lsx","ma_nvl"],"Giá trị dở dang đầu kỳ theo yếu tố");ytdd_dkModule.defaultValues={tien_nt:0,tien:0,thang:(new Date).getMonth()+1,nam:(new Date).getFullYear()};var ytdd_ckModule=new baseInput("ytdd_ck","ytdd_ck",["ma_yt","ma_sp","ma_dvcs","ma_bp","ma_lsx","ma_nvl"],"Giá trị dở dang cuối kỳ theo yếu tố");ytdd_ckModule.defaultValues={tien_nt:0,tien:0,thang:(new Date).getMonth()+1,nam:(new Date).getFullYear()};var spdd_dkModule=new baseInput("spdd_dk","spdd_dk",["ma_sp","ma_dvcs","ma_bp","ma_lsx"],"Số lượng sản phẩm dở dang đầu kỳ");spdd_dkModule.defaultValues={sl_dd:0,ty_le_ht:100,sl_ht_qd:0,thang:(new Date).getMonth()+1,nam:(new Date).getFullYear()},spdd_dkModule.init=function(t){t.$watch("data.sl_dd",function(){t.isDataLoaded&&(t.data.sl_ht_qd=t.data.sl_dd*t.data.ty_le_ht/100)}),t.$watch("data.ty_le_ht",function(){t.isDataLoaded&&(t.data.sl_ht_qd=t.data.sl_dd*t.data.ty_le_ht/100)})};var spdd_ckModule=new baseInput("spdd_ck","spdd_ck",["ma_sp","ma_dvcs","ma_bp","ma_lsx"],"Số lượng sản phẩm dở dang cuối kỳ");spdd_ckModule.defaultValues={sl_dd:0,ty_le_ht:100,sl_ht_qd:0,thang:(new Date).getMonth()+1,nam:(new Date).getFullYear()},spdd_ckModule.init=function(t){t.$watch("data.sl_dd",function(){t.isDataLoaded&&(t.data.sl_ht_qd=t.data.sl_dd*t.data.ty_le_ht/100)}),t.$watch("data.ty_le_ht",function(){t.isDataLoaded&&(t.data.sl_ht_qd=t.data.sl_dd*t.data.ty_le_ht/100)})};var rpttinhgiathanh=new baseRpt("tinhgiathanh","tinhgiathanh","Tính giá thành sản xuất");rpttinhgiathanh.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString())},rpttinhgiathanh.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.thang=(n.getMonth()+1).toString()};var rptthgt=new baseRpt("thgt","thgt","Tổng hợp giá thành");rptthgt.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString())},rptthgt.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.thang=(n.getMonth()+1).toString()};var ckgtluongModule=new baseInput("ckgtluong","ckgtluong",["ten_giam_tru"],"Giảm trừ theo lương",{cache_data:!1}),dmloaicongModule=new baseInput("dmloaicong","dmloaicong",["ma_loai_cong","ten_loai_cong"],"Danh mục loại công"),chamcongModule=new baseInput("chamcong","chamcong",["ma_nv","ma_loai_cong"],"Chấm công",{onLoading:function(t,n){n.$controller("initChamcong",{$scope:t})}});chamcongModule.module.controller("initChamcong",["$scope","$localStorage","$compile","$timeout","uiCalendarConfig","$uibModal","chamcong","$rootScope",function(t,n,e,a,i,o,r,c){var d=function(t){var n={title:t.ten_loai_cong?t.ten_loai_cong:t.exfields.ten_loai_cong,draggable:!0,resizable:!0,item:t},e=t.ngay,a=t.ngay;return n.start=new Date(e),n.end=new Date(a),n.allDay=n.start.getTime()==n.end.getTime(),n.start.getTime()===n.end.getTime()&&n.end.setHours(n.end.getHours()+1),n.className=t.color?"bg-"+t.color:"",n};t.events=[],t.zevents=[],t.eventsF=function(n,e,a,i){t.loadding=!0;var o={ngay:{$gte:n,$lte:e}};if(t.ma_nv){o.ma_nv=t.ma_nv;var l=r.load2(id_app,{condition:o});l.promise.then(function(n){var e=[];t.loadding=!1;var a=n.data;a.forEach(function(t){e.push(d(t))}),i(e)},function(n){t.loadding=!1,i([]);var e=n.data;c.alert(e?e.message:"Không kết nối được với máy chủ")})}},t.eventClick=function(e){chamcongModule.quickedit(o,e.item._id,function(e){t.zevents.push({}),e.exfields&&e.exfields.is_default_cong&&n.set("default_cong"+id_app,e.ma_loai_cong)},function(n){console.log("deleted",n),t.zevents.push({})})},t.renderCalendar=function(t){a(function(){i.calendars[t]&&i.calendars[t].fullCalendar("render")})},t.eventRender=function(n,a){e(a)(t)};var l=new Date;t.dayClick=function(e){if(!t.ma_nv)return c.alert("Chọn một nhân viên trước khi chấm công");var a=e.toISOString();a+=10===a.length?"T08:00:00+07:00":"+07:00";var i=new Date(a);if(t.default_cong=n.get("default_cong"+id_app),t.default_cong){var _={ngay:i,ma_nv:t.ma_nv,ma_loai_cong:t.default_cong};r.create(id_app,_).then(function(n){var e=d(n.data);l=e.date,t.uiConfig.calendar.defaultDate=l,t.zevents.push(e)},function(t){c.alert(t.data?t.data:"Không thể kết nối được với máy chủ")})}else chamcongModule.quickadd(o,function(e){var a=d(e);l=a.date,t.uiConfig.calendar.defaultDate=l,t.zevents.push(a),e.exfields&&e.exfields.is_default_cong&&n.set("default_cong"+id_app,e.ma_loai_cong)},{ngay:i,ma_nv:t.ma_nv})},t.uiConfig={calendar:{height:"auto",editable:!0,locale:"vi",header:{right:"prev,next"},defaultDate:l,ignoreTimezone:!0,eventClick:t.eventClick,eventDrop:t.alertOnDrop,eventResize:t.alertOnResize,eventRender:t.eventRender,dayClick:t.dayClick}},t.eventSources=[t.eventsF],t.chonNhanVien=function(n){t.ma_nv=n.ma_nv,t.zevents.push({})}}]);var rptkqchamcong=new baseRpt("kqchamcong","kqchamcong","Kết quả chấm công");rptkqchamcong.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var dmchucvuModule=new baseInput("dmchucvu","dmchucvu",["group_name","group_type"],"Chức vụ",{cache_data:!1,createState:!0,menu:"lists",mOrder:9}),usergroupModule=new baseInput("usergroup","usergroup",["group_name"],"Nhóm người dùng",{cache_data:!1,createState:!0,menu:"system"}),ent_rptthnxt=new baseRptLink("entthnxt","rstocksummary/1","ENT - Tổng hợp nhập xuất tồn",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_vt&&""!==n.ma_vt.trim()){var i="/entsctvt?cSite="+t.condition.ma_kho.trim();i=i+"&cItem="+n.ma_vt.trim(),i=i+"&dFrom="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&dTo="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i+="&isDrillDown=true",a.url(i)}}}});ent_rptthnxt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.ma_kho="",t.ma_vt="",t.inctdc=1,t.toncuoibangkhong=0,t.cOrder="ma_vt"};var ent_rptsctvt=new baseRptLink("entsctvt","sochitietvattu/1","ENT - Sổ chi tiết vật tư");ent_rptsctvt.defaultCondition=function(t){var n=new Date;t.dFrom=new Date(n.getFullYear(),n.getMonth(),1),t.dTo=n,t.cLan="V",t.cOrder="Ngay_ct,nxt"},ent_rptsctvt.afterLoadData=function(t){t.title="ENT - Sổ chi tiết vật tư: "+t.condition.cItem,t.condition.cSite&&(t.title=t.title+" - "+t.condition.cSite)};var entrptScttk=new baseRptLink("entscttk","rsochitiet/1","ENT-Sổ chi tiết tài khoản");entrptScttk.defaultCondition=function(t){var n=new Date;t.dFrom=new Date(n.getFullYear(),n.getMonth(),1),t.dTo=n,t.cAcct="",t.cLan="Vi"},entrptScttk.afterLoadData=function(t){t.title="ENT-Sổ chi tiết tài khoản: "+t.condition.cAcct};var entrptsctcnkh=new baseRptLink("entsctcnkh","rSoCtCnKh/1","ENT-Sổ chi tiết công nợ khách hàng");entrptsctcnkh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="131",t.ma_kh="",t.ngon_ngu="vi",t.isDetail=0},entrptsctcnkh.afterLoadData=function(t){t.title="ENT-Sổ chi tiết công nợ khách hàng: "+t.condition.ma_kh};var entrptCdpstk=new baseRptLink("entcdpstk","rcandoipstk_200/1","ENT-Cân đối phát sinh tài khoản",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.Tk&&""!=n.Tk){var i="/entscttk?cAcct="+n.Tk.trim();i=i+"&ten_tk="+n.Ten_tk.trim(),i=i+"&dFrom="+e("date")(t.condition.dFrom,"yyyy-MM-dd"),i=i+"&dTo="+e("date")(t.condition.dTo,"yyyy-MM-dd"),i+="&isDrillDown=true",a.url(i)}}}});entrptCdpstk.defaultCondition=function(t){var n=new Date;t.dFrom=new Date(n.getFullYear(),n.getMonth(),1),t.dTo=n,t.cAcct="",t.nMax=99,t.bu_tru=!1,t.chi_xem_tk_ct=0,t.nGlAcct=0};var entrptcdpskh=new baseRptLink("entcdpskh","rbacdpscnkh/1","ENT-Cân đối phát sinh theo khách hàng",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_kh){var i="/entsctcnkh?tk="+t.condition.tk.trim();i=i+"&ma_kh="+n.ma_kh.trim(),i=i+"&ten_kh="+n.ten_kh.trim(),i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i+="&isDrillDown=true",a.url(i)}}}});entrptcdpskh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="131",t.ma_kh="",t.ngon_ngu="Vi"};var entbclailotheokh=new baseRptLink("entbclailotheokh","rbcbhtheodoanhso/1","ENT-Báo cáo bán hàng theo số lượng, doanh số và lợi nhuận",{onLoading:function(t,n){n.$filter,n.$location;t.series=["Lợi nhuận","Doanh thu","Số lượng"]},onAfterLoadData:function(t){var n=_.filter(t.data,function(t){return t.bold!==!0});t.labels=_.pluck(n,"dien_giai"),t.so_luong=_.pluck(n,"so_luong"),t.pt=_.pluck(n,"pt"),t.lai=_.pluck(n,"lai"),$("#container-chart").highcharts({title:{text:""},xAxis:{categories:t.labels},yAxis:[{min:0,title:{text:"VND"},labels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},{title:{text:"Số lượng",style:{color:Highcharts.getOptions().colors[0]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[0]}},opposite:!0}],legend:{align:"right",x:-30,verticalAlign:"top",y:25,floating:!0,backgroundColor:Highcharts.theme&&Highcharts.theme.background2||"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{headerFormat:"<b>{point.x}</b><br/>",pointFormat:"{series.name}: {point.y}"},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}}}},series:[{name:"Lợi nhuận",data:t.lai,type:"column",yAxis:0},{name:"Doanh thu",data:t.pt,type:"column",yAxis:0},{name:"Số lượng",data:t.so_luong,type:"line",yAxis:1}]})}});entbclailotheokh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk_vt="",t.tk_du="",t.ma_vt="",t.ma_kh="",t.ma_ncc="",t.ma_kho="",t.ma_dt="",t.nvbh="",t.tinh_dc=1,t.dvcs="",t.bctheo="ma_kh",t.nhomtheo="",t.rptid="rbcbhtheodoanhso",t.nxt="2",t.ma_ct="HD2,PBL",t.top=10,t.ma_phi=""};var entbclailotheonv=new baseRptLink("entbclailotheonv","rbcbhtheodoanhso/1","ENT-Báo cáo bán hàng theo số lượng và doanh số",{onLoading:function(t,n){n.$filter,n.$location;t.series=["Doanh thu","Số lượng"]},onAfterLoadData:function(t){var n=_.filter(t.data,function(t){return t.bold!==!0});t.labels=_.pluck(n,"dien_giai"),t.so_luong=_.pluck(n,"so_luong"),t.pt=_.pluck(n,"pt"),t.lai=_.pluck(n,"lai"),$("#container-chart").highcharts({title:{text:""},xAxis:{categories:t.labels},yAxis:[{min:0,title:{text:"VND"},labels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},{title:{text:"Số lượng",style:{color:Highcharts.getOptions().colors[0]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[0]}},opposite:!0}],legend:{align:"right",x:-30,verticalAlign:"top",y:25,floating:!0,backgroundColor:Highcharts.theme&&Highcharts.theme.background2||"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{headerFormat:"<b>{point.x}</b><br/>",pointFormat:"{series.name}: {point.y}"},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}}}},series:[{name:"Doanh thu",data:t.pt,type:"column",yAxis:0},{name:"Số lượng",data:t.so_luong,type:"line",yAxis:1}]})}});entbclailotheonv.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk_vt="",t.tk_du="",t.ma_vt="",t.ma_kh="",t.ma_ncc="",t.ma_kho="",t.ma_dt="",t.nvbh="",t.tinh_dc=1,t.dvcs="",t.bctheo="ma_nv",t.nhomtheo="",t.rptid="rbcbhtheodoanhso",t.nxt="2",t.ma_ct="HD2,PBL",t.top=10,t.ma_phi=""};var entrptrbcctcp=new baseRptLink("entrbcctcp","rbcctcp/1","Báo cáo chi tiết chi phí");entrptrbcctcp.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="6",t.ma_bp="",t.ma_phi="",t.nhomtheo="ma_phi",t.rptid="rbcctcp"},entrptrbcctcp.afterLoadData=function(t){var n=_.filter(t.data,function(t){return t.bold===!0&&t.tk});t.labels=_.pluck(n,"tk"),t.tien=_.pluck(n,"tien"),$("#container-chart").highcharts({title:{text:""},xAxis:{categories:t.labels},yAxis:[{min:0,title:{text:"VND"},labels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}}],legend:{align:"right",x:-30,verticalAlign:"top",y:25,floating:!0,backgroundColor:Highcharts.theme&&Highcharts.theme.background2||"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{headerFormat:"<b>{point.x}</b><br/>",pointFormat:"{series.name}: {point.y}"},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}}}},series:[{name:"Tiền",data:t.tien,type:"column",yAxis:0}]})};var entrptrbcthcp=new baseRptLink("entrbcthcp","rbcthcp/1","Báo cáo tổng hợp chi phí");entrptrbcthcp.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="6",t.ma_bp="",t.ma_phi="",t.bctheo="ma_phi",t.nhomtheo="",t.rptid="rbcthcp"},entrptrbcthcp.afterLoadData=function(t){var n=_.filter(t.data,function(t){return t.bold!==!0&&t.ma});t.labels=_.pluck(n,"ma"),t.tien=_.pluck(n,"tien"),$("#container-chart").highcharts({title:{text:""},xAxis:{categories:t.labels},yAxis:[{min:0,title:{text:"VND"},labels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}}],legend:{align:"right",x:-30,verticalAlign:"top",y:25,floating:!0,backgroundColor:Highcharts.theme&&Highcharts.theme.background2||"white",borderColor:"#CCC",borderWidth:1,shadow:!1},tooltip:{headerFormat:"<b>{point.x}</b><br/>",pointFormat:"{series.name}: {point.y}"},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white",style:{textShadow:"0 0 3px black"}}}},series:[{name:"Tiền",data:t.tien,type:"column",yAxis:0}]})};var entrbchdmhthtt=new baseRptLink("entrbchdmhthtt","rbchdmhthtt/1","ENT-Hóa đơn mua hàng theo hạn thanh toán",{onLoading:function(){}});entrbchdmhthtt.defaultCondition=function(t){var n=new Date;t.ngay_tt=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="331",t.ma_kh="",t.khoang_tg=30,t.only_summary=!1,t.ma_dvcs=""};var entrbchdbhthtt=new baseRptLink("entrbchdbhthtt","rbchdbhthtt/1","ENT-Hóa đơn bán hàng theo hạn thanh toán",{onLoading:function(){}});entrbchdbhthtt.defaultCondition=function(t){var n=new Date;t.ngay_tt=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk="131",t.ma_kh="",t.khoang_tg=30,t.only_summary=!1,t.ma_dvcs=""};var ent_rptbanggiaban=new baseRptLink("entbanggiaban","banggiaban/1","ENT - Bảng giá bán",{onLoading:function(){}});ent_rptbanggiaban.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.ma_kho="",t.ma_vt="",t.ma_kh="",t.nh_kh1="",t.nh_vt1="",t.nh_vt2="",t.nh_vt3=""};var id_app,access_token,cmdmodules,paths_not_require_id_app=["code","app","colleague","notification","message","profile","users","comment","versioninfo","labelinfo","tableinfo","license","trialinfo","admin","rptobject","trangthai","step"],accApp=angular.module("accApp",modulesD);accApp.config(["$provide","$httpProvider","$routeProvider","ImgCacheProvider","$compileProvider",function(t,n,e,a,i){a.setOption("debug",!1),a.setOption("chromeQuota",52428800),a.setOption("usePersistentCache",!0),a.manualInit=!0,i.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension):/),t.factory("myHttpInterceptor",["$q","$rootScope","$location",function(t,n,e){return{request:function(t){return t},requestError:function(n){return t.reject(n)},response:function(t){return t},responseEror:function(a){return 401===a.status?(n.isLogined=!1,e.url("/login")):(0==a.status||500==a.status)&&n.error("Không kết nối được với máy chủ"),t.reject(a)}}}]),n.interceptors.push("myHttpInterceptor"),e.otherwise({redirectTo:"/dashboard"})}]),accApp.constant("_",window._),accApp.constant("async",window.async),accApp.factory("api",["$http","$localStorage","$rootScope",function(t,n,e){return{init:function(a){a||(a=n.get("token")),a?(e.isLogined=!0,e.token=a):e.isLogined=!1,access_token=a,t.defaults.headers.common["X-Access-Token"]=a}}}]);var _platform="APP",_online=!0;accApp.run(["indexCache","toastrConfig","$q","$rootScope","api","$window","user","app","$location","$shttp","appInfo","$timeout","editableOptions","$uibModalStack","$localStorage","$cordovaDialogs","$cordovaToast","$cordovaDevice","$document","$uibModal","$cordovaStatusbar","$cordovaNetwork","ImgCache","toastr",function(t,n,e,a,i,o,r,c,d,l,u,s,p,h,f,g,m,v,k,b,y,w,S,M){a.online=navigator.onLine,_online=a.online,a.getCacheFactory=function(n,e,a,i){return t.getCacheFactory(n,e,i)},a.syncing=!1,a.sync=function(t){return t||(t=function(){}),id_app&&a.app_info&&_online&&"APP"!=_platform&&!a[id_app+"sync"]?(a[id_app+"sync"]=!0,console.log("begin upload data to server..."),void async.parallel({up:function(t){var n=a.getCacheFactory(id_app,"tempData");console.log("get values from tempData"),n.values(function(e,i){return e?t():(console.log("end get values from tempData",i),void async.map(i,function(t,e){var i=t.name_service_need_sync;if(i){var o,r,c=server_url_report+"/api/"+id_app+"/"+i;r=t._id,t.tmp_id&&t.tmp_id===t._id?(delete t._id,o=l.post(c,t)):(c=c+"/"+t._id,o=l.put(c,t)),o.then(function(o){n.remove(r,function(){console.log("remove from temp",t,r)}),a.getCacheFactory(id_app,i).remove(r),a.getCacheFactory(id_app,i).put(o.data._id,o.data),e()},function(o){o.data&&(n.remove(r),a.getCacheFactory(id_app,i).remove(r),console.log("error sync",o.data,t)),e()})}else n.remove(t._id),a.getCacheFactory(id_app,i).remove(t._id),e()},function(n){n&&console.log("sync error",n),t()}))})},del:function(t){var n=a.getCacheFactory(id_app,"tempData_deleted");n.values(function(e,i){return e?t():void async.map(i,function(t,e){var i=t.name_service;if(i&&t._id.indexOf("$$")<0){console.log("begin delete sync",i,t._id);var o=server_url_report+"/api/"+id_app+"/"+i+"/"+t._id;l.delete(o).then(function(){console.log("finished delete sync",i,t._id),n.remove(t._id),a.getCacheFactory(id_app,i).remove(t._id),e()},function(o){o.data&&(console.log("error delete sync",i,t._id,o.data),n.remove(t._id),a.getCacheFactory(id_app,i).remove(t._id)),e()})}else n.remove(t._id),a.getCacheFactory(id_app,i).remove(t._id),e()},function(n){n&&console.log("sync delete error",n),t()})})}},function(){if("zbrowser"===_platform)console.log("don't download data from server for",_platform),a[id_app+"sync"]=!1,t();else{console.log("begin download data from server...");var n,i=["users","versioninfo","trialinfo","license","tableinfo","forminfo"],o=1e6,r=new Date;a.sync_date=f.get(id_app+"sync_date"),async.mapSeries(_.keys(STPModules),function(t,r){if((!n||n.indexOf(t.toLowerCase())>=0)&&i.indexOf(t.toLowerCase())<0){var c=STPModules[t];c.obj.download?async.parallel({del:function(t){var n={tu_ngay:a.sync_date};c.obj.getService(l,e,a).logs(id_app,"DELETE",n).then(function(n){async.mapSeries(n.data,function(t,n){a.getCacheFactory(id_app,t.id_func.toLowerCase()).remove(t.data.id),n()},function(){t()})},function(n){n.data&&console.log(n.data),t()})},dow:function(t){c.obj.download(l,e,a,o,function(n){t()})}},function(){r()}):r()}else r()},function(){a[id_app+"sync"]=!1,f.set(id_app+"sync_date",r),t()})}})):void t()},document.addEventListener("deviceready",function(){S.$init(),_platform=v.getPlatform(),"function"==typeof require&&(_platform="nwjs"),y.overlaysWebView(!0),y.styleHex("#34AADC"),"browser"===_platform||"nwjs"===_platform?(_online=navigator.onLine,a.online=_online,o.addEventListener("offline",function(){a.$apply(function(){a.online=!1,_online=!1})},!1),o.addEventListener("online",function(){a.$apply(function(){a.online=!0,_online=!0,a.sync(function(){a.syncing=!1})})},!1)):(_online=w.isOnline(),a.online=_online,a.$on("$cordovaNetwork:online",function(){a.online=!0,_online=!0,a.sync(function(){a.syncing=!1})}),a.$on("$cordovaNetwork:offline",function(){a.online=!1,_online=!1})),a.syncing=!0,s(function(){a.sync(function(){a.syncing=!1})},0)},!1),a.platform=function(){return _platform},a.isLogined=!1,a.program_name=MAIN_APPLICATION_NAME,a.version=2.5,a.alert=function(t,n,e){b.open({templateUrl:"templates/sys/alert.html",controller:["$scope","$rootScope","$uibModalInstance",function(a,i,o){a.dismiss=function(){o.close()},a.msg=t,a.title=n,a.onClick=e||function(){}}],size:"sm"})},a.confirm=function(t){{var n=e.defer();b.open({templateUrl:"templates/sys/confirm.html",controller:["$scope","$rootScope","$uibModalInstance",function(e,a,i){e.dismiss=function(){n.resolve(0),i.close()},e.ok=function(){n.resolve(1),i.close()},e.msg=t}],size:"sm",backdrop:"static"})}return n.promise},a.prompt=function(t,n){return g.prompt(t,a.program_name,["Nhận","Huỷ"],n)},angular.extend(n,{iconClasses:{error:"toast-error",info:"toast-info",success:"toast-system",warning:"toast-warning"},positionClass:"toast-bottom-right",progressBar:!1,newestOnTop:!0,maxOpened:0,preventDuplicates:!1,preventOpenDuplicates:!1}),a.toast=function(t,n,e,i,o){o||(o="info");var r;switch(o){case"error":r=M.error;break;case"warning":r=M.warning;break;case"success":r=M.success;break;default:r=M.info}var c={allowHtml:!0,closeButton:!0,timeOut:n||3e3,onTap:i};"android"===a.platform().toLowerCase()||"ios"===a.platform().toLowerCase()?m.showShortTop(t).then(function(){},function(){r(t,"",c)}):r(t,"",c)},a.openDefaultInterface=function(){if(a.interface){var t=_.find(interfaces,function(t){return t.id===a.interface});d.url(t?"/"+(t.default||"dashboard"):"/dashboard")}else d.url("/dashboard")},a.openUrl=function(t,n,e,a){var i={};if(n&&_.extend(i,n),a&&_.extend(i,a),t){var o,r,c=t.split("?")[0].split("/"),l=c[0];!l&&c.length>1?(l=c[1],o=c.length>2?c[2]:"",r=c.length>3?c[3]:""):(o=c.length>1?c[1]:"",r=c.length>2?c[2]:"");var u=STPModules[l.toLowerCase()];if(u){var s=u.obj;switch("RPT"==u.type?(i.isDrillDown=!0,o="listview"):(o||(o=i._action),o||(o="listview")),_.extend(i,STP.queryStringToJSON(t)),delete i._action,o){case"listview":s.quickview(b,i,e);break;case"edit":r||(r=i._id),r&&s.quickedit(b,r,e);break;case"add":s.quickadd(b,e,i);break;default:d.url(t)}}else console.log("not found module",l,t,i),d.url(t)}},a.downloadFile=function(t,n,e){var i;_.isObject(t)?(i=server_url_report+"/api/"+t.id_app+"/file/download/"+t._id+"?access_token="+a.token,n||(n=t.file.originalname)):(i=t,n||(n="file")),l.get(i,{responseType:"arraybuffer"}).then(function(t){var a=new Blob([t.data]);saveAs(a,n),e&&e()},function(t){e?e(t.data||"Không thể kết nối với máy chủ"):a.alert(t.data?t.data:"Không thể kết nối với máy chủ")})},a.innerHeight=o.innerHeight,a.innerWidth=o.innerWidth,a.isMobile=a.innerWidth<=991,angular.element(o).bind("resize",function(){a.innerHeight=o.innerHeight,a.innerWidth=o.innerWidth,a.isMobile=a.innerWidth<=991}),a.printS=function(t,n){n||(n=a.program_name||""),document.addEventListener("deviceready",function(){if(t='<html><head><style> @media print { @page { margin: 0}}</style><link rel="stylesheet" type="text/css" href="libs/bootstrap/dist/css/bootstrap.min.css" /><link rel="stylesheet" type="text/css" href="libs/semantic-ui-card/card.min.css" /><link rel="stylesheet" type="text/css" href="css/main.css" /><title>'+n+'</title></head><body style ="margin-top: 0.1cm;margin-bottom:0.1cm">'+t+"</body></html>","browser"===_platform||"nwjs"===_platform)document.getElementById("printframe").contentWindow.document.documentElement.innerHTML=t,setTimeout(function(){window.frames.printframe.print()},500);else try{cordova.plugins.printer.print(t,"Document.html")}catch(e){a.toast(e)}},!1)},a.lang=f.get("lang"),initLabel(a,a,u,"SYS",l),a.setLang=function(t){a.lang=t,f.set("lang",t),o.location.reload()},p.theme="bs3",l.get(server_url+"/public/province",{cache:!0}).then(function(t){var n=t.data;a.province=n}),a.STP=STP,a.nextTick=function(t){s(t,0)},a.server_url=server_url,a.$watch("app_info",function(t,n){$("title").text(a.function_title?a.function_title+(a.app_info?" - "+a.app_info.name:""):program_name),t&&!_.isEqual(t,n)&&(a.syncing=!0,s(function(){a.sync(function(){a.syncing=!1})},0),a.commands={},u.commands(a.id_app),a.app_info.user_created?(a.members=[{email:a.app_info.user_created,name:a.app_info.user_created.split("@")[0]}],a.app_info.participants.forEach(function(t){a.members.push({email:t.email,name:t.name})
})):a.members=[])},!0),a.$watch("function_title",function(t){$("title").text(t?a.function_title+(a.app_info?" - "+a.app_info.name:""):program_name)}),a.$on("$routeChangeStart",function(){o.scrollTo(0,0),a.$broadcast("$dataChangeSuccess"),h.dismissAll()}),a.openPath=function(t,n){a.menuActive=n,d.url(t)},a.confDashboard=function(){u.confDashboard(a.app_info)},a.searchword="",a.searchAllKeyup=function(t,n){13===t.keyCode&&n&&d.url("search/"+n)},a.searchAll=function(t){t&&d.url("search/"+t)},a.tinymceOptionsEmail={setup:function(t){t.addButton("hlink",{text:"Liên kết nội bộ",icon:!1,onclick:function(){hlinkModule.quickview(b,{},function(){},{templateUrl:"hlinkview",onListItemClick:function(n,e){e.close();var a=server_url+"/public/link/"+n._id+"/{{receiver._id}}?cid={{cid}}",i="<a href='"+a+"'>"+n.name+"</a>";t.insertContent(i)}})}}),t.addButton("insertName",{text:"Tên người nhận",icon:!1,onclick:function(){t.insertContent("{{receiver.name}}")}}),t.addButton("insertAddress",{text:"Email người nhận",icon:!1,onclick:function(){t.insertContent("{{receiver.address}}")}})},menubar:!1,relative_urls:!1,remove_script_host:!1,height:300,theme:"modern",toolbar_items_size:"small",content_css:"libs/bootstrap/dist/css/bootstrap.min.css",importcss_append:!0,paste_data_images:!1,paste_as_text:!1,plugins:["advlist autolink code fullscreen importcss link image lists hr anchor pagebreak","searchreplace visualblocks visualchars code media nonbreaking","table contextmenu directionality emoticons template textcolor paste  textcolor colorpicker textpattern"],toolbar1:"hlink insertName insertAddress | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | fontselect fontsizeselect | table | hr removeformat | searchreplace | bullist numlist | outdent indent blockquote | link unlink anchor image media| pagebreak | forecolor backcolor  | fullscreen code",image_advtab:!0,language:"vi_VN"},a.tinymceOptions={},_.extend(a.tinymceOptions,a.tinymceOptionsEmail,{toolbar1:"bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | fontselect fontsizeselect | table | hr removeformat | searchreplace | bullist numlist | outdent indent blockquote | link unlink anchor image media | pagebreak | forecolor backcolor | fullscreen code"}),i.init()}]),accApp.directive("format",["$filter",function(t){return{require:"?ngModel",scope:{ngModel:"=",watchChange:"&?",round:"=?"},controller:["$scope",function(t){t.$watch("ngModel",function(n){void 0==n?t.ngModel=0:t.watchChange&&t.watchChange()})}],link:function(n,e,a,i){i&&(angular.element(e).on("blur",function(){var a=t("number")(n.ngModel,n.round);e.val(a)}),i.$formatters.unshift(function(){return(void 0==i.$modelValue||""==i.$modelValue)&&(i.$modelValue=0),t(a.format)(i.$modelValue,n.round)}),i.$parsers.unshift(function(a){(void 0==a||""==a)&&(a="0");var i=a.replace(/[^\d|\-+|,+]/g,""),o=i.replace(/,/g,".");if(i.indexOf(",")<0){var r=t("number")(o);i.indexOf(",")==i.length-1&&(r+=","),e.val(r)}var c=Number(o);return void 0==c&&(c=0),STP.round(c,n.round)}))}}}]),accApp.directive("ngData",function(){return{controller:["$scope",function(){}]}}),accApp.directive("ngSum",function(){return{scope:{ngSum:"@",ngData:"=",ngModel:"="},link:function(t){t.$watch("ngData",function(n){var e=0;n&&angular.forEach(n,function(n){var a=Number(n[t.ngSum])||0;e+=a}),t.ngModel=e},!0)}}}),accApp.directive("ngDatepicker",["$window",function(){return{restrict:"E",require:"^ngModel",scope:{ngModel:"=",ngChange:"&",ngReadonly:"=?",ngDisabled:"=?"},templateUrl:"templates/sys/ng-datepicker.html",controller:["$scope","$filter",function(t){t.$watch("ngModel",function(n,e){n&&!_.isDate(n)&&(t.ngModel=new Date(n)),t.ngChange&&n!=e&&t.ngChange()})}],link:function(){}}}]),accApp.directive("ngDatetimepicker",["$window",function(){return{restrict:"E",require:"^ngModel",scope:{ngModel:"=",ngChange:"&"},template:'<input type="datetime-local" class="form-control" ng-model="ngModel">',controller:["$scope","$filter",function(t){t.$watch("ngModel",function(n,e){var a=n;a&&!_.isDate(a)&&(a=new Date(a)),a&&(a.setMilliseconds(0),a.setSeconds(0),t.ngModel=a),t.ngChange&&n!=e&&t.ngChange()})}],link:function(){}}}]),accApp.directive("ngRequiredCn",["dmtk",function(t){var n=!1,e=function(t,e){1!=n||e.$viewValue&&""!=e.$viewValue?e.$setValidity("ngRequiredCn",!0):e.$setValidity("ngRequiredCn",!1)};return{restrict:"A",require:"?ngModel",link:function(a,i,o,r){a.$watch(o.ngRequiredCn,function(i){i?a.tks?(n=_.filter(a.tks,function(t){return t.tk==i&&t.tk_cn}).length>0,e(a,r)):t.list(id_app,{tk:i,tk_cn:!0},"tk_cn").then(function(t){var i=t.data;n=0==i.length?!1:!0,e(a,r)}):(n=!1,e(a,r))}),a.$watch(o.ngModel,function(){e(a,r)})}}}]),accApp.directive("ngRequiredQ",[function(){return{restrict:"A",require:"?ngModel",link:function(t,n,e,a){t.$watch(e.ngRequiredQ,function(t){t?a.$setValidity("ngRequired",!1):a.$setValidity("ngRequired",!0)})}}}]),accApp.directive("topMenu",[function(){return{restrict:"E",templateUrl:"templates/sys/top-menu.html",controller:["$scope","$rootScope","colleague","$window","user","app","$location","$http","appInfo","$timeout",function(t,n,e,a,i,o,r,c){n.notifies_count=0,n.messages_count=0,n.task_count=0,n.getMessages=function(t){n.msgs=[{content:"Đang lấy dữ liệu..."}],i.getMessagesColleagues(function(e,a){e?(n.messages_count=0,n.msgs=[{content:"Không thể lấy dữ liệu từ server"}]):(n.msgs=a,n.messages_count=a.length,t&&t(a))})},n.getInvitations=function(t){n.notifies={notifications:[{content:"Đang lấy dữ liệu..."}]},i.getNotifies(function(e,a){e?(n.notifies_count=0,n.notifies={notifications:[{content:"Không thể lấy dữ liệu từ server"}]}):(n.notifies=a,n.notifies_count=a.colls.length+a.apps.length+a.notifications.length,t&&t(a))})},n.getTask=function(){n.tasks=[{ten_cv:"Đang lấy dữ liệu..."}];var t=new Date,e={progress:{$ne:2},start_date:{$lt:t},status:!0,phu_trach:n.user.email};c.get(server_url+"/api/"+id_app+"/task?fields=ten_cv,percent,progress,priority&q="+JSON.stringify(e)).then(function(t){var e=t.data;n.tasks=e,n.task_count=e.length},function(){n.tasks=[{ten_cv:"Không thể lấy dữ liệu từ server"}]})},n.acceptInvitor=function(t,i){"colleague"==t&&e.active(i).then(function(t){t.data;(0==r.url().indexOf("/colleague")||0==r.url().indexOf("colleague"))&&a.location.reload()},function(){n.alert("Không thể thực hiện thao tác này")}),"app"==t&&o.active(i).then(function(t){t.data;(0==r.url().indexOf("/app")||0==r.url().indexOf("app"))&&a.location.reload()},function(){n.alert("Không thể thực hiện thao tác này")})},n.notAcceptInvitor=function(t,i){"colleague"==t&&e.notaccept(i).then(function(t){t.data;(0==r.url().indexOf("/colleague")||0==r.url().indexOf("colleague"))&&a.location.reload()},function(){n.alert("Không thể thực hiện thao tác này")}),"app"==t&&o.notaccept(i).then(function(t){t.data;(0==r.url().indexOf("/app")||0==r.url().indexOf("app"))&&a.location.reload()},function(){n.alert("Không thể thực hiện thao tác này")})},n.$watch("app_info",function(t){t&&n.getTask()},!0)}]}}]),accApp.directive("horizantalMenu",[function(){return{restrict:"E",templateUrl:"templates/sys/horizantal-menu.html"}}]),accApp.directive("applicationFooter",[function(){return{restrict:"E",templateUrl:"templates/sys/application-footer.html"}}]),accApp.directive("applicationHeader",[function(){return{restrict:"E",templateUrl:"templates/sys/application-header.html"}}]),accApp.directive("appHeader",[function(){return{restrict:"E",templateUrl:"templates/sys/app-header.html",controller:["$scope","$uibModal","appInfo","$localStorage",function(t,n,e){t.confdashboard=function(){e.info("/dashboard",function(t,n,a){t||e.confDashboard(a)})}}]}}]),accApp.directive("ngPage",[function(){return{restrict:"E",templateUrl:"templates/sys/ng-page.html"}}]),accApp.directive("ngPageFx",[function(){return{restrict:"E",scope:{service:"=",list:"=",condition:"=",start:"=",pageChanged:"&"},templateUrl:"templates/sys/ng-page.html",controller:["$scope","$http","$rootScope",function(t,n,e){t.current_page=1,t.getPages=function(){t.service.load(id_app,{condition:t.condition,count:1}).then(function(n){var e=n.data;t.total_page=STP.round(e.rows_number/t.limit,0),t.total_page<e.rows_number/t.limit&&(t.total_page+=1),0==t.total_page&&(t.total_page=1),t.pages=[];for(var a=1;a<=t.total_page;a++)t.pages.push(a)})},t.goToPage=function(a){a||(a=1),e.nextTick(function(){t.$emit("$dataChangeStart"),t.service.load(id_app,{condition:t.condition,page:a,limit:t.limit,fields:t.fields}).then(function(e){var i=e.data;async.map(i,function(e,a){t.emailCurrentUser?n.get(server_url+"/api/follow?q={id_object:'"+e._id+"',user_created:'"+t.emailCurrentUser+"'}").then(function(t){var n=t.data;n&&n.length>0?(e.followObject=n[0],e.follow_yn=1):e.follow_yn=0,a()},function(t){e.follow_yn=0,a(t)}):a()},function(n){n&&console.log(n),t.$emit("$dataChangeSuccess"),t.current_page=a,t.pageChanged({$page:a}),t.list=i})},function(){t.$emit("$dataChangeError")})})}}],link:function(t,n,e){t.total_page=1,t.pages=[1],e.hasOwnProperty("emailCurrentUser")&&(t.emailCurrentUser=e.emailCurrentUser),t.fields=e.hasOwnProperty("fields")?e.fields:"",e.hasOwnProperty("limit")&&(t.limit=e.limit),t.current_page=e.hasOwnProperty("currentPage")?Number(e.currentPage):1,t.limit||(t.limit=20),t.$watch("start",function(n){n&&(t.getPages(),t.goToPage(t.current_page),t.start=null)})}}}]),accApp.directive("list",["$location",function($location){return{restrict:"E",transclude:{title:"?listTitle",extToolbar:"?listExtToolbar",extFilter:"?listExtFilter",body:"listBody",footer:"?listFooter"},templateUrl:"templates/sys/list.html",link:function(scope,elem,attrs,contr){if(scope.toolbar_show=!0,attrs.hasOwnProperty("toolbarShow")&&(scope.toolbar_show=attrs.toolbarShow),scope.advSearch_show=attrs.advSearch,attrs.hasOwnProperty("boxSearch")?("false"==attrs.boxSearch&&(attrs.boxSearch=!1),"true"==attrs.boxSearch&&(attrs.boxSearch=!0),scope.boxSearch=attrs.boxSearch):scope.boxSearch=!0,attrs.hasOwnProperty("btnadd")){var btnAdd=eval("({"+attrs.btnadd+"})");void 0==btnAdd.show&&(btnAdd.show=!0),void 0==btnAdd.text&&(btnAdd.text="Mới"),scope.add_show=btnAdd.show,scope.add_text=btnAdd.text}else scope.add_show=!0,scope.add_text="Mới";if(attrs.btndelete){var btnDelete=eval("({"+attrs.btndelete+"})");void 0==btnDelete.show&&(btnDelete.show=!0),void 0==btnDelete.text&&(btnDelete.text="Xóa"),scope.delete_show=btnDelete.show,scope.delete_text=btnDelete.text}else scope.delete_text="Xóa",scope.delete_show=!0;if(scope.import_show=!0,attrs.btnimport){var btnimport=eval("({"+attrs.btnimport+"})");btnimport.show===!1&&(scope.import_show=!1),scope.import_text="Nhập từ Excel"}if(attrs.btnexport){var btnexport=eval("({"+attrs.btnexport+"})");btnexport.show&&(scope.export_show=!0)}if(attrs.options){var options=eval("({"+attrs.options+"})");scope.options_show=!0,scope.options_text=options.text}scope.showExtraToolbar=!0;var ex=$(elem).find(".extra-button");scope.showExtraToolbar=ex.length>0&&ex[0]?ex[0].innerText.length>0:!1}}}]),accApp.directive("voucher",["$location",function($location){return{restrict:"E",transclude:{title:"?voucherTitle",extToolbar:"?voucherExtToolbar",extFilter:"?voucherExtFilter",body:"?voucherBody",bodyMaster:"?voucherBodyMaster",bodyDetail:"?voucherBodyDetail",footer:"?voucherFooter"},templateUrl:function(t,n){return n.masterDetail?"templates/sys/voucher-master-detail.html":"templates/sys/voucher.html"},link:function(scope,elem,attrs,contr){if(scope.manTabs={activeTab:0},attrs.hasOwnProperty("boxSearch")?("false"==attrs.boxSearch&&(attrs.boxSearch=!1),"true"==attrs.boxSearch&&(attrs.boxSearch=!0),scope.boxSearch=attrs.boxSearch):scope.boxSearch=!0,attrs.hasOwnProperty("btnadd")){var btnAdd=eval("({"+attrs.btnadd+"})");void 0==btnAdd.show&&(btnAdd.show=!0),void 0==btnAdd.text&&(btnAdd.text="Mới"),scope.add_show=btnAdd.show,scope.add_text=btnAdd.text}else scope.add_show=!0,scope.add_text="Mới";if(attrs.btndelete){var btnDelete=eval("({"+attrs.btndelete+"})");void 0==btnDelete.show&&(btnDelete.show=!0),void 0==btnDelete.text&&(btnDelete.text="Xóa"),scope.delete_show=btnDelete.show,scope.delete_text=btnDelete.text}else scope.delete_text="Xóa",scope.delete_show=!0;if(scope.import_show=!0,attrs.btnimport){var btnimport=eval("({"+attrs.btnimport+"})");btnimport.show===!1&&(scope.import_show=!1),scope.import_text="Nhập từ Excel"}if(attrs.btnexport){var btnexport=eval("({"+attrs.btnexport+"})");btnexport.show&&(scope.export_show=!0)}if(attrs.options){var options=eval("({"+attrs.options+"})");scope.options_show=!0,scope.options_text=options.text}scope.showExtraToolbar=!0;var ex=$(elem).find(".extra-button");scope.showExtraToolbar=ex.length>0&&ex[0]?ex[0].innerText.length>0:!1}}}]),accApp.directive("stplistheader",["$location",function($location){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/list-header.html",link:function(scope,elem,attrs,contr){if(attrs.hasOwnProperty("boxSearch")?("false"==attrs.boxSearch&&(attrs.boxSearch=!1),"true"==attrs.boxSearch&&(attrs.boxSearch=!0),scope.boxSearch=attrs.boxSearch):scope.boxSearch=!0,attrs.hasOwnProperty("btnadd")){var btnAdd=eval("({"+attrs.btnadd+"})");void 0==btnAdd.show&&(btnAdd.show=!0),void 0==btnAdd.text&&(btnAdd.text="Mới"),scope.add_show=btnAdd.show,scope.add_text=btnAdd.text}else scope.add_show=!0,scope.add_text="Mới";if(attrs.btndelete){var btnDelete=eval("({"+attrs.btndelete+"})");void 0==btnDelete.show&&(btnDelete.show=!0),void 0==btnDelete.text&&(btnDelete.text="Xóa"),scope.delete_show=btnDelete.show,scope.delete_text=btnDelete.text}else scope.delete_text="Xóa",scope.delete_show=!0;if(attrs.btn1){var btn1=eval("({"+attrs.btn1+"})");scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)}if(attrs.btn2){var btn2=eval("({"+attrs.btn2+"})");scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)}if(attrs.btn3){var btn3=eval("({"+attrs.btn3+"})");scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)}if(attrs.btn4){var btn4=eval("({"+attrs.btn4+"})");scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)}if(attrs.btn5){var btn5=eval("({"+attrs.btn5+"})");scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)}if(scope.import_show=!0,attrs.btnimport){var btnimport=eval("({"+attrs.btnimport+"})");btnimport.show===!1&&(scope.import_show=!1),scope.import_text="Nhập từ Excel"}if(attrs.btnexport){var btnexport=eval("({"+attrs.btnexport+"})");btnexport.show&&(scope.export_show=!0)}}}}]),accApp.directive("listViewHeader",["$location",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/list-view-header.html",controller:["$scope","$rootScope",function(t,n){t.$watch("data",function(e){e&&(t.title_view=e[t.headerTitleField],n.title_view=t.title_view)},!0)}],link:function(t,n,e){t.headerTitleField=e.headerTitle}}}]),accApp.directive("stpvoucherheader",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/voucher-header.html",link:function(scope,elem,attrs,control){if(attrs.btn1){var btn1=eval("({"+attrs.btn1+"})");scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)}if(attrs.btn2){var btn2=eval("({"+attrs.btn2+"})");scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)}if(attrs.btn3){var btn3=eval("({"+attrs.btn3+"})");scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)}if(attrs.btn4){var btn4=eval("({"+attrs.btn4+"})");scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)}if(attrs.btn5){var btn5=eval("({"+attrs.btn5+"})");scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)}if(scope.import_show=!0,attrs.btnimport){var btnimport=eval("({"+attrs.btnimport+"})");btnimport.show===!1&&(scope.import_show=!1),scope.import_text="Nhập từ Excel"}if(attrs.options){var options=eval("({"+attrs.options+"})");scope.options_show=!0,scope.options_text=options.text}}}}),accApp.directive("headerFormInputFull",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/header-form-input-full.html",link:function(t,n,e){e.saveText&&(t.save_text=e.saveText),e.cancelText&&(t.cancel_text=e.cancelText),t.windowHeight=window.innerHeight}}}),accApp.directive("formInput",function(){return{restrict:"E",transclude:{title:"?formInputTitle",body:"formInputBody",footer:"?formInputFooter"},templateUrl:function(){var t="form-input";return"templates/sys/"+t+".html"},link:function(t,n,e){t.save_text=e.saveText?e.saveText:t.getLabel("luu","Lưu").text,t.cancel_text=e.cancelText?e.cancelText:t.getLabel("huu","Huỷ").text,t.delete_text=e.deleteText?e.deleteText:t.getLabel("xoa","Xoá").text,t.print_text=e.printText?e.printText:t.getLabel("in","In").text,t.autoHeight=e.autoHeight&&"true"===e.autoHeight&&window.innerHeight>568,n.bind("keydown",function(n){var e=n.keyCode||n.which;n.ctrlKey&&t.create&&t.form&&!t.form.$invalid&&(83==e?(t.create(),n.preventDefault()):80==e&&(t.create(1),n.preventDefault()))})}}}),accApp.directive("formDetail",function(){return{restrict:"E",transclude:{title:"?formDetailTitle",toolbar:"?formDetailToolbar",body:"formDetailBody",footer:"?formDetailFooter"},templateUrl:"templates/sys/form-detail.html",link:function(t,n,e){t.autoHeight=(!e.autoHeight||"true"===e.autoHeight)&&window.innerHeight>568,n.bind("keydown",function(n){var e=n.keyCode||n.which;n.ctrlKey&&83==e&&t.updateDetail&&t.formdetail&&!t.formdetail.$invalid&&(t.updateDetail(),n.preventDefault())})}}}),accApp.directive("headerFormInput",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/header-form-input.html",link:function(t,n,e){e.saveText&&(t.save_text=e.saveText),e.cancelText&&(t.cancel_text=e.cancelText)}}}),accApp.directive("headerDialogSelect",function(){return{restrict:"E",templateUrl:"templates/sys/header-dialog-select.html",controller:["$rootScope","$scope","appInfo","$http",function(){}],link:function(t,n,e){t.title=e.hasOwnProperty("title")?e.title:"Danh sách",t.placeholder=e.hasOwnProperty("placeholder")?e.placeholder:"Gõ từ cần tìm..."}}}),accApp.directive("footerFormInput",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/footer-form-input.html",link:function(t,n,e){e.saveText&&(t.save_text=e.saveText),e.cancelText&&(t.cancel_text=e.cancelText)}}}),accApp.directive("rptHeader",["$location",function($location){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/rpt-header.html",controller:["$uibModal","$scope","$rootScope",function(t,n,e){n.openKbm=function(){return n.kbm?void e.openUrl(n.kbm):e.alert("Miss attr kbm")},n.hideCondition=function(t){n.condition_show=t?!1:!n.condition_show;var e=angular.element(document.getElementById("rptContent")),a=e.controller("scrollableContent");a.scrollTo(0)}}],link:function(scope,elem,attrs,controller){if(attrs.kbm&&(scope.kbm=attrs.kbm,scope.kbm_yn=!0),scope.btnok_text="Xem",scope.btnok_show=!0,attrs.btnok){var btnok=eval("({"+attrs.btnok+"})");btnok.text&&(scope.btnok_text=btnok.text),btnok.show&&(scope.btnok_show=btnok.show)}if(attrs.btn1){var btn1=eval("({"+attrs.btn1+"})");scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)}if(attrs.btn2){var btn2=eval("({"+attrs.btn2+"})");scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)}if(attrs.btn3){var btn3=eval("({"+attrs.btn3+"})");scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)}if(attrs.btn4){var btn4=eval("({"+attrs.btn4+"})");scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)}if(attrs.btn5){var btn5=eval("({"+attrs.btn5+"})");scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)}if(attrs.btnprint){var btnprint=eval("({"+attrs.btnprint+"})");void 0==btnprint.show&&(btnprint.show=!0),scope.btnprint_show=btnprint.show}else scope.btnprint_show=!0;if(attrs.btnexcel){var btnexcel=eval("({"+attrs.btnexcel+"})");void 0==btnexcel.show&&(btnexcel.show=!0),scope.btnexcel_show=btnexcel.show}else scope.btnexcel_show=!0}}}]),accApp.directive("report",["$location",function($location){return{restrict:"E",transclude:{filter:"reportFilter",viewer:"reportViewer"},templateUrl:"templates/sys/report.html",controller:["$uibModal","$scope","$rootScope",function(t,n,e){n.openKbm=function(){return n.kbm?void e.openUrl(n.kbm):e.alert("Miss attr kbm")},n.hideCondition=function(t){n.condition_show=t?!1:!n.condition_show;var e=angular.element(document.getElementById("rptContent")),a=e.controller("scrollableContent");a.scrollTo(0)}}],link:function(scope,elem,attrs,controller){if(attrs.kbm&&(scope.kbm=attrs.kbm,scope.kbm_yn=!0),scope.btnok_text="Xem",scope.btnok_show=!0,attrs.btnok){var btnok=eval("({"+attrs.btnok+"})");btnok.text&&(scope.btnok_text=btnok.text),btnok.show&&(scope.btnok_show=btnok.show)}if(attrs.btn1){var btn1=eval("({"+attrs.btn1+"})");scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)}if(attrs.btn2){var btn2=eval("({"+attrs.btn2+"})");scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)}if(attrs.btn3){var btn3=eval("({"+attrs.btn3+"})");scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)}if(attrs.btn4){var btn4=eval("({"+attrs.btn4+"})");scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)}if(attrs.btn5){var btn5=eval("({"+attrs.btn5+"})");scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)}if(attrs.btnprint){var btnprint=eval("({"+attrs.btnprint+"})");void 0==btnprint.show&&(btnprint.show=!0),scope.btnprint_show=btnprint.show}else scope.btnprint_show=!0;if(attrs.btnexcel){var btnexcel=eval("({"+attrs.btnexcel+"})");void 0==btnexcel.show&&(btnexcel.show=!0),scope.btnexcel_show=btnexcel.show}else scope.btnexcel_show=!0}}}]),accApp.directive("navbarPrint",function(){return{restrict:"E",templateUrl:"templates/sys/navbar-print.html"}}),accApp.factory("$cache_lists",function(){return{}}),accApp.directive("stpLink",function(){return{restrict:"E",scope:{link:"=",collection:"@",collectionsLink:"@"},templateUrl:"templates/sys/link.html",controller:["$scope","$shttp","$window","$location","$rootScope","appInfo","link",function($scope,$http,$window,$location,$rootScope,appInfo,sv_link){initLabel($rootScope,$scope,appInfo,"LINK",$http),$scope.textSearch="",$scope.location=$location.url();var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink),collectionsTitle={};collections.forEach(function(c){var module_name=c+"Module",module=eval("("+module_name+")");collectionsTitle[c]=module.title}),$scope.collectionsTitleString=_.values(collectionsTitle).join(),$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t,{cache:!0}).then(function(t){var n=t.data;$scope.link.links=n},function(t){t.data&&console.log(t.data)})},$scope.getHeaderCollection=function(t){return collectionsTitle[t.collection_obj]},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n,{cache:!0}).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="";var n=_.find($scope.link.links,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id,sv_link.create(id_app,e).then(function(n){var a=n.data;_.extend(e,a),e.obj=t,e.title=t.title,$scope.link.links.push(e)},function(t){t.data&&$rootScope.alert(t.data)})}},$scope.unLink=function(t){sv_link.delete(id_app,t._id).then(function(n){n.data;$scope.link.links=_.reject($scope.link.links,function(n){return n._id==t._id})},function(t){t.data&&$rootScope.alert(t.data)})},$scope.getItem=function(t,n,e){$scope.addLink(t,e)}}],link:function(t,n,e){e.link&&e.collection&&e.collectionsLink||console.error("stp-link directive require attributes:link,collection,collection-link"),t.$watch("link",function(n){n&&(t.link.links||(t.link.links=[]),t.load())})}}}),accApp.directive("getValue",["$http","$rootScope",function(t){return{restrict:"A",scope:{module:"@",field:"@",condition:"@"},link:function(n,e){var a=function(a,i){if(n.module){"dmkh"===n.module&&(n.module="customer"),"dmtk"===n.module&&(n.module="account");var o=server_url+"/api/"+id_app+"/"+n.module+"?t=1";if(a)try{a=JSON.parse("{"+a+"}"),o=o+"&q="+JSON.stringify(a)}catch(r){console.log(r.message,"{"+a+"}"),o=o+"&"+a}i&&(o=o+"&fields="+i),t.get(o).then(function(t){var n;t.data&&t.data.length>0&&(n=t.data[0][i]),n||(n=""),e.text(n)},function(t){e.text(t.data)})}};a(n.condition,n.field)}}}]),accApp.directive("ngGetInfo",["$http",function($http){return{restrict:"A",scope:{conditionValue:"=",runWhenConditionChanged:"=",ngModel:"="},controller:["$scope",function(t){var n=function(n,e,a){var i=server_url+"/api/"+n+"/"+t.pathService+"?t=1";if(e)if(angular.isObject(e)){var o=JSON.stringify(e);i=i+"&q="+o}else i=i+"&"+e;return a&&(i=i+"&fields="+a),$http.get(i)};t.getValue=function(e){var a={};for(var i in t.condition){var o=t.condition[i];a[i]="???"==o?t.conditionValue:o}n(id_app,a,t.fieldInfo).then(function(n){var a=n.data;1==a.length&&e(a[0][t.fieldInfo])})}}],link:function(scope,elem,attrs){var ngGetInfo=eval("({"+attrs.ngGetInfo+"})");scope.fieldInfo=ngGetInfo.fieldInfo;var module=eval("("+ngGetInfo.module+"Module)");scope.pathService=module.server_path,scope.condition=ngGetInfo.condition,attrs.hasOwnProperty("runWhenConditionChanged")||(scope.runWhenConditionChanged=!0),scope.$watch("conditionValue",function(t,n){return scope.runWhenConditionChanged?t||t===n?void(scope.fieldInfo&&scope.getValue(function(t){t&&(scope.ngModel=t)})):void(scope.ngModel=null):void 0})}}}]),accApp.directive("history",function(){return{restrict:"E",scope:{link:"=",module:"@",actions:"@"},templateUrl:"templates/sys/history.html",controller:["$scope","$http","$uibModal","$rootScope","appInfo",function($scope,$http,$uibModal,$rootScope,appInfo){initLabel($rootScope,$scope,appInfo,"HISTORY",$http);var module=eval("("+$scope.module+"Module)");$scope.getHistory=function(){var t=module.url_service(server_url)+"/g/history/"+$scope.link._id;$scope.actions&&(t=t+"?actions="+$scope.actions),$http.get(t).then(function(t){var n=t.data;n.forEach(function(t){t.action_text="GET"==t.action?"Đã xem":"UPDATE"==t.action?"Đã cập nhật":"ADD"==t.action?"Đã tạo":t.action}),$scope.history=n},function(t){console.error(t)})},$scope.openProfile=function(t){viewProfile($uibModal,t)}}],link:function(t){t.$watch("link",function(n){n&&t.getHistory()})}}}),accApp.directive("parseHtml",function(){return{restrict:"A",scope:{parseHtml:"="},link:function(t,n){t.$watch("parseHtml",function(t){if(t&&_.isString(t)){var e=/<[a-z][\s\S]*>/i.test(t);n.html(e?t:t.replace(/\n/g,"<br/>"))}})}}}),accApp.directive("parseText",function(){return{restrict:"A",scope:{parseText:"=",limit:"@"},link:function(t,n){t.$watch("parseText",function(e){if(e){var a,i=/<[a-z][\s\S]*>/i.test(e);i?(n.html(e),a=n.text()):a=e,t.limit&&a.length>Number(t.limit)&&(n.attr("title",a),a=a.substring(0,t.limit)+"..."),n.text(a)}})}}}),accApp.directive("textcomplete",["Textcomplete",function(t){return{restrict:"EA",scope:{members:"=",message:"="},template:"<textarea class=\"form-control\" rows=\"5\" ng-model='message' type='text'></textarea>",link:function(n,e){n.$watch("members",function(a){if(a&&a.length>0){var i=n.members,o=e.find("textarea"),r=new t(o,[{match:/(^|\s)@(\w*)$/,search:function(t,n){n($.map(i,function(n){return 0===n.toLowerCase().indexOf(t.toLowerCase())?n:null}))},index:2,replace:function(t){return"$1@"+t+" "}}]);$(r).on({"textComplete:select":function(t,e){n.$apply(function(){n.message=e})},"textComplete:show":function(){$(this).data("autocompleting",!0)},"textComplete:hide":function(){$(this).data("autocompleting",!1)}})}})}}}]),accApp.directive("routeLoader",function(){return{restrict:"EA",link:function(t,n){function e(){n.css("display","none")}var a=n.css("display");t.$on("$routeChangeStart",function(){n.css("display",a)}),t.$on("$routeChangeSuccess",e),t.$on("$routeChangeError",e),e()}}}),accApp.directive("serverLoader",function(){return{restrict:"EA",link:function(t,n){function e(){n.css("display","none")}var a=n.css("display");t.$on("$dataChangeStart",function(){t.serverAction="Đang tải dữ liệu",n.css("display",a)}),t.$on("$dataSaveStart",function(){t.serverAction="Đang lưu dữ liệu",n.css("display",a)}),t.$on("$dataChangeSuccess",e),t.$on("$dataChangeError",e),t.$on("$dataSaveSuccess",e),t.$on("$dataSaveError",e),e()}}}),accApp.directive("fileUploadProgress",function(){return{restrict:"EA",link:function(t,n){function e(){n.css("display","none")}var a=n.css("display");t.$on("$fileUploadStart",function(){t.serverAction="Đang tải dữ liệu",n.css("display",a)}),t.$on("$fileUploadSuccess",e),t.$on("$fileUploadError",e),e()}}}),accApp.directive("follow",function(){return{restrict:"E",scope:{collectionsFollow:"@"},templateUrl:"templates/sys/follow.html",controller:["$scope","$rootScope","$http","appInfo",function(t,n,e,a){initLabel(n,t,a,"FOLLOW",e),t.load=function(){a.info("follow",function(n,a,i){if(t.follows=[],!n&&i._id){if(!t.collectionsFollow||!i)return;var o=server_url+"/api/"+i._id+"/follow?q={user_created:'"+a.email+"'}&collections="+t.collectionsFollow;e.get(o).then(function(n){var e=n.data;t.follows=e})}})}}],link:function(t){t.load()}}}),accApp.directive("like",function(){return{restrict:"E",templateUrl:"templates/sys/like.html",controller:["$scope","$rootScope","$http","appInfo",function(t,n,e,a){t.load=function(){a.info("like_module",function(n,a,i){if(t.likes=[],!n&&i._id){var o=server_url+"/api/"+i._id+"/like_module?q={user_created:'"+a.email+"',like:true}";e.get(o).then(function(n){var e=n.data;t.likes=e})}})}}],link:function(t){t.load()}}}),accApp.directive("shortcut",["$document","$rootScope",function(t,n){return{restrict:"A",link:function(){t.bind("keydown",function(t){(t.ctrlKey&&(65==t.which||77==t.which||114==t.which||78==t.which||68==t.which||69==t.which||80==t.which||85==t.which||83==t.which)||116==t.which)&&t.preventDefault(),n.$apply(function(){n.$broadcast("keydown",t)})}),document.addEventListener("backbutton",function(t){if(n.ui_dropdowns)for(var e in n.ui_dropdowns)n.Ui.turnOff(e);n.$apply(function(){n.$broadcast("backbutton","1")}),t.preventDefault()},!1)}}}]),accApp.directive("input",function(){return{restrict:"E",priority:-1,link:function(t,n,e){"date"==e.type&&$(n).updatePolyfill()}}}),accApp.directive("nextFocus",function(){return{restrict:"A",link:function(t,n){function e(){var t=angular.element(n[0].querySelector(".always-focus"));t&&t.focus()}var a=angular.element(n[0].querySelectorAll("input,textarea"));if(a.length>0)for(var i=0;i<a.length;i++){var o=a.eq(i);o.bind("blur",function(){e()})}n.bind("click",function(){"TEXTAREA"!==document.activeElement.nodeName.toUpperCase()&&"INPUT"!==document.activeElement.nodeName.toUpperCase()&&"SELECT"!==document.activeElement.nodeName.toUpperCase()&&e()
}),n.bind("keydown",function(t){var i=t.keyCode||t.which;if(13===i){if(angular.element(n[0].querySelectorAll(".always-focus")).length>0)return e();if("TEXTAREA"!==document.activeElement.nodeName.toUpperCase()&&document.activeElement.className.indexOf("always-focus")<0&&(a=angular.element(n[0].querySelectorAll(".form-control,input,textarea")),a.length>0)){for(var o=a.index(document.activeElement)+1;;){if(o>=a.length){o=0;break}if(!a.eq(o).is(":disabled")&&!a.eq(o).is(":hidden"))break;o+=1}a.eq(o).focus(),t.preventDefault()}}})}}}),accApp.directive("a",function(){return{restrict:"E",link:function(t,n,e){n.bind("click",function(){e.href&&e.href.indexOf("javascript")<0})}}}),accApp.directive("barcode",function(){return{restrict:"E",scope:{data:"=",fieldCode:"@",fieldLabel:"@",fieldPrice:"@",fieldQty:"@",onClick:"&?",onClose:"&?"},templateUrl:"templates/sys/barcode.html",controller:["$scope","$uibModal","$rootScope",function(t,n,e){t.server_url=server_url_report,t.STP=e.STP,t.barcode_options={format:"CODE128",lineColor:"#000000",width:1,height:50,columns:"four",displayValue:!0,displayLabel:!0,displayPrice:!0,fontOptions:"",font:"monospace",textAlign:"center",textPosition:"bottom",textMargin:2,fontSize:20,background:"#ffffff",margin:0,marginTop:void 0,marginBottom:void 0,marginLeft:void 0,marginRight:void 0,valid:function(){}},t.click=function(n){t.onClick&&t.onClick({$item:n})},t.barcodeOptionsShow=function(){n.open({templateUrl:"templates/sys/barcode-options.html",controller:["$scope","$rootScope","$controller","$http","$uibModalInstance","parentScope","appInfo",function(t,n,e,a,i,o,r){initLabel(n,t,r,"SYS",a),t.barcode_options=o.barcode_options,t.cancel=function(){i.close()}}],size:"md",resolve:{parentScope:function(){return t}}})},t.printBarcode=function(t){t||(t="");var n=document.getElementById("printViewBarcode");if(!n)return e.alert("Mẫu in thiếu id 'printViewBarcode'");var a=n.innerHTML;e.printS(a,t)},t.$watch("data",function(n){if(n){t._data=[];var e,a;t.data.forEach(function(n){for(void 0==n[t.fieldQty]&&(n[t.fieldQty]=1),e=0;e<n[t.fieldQty];e++)a={},_.extend(a,n),delete a.$$hashKey,t._data.push(a)})}},!0)}],link:function(t){t.fieldQty||(t.fieldQty="so_luong")}}}),accApp.directive("buttonSlide",["$location",function(){return{restrict:"E",scope:{width:"@",height:"@",actions:"=?",text:"@",top:"@"},transclude:{title:"?btnTitle",content:"?btnContent"},templateUrl:"templates/sys/button-slide.html",link:function(t){t.width=t.width?Number(t.width):250,t.height=t.heigh?Number(t.height):window.innerHeight-200,t.is_close=!0,t.showhide=function(){t.is_close=!t.is_close},t.hide=function(){t.is_close=!0},t.show=function(){t.is_close=!1},t.actions={},t.actions.hide=t.hide,t.actions.showhide=t.showhide,t.top=t.top?Number(t.top):120}}}]);var isDrapItem=!1;accApp.directive("pivotReport",function(){return{restrict:"E",scope:{data:"=",filter:"=?",rows:"=?",cols:"=?",vals:"=?",id:"=?",sumFields:"=?",maxFields:"=?",textFields:"=?",minFields:"=?",averageFields:"=?"},template:'<div ng-show="_data && _data.length>0"><div id="pivot"></div></div>',controller:["$scope","$uibModal","$rootScope","$localStorage","excel","$filter",function(t,n,e,a,i){var o,r,c=$.pivotUtilities.aggregatorTemplates,d=$.pivotUtilities.numberFormat,l=d({digitsAfterDecimal:2}),u=function(n){if(n){r.vals||(r.vals=[]),n.append(" ");for(var e=$("<span>").appendTo(n),a=0;a<t.sumFields.length;a++){var i=t.sumFields[a],o=!1;_.find(r.vals,function(t){return t==i})&&(o=!0);var c=$("<label style='padding-left:10px'>").appendTo(e);$("<input/>",{type:"checkbox",checked:o,sfield:i}).appendTo(c).bind("change",function(){var t=$(this).attr("sfield");this.checked?r.vals.push(t):r.vals=_.filter(r.vals,function(n){return n!==t}),k()}),c.append("<span> "+i+" </span>")}}},s=function(){return function(){var n=r.vals;return n||(n=[]),function(){var e={};for(_i=0,_len=n.length;_len>_i;_i++)e[n[_i]]=0;return{push:function(a){for(_i=0,_len=n.length;_len>_i;_i++)t.textFields&&_.contains(t.textFields,n[_i])&&n[_i]&&a[n[_i]]?e[n[_i]]=e[n[_i]]?e[n[_i]]+","+a[n[_i]]:a[n[_i]]:e[n[_i]]+=n[_i]?parseFloat(a[n[_i]]):0},multivalue:function(){return e},value:function(){return e[n[0]]},format:function(t){return l(t)},label:"Facts"}}}},p=function(){return function(t){var n,e,a,i,o,r,c,d,l,s,p,h,f,g,m,k,y,w,S,M,D,x;o=t.colAttrs,h=t.rowAttrs,g=t.getRowKeys(),c=t.getColKeys();var T={}.hasOwnProperty,C=function(t,n,e){if(!t)return 0;var a,i,o,r,c,d,l,_;if(0!==n){for(r=!0,_=a=0,c=e;c>=0?c>=a:a>=c;_=c>=0?++a:--a)t[n-1][_]!==t[n][_]&&(r=!1);if(r)return-1}for(i=0;n+i<t.length;){for(l=!1,_=o=0,d=e;d>=0?d>=o:o>=d;_=d>=0?++o:--o)t[n][_]!==t[n+i][_]&&(l=!0);if(l)break;i++}return i};e=$("<div>");var P=$("<button>").text("Xuất excel").attr("colspan",2).bind("click",function(){b()});e.append(P),n=$("<span>"),e.append(n),u(n),p=$("<table class='pvtTable'>"),e.append(p),D=$("<thead>"),p.append(D);for(l in o){i=o[l],y=$("<tr>"),0===parseInt(l)&&0!==h.length&&y.append($("<th>").attr("colspan",h.length).attr("rowspan",o.length)),y.append($("<th class='pvtAxisLabel'>").text(i)),tmpAggregator=t.getAggregator([],[]),tmpAggregator.multivalue?(col_colspan=Object.keys(tmpAggregator.multivalue()).length,col_rowspan=1):(col_colspan=1,col_rowspan=2);for(d in c)r=c[d],m=$("<th class='pvtColLabel'>").text(r[l]).attr("colspan",col_colspan),parseInt(l)===o.length-1&&0!==h.length&&m.attr("rowspan",col_rowspan),y.append(m);0===parseInt(l)&&y.append($("<th class='pvtTotalLabel'>").text("Tổng cộng").attr("colspan",col_colspan).attr("rowspan",col_rowspan)),D.append(y)}if(0!==h.length){y=$("<tr>");for(d in h)s=h[d],y.append($("<th class='pvtAxisLabel'>").text(s));if(tmpAggregator=t.getAggregator([],[]),tmpAggregator.multivalue){o.length>0&&(m=$("<th>"),y.append(m)),S=tmpAggregator.multivalue();for(d in c)for(v in S)y.append($("<th class='pvtColLabel'>").text(v).data("value",v));for(v in S)y.append($("<th class='pvtColLabel'>").text(v).data("value",v))}else m=$("<th>"),0===o.length&&m.addClass("pvtTotalLabel").text("Tổng cộng"),y.append(m);D.append(y)}x=$("<tbody>"),p.append(x);for(d in g){f=g[d],y=$("<tr>");for(l in f)T.call(f,l)&&(w=f[l],M=C(g,parseInt(d),parseInt(l)),-1!==M&&(m=$("<th class='pvtRowLabel'>").text(w).attr("rowspan",M),parseInt(l)===h.length-1&&0!==o.length&&m.attr("colspan",2),y.append(m)));for(l in c)if(r=c[l],a=t.getAggregator(f,r),a.multivalue){S=a.multivalue();for(v in S){var E=S[v];_.isNumber(E)&&(E=a.format(E)),y.append($("<td class='pvtVal row"+d+" col"+l+"'>").text(E).attr("data-value",S[v]))}}else if(tmpAggregator=t.getAggregator([],[]),tmpAggregator.multivalue){S=tmpAggregator.multivalue();for(v in S)y.append($("<td class='pvtVal row"+d+" col"+l+"'>").text(a.format(0)).attr("data-value",0))}else S=a.value(),y.append($("<td class='pvtVal row"+d+" col"+l+"'>").text(a.format(S)).attr("data-value",S));if(k=t.getAggregator(f,[]),k.multivalue){S=k.multivalue();for(v in S){var E=S[v];_.isNumber(E)&&(E=k.format(E)),y.append($("<td class='pvtTotal rowTotal'>").text(E).attr("data-value",S[v]).attr("data-for","row"+d))}}else S=k.value(),y.append($("<td class='pvtTotal rowTotal'>").text(k.format(S)).attr("data-value",S).attr("data-for","row"+d));x.append(y)}y=$("<tr>"),m=$("<th class='pvtTotalLabel'>").text("Tổng cộng"),m.attr("colspan",h.length+(0===o.length?0:1)),y.append(m);for(l in c)if(r=c[l],k=t.getAggregator([],r),k.multivalue){S=k.multivalue();for(v in S){var E=S[v];_.isNumber(E)&&(E=k.format(E)),y.append($("<td class='pvtTotal colTotal'>").text(E).attr("data-value",S[v]).attr("data-for","col"+l))}}else S=k.value(),y.append($("<td class='pvtTotal colTotal'>").text(k.format(S)).attr("data-value",S).attr("data-for","col"+l));if(k=t.getAggregator([],[]),k.multivalue){S=k.multivalue();for(v in S)y.append($("<td class='pvtGrandTotal'>").text(k.format(S[v])).attr("data-value",S[v]))}else S=k.value(),y.append($("<td class='pvtGrandTotal'>").text(k.format(S)).attr("data-value",S));return x.append(y),p.data("dimensions",[g.length,c.length]),e}};if(t.id&&(r=a.get("pivotConfig_"+t.id),r&&(r=JSON.parse(r))),r)r.vals||(r.vals=[]);else{var h,f,g;t.rows&&(h=t.rows),t.cols&&(f=t.cols),t.vals&&(g=t.vals),r={rows:h,cols:f,vals:g}}r.cols=["Tiền","Tiền ngoại tệ"],r.onRefresh=function(n){if(t.id){var e=JSON.parse(JSON.stringify(n));delete e.aggregators,delete e.renderers,delete e.rendererOptions,delete e.localeStrings,delete e.onRefresh,e.vals=r.vals,_.extend(r,e),a.set("pivotConfig_"+t.id,JSON.stringify(e))}};var m={};m.Cộng=s(),m.Đếm=function(){return c.count()()},r.aggregators=m,r.renderers={Bảng:p()},_.extend(r.renderers,$.pivotUtilities.c3_renderers),r.hiddenAttributes=t.sumFields;var k=function(){o||(o=[]),r.vals||(r.vals=[]),$("#pivot").pivotUI(o,r,!0)},b=function(){i.tableToExcel(".pvtTable","ungdungquanly.vn")};t.$watch("data",function(n,e){n&&!_.isEqual(n,e)&&(o=t.filter?_.where(t.data,t.filter):t.data,t._data=o,k())})}],link:function(){}}}),accApp.directive("ngTypeahead",["$http",function($http){return{restrict:"E",scope:{ngModel:"=",ngDisabled:"=?",ngShow:"=?",label:"=?",onSelect:"&?",fieldModel:"@",module:"@",condition:"@",defaultValues:"@",parentData:"=?",setFields:"@"},template:function(t,n){var e="<div class='inner-addon right-addon'>";return e+="<input type='text'",e+=" ng-blur='blur()' ng-change='label=undefined' typeahead-on-select = 'getItem($item, $model, $label)'",n.hasOwnProperty("ngRequired")&&(e=e+" ng-required='"+n.ngRequired+"'"),n.hasOwnProperty("ngDisabled")&&(e+=" ng-disabled='ngDisabled'"),n.hasOwnProperty("ngShow")&&(e+=" ng-show='ngShow'"),e=n.hasOwnProperty("group")?e+"typeahead-min-length='2' typeahead-template-url='templates/"+n.group+"/"+n.module+"/templates/typeahead.html' ":e+"typeahead-min-length='2' typeahead-template-url='templates/lists/"+n.module+"/templates/typeahead.html' ",n.hasOwnProperty("placeholder")&&(e=e+" placeholder='"+n.placeholder+"' "),e+=" ng-model='ngModel'",e=e+" uib-typeahead='item."+n.fieldModel+" as item."+n.fieldModel+" for item in getList($viewValue,10)' class='form-control'>",(void 0==n.showButtonList||1==n.showButtonList)&&(n.hasOwnProperty("ngDisabled")||(e+="<i class='glyphicon glyphicon-triangle-bottom'  ng-show='show_btn_list'   ng-click='showList()'></i>")),e+="</div>"},controller:["$scope","$uibModal","$window","$interval","$rootScope","$q","$timeout",function($scope,$uibModal,$window,$interval,$rootScope,$q,$timeout){var stp_module=STPModules[$scope.module.toLowerCase()];if(stp_module){var module=stp_module.obj;$scope.pathService=module.server_path,$scope.fieldsSearch=module.fields_find,$scope.setData4Fields=function(item){if($scope.parentData&&$scope.setFields){var _fields=eval("({"+$scope.setFields+"})");for(var f in _fields)$scope.parentData[f]=item?item[_fields[f]]:void 0}};var list=function(t,n,e,a){var i=$q.defer(),o=$rootScope.getCacheFactory(t,"SYSTEM"),r=$scope.pathService;if(_.isObject(n)?r+=JSON.stringify(n):r=r+n?n:"",_online){if(_.contains(paths_not_require_id_app,$scope.pathService))var c=server_url+"/api/"+$scope.pathService+"?t=1";else var c=server_url+"/api/"+t+"/"+$scope.pathService+"?t=1";if(a&&(c=c+"&limit="+a),n)if(angular.isObject(n)){var d=JSON.stringify(n);c=c+"&q="+d}else c=c+"&"+n;!e&&$scope.fields&&(e=$scope.fields),e&&(c=c+"&fields="+e),$http.get(c).then(function(t){o.put(r,t.data),i.resolve(t)},function(c){if(c.data)i.reject(c);else{var d=o.get(r);d?i.resolve({data:d}):module.getService($http,$q,$rootScope).filterOffline(t,{condition:n,fields:e,limit:a}).then(function(t){i.resolve(t)},function(t){i.reject(t)})}})}else{var l=o.get(r);l?i.resolve({data:l}):module.getService($http,$q,$rootScope).filterOffline(t,{condition:n,fields:e,limit:a}).then(function(t){i.resolve(t)},function(t){i.reject(t)})}return i.promise};$scope.prepareCondition=function(value){var condition={},f;if($scope.condition)try{var _c_p=eval("({"+$scope.condition+"})");_.extend(condition,_c_p)}catch(e){console.error("error parse script",$scope.condition,e)}if(value)if(_online){if("$text"==$scope.fieldsSearch)return"$text="+value;condition.$or=[],$scope.fieldsSearch.forEach(function(field){f=eval(0==field.toLowerCase().indexOf("tk")?"({'"+field+"':{$regex:'^"+value+"',$options:'i'}})":"({'"+field+"':{$regex:'"+value+"',$options:'i'}})"),condition.$or.push(f)})}else condition.value_for_find=value;return condition},$scope.getList=function(t,n,e){var a=$scope.prepareCondition(t);return list(id_app,a,null,n).then(function(t){var n=t.data;return e&&e(n),n})},$scope.getItem=function(t){$scope.fieldLabel&&($scope.label=t[$scope.fieldLabel]),$scope.setData4Fields(t),$scope.onSelect&&$timeout(function(){$scope.onSelect({$item:t})},100)},$scope.blur=function(){if($scope.ngModel&&!$scope.label&&$scope.fieldLabel){var condition=eval("({"+$scope.fieldModel+":'"+$scope.ngModel+"'})");if($scope.condition){var _c_p=eval("({"+$scope.condition+"})");_.extend(condition,_c_p)}list(id_app,condition,$scope.fieldLabel).then(function(t){var n=t.data;$scope.label||(1==n.length?($scope.setData4Fields(n[0]),$scope.label=n[0][$scope.fieldLabel]):($scope.setData4Fields(),$scope.ngModel=void 0)),$scope.onSelect&&$timeout(function(){$scope.onSelect({$item:n.length>0?n[0]:{}})},100)})}$scope.ngModel||$scope.onSelect&&$timeout(function(){$scope.onSelect({$item:{}})},100)},$scope.showList=function(){var modalInstance=$uibModal.open({templateUrl:"templates/"+$scope.group+"/"+$scope.module+"/templates/dialog-select.html",controller:["$scope","$uibModalInstance","parentScope",$scope.module,"$rootScope",function($scope,$uibModalInstance,parentScope,service,$rootScope){$scope.getList=function(t,n){parentScope.getList(t,n,function(t){$scope.items=t})},$scope.keyup=function(t,n){13==t.keyCode&&n&&$scope.getList(n)},$scope.select=function(t){parentScope.ngModel=t[parentScope.fieldModel],parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.setData4Fields(t),parentScope.onSelect&&$timeout(function(){parentScope.onSelect({$item:t})},100),$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.close()},$scope.openList=function(){var url=parentScope.module;if(parentScope.condition){var condition=eval("({"+parentScope.condition+"})"),_q="";for(var key in condition)_q=_q?_q+"&"+key+"="+condition[key]:key+"="+condition[key];_q&&(url=url+"?"+_q)}$rootScope.openUrl(url),$uibModalInstance.close()},$scope.quickadd=function(){var dfvs={};parentScope.defaultValues&&(dfvs=eval("({"+parentScope.defaultValues+"})")),module.quickadd($uibModal,function(t){parentScope.ngModel=t[parentScope.fieldModel],parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.setData4Fields(t)},dfvs),$uibModalInstance.close()},$scope.quickedit=function(t){module.quickedit($uibModal,t._id,function(n){_.extend(t,n),parentScope.setData4Fields(t)})},$scope.delete=function(t){$rootScope.confirm("Bạn có chắc chắn xóa không?").then(function(n){1==n&&service.delete(id_app,t._id).then(function(){$scope.items=_.filter($scope.items,function(n){return n._id!==t._id})},function(t){var n=t.data;n||(n="Không thể kết nối với máy chủ"),$rootScope.alert(n)})})},$scope.getList("",10)}],size:"xs",resolve:{parentScope:function(){return $scope}}})}}}],link:function(t,n,e){t.show_btn_list=!0,e.hasOwnProperty("fields")&&(t.fields=e.fields),e.hasOwnProperty("fieldLabel")&&(t.fieldLabel=e.fieldLabel),t.group=e.hasOwnProperty("group")?e.group:"lists",t.$watch("ngModel",function(){t.ngModel||(t.label="")})}}}]),accApp.directive("ngSelector",["$http","$cache_lists",function($http,$cache){return{restrict:"E",scope:{ngModel:"=",label:"=?",ngChange:"&",onSelect:"&?",ngDisabled:"=?",module:"@",fields:"@",fieldModel:"@",fieldLabel:"@",defaultValues:"@",condition:"@",parentData:"=?",setFields:"@"},template:function(elem,attrs){var html="";if(attrs.hasOwnProperty("button")){var button=eval("({"+attrs.button+"})");button.class||(button.class="btn btn-default"),button.text||(button.text="..."),html=html+"<a class='"+button.class+"'  ng-click='showList()'>"+button.text+"</a>"}else attrs.hasOwnProperty("multiple")?(html='<multiple-autocomplete ng-model="selectedList" object-property="label" suggestions-arr="items" ',(void 0==attrs.showButtonList||1==attrs.showButtonList)&&(attrs.hasOwnProperty("ngDisabled")||(html+='show-list="showList" ')),html+="></multiple-autocomplete>"):(html="<div>",(void 0==attrs.showButtonList||1==attrs.showButtonList)&&(html="<div class='inner-addon right-addon'>"),html+="<select ng-model='ngModel' ng-disabled ='ngDisabled' ng-change='itemSelected()'",html=attrs.hasOwnProperty("options")?html+' ng-options="'+attrs.options+'"':attrs.hasOwnProperty("showCode")?html+' ng-options="item.'+attrs.fieldModel+" as item."+attrs.fieldModel+" + ' - ' +  item."+attrs.fieldLabel+'  for item in items" ':html+' ng-options="item.'+attrs.fieldModel+" as item."+attrs.fieldLabel+'  for item in items" ',html+=" class='form-control'></select>",(void 0==attrs.showButtonList||1==attrs.showButtonList)&&(attrs.hasOwnProperty("ngDisabled")||(html+="<i class='glyphicon glyphicon-triangle-bottom'  ng-show='show_btn_list'   ng-click='showList()'></i>")),html+="</div>");return html},controller:["$scope","$uibModal","$window","$interval","$rootScope","$q",function($scope,$uibModal,$window,$interval,$rootScope,$q){var stp_module=STPModules[$scope.module.toLowerCase()];if(stp_module){var module=stp_module.obj;$scope.pathService=module.server_path,$scope.fieldsSearch=module.fields_find;var selectedListChanged=!1,modelChanged=!1;$scope.selectedList=[],$scope.itemSelected=function(){if($scope.items){var t=_.find($scope.items,function(t){return t[$scope.fieldModel]==$scope.ngModel});$scope.ngChange({$item:t}),$scope.onSelect&&$scope.onSelect({$item:t}),t&&($scope.fieldLabel&&($scope.label=t[$scope.fieldLabel]),$scope.setData4Fields(t))}else $scope.ngChange({$item:null})},$scope.setData4Fields=function(item){if($scope.parentData&&$scope.setFields){var _fields=eval("({"+$scope.setFields+"})");for(var f in _fields)$scope.parentData[f]=item[_fields[f]]}},$scope.$watch("selectedList",function(t){$scope.multiple&&(selectedListChanged=!0,t&&!modelChanged&&($scope.ngModel=[],$scope.ngModel=_.pluck(t,$scope.fieldModel)),selectedListChanged=!1)},!0),$scope.$watch("items",function(t){if(t&&$scope.ngModel&&$scope.multiple){var n=($scope.fieldLabel||$scope.fieldModel).split(",");$scope.items.forEach(function(t){t.label="",n.forEach(function(n){t.label=t.label?t.label+" - "+t[n]:t[n]})}),modelChanged=!0,selectedListChanged=!0,$scope.selectedList=[],$scope.ngModel.forEach(function(t){var n=_.find($scope.items,function(n){return n[$scope.fieldModel]==t});n&&$scope.selectedList.push(n)}),modelChanged=!1,selectedListChanged=!1}},!0),$scope.$watch("ngModel",function(t){modelChanged=!0,_.isArray(t)&&!selectedListChanged&&($scope.selectedList=[],t.forEach(function(t){var n=_.find($scope.items,function(n){return n[$scope.fieldModel]==t});n&&$scope.selectedList.push(n)})),modelChanged=!1}),$scope.list=function(t,n,e,a){var i=$q.defer(),o=$rootScope.getCacheFactory(t,"SYSTEM"),r=$scope.pathService;if(_.isObject(n)?r+=JSON.stringify(n):r=r+n?n:"",_online){if(_.contains(paths_not_require_id_app,$scope.pathService))var c=server_url+"/api/"+$scope.pathService+"?t=1";else var c=server_url+"/api/"+t+"/"+$scope.pathService+"?t=1";if(a&&(c=c+"&limit="+a),n)if(angular.isObject(n)){var d=JSON.stringify(n);c=c+"&q="+d}else c=c+"&"+n;!e&&$scope.fields&&(e=$scope.fields),e&&(c=c+"&fields="+e),$http.get(c).then(function(t){o.put(r,t.data),i.resolve(t)},function(c){if(c.data)i.reject(c);else{var d=o.get(r);d?i.resolve({data:d}):module.getService($http,$q,$rootScope).filterOffline(t,{condition:n,fields:e,limit:a}).then(function(t){i.resolve(t)},function(t){i.reject(t)})}})}else{var l=o.get(r);l?i.resolve({data:l}):module.getService($http,$q,$rootScope).filterOffline(t,{condition:n,fields:e,limit:a}).then(function(t){i.resolve(t)},function(t){i.reject(t)})}return i.promise},$scope.refresh=function(){var condition={status:!0};if($scope.condition){var _cp_=eval("({"+$scope.condition+"})");_.extend(condition,_cp_)}$scope.list(id_app,condition).then(function(res){var data=res.data;if(!$scope.condition){var key=$scope.module+"_"+id_app;$cache[key]=data}if($scope.items=[],$scope.emptyYn&&!$scope.multiple){var empty_item=eval("({"+$scope.fieldModel+":'',"+$scope.fieldLabel+":'"+$scope.headerText+"'})");$scope.items.push(empty_item)}angular.forEach(data,function(t){$scope.items.push(t)}),!$scope.ngModel&&$scope.items.length>0&&($scope.ngModel=$scope.items[0][$scope.fieldModel],$scope.fieldLabel&&($scope.label=$scope.items[0][$scope.fieldLabel]),$scope.itemSelected())})},$scope.showList=function(){var modalInstance=$uibModal.open({templateUrl:"templates/"+$scope.group+"/"+$scope.module+"/templates/dialog-select.html",controller:["$scope","$uibModalInstance","parentScope",$scope.module,"$rootScope",function($scope,$uibModalInstance,parentScope,service,$rootScope){$scope.getList=function(value,limit){var condition={};parentScope.condition&&(condition=eval("({"+parentScope.condition+"})")),value&&("$text"==parentScope.fieldsSearch?condition.$text={$search:value}:(condition.$or=[],parentScope.fieldsSearch.forEach(function(field){var f=eval("({'"+field+"':{$regex:'"+value+"',$options:'i'}})");condition.$or.push(f)}))),parentScope.list(id_app,condition,null,limit).then(function(t){$scope.items=t.data})},$scope.keyup=function(t,n){13==t.keyCode&&n&&$scope.getList(n)},$scope.getList("",10),$scope.select=function(t){parentScope.multiple?(_.isArray(parentScope.ngModel)||(parentScope.ngModel=[]),parentScope.ngModel.push(t[parentScope.fieldModel]),parentScope.selectedList.push(t)):parentScope.ngModel=t[parentScope.fieldModel],parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.onSelect&&parentScope.onSelect({$item:t}),parentScope.setData4Fields(t),$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.close()},$scope.openList=function(){var url=parentScope.module;if(parentScope.condition){var condition=eval("({"+parentScope.condition+"})"),_q="";for(var key in condition)_q=_q?_q+"&"+key+"="+condition[key]:key+"="+condition[key];_q&&(url=url+"?"+_q)}$rootScope.openUrl(url,null,function(){parentScope.refresh()}),$uibModalInstance.close()},$scope.quickadd=function(){var dfvs={};parentScope.defaultValues&&(dfvs=eval("({"+parentScope.defaultValues+"})")),module.quickadd($uibModal,function(t){parentScope.items.push(t),parentScope.multiple?(_.isArray(parentScope.ngModel)||(parentScope.ngModel=[]),parentScope.ngModel.push(t[parentScope.fieldModel]),parentScope.selectedList.push(t)):(parentScope.ngModel=t[parentScope.fieldModel],parentScope.setData4Fields(t)),parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.onSelect&&parentScope.onSelect({$item:t});var n=parentScope.module+"_"+id_app;$cache[n]&&$cache[n].push(t)},dfvs),$uibModalInstance.close()},$scope.quickedit=function(t){module.quickedit($uibModal,t._id,function(n){var e;parentScope.multiple?(e=_.find(parentScope.selectedList,function(t){return t._id==n._id}),e&&_.extend(e,n)):(_.extend(t,n),parentScope.setData4Fields(t)),e=_.find(parentScope.items,function(t){return t._id==n._id}),e&&_.extend(e,n)})},$scope.delete=function(t){$rootScope.confirm("Bạn có chắc chắn xóa không?").then(function(n){1==n&&service.delete(id_app,t._id).then(function(){parentScope.items=_.filter(parentScope.items,function(n){return n._id!==t._id});var n=parentScope.module+"_"+id_app;$cache[n]&&($cache[n]=parentScope.items),$scope.items=_.filter($scope.items,function(n){return n._id!==t._id})},function(t){var n=t.data;n||(n="Không thể kết nối với máy chủ"),$rootScope.alert(n)})})}}],size:"xs",resolve:{parentScope:function(){return $scope}}})},$scope.getList=function(){var key=$scope.module+"_"+id_app;if($cache[key]&&!$scope.condition&&$scope.cache){var data=$cache[key];if($scope.items=[],$scope.emptyYn&&!$scope.multiple){var empty_item=eval("({"+$scope.fieldModel+":'',"+$scope.fieldLabel+":'"+$scope.headerText+"'})");$scope.items.push(empty_item)}angular.forEach(data,function(t){$scope.items.push(t)}),!$scope.ngModel&&$scope.items.length>0&&($scope.ngModel=$scope.items[0][$scope.fieldModel],$scope.fieldLabel&&($scope.label=$scope.items[0][$scope.fieldLabel]),$scope.onSelect&&$scope.onSelect({$item:$scope.items[0]}))}else $scope.refresh()},$scope.$watch("condition",function(t,n){t&&t!==n&&$scope.getList()})}}],link:function(t,n,e){t.show_btn_list=!0,t.multiple=e.hasOwnProperty("multiple")?!0:!1,t.cache=e.hasOwnProperty("cache")?e.cache:t.multiple,t.headerText=e.hasOwnProperty("headerText")?e.headerText:e.hasOwnProperty("placeholder")?e.placeholder:"--",t.group=e.hasOwnProperty("group")?e.group:"lists",t.emptyYn=e.hasOwnProperty("ngRequired")||e.hasOwnProperty("required")?!1:!0,t.getList()}}}]),accApp.directive("multiSelect",["$http","$cache_lists",function(){return{restrict:"E",scope:{ngModel:"=",fieldLabel:"@",fieldData:"@",items:"="},templateUrl:"templates/sys/multi-select.html",controller:["$scope","$rootScope",function(t){function n(){a=!0,t.arrs.length=0,t.items.forEach(function(n){n.sel=t.ngModel.indexOf(n[t.fieldData])>=0?!0:!1,t.arrs.push(n)}),a=!1}var e=!1,a=!1;t.arrs=[],t.$watch("arrs",function(n,i){if(!a){if(e=!0,!_.isEqual(n,i)){var o={};if(n)var o=_.filter(n,function(t){return t.sel});t.ngModel=_.pluck(o,t.fieldData)}e=!1}},!0),t.$watch("ngModel",function(n,i){if(!_.isEqual(n,i)&&n&&t.arrs){if(e)return;a=!0,t.arrs.forEach(function(e){e.sel=n.indexOf(e[t.fieldData])>=0}),a=!1}},!0),t.ngModel&&t.items&&n(),t.$watch("items",function(t,e){_.isEqual(t,e)||n()},!0)}],link:function(){}}}]);