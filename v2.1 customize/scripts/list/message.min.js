var messageModule=new baseInput("message","message",["email_owner","email_receiver","email_sender","content"],"Tin nh\u1eafn",{services:function(a){var d={list:function(c,b,g,d,h,k){var f=["email_owner","email_receiver","email_sender","content"];c=server_url+"/api/message/colleague/list?t=1";1==d&&(c+="&count=1");h&&(c=c+"&page="+h.toString());k&&(c=c+"&limit="+k.toString());if(angular.isObject(b))d=JSON.stringify(b),c=c+"&q="+d;else if(b&&""!=b.trim()&&f&&0!=f.length){var e="";f.forEach(function(a){e=
""==e?a+"="+b:e+"&"+a+"="+b});""!=e&&(c=c+"&"+e)}g&&(c=c+"&fields="+g);return a.get(c)},chat:function(c,b){return a.get(server_url+"/api/message/chat/"+b)},support:function(c,b,d){return a.post(server_url+"/public/support/"+b,d)},get:function(c,b){return a.get(server_url+"/api/message/"+b)},create:function(c,b){return a.post(server_url+"/api/message",b)},update:function(c,b,d){return a.put(server_url+"/api/message/"+b,d)},delete:function(c,b){return a.delete(server_url+"/api/message/"+b)},load:function(a,
b){return b?d.list(a,b.condition,b.fields,b.count,b.page,b.limit):d.list(a)}};return d}});
messageModule.module.controller("baseMessageChatController",["$scope","$location","$routeParams","$rootScope","message","$window","$uibModal","socket","user","appInfo","$http",function(a,d,c,b,g,n,h,k,f,e,l){initLabel(b,a,e,"message",l);e.info("message",function(b,d,q){if(!b){b=c.email;f.getProfile(b,function(b,c){if(b)return alert(b);a.profile=c});var e={};k.on("message",function(b){e[b._id]||(e[b._id]=b._id,a.profile&&(b.picture_sender=a.profile.picture,b.name_sender=a.profile.name),a.msgs.push(b))});
a.data={};a.data.email_receiver=b;g.chat(void 0,b).success(function(b){a.msgs=b});a.send=function(){g.create(void 0,a.data).success(function(b){a.data.content="";a.msgs.push(b)}).error(function(a){alert(a)})};a.enter2send=function(b){13==b.keyCode&&a.send()};a.deleteMsg=function(b){confirm("C\u00f3 ch\u1eafc ch\u1eafn x\u00f3a tin nh\u1eafn n\u00e0y kh\u00f4ng?")&&g.delete(null,b).success(function(){a.msgs=_.reject(a.msgs,function(a){return a._id==b})}).error(function(a){alert("Kh\u00f4ng th\u1ec3 x\u00f3a tin  nh\u1eafn n\u00e0y")})};
a.openProfile=function(a){messageModule.viewProfile(h,a)}}})}]);messageModule.module.controller("baseMessageHomeController",["$scope","$location","$routeParams","$rootScope","message","$window",function(a,d,c,b,g,n){a.chat=function(a){d.url("message/chat/"+a.email_coll)}}]);messageModule.initHomeController=function(a,d){a("baseMessageHomeController",{$scope:d})};
messageModule.controller("supportController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams","socket",function(a,d,c,b,g,n,h,k,f){var e=c.get("token"),l=k.title,m;b.user?m=b.user.email:(e=h.atob(l),f.on("connect",function(){f.emit("login",{token:e,email:e})}),f.on("message:new",function(a){notificationShowed[a._id+":new"]||(notificationShowed[a._id+":new"]=a,nodeWebkit.notification(a.content,"Tin nh\u1eafn t\u1eeb "+a.sender,"/support/"+l))}),m=e);a.msgs=[];
var p={};f.on("message",function(b){p[b._id]||(p[b._id]=b._id,a.profile&&(b.picture_sender=a.profile.picture,b.name_sender=a.profile.name),a.msgs.push(b))});a.data={title:l};a.data.content="";a.send=function(){message.support(void 0,m,a.data).success(function(b){a.data.content="";a.msgs.push(b)}).error(function(a){alert(a)})};a.enter2send=function(b){13==b.keyCode&&a.send()};a.deleteMsg=function(b){confirm("C\u00f3 ch\u1eafc ch\u1eafn x\u00f3a tin nh\u1eafn n\u00e0y kh\u00f4ng?")&&message.delete(null,
b).success(function(){a.msgs=_.reject(a.msgs,function(a){return a._id==b})}).error(function(a){alert("Kh\u00f4ng th\u1ec3 x\u00f3a tin  nh\u1eafn n\u00e0y")})};a.openProfile=function(a){messageModule.viewProfile($uibModal,a)}}]);
messageModule.module.config(["$routeProvider","$locationProvider",function(a,d){a.when("/message/chat/:email",{templateUrl:"templates/lists/message/templates/edit.html",controller:"baseMessageChatController"}).when("/support/:title",{templateUrl:"templates/login/templates/support.html",controller:"supportController"})}]);
